var morphicVersion="2012-Mar-27",modules={},useBlurredShadows=!0,standardSettings={minimumFontHeight:getMinimumFontHeight(),menuFontName:"sans-serif",menuFontSize:12,bubbleHelpFontSize:10,prompterFontName:"sans-serif",prompterFontSize:12,prompterSliderSize:10,handleSize:15,scrollBarSize:12,mouseScrollAmount:40,useVirtualKeyboard:!1},touchScreenSettings={minimumFontHeight:standardSettings.minimumFontHeight,menuFontName:"sans-serif",menuFontSize:24,bubbleHelpFontSize:18,prompterFontName:"sans-serif",
prompterFontSize:24,prompterSliderSize:20,handleSize:26,scrollBarSize:24,mouseScrollAmount:40,useVirtualKeyboard:!0},MorphicPreferences=standardSettings;function nop(){return null}function contains(a,b){return a.some(function(a){return a===b})}function detect(a,b){var c,d=a.length;for(c=0;c<d;c+=1)if(b.call(null,a[c]))return a[c];return null}function isString(a){return"string"===typeof a||a instanceof String}function isObject(a){return null!==a&&("object"===typeof a||a instanceof Object)}
function radians(a){return a*Math.PI/180}function degrees(a){return 180*a/Math.PI}function fontHeight(a){return Math.max(a,MorphicPreferences.minimumFontHeight)}function newCanvas(a){var b;b=a||{x:0,y:0};a=document.createElement("canvas");a.width=b.x;a.height=b.y;return a}
function getMinimumFontHeight(){var a=document.createElement("canvas"),b,c,d,e;a.width=50;a.height=50;a=a.getContext("2d");a.font="1px serif";b=a.measureText("I").width;a.fillStyle="black";a.textBaseline="bottom";a.fillText("I",0,50);for(e=0;50>e;e+=1)for(d=0;d<b;d+=1)if(c=a.getImageData(d,e,1,1),0!==c.data[3])return 50-e+1;return 0}
function getDocumentPositionOf(a){var b;if(null===a)return{x:0,y:0};b={x:a.offsetLeft,y:a.offsetTop};for(a=a.offsetParent;null!==a;)b.x+=a.offsetLeft,b.y+=a.offsetTop,a!==document.body&&a!==document.documentElement&&(b.x-=a.scrollLeft,b.y-=a.scrollTop),a=a.offsetParent;return b}function clone(a){if("object"===typeof a){var b=function(){};b.prototype=a;return new b}return a}
function copy(a){var b,c;if("object"!==typeof a)return a;b=a.valueOf();if(a!==b)return new a.constructor(b);if(a instanceof a.constructor&&a.constructor!==Object)for(c in b=clone(a.constructor.prototype),a)a.hasOwnProperty(c)&&(b[c]=a[c]);else for(c in b={},a)b[c]||(b[c]=a[c]);return b}function Color(a,b,c,d){this.r=a||0;this.g=b||0;this.b=c||0;this.a=d||(0===d?0:1)}Color.prototype.toString=function(){return"rgba("+Math.round(this.r)+","+Math.round(this.g)+","+Math.round(this.b)+","+this.a+")"};
Color.prototype.copy=function(){return new Color(this.r,this.g,this.b,this.a)};Color.prototype.eq=function(a){return this.r===a.r&&this.g===a.g&&this.b===a.b};Color.prototype.hsv=function(){var a,b,c,d,e=this.r/255,f=this.g/255,g=this.b/255;a=Math.max(e,f,g);b=Math.min(e,f,g);c=a;d=a-b;if(a===b)c=0;else{switch(a){case e:c=(f-g)/d+(f<g?6:0);break;case f:c=(g-e)/d+2;break;case g:c=(e-f)/d+4}c/=6}return[c,0===a?0:d/a,a]};
Color.prototype.set_hsv=function(a,b,c){var d,e,f;d=Math.floor(6*a);e=6*a-d;a=c*(1-b);f=c*(1-e*b);b=c*(1-(1-e)*b);switch(d%6){case 0:this.r=c;this.g=b;this.b=a;break;case 1:this.r=f;this.g=c;this.b=a;break;case 2:this.r=a;this.g=c;this.b=b;break;case 3:this.r=a;this.g=f;this.b=c;break;case 4:this.r=b;this.g=a;this.b=c;break;case 5:this.r=c,this.g=a,this.b=f}this.r*=255;this.g*=255;this.b*=255};
Color.prototype.mixed=function(a,b){var c=Math.min(Math.max(a,0),1),d=1-c;return new Color(this.r*c+b.r*d,this.g*c+b.g*d,this.b*c+b.b*d)};Color.prototype.darker=function(a){var b=0.8333;a&&(b=(100-a)/100);return this.mixed(b,new Color(0,0,0))};Color.prototype.lighter=function(a){var b=0.8333;a&&(b=(100-a)/100);return this.mixed(b,new Color(255,255,255))};Color.prototype.dansDarker=function(){var a=this.hsv(),b=new Color,c=Math.max(a[2]-0.16,0);b.set_hsv(a[0],a[1],c);return b};
function Point(a,b){this.x=a||0;this.y=b||0}Point.prototype.toString=function(){return Math.round(this.x.toString())+"@"+Math.round(this.y.toString())};Point.prototype.copy=function(){return new Point(this.x,this.y)};Point.prototype.eq=function(a){return this.x===a.x&&this.y===a.y};Point.prototype.lt=function(a){return this.x<a.x&&this.y<a.y};Point.prototype.gt=function(a){return this.x>a.x&&this.y>a.y};Point.prototype.ge=function(a){return this.x>=a.x&&this.y>=a.y};
Point.prototype.le=function(a){return this.x<=a.x&&this.y<=a.y};Point.prototype.max=function(a){return new Point(Math.max(this.x,a.x),Math.max(this.y,a.y))};Point.prototype.min=function(a){return new Point(Math.min(this.x,a.x),Math.min(this.y,a.y))};Point.prototype.round=function(){return new Point(Math.round(this.x),Math.round(this.y))};Point.prototype.abs=function(){return new Point(Math.abs(this.x),Math.abs(this.y))};Point.prototype.neg=function(){return new Point(-this.x,-this.y)};
Point.prototype.mirror=function(){return new Point(this.y,this.x)};Point.prototype.floor=function(){return new Point(Math.max(Math.floor(this.x),0),Math.max(Math.floor(this.y),0))};Point.prototype.ceil=function(){return new Point(Math.ceil(this.x),Math.ceil(this.y))};Point.prototype.add=function(a){return a instanceof Point?new Point(this.x+a.x,this.y+a.y):new Point(this.x+a,this.y+a)};
Point.prototype.subtract=function(a){return a instanceof Point?new Point(this.x-a.x,this.y-a.y):new Point(this.x-a,this.y-a)};Point.prototype.multiplyBy=function(a){return a instanceof Point?new Point(this.x*a.x,this.y*a.y):new Point(this.x*a,this.y*a)};Point.prototype.divideBy=function(a){return a instanceof Point?new Point(this.x/a.x,this.y/a.y):new Point(this.x/a,this.y/a)};
Point.prototype.floorDivideBy=function(a){return a instanceof Point?new Point(Math.floor(this.x/a.x),Math.floor(this.y/a.y)):new Point(Math.floor(this.x/a),Math.floor(this.y/a))};Point.prototype.r=function(){var a=this.multiplyBy(this);return Math.sqrt(a.x+a.y)};Point.prototype.degrees=function(){var a;if(0===this.x)return 0<=this.y?90:270;a=Math.atan(this.y/this.x);return 0<=this.x?0<=this.y?degrees(a):360+degrees(a):180+degrees(a)};
Point.prototype.theta=function(){var a;if(0===this.x)return 0<=this.y?radians(90):radians(270);a=Math.atan(this.y/this.x);return 0<=this.x?0<=this.y?a:radians(360)+a:radians(180)+a};Point.prototype.crossProduct=function(a){return this.multiplyBy(a.mirror())};Point.prototype.distanceTo=function(a){return a.subtract(this).r()};Point.prototype.rotate=function(a,b){var c=this.subtract(b);return"right"===a?(new Point(-c.y,c.y)).add(b):"left"===a?(new Point(c.y,-c.y)).add(b):b.subtract(c)};
Point.prototype.flip=function(a,b){return"vertical"===a?new Point(this.x,2*b.y-this.y):new Point(2*b.x-this.x,this.y)};Point.prototype.distanceAngle=function(a,b){var c=b,d;270<c?c-=360:-270>c&&(c+=360);if(-90<=c&&90>=c)return c=Math.sin(radians(c))*a,d=Math.sqrt(a*a-c*c),new Point(c+this.x,this.y-d);c=Math.sin(radians(180-c))*a;d=Math.sqrt(a*a-c*c);return new Point(c+this.x,this.y+d)};Point.prototype.scaleBy=function(a){return this.multiplyBy(a)};Point.prototype.translateBy=function(a){return this.add(a)};
Point.prototype.rotateBy=function(a,b){var c=b||new Point(0,0),d=this.subtract(c),e=d.r(),d=a-d.theta();return new Point(c.x+e*Math.cos(d),c.y-e*Math.sin(d))};Point.prototype.asArray=function(){return[this.x,this.y]};function Rectangle(a,b,c,d){this.init(new Point(a||0,b||0),new Point(c||0,d||0))}Rectangle.prototype.init=function(a,b){this.origin=a;this.corner=b};Rectangle.prototype.toString=function(){return"["+this.origin.toString()+" | "+this.extent().toString()+"]"};
Rectangle.prototype.copy=function(){return new Rectangle(this.left(),this.top(),this.right(),this.bottom())};Point.prototype.corner=function(a){return new Rectangle(this.x,this.y,a.x,a.y)};Point.prototype.rectangle=function(a){var b;b=this.min(a);a=this.max(a);return new Rectangle(b.x,b.y,a.x,a.y)};Point.prototype.extent=function(a){a=this.add(a);return new Rectangle(this.x,this.y,a.x,a.y)};
Rectangle.prototype.setTo=function(a,b,c,d){this.origin=new Point(a||(0===a?0:this.left()),b||(0===b?0:this.top()));this.corner=new Point(c||(0===c?0:this.right()),d||(0===d?0:this.bottom()))};Rectangle.prototype.area=function(){var a=this.width();return 0>a?0:Math.max(a*this.height(),0)};Rectangle.prototype.bottom=function(){return this.corner.y};Rectangle.prototype.bottomCenter=function(){return new Point(this.center().x,this.bottom())};
Rectangle.prototype.bottomLeft=function(){return new Point(this.origin.x,this.corner.y)};Rectangle.prototype.bottomRight=function(){return this.corner.copy()};Rectangle.prototype.boundingBox=function(){return this};Rectangle.prototype.center=function(){return this.origin.add(this.corner.subtract(this.origin).floorDivideBy(2))};Rectangle.prototype.corners=function(){return[this.origin,this.bottomLeft(),this.corner,this.topRight()]};Rectangle.prototype.extent=function(){return this.corner.subtract(this.origin)};
Rectangle.prototype.height=function(){return this.corner.y-this.origin.y};Rectangle.prototype.left=function(){return this.origin.x};Rectangle.prototype.leftCenter=function(){return new Point(this.left(),this.center().y)};Rectangle.prototype.right=function(){return this.corner.x};Rectangle.prototype.rightCenter=function(){return new Point(this.right(),this.center().y)};Rectangle.prototype.top=function(){return this.origin.y};
Rectangle.prototype.topCenter=function(){return new Point(this.center().x,this.top())};Rectangle.prototype.topLeft=function(){return this.origin};Rectangle.prototype.topRight=function(){return new Point(this.corner.x,this.origin.y)};Rectangle.prototype.width=function(){return this.corner.x-this.origin.x};Rectangle.prototype.position=function(){return this.origin};Rectangle.prototype.eq=function(a){return this.origin.eq(a.origin)&&this.corner.eq(a.corner)};
Rectangle.prototype.abs=function(){var a,b;a=this.origin.abs();b=this.corner.max(a);return a.corner(b)};Rectangle.prototype.insetBy=function(a){var b=new Rectangle;b.origin=this.origin.add(a);b.corner=this.corner.subtract(a);return b};Rectangle.prototype.expandBy=function(a){var b=new Rectangle;b.origin=this.origin.subtract(a);b.corner=this.corner.add(a);return b};Rectangle.prototype.intersect=function(a){var b=new Rectangle;b.origin=this.origin.max(a.origin);b.corner=this.corner.min(a.corner);return b};
Rectangle.prototype.merge=function(a){var b=new Rectangle;b.origin=this.origin.min(a.origin);b.corner=this.corner.max(a.corner);return b};Rectangle.prototype.round=function(){return this.origin.round().corner(this.corner.round())};Rectangle.prototype.spread=function(){return this.origin.floor().corner(this.corner.ceil())};
Rectangle.prototype.amountToTranslateWithin=function(a){var b,c;this.right()>a.right()&&(b=a.right()-this.right());this.bottom()>a.bottom()&&(c=a.bottom()-this.bottom());this.left()+b<a.left()&&(b=a.left()-this.right());this.top()+c<a.top()&&(c=a.top()-this.top());return new Point(b,c)};Rectangle.prototype.containsPoint=function(a){return this.origin.le(a)&&a.lt(this.corner)};Rectangle.prototype.containsRectangle=function(a){return a.origin.gt(this.origin)&&a.corner.lt(this.corner)};
Rectangle.prototype.intersects=function(a){var b=a.origin,a=a.corner;return a.x>=this.origin.x&&a.y>=this.origin.y&&b.x<=this.corner.x&&b.y<=this.corner.y};Rectangle.prototype.scaleBy=function(a){var b=this.origin.multiplyBy(a),a=this.corner.multiplyBy(a);return new Rectangle(b.x,b.y,a.x,a.y)};Rectangle.prototype.translateBy=function(a){var b=this.origin.add(a),a=this.corner.add(a);return new Rectangle(b.x,b.y,a.x,a.y)};
Rectangle.prototype.asArray=function(){return[this.left(),this.top(),this.right(),this.bottom()]};Rectangle.prototype.asArray_xywh=function(){return[this.left(),this.top(),this.width(),this.height()]};function Node(a,b){this.init(a||null,b||[])}Node.prototype.init=function(a,b){this.parent=a||null;this.children=b||[]};Node.prototype.toString=function(){return"a Node["+this.children.length.toString()+"]"};Node.prototype.addChild=function(a){this.children.push(a);a.parent=this};
Node.prototype.addChildFirst=function(a){this.children.splice(0,null,a);a.parent=this};Node.prototype.removeChild=function(a){a=this.children.indexOf(a);-1!==a&&this.children.splice(a,1)};Node.prototype.root=function(){return null===this.parent?this:this.parent.root()};Node.prototype.depth=function(){return null===this.parent?0:this.parent.depth()+1};Node.prototype.allChildren=function(){var a=[this];this.children.forEach(function(b){a=a.concat(b.allChildren())});return a};
Node.prototype.forAllChildren=function(a){0<this.children.length&&this.children.forEach(function(b){b.forAllChildren(a)});a.call(null,this)};Node.prototype.allLeafs=function(){var a=[];this.allChildren().forEach(function(b){0===b.children.length&&a.push(b)});return a};Node.prototype.allParents=function(){var a=[this];null!==this.parent&&(a=a.concat(this.parent.allParents()));return a};
Node.prototype.siblings=function(){var a=this;return null===this.parent?[]:this.parent.children.filter(function(b){return b!==a})};Node.prototype.parentThatIsA=function(a){return this instanceof a?this:!this.parent?null:this.parent instanceof a?this.parent:this.parent.parentThatIsA(a)};Node.prototype.parentThatIsAnyOf=function(a){var b=!1,c=this;a.forEach(function(a){c.constructor===a&&(b=!0)});return b?this:!this.parent?null:this.parent.parentThatIsAnyOf(a)};Morph.prototype=new Node;
Morph.prototype.constructor=Morph;Morph.uber=Node.prototype;Morph.prototype.trackChanges=!0;Morph.prototype.shadowBlur=4;function Morph(){this.init()}
Morph.prototype.init=function(){Morph.uber.init.call(this);this.isMorph=!0;this.bounds=new Rectangle(0,0,50,40);this.color=new Color(80,80,80);this.cachedTexture=this.texture=null;this.alpha=1;this.isVisible=!0;this.noticesTransparentClick=this.acceptsDrops=this.isTemplate=this.isDraggable=!1;this.drawNew();this.fps=0;this.customContextMenu=null;this.lastTime=Date.now()};
Morph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+" "+this.children.length.toString()+" "+this.bounds};Morph.prototype.destroy=function(){null!==this.parent&&(this.fullChanged(),this.parent.removeChild(this))};Morph.prototype.stepFrame=function(){if(!this.step)return null;var a,b;a=Date.now();b=a-this.lastTime;if(1>(0<this.fps?1E3/this.fps-b:0))this.lastTime=a,this.step(),this.children.forEach(function(a){a.stepFrame()})};
Morph.prototype.step=function(){nop()};Morph.prototype.left=function(){return this.bounds.left()};Morph.prototype.right=function(){return this.bounds.right()};Morph.prototype.top=function(){return this.bounds.top()};Morph.prototype.bottom=function(){return this.bounds.bottom()};Morph.prototype.center=function(){return this.bounds.center()};Morph.prototype.bottomCenter=function(){return this.bounds.bottomCenter()};Morph.prototype.bottomLeft=function(){return this.bounds.bottomLeft()};
Morph.prototype.bottomRight=function(){return this.bounds.bottomRight()};Morph.prototype.boundingBox=function(){return this.bounds};Morph.prototype.corners=function(){return this.bounds.corners()};Morph.prototype.leftCenter=function(){return this.bounds.leftCenter()};Morph.prototype.rightCenter=function(){return this.bounds.rightCenter()};Morph.prototype.topCenter=function(){return this.bounds.topCenter()};Morph.prototype.topLeft=function(){return this.bounds.topLeft()};Morph.prototype.topRight=function(){return this.bounds.topRight()};
Morph.prototype.position=function(){return this.bounds.origin};Morph.prototype.extent=function(){return this.bounds.extent()};Morph.prototype.width=function(){return this.bounds.width()};Morph.prototype.height=function(){return this.bounds.height()};Morph.prototype.fullBounds=function(){var a;a=this.bounds;this.children.forEach(function(b){b.isVisible&&(a=a.merge(b.fullBounds()))});return a};
Morph.prototype.fullBoundsNoShadow=function(){var a;a=this.bounds;this.children.forEach(function(b){!(b instanceof ShadowMorph)&&b.isVisible&&(a=a.merge(b.fullBounds()))});return a};Morph.prototype.visibleBounds=function(){var a=this.bounds;this.allParents().filter(function(a){return a instanceof FrameMorph}).forEach(function(b){a=a.intersect(b.bounds)});return a};
Morph.prototype.moveBy=function(a){this.changed();this.bounds=this.bounds.translateBy(a);this.children.forEach(function(b){b.moveBy(a)});this.changed()};Morph.prototype.silentMoveBy=function(a){this.bounds=this.bounds.translateBy(a);this.children.forEach(function(b){b.silentMoveBy(a)})};Morph.prototype.setPosition=function(a){a=a.subtract(this.topLeft());(0!==a.x||0!==a.y)&&this.moveBy(a)};Morph.prototype.silentSetPosition=function(a){a=a.subtract(this.topLeft());(0!==a.x||0!==a.y)&&this.silentMoveBy(a)};
Morph.prototype.setLeft=function(a){this.setPosition(new Point(a,this.top()))};Morph.prototype.setRight=function(a){this.setPosition(new Point(a-this.width(),this.top()))};Morph.prototype.setTop=function(a){this.setPosition(new Point(this.left(),a))};Morph.prototype.setBottom=function(a){this.setPosition(new Point(this.left(),a-this.height()))};Morph.prototype.setCenter=function(a){this.setPosition(a.subtract(this.extent().floorDivideBy(2)))};Morph.prototype.setFullCenter=function(a){this.setPosition(a.subtract(this.fullBounds().extent().floorDivideBy(2)))};
Morph.prototype.keepWithin=function(a){var b;b=this.fullBounds().left()-a.left();0>b&&this.moveBy(new Point(-b,0));b=this.fullBounds().right()-a.right();0<b&&this.moveBy(new Point(-b,0));b=this.fullBounds().top()-a.top();0>b&&this.moveBy(new Point(0,-b));a=this.fullBounds().bottom()-a.bottom();0<a&&this.moveBy(new Point(0,-a))};Morph.prototype.setExtent=function(a){a.eq(this.extent())||(this.changed(),this.silentSetExtent(a),this.changed(),this.drawNew())};
Morph.prototype.silentSetExtent=function(a){var b;b=a.round();a=Math.max(b.x,0);b=Math.max(b.y,0);this.bounds.corner=new Point(this.bounds.origin.x+a,this.bounds.origin.y+b)};Morph.prototype.setWidth=function(a){this.setExtent(new Point(a||0,this.height()))};Morph.prototype.silentSetWidth=function(a){a=Math.max(Math.round(a||0),0);this.bounds.corner=new Point(this.bounds.origin.x+a,this.bounds.corner.y)};Morph.prototype.setHeight=function(a){this.setExtent(new Point(this.width(),a||0))};
Morph.prototype.silentSetHeight=function(a){a=Math.max(Math.round(a||0),0);this.bounds.corner=new Point(this.bounds.corner.x,this.bounds.origin.y+a)};Morph.prototype.setColor=function(a){a&&!this.color.eq(a)&&(this.color=a,this.changed(),this.drawNew())};Morph.prototype.drawNew=function(){this.image=newCanvas(this.extent());var a=this.image.getContext("2d");a.fillStyle=this.color.toString();a.fillRect(0,0,this.width(),this.height());this.texture&&this.drawTexture(this.texture)};
Morph.prototype.drawTexture=function(a){var b=this;this.cachedTexture&&this.texture===a?this.drawCachedTexture():(this.cachedTexture=new Image,this.cachedTexture.src=this.texture=a,this.cachedTexture.onload=function(){b.drawCachedTexture()})};Morph.prototype.drawCachedTexture=function(){var a=this.image.getContext("2d"),b=a.createPattern(this.cachedTexture,"repeat");a.fillStyle=b;a.fillRect(0,0,this.image.width,this.image.height);this.changed()};
Morph.prototype.drawOn=function(a,b){var c,d,e,f,g;if(!this.isVisible)return null;c=(b||this.bounds()).intersect(this.bounds).round();if(c.extent().gt(new Point(0,0))){d=this.position().neg();d=c.copy().translateBy(d).round();e=a.getContext("2d");e.globalAlpha=this.alpha;f=d.left();g=d.top();f=Math.min(d.width(),this.image.width-f);g=Math.min(d.height(),this.image.height-g);if(1>f||1>g)return null;e.drawImage(this.image,d.left(),d.top(),f,g,c.left(),c.top(),f,g)}};
Morph.prototype.fullDrawOn=function(a,b){var c;if(!this.isVisible)return null;c=b||this.fullBounds();this.drawOn(a,c);this.children.forEach(function(b){b.fullDrawOn(a,c)})};Morph.prototype.hide=function(){this.isVisible=!1;this.changed();this.children.forEach(function(a){a.hide()})};Morph.prototype.show=function(){this.isVisible=!0;this.changed();this.children.forEach(function(a){a.show()})};Morph.prototype.toggleVisibility=function(){this.isVisible=!this.isVisible;this.changed();this.children.forEach(function(a){a.toggleVisibility()})};
Morph.prototype.fullImageClassic=function(){var a=this.fullBounds(),b=newCanvas(a.extent());this.fullDrawOn(b,a);b.globalAlpha=this.alpha;return b};Morph.prototype.fullImage=function(){var a,b,c;a=newCanvas(this.fullBounds().extent());b=a.getContext("2d");c=this.fullBounds();this.allChildren().forEach(function(a){a.isVisible&&(b.globalAlpha=a.alpha,b.drawImage(a.image,a.bounds.origin.x-c.origin.x,a.bounds.origin.y-c.origin.y))});return a};
Morph.prototype.shadowImage=function(a,b){var c,d,e,f,g=a||new Point(7,7),h=b||new Color(0,0,0);c=this.fullBounds().extent();d=this.fullImage();e=newCanvas(c);f=e.getContext("2d");f.drawImage(d,0,0);f.globalCompositeOperation="destination-out";f.drawImage(d,-g.x,-g.y);d=newCanvas(c);f=d.getContext("2d");f.drawImage(e,0,0);f.globalCompositeOperation="source-atop";f.fillStyle=h.toString();f.fillRect(0,0,c.x,c.y);return d};
Morph.prototype.shadowImageBlurred=function(a,b){var c,d,e,f=a||new Point(7,7),g=this.shadowBlur,h=b||new Color(0,0,0);c=this.fullBounds().extent().add(2*g);d=this.fullImage();c=newCanvas(c);e=c.getContext("2d");e.shadowOffsetX=f.x;e.shadowOffsetY=f.y;e.shadowBlur=g;e.shadowColor=h.toString();e.drawImage(d,g-f.x,g-f.y);e.shadowOffsetX=0;e.shadowOffsetY=0;e.shadowBlur=0;e.globalCompositeOperation="destination-out";e.drawImage(d,g-f.x,g-f.y);return c};
Morph.prototype.shadow=function(a,b,c){var d=new ShadowMorph,a=a||new Point(7,7),b=b||(0===b?0:0.2),e=this.fullBounds();d.setExtent(e.extent().add(2*this.shadowBlur));useBlurredShadows?(d.image=this.shadowImageBlurred(a,c),d.alpha=b,d.setPosition(e.origin.add(a).subtract(this.shadowBlur))):(d.image=this.shadowImage(a,c),d.alpha=b,d.setPosition(e.origin.add(a)));return d};
Morph.prototype.addShadow=function(a,b,c){a=this.shadow(a||new Point(7,7),b||(0===b?0:0.2),c);this.addBack(a);this.fullChanged();return a};Morph.prototype.getShadow=function(){var a;a=this.children.slice(0).reverse().filter(function(a){return a instanceof ShadowMorph});return 0!==a.length?a[0]:null};Morph.prototype.removeShadow=function(){var a=this.getShadow();null!==a&&(this.fullChanged(),this.removeChild(a))};Morph.prototype.penTrails=function(){return this.image};
Morph.prototype.changed=function(){if(this.trackChanges){var a=this.root();a instanceof WorldMorph&&a.broken.push(this.visibleBounds().spread())}this.parent&&this.parent.childChanged(this)};Morph.prototype.fullChanged=function(){if(this.trackChanges){var a=this.root();a instanceof WorldMorph&&a.broken.push(this.fullBounds().spread())}};Morph.prototype.childChanged=function(){this.parent&&this.parent.childChanged(this)};
Morph.prototype.world=function(){var a=this.root();return a instanceof WorldMorph?a:null};Morph.prototype.add=function(a){var b=a.parent;null!==b&&b.removeChild(a);this.addChild(a)};Morph.prototype.addBack=function(a){var b=a.parent;null!==b&&b.removeChild(a);this.addChildFirst(a)};Morph.prototype.topMorphSuchThat=function(a){var b;return a.call(null,this)?(b=detect(this.children.slice(0).reverse(),a))?b.topMorphSuchThat(a):this:null};
Morph.prototype.morphAt=function(a){var b=null;this.allChildren().slice(0).reverse().forEach(function(c){c.fullBounds().containsPoint(a)&&null===b&&(b=c)});return b};Morph.prototype.overlappedMorphs=function(){var a=this.world(),b=this.fullBounds(),c=this,d=this.allParents(),e=this.allChildren();return a.allChildren().filter(function(f){return f.isVisible&&f!==c&&f!==a&&!contains(d,f)&&!contains(e,f)&&f.fullBounds().intersects(b)})};
Morph.prototype.getPixelColor=function(a){a=a.subtract(this.bounds.origin);a=this.image.getContext("2d").getImageData(a.x,a.y,1,1);return new Color(a.data[0],a.data[1],a.data[2],a.data[3])};Morph.prototype.isTransparentAt=function(a){var b;if(this.bounds.containsPoint(a)){if(this.texture)return!1;a=a.subtract(this.bounds.origin);b=this.image.getContext("2d");a=b.getImageData(Math.floor(a.x),Math.floor(a.y),1,1);return 0===a.data[3]}return!1};
Morph.prototype.copy=function(){var a=copy(this);a.parent=null;a.children=[];a.bounds=this.bounds.copy();return a};Morph.prototype.fullCopy=function(){var a={},b;b=this.copyRecordingReferences(a);b.forAllChildren(function(b){b.updateReferences(a)});return b};Morph.prototype.copyRecordingReferences=function(a){var b=this.copy();a[this]=b;this.children.forEach(function(c){b.add(c.copyRecordingReferences(a))});return b};
Morph.prototype.updateReferences=function(a){for(var b in this)b.isMorph&&a[b]&&(this[b]=a[b])};Morph.prototype.rootForGrab=function(){return this instanceof ShadowMorph?this.parent.rootForGrab():this.parent instanceof ScrollFrameMorph?this.parent:null===this.parent||this.parent instanceof WorldMorph||this.parent instanceof FrameMorph||!0===this.isDraggable?this:this.parent.rootForGrab()};
Morph.prototype.wantsDropOf=function(a){return a instanceof HandleMorph||a instanceof MenuMorph||a instanceof InspectorMorph?!1:this.acceptsDrops};Morph.prototype.pickUp=function(a){a=a||this.world();this.setPosition(a.hand.position().subtract(this.extent().floorDivideBy(2)));a.hand.grab(this)};Morph.prototype.isPickedUp=function(){return null!==this.parentThatIsA(HandMorph)};Morph.prototype.nop=function(){nop()};Morph.prototype.resize=function(){this.world().activeHandle=new HandleMorph(this)};
Morph.prototype.move=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"move")};Morph.prototype.hint=function(a){var b;(b=a)?a.toString&&(b=a.toString()):b="NULL";a=new MenuMorph(this,b);a.isDraggable=!0;a.popUpCenteredAtHand(this.world())};Morph.prototype.inform=function(a){var b;(b=a)?a.toString&&(b=a.toString()):b="NULL";a=new MenuMorph(this,b);a.addItem("Ok");a.isDraggable=!0;a.popUpCenteredAtHand(this.world())};
Morph.prototype.prompt=function(a,b,c,d,e,f,g,h){var i,j;g&&(j=!0);a=new MenuMorph(b||null,a||"",c||null);i=new StringFieldMorph(d||"",e||100,MorphicPreferences.prompterFontSize,MorphicPreferences.prompterFontName,!1,!1,j);a.items.push(i);if(g||MorphicPreferences.useVirtualKeyboard)d=new SliderMorph(f||0,g,parseFloat(d),Math.floor((g-f)/4),"horizontal"),d.alpha=1,d.color=new Color(225,225,225),d.button.color=a.borderColor,d.button.highlightColor=d.button.color.copy(),d.button.highlightColor.b+=100,
d.button.pressColor=d.button.color.copy(),d.button.pressColor.b+=150,d.setHeight(MorphicPreferences.prompterSliderSize),d.action=h?function(a){i.changed();i.text.text=Math.round(a).toString();i.text.drawNew();i.text.changed();i.text.edit()}:function(a){i.changed();i.text.text=a.toString();i.text.drawNew();i.text.changed()},a.items.push(d);a.addLine(2);a.addItem("Ok",function(){return i.string()});a.addItem("Cancel",function(){return null});a.isDraggable=!0;a.popUpAtHand(this.world());i.text.edit()};
Morph.prototype.pickColor=function(a,b,c,d){var e,a=new MenuMorph(b||null,a||"",c||null);e=new ColorPickerMorph(d);a.items.push(e);a.addLine(2);a.addItem("Ok",function(){return e.getChoice()});a.addItem("Cancel",function(){return null});a.isDraggable=!0;a.popUpAtHand(this.world())};Morph.prototype.inspect=function(a){var b=this.world(),c=this;a&&(c=a);a=new InspectorMorph(c);a.setPosition(b.hand.position());a.keepWithin(b);b.add(a);a.changed()};
Morph.prototype.contextMenu=function(){var a;return this.customContextMenu?this.customContextMenu:(a=this.world())&&a.isDevMode?this.parent===a?this.developersMenu():this.hierarchyMenu():this.userMenu()||this.parent&&this.parent.userMenu()};Morph.prototype.hierarchyMenu=function(){var a=this.allParents(),b=this.world(),c=new MenuMorph(this,null);a.forEach(function(a){a.developersMenu&&a!==b&&c.addItem(a.toString().slice(0,50),function(){a.developersMenu().popUpAtHand(b)})});return c};
Morph.prototype.developersMenu=function(){var a=this.world(),b=this.userMenu()||this.parent&&this.parent.userMenu(),c=new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]);b&&(c.addItem("user features...",function(){b.popUpAtHand(a)}),c.addLine());c.addItem("color...",function(){this.pickColor(c.title+"\ncolor:",this.setColor,this,this.color)},"choose another color \nfor this morph");c.addItem("transparency...",function(){this.prompt(c.title+"\nalpha\nvalue:",
this.setAlphaScaled,this,(this.alpha*100).toString(),null,1,100,true)},"set this morph's\nalpha value");c.addItem("resize...","resize","show a handle\nwhich can be dragged\nto change this morph's extent");c.addLine();c.addItem("duplicate",function(){this.fullCopy().pickUp(this.world())},"make a copy\nand pick it up");c.addItem("pick up","pickUp","disattach and put \ninto the hand");c.addItem("attach...","attach","stick this morph\nto another one");c.addItem("move...","move","show a handle\nwhich can be dragged\nto move this morph");
c.addItem("inspect...","inspect","open a window\non all properties");c.addLine();this.isDraggable?c.addItem("lock","toggleIsDraggable","make this morph\nunmovable"):c.addItem("unlock","toggleIsDraggable","make this morph\nmovable");c.addItem("hide","hide");c.addItem("delete","destroy");this instanceof WorldMorph||(c.addLine(),c.addItem("World...",function(){a.contextMenu().popUpAtHand(a)},"show the\nWorld's menu"));return c};Morph.prototype.userMenu=function(){return null};
Morph.prototype.setAlphaScaled=function(a){"number"===typeof a?this.alpha=Math.min(Math.max(a/100,0.1),1):(a=parseFloat(a),isNaN(a)||(this.alpha=Math.min(Math.max(a/100,0.1),1)));this.changed()};Morph.prototype.attach=function(){var a=this.overlappedMorphs(),b=new MenuMorph(this,"choose new parent:"),c=this;a.forEach(function(a){b.addItem(a.toString().slice(0,50),function(){a.add(c);c.isDraggable=!1})});0<a.length&&b.popUpAtHand(this.world())};
Morph.prototype.toggleIsDraggable=function(){this.isDraggable=!this.isDraggable};Morph.prototype.colorSetters=function(){return["color"]};Morph.prototype.numericalSetters=function(){return["setLeft","setTop","setWidth","setHeight","setAlphaScaled"]};Morph.prototype.allEntryFields=function(){return this.allChildren().filter(function(a){return a.isEditable})};Morph.prototype.nextEntryField=function(a){var b=this.allEntryFields(),a=b.indexOf(a);if(-1!==a)return b.length>a-1?b[a+1]:b[0]};
Morph.prototype.previousEntryField=function(a){var b=this.allEntryFields(),a=b.indexOf(a);if(-1!==a)return a-1>b.length?b[a-1]:b[b.length+1]};Morph.prototype.tab=function(a){this.nextTab?this.nextTab(a):this.parent&&this.parent.tab(a)};Morph.prototype.backTab=function(a){this.previousTab?this.previousTab(a):this.parent&&this.parent.backTab(a)};Morph.prototype.escalateEvent=function(a,b){for(var c=this.parent;!c[a]&&null!==c.parent;)c=c.parent;c[a]&&c[a].call(c,b)};
Morph.prototype.evaluateString=function(a){var b;try{b=eval(a),this.drawNew(),this.changed()}catch(c){this.inform(c)}return b};Morph.prototype.isTouching=function(a){a=this.overlappingImage(a);a=a.getContext("2d").getImageData(1,1,a.width,a.height).data;return null!==detect(a,function(a){return 0!==a})};
Morph.prototype.overlappingImage=function(a){var b=this.fullBounds(),c=a.fullBounds(),d=b.intersect(c),e=newCanvas(d.extent()),f=e.getContext("2d");if(1>d.width()||1>d.height())return newCanvas(new Point(1,1));f.drawImage(this.fullImage(),d.origin.x-b.origin.x,d.origin.y-b.origin.y);f.globalCompositeOperation="source-in";f.drawImage(a.fullImage(),c.origin.x-d.origin.x,c.origin.y-d.origin.y);return e};ShadowMorph.prototype=new Morph;ShadowMorph.prototype.constructor=ShadowMorph;ShadowMorph.uber=Morph.prototype;
function ShadowMorph(){this.init()}HandleMorph.prototype=new Morph;HandleMorph.prototype.constructor=HandleMorph;HandleMorph.uber=Morph.prototype;function HandleMorph(a,b,c,d,e,f){this.init(a,b,c,d,e,f)}
HandleMorph.prototype.init=function(a,b,c,d,e,f){var g=MorphicPreferences.handleSize;this.target=a||null;this.minExtent=new Point(b||0,c||0);this.inset=new Point(d||0,e||d||0);this.type=f||"resize";HandleMorph.uber.init.call(this);this.color=new Color(255,255,255);this.isDraggable=!1;this.noticesTransparentClick=!0;this.setExtent(new Point(g,g))};
HandleMorph.prototype.drawNew=function(){this.normalImage=newCanvas(this.extent());this.highlightImage=newCanvas(this.extent());this.drawOnCanvas(this.normalImage,this.color,new Color(100,100,100));this.drawOnCanvas(this.highlightImage,new Color(100,100,255),new Color(255,255,255));this.image=this.normalImage;this.target&&(this.setPosition(this.target.bottomRight().subtract(this.extent().add(this.inset))),this.target.add(this),this.target.changed())};
HandleMorph.prototype.drawOnCanvas=function(a,b,c){var a=a.getContext("2d"),d,e,f,g;a.lineWidth=1;a.lineCap="round";a.strokeStyle=b.toString();if("move"===this.type){b=this.bottomLeft().subtract(this.position());d=b.copy();e=this.topRight().subtract(this.position());f=e.copy();for(g=0;g<=this.height();g+=6)d.y=b.y-g,f.y=e.y-g,a.beginPath(),a.moveTo(d.x,d.y),a.lineTo(f.x,f.y),a.closePath(),a.stroke()}b=this.bottomLeft().subtract(this.position());d=b.copy();e=this.topRight().subtract(this.position());
f=e.copy();for(g=0;g<=this.width();g+=6)d.x=b.x+g,f.x=e.x+g,a.beginPath(),a.moveTo(d.x,d.y),a.lineTo(f.x,f.y),a.closePath(),a.stroke();a.strokeStyle=c.toString();if("move"===this.type){b=this.bottomLeft().subtract(this.position());d=b.copy();e=this.topRight().subtract(this.position());f=e.copy();for(g=-2;g<=this.height();g+=6)d.y=b.y-g,f.y=e.y-g,a.beginPath(),a.moveTo(d.x,d.y),a.lineTo(f.x,f.y),a.closePath(),a.stroke()}b=this.bottomLeft().subtract(this.position());d=b.copy();e=this.topRight().subtract(this.position());
f=e.copy();for(g=2;g<=this.width();g+=6)d.x=b.x+g,f.x=e.x+g,a.beginPath(),a.moveTo(d.x,d.y),a.lineTo(f.x,f.y),a.closePath(),a.stroke()};HandleMorph.prototype.step=null;
HandleMorph.prototype.mouseDownLeft=function(a){var b=this.root(),c=a.subtract(this.bounds.origin),d=this;if(!this.target)return null;this.step=function(){var a;b.hand.mouseButton?(a=b.hand.bounds.origin.copy().subtract(c),"resize"===this.type?(a=a.add(d.extent().add(d.inset)).subtract(d.target.bounds.origin),a=a.max(d.minExtent),d.target.setExtent(a),d.setPosition(d.target.bottomRight().subtract(d.extent().add(d.inset)))):d.target.setPosition(a.subtract(this.target.extent()).add(this.extent()))):
this.step=null};this.target.step||(this.target.step=function(){nop()})};HandleMorph.prototype.rootForGrab=function(){return this};HandleMorph.prototype.mouseEnter=function(){this.image=this.highlightImage;this.changed()};HandleMorph.prototype.mouseLeave=function(){this.image=this.normalImage;this.changed()};HandleMorph.prototype.copyRecordingReferences=function(a){var b=HandleMorph.uber.copyRecordingReferences.call(this,a);b.target&&a[this.target]&&(b.target=a[this.target]);return b};
HandleMorph.prototype.attach=function(){var a=this.overlappedMorphs(),b=new MenuMorph(this,"choose target:"),c=this;a.forEach(function(a){b.addItem(a.toString().slice(0,50),function(){c.isDraggable=!1;c.target=a;c.drawNew();c.noticesTransparentClick=!0})});0<a.length&&b.popUpAtHand(this.world())};PenMorph.prototype=new Morph;PenMorph.prototype.constructor=PenMorph;PenMorph.uber=Morph.prototype;function PenMorph(){this.init()}
PenMorph.prototype.init=function(){var a=4*MorphicPreferences.handleSize;this.wantsRedraw=this.isWarped=!1;this.heading=0;this.isDown=!0;this.size=1;HandleMorph.uber.init.call(this);this.setExtent(new Point(a,a))};PenMorph.prototype.changed=function(){if(!1===this.isWarped){var a=this.root();a instanceof WorldMorph&&a.broken.push(this.visibleBounds().spread());this.parent&&this.parent.childChanged(this)}};
PenMorph.prototype.drawNew=function(){var a,b,c,d,e;if(this.isWarped)return this.wantsRedraw=!0,null;this.image=newCanvas(this.extent());a=this.image.getContext("2d");e=this.width()/2;b=this.center().subtract(this.bounds.origin);c=b.distanceAngle(0.75*e,this.heading-180);d=b.distanceAngle(e,this.heading+195);e=b.distanceAngle(e,this.heading-195);a.fillStyle=this.color.toString();a.beginPath();a.moveTo(b.x,b.y);a.lineTo(d.x,d.y);a.lineTo(c.x,c.y);a.lineTo(e.x,e.y);a.closePath();a.strokeStyle="white";
a.lineWidth=3;a.stroke();a.strokeStyle="black";a.lineWidth=1;a.stroke();a.fill();this.wantsRedraw=!1};PenMorph.prototype.setHeading=function(a){this.heading=parseFloat(a)%360;!1===this.isWarped&&(this.drawNew(),this.changed())};
PenMorph.prototype.drawLine=function(a,b){var c=this.parent.penTrails().getContext("2d"),d=a.subtract(this.parent.bounds.origin),e=b.subtract(this.parent.bounds.origin);this.isDown&&(c.lineWidth=this.size,c.strokeStyle=this.color.toString(),c.lineCap="round",c.lineJoin="round",c.beginPath(),c.moveTo(d.x,d.y),c.lineTo(e.x,e.y),c.stroke(),!1===this.isWarped&&this.world().broken.push(a.rectangle(b).expandBy(Math.max(this.size/2,1)).intersect(this.parent.visibleBounds()).spread()))};
PenMorph.prototype.turn=function(a){this.setHeading(this.heading+parseFloat(a))};PenMorph.prototype.forward=function(a){var b=this.center(),a=parseFloat(a);this.setPosition(0<=a?this.position().distanceAngle(a,this.heading):this.position().distanceAngle(Math.abs(a),this.heading-180));this.drawLine(b,this.center())};PenMorph.prototype.down=function(){this.isDown=!0};PenMorph.prototype.up=function(){this.isDown=!1};PenMorph.prototype.clear=function(){this.parent.drawNew();this.parent.changed()};
PenMorph.prototype.startWarp=function(){this.isWarped=!0};PenMorph.prototype.endWarp=function(){this.wantsRedraw&&this.drawNew();this.changed();this.parent.changed();this.isWarped=!1};PenMorph.prototype.warp=function(a){this.startWarp();a.call(this);this.endWarp()};PenMorph.prototype.warpOp=function(a,b){this.startWarp();this[a].apply(this,b);this.endWarp()};PenMorph.prototype.warpSierpinski=function(a,b){this.warpOp("sierpinski",[a,b])};
PenMorph.prototype.sierpinski=function(a,b){var c;if(a>b)for(c=0;3>c;c+=1)this.sierpinski(0.5*a,b),this.turn(120),this.forward(a)};PenMorph.prototype.warpTree=function(a,b,c){this.warpOp("tree",[a,b,c])};PenMorph.prototype.tree=function(a,b,c){0<a&&(this.size=a,this.forward(b),this.turn(c),this.tree(a-1,0.75*b,c),this.turn(-2*c),this.tree(a-1,0.75*b,c),this.turn(c),this.forward(-b))};ColorPaletteMorph.prototype=new Morph;ColorPaletteMorph.prototype.constructor=ColorPaletteMorph;
ColorPaletteMorph.uber=Morph.prototype;function ColorPaletteMorph(a,b){this.init(a||null,b||new Point(80,50))}ColorPaletteMorph.prototype.init=function(a,b){ColorPaletteMorph.uber.init.call(this);this.target=a;this.targetSetter="color";this.silentSetExtent(b);this.choice=null;this.drawNew()};
ColorPaletteMorph.prototype.drawNew=function(){var a,b,c,d,e,f;b=this.extent();this.image=newCanvas(this.extent());a=this.image.getContext("2d");this.choice=new Color;for(c=0;c<=b.x;c+=1){e=360*c/b.x;for(d=0;d<=b.y;d+=1)f=100-100*(d/b.y),a.fillStyle="hsl("+e+",100%,"+f+"%)",a.fillRect(c,d,1,1)}};ColorPaletteMorph.prototype.mouseMove=function(a){this.choice=this.getPixelColor(a);this.updateTarget()};ColorPaletteMorph.prototype.mouseDownLeft=function(a){this.choice=this.getPixelColor(a);this.updateTarget()};
ColorPaletteMorph.prototype.updateTarget=function(){this.target instanceof Morph&&null!==this.choice&&(this.target[this.targetSetter]instanceof Function?this.target[this.targetSetter].call(this.target,this.choice):(this.target[this.targetSetter]=this.choice,this.target.drawNew(),this.target.changed()))};ColorPaletteMorph.prototype.copyRecordingReferences=function(a){var b=ColorPaletteMorph.uber.copyRecordingReferences.call(this,a);b.target&&a[this.target]&&(b.target=a[this.target]);return b};
ColorPaletteMorph.prototype.developersMenu=function(){var a=ColorPaletteMorph.uber.developersMenu.call(this);a.addLine();a.addItem("set target","setTarget","choose another morph\nwhose color property\n will be controlled by this one");return a};
ColorPaletteMorph.prototype.setTarget=function(){var a=this.overlappedMorphs(),b=new MenuMorph(this,"choose target:"),c=this;a.push(this.world());a.forEach(function(a){b.addItem(a.toString().slice(0,50),function(){c.target=a;c.setTargetSetter()})});1===a.length?(this.target=a[0],this.setTargetSetter()):0<a.length&&b.popUpAtHand(this.world())};
ColorPaletteMorph.prototype.setTargetSetter=function(){var a=this.target.colorSetters(),b=new MenuMorph(this,"choose target property:"),c=this;a.forEach(function(a){b.addItem(a,function(){c.targetSetter=a})});1===a.length?this.targetSetter=a[0]:0<a.length&&b.popUpAtHand(this.world())};GrayPaletteMorph.prototype=new ColorPaletteMorph;GrayPaletteMorph.prototype.constructor=GrayPaletteMorph;GrayPaletteMorph.uber=ColorPaletteMorph.prototype;
function GrayPaletteMorph(a,b){this.init(a||null,b||new Point(80,10))}GrayPaletteMorph.prototype.drawNew=function(){var a,b,c;b=this.extent();this.image=newCanvas(this.extent());a=this.image.getContext("2d");this.choice=new Color;c=a.createLinearGradient(0,0,b.x,b.y);c.addColorStop(0,"black");c.addColorStop(1,"white");a.fillStyle=c;a.fillRect(0,0,b.x,b.y)};ColorPickerMorph.prototype=new Morph;ColorPickerMorph.prototype.constructor=ColorPickerMorph;ColorPickerMorph.uber=Morph.prototype;
function ColorPickerMorph(a){this.init(a||new Color(255,255,255))}ColorPickerMorph.prototype.init=function(a){this.choice=a;ColorPickerMorph.uber.init.call(this);this.color=new Color(255,255,255);this.silentSetExtent(new Point(80,80));this.drawNew()};ColorPickerMorph.prototype.drawNew=function(){ColorPickerMorph.uber.drawNew.call(this);this.buildSubmorphs()};
ColorPickerMorph.prototype.buildSubmorphs=function(){var a,b;this.children.forEach(function(a){a.destroy()});this.children=[];this.feedback=new Morph;this.feedback.color=this.choice;this.feedback.setExtent(new Point(20,20));a=new ColorPaletteMorph(this.feedback,new Point(this.width(),50));b=new GrayPaletteMorph(this.feedback,new Point(this.width(),5));a.setPosition(this.bounds.origin);this.add(a);b.setPosition(a.bottomLeft());this.add(b);a=b.left()+Math.floor((b.width()-this.feedback.width())/2);
b=b.bottom()+Math.floor((this.bottom()-b.bottom()-this.feedback.height())/2);this.feedback.setPosition(new Point(a,b));this.add(this.feedback)};ColorPickerMorph.prototype.getChoice=function(){return this.feedback.color};ColorPickerMorph.prototype.rootForGrab=function(){return this};BlinkerMorph.prototype=new Morph;BlinkerMorph.prototype.constructor=BlinkerMorph;BlinkerMorph.uber=Morph.prototype;function BlinkerMorph(a){this.init(a)}
BlinkerMorph.prototype.init=function(a){BlinkerMorph.uber.init.call(this);this.color=new Color(0,0,0);this.fps=a||2;this.drawNew()};BlinkerMorph.prototype.step=function(){this.toggleVisibility()};CursorMorph.prototype=new BlinkerMorph;CursorMorph.prototype.constructor=CursorMorph;CursorMorph.uber=BlinkerMorph.prototype;function CursorMorph(a){this.init(a)}
CursorMorph.prototype.init=function(a){this.keyDownEventUsed=!1;this.target=a;this.originalContents=this.target.text;this.slot=this.target.text.length;CursorMorph.uber.init.call(this);a=fontHeight(this.target.fontSize);this.setExtent(new Point(Math.max(Math.floor(a/20),1),a));this.drawNew();this.image.getContext("2d").font=this.target.font();this.gotoSlot(this.slot)};
CursorMorph.prototype.processKeyPress=function(a){if(this.keyDownEventUsed)return this.keyDownEventUsed=!1,null;if(40===a.keyCode||40===a.charCode)return this.insert("("),null;if(37===a.keyCode||37===a.charCode)return this.insert("%"),null;var b=[8,13,18,27,35,36,37,38,39,40,46];a.keyCode?contains(b,a.keyCode)||(a.ctrlKey?this.ctrl(a.keyCode):this.insert(String.fromCharCode(a.keyCode))):a.charCode&&(contains(b,a.charCode)||(a.ctrlKey?this.ctrl(a.charCode):this.insert(String.fromCharCode(a.charCode))))};
CursorMorph.prototype.processKeyDown=function(a){this.keyDownEventUsed=!1;if(a.ctrlKey)return this.ctrl(a.keyCode);switch(a.keyCode){case 37:this.goLeft();this.keyDownEventUsed=!0;break;case 39:this.goRight();this.keyDownEventUsed=!0;break;case 38:this.goUp();this.keyDownEventUsed=!0;break;case 40:this.goDown();this.keyDownEventUsed=!0;break;case 36:this.goHome();this.keyDownEventUsed=!0;break;case 35:this.goEnd();this.keyDownEventUsed=!0;break;case 46:this.deleteRight();this.keyDownEventUsed=!0;
break;case 8:this.deleteLeft();this.keyDownEventUsed=!0;break;case 13:this.target instanceof StringMorph?this.accept():this.insert("\n");this.keyDownEventUsed=!0;break;case 27:this.cancel();this.keyDownEventUsed=!0;break;case 190:this.insert(".");this.keyDownEventUsed=!0;break;case 191:this.insert("?");this.keyDownEventUsed=!0;break;case 222:this.insert("'"),this.keyDownEventUsed=!0}};CursorMorph.prototype.gotoSlot=function(a){this.setPosition(this.target.slotPosition(a));this.slot=Math.max(a,0)};
CursorMorph.prototype.goLeft=function(){this.target.clearSelection();this.gotoSlot(this.slot-1)};CursorMorph.prototype.goRight=function(){this.target.clearSelection();this.gotoSlot(this.slot+1)};CursorMorph.prototype.goUp=function(){this.target.clearSelection();this.gotoSlot(this.target.upFrom(this.slot))};CursorMorph.prototype.goDown=function(){this.target.clearSelection();this.gotoSlot(this.target.downFrom(this.slot))};CursorMorph.prototype.goHome=function(){this.target.clearSelection();this.gotoSlot(this.target.startOfLine(this.slot))};
CursorMorph.prototype.goEnd=function(){this.target.clearSelection();this.gotoSlot(this.target.endOfLine(this.slot))};CursorMorph.prototype.gotoPos=function(a){this.gotoSlot(this.target.slotAt(a));this.show()};CursorMorph.prototype.accept=function(){var a=this.root();a&&a.stopEditing();this.escalateEvent("accept",null)};
CursorMorph.prototype.cancel=function(){var a=this.root();a&&a.stopEditing();this.target.text=this.originalContents;this.target.changed();this.target.drawNew();this.target.changed();this.escalateEvent("cancel",null)};
CursorMorph.prototype.insert=function(a){var b;if("\t"===a)return this.target.tab(this.target);if(!this.target.isNumeric||!isNaN(parseFloat(a))||contains(["-","."],a))""!==this.target.selection()&&(this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection()),b=this.target.text,b=b.slice(0,this.slot)+a+b.slice(this.slot),this.target.text=b,this.target.drawNew(),this.target.changed(),this.goRight()};
CursorMorph.prototype.ctrl=function(a){if(97===a||65===a)return this.target.selectAll(),null;if(123===a)return this.insert("{"),null;if(125===a)return this.insert("}"),null;if(91===a)return this.insert("["),null;if(93===a)return this.insert("]"),null};
CursorMorph.prototype.deleteRight=function(){var a;""!==this.target.selection()?(this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection()):(a=this.target.text,this.target.changed(),a=a.slice(0,this.slot)+a.slice(this.slot+1),this.target.text=a,this.target.drawNew())};
CursorMorph.prototype.deleteLeft=function(){var a;""!==this.target.selection()&&(this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection());a=this.target.text;this.target.changed();a=a.slice(0,Math.max(this.slot-1,0))+a.slice(this.slot);this.target.text=a;this.target.drawNew();this.goLeft()};
CursorMorph.prototype.inspectKeyEvent=function(a){this.inform("Key pressed: "+String.fromCharCode(a.charCode)+"\n------------------------\ncharCode: "+a.charCode.toString()+"\nkeyCode: "+a.keyCode.toString()+"\naltKey: "+a.altKey.toString()+"\nctrlKey: "+a.ctrlKey.toString())};BoxMorph.prototype=new Morph;BoxMorph.prototype.constructor=BoxMorph;BoxMorph.uber=Morph.prototype;function BoxMorph(a,b,c){this.init(a,b,c)}
BoxMorph.prototype.init=function(a,b,c){this.edge=a||4;this.border=b||(0===b?0:2);this.borderColor=c||new Color;BoxMorph.uber.init.call(this)};
BoxMorph.prototype.drawNew=function(){var a;this.image=newCanvas(this.extent());a=this.image.getContext("2d");if(0===this.edge&&0===this.border)return BoxMorph.uber.drawNew.call(this),null;a.fillStyle=this.color.toString();a.beginPath();this.outlinePath(a,Math.max(this.edge-this.border,0),this.border);a.closePath();a.fill();0<this.border&&(a.lineWidth=this.border,a.strokeStyle=this.borderColor.toString(),a.beginPath(),this.outlinePath(a,this.edge,this.border/2),a.closePath(),a.stroke())};
BoxMorph.prototype.outlinePath=function(a,b,c){var c=b+c,d=this.width(),e=this.height();a.arc(c,c,b,radians(-180),radians(-90),!1);a.arc(d-c,c,b,radians(-90),radians(-0.0),!1);a.arc(d-c,e-c,b,radians(0),radians(90),!1);a.arc(c,e-c,b,radians(90),radians(180),!1)};
BoxMorph.prototype.developersMenu=function(){var a=BoxMorph.uber.developersMenu.call(this);a.addLine();a.addItem("border width...",function(){this.prompt(a.title+"\nborder\nwidth:",this.setBorderWidth,this,this.border.toString(),null,0,100,!0)},"set the border's\nline size");a.addItem("border color...",function(){this.pickColor(a.title+"\nborder color:",this.setBorderColor,this,this.borderColor)},"set the border's\nline color");a.addItem("corner size...",function(){this.prompt(a.title+"\ncorner\nsize:",
this.setCornerSize,this,this.edge.toString(),null,0,100,!0)},"set the corner's\nradius");return a};BoxMorph.prototype.setBorderWidth=function(a){"number"===typeof a?this.border=Math.max(a,0):(a=parseFloat(a),isNaN(a)||(this.border=Math.max(a,0)));this.drawNew();this.changed()};BoxMorph.prototype.setBorderColor=function(a){a&&(this.borderColor=a,this.drawNew(),this.changed())};
BoxMorph.prototype.setCornerSize=function(a){"number"===typeof a?this.edge=Math.max(a,0):(a=parseFloat(a),isNaN(a)||(this.edge=Math.max(a,0)));this.drawNew();this.changed()};BoxMorph.prototype.colorSetters=function(){return["color","borderColor"]};BoxMorph.prototype.numericalSetters=function(){var a=BoxMorph.uber.numericalSetters.call(this);a.push("setBorderWidth","setCornerSize");return a};SpeechBubbleMorph.prototype=new BoxMorph;SpeechBubbleMorph.prototype.constructor=SpeechBubbleMorph;
SpeechBubbleMorph.uber=BoxMorph.prototype;function SpeechBubbleMorph(a,b,c,d,e,f,g){this.init(a,b,c,d,e,f,g)}SpeechBubbleMorph.prototype.init=function(a,b,c,d,e,f,g){this.isPointingRight=!0;this.contents=a||"";this.padding=f||0;this.isThought=g||!1;SpeechBubbleMorph.uber.init.call(this,c||6,d||(0===d?0:1),e||new Color(140,140,140));this.color=b||new Color(230,230,230);this.drawNew()};
SpeechBubbleMorph.prototype.popUp=function(a,b){this.drawNew();this.setPosition(b.subtract(new Point(0,this.height())));this.addShadow(new Point(2,2),80);this.keepWithin(a);a.add(this);this.changed();a.hand.destroyTemporaries();a.hand.temporaries.push(this);this.mouseEnter=function(){this.destroy()}};
SpeechBubbleMorph.prototype.drawNew=function(){this.contentsMorph&&this.contentsMorph.destroy();this.contents instanceof Morph?this.contentsMorph=this.contents:isString(this.contents)?this.contentsMorph=new TextMorph(this.contents,MorphicPreferences.bubbleHelpFontSize,null,!1,!0,"center"):this.contents instanceof HTMLCanvasElement?(this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(this.contents.width),this.contentsMorph.silentSetHeight(this.contents.height),this.contentsMorph.image=this.contents):
this.contentsMorph=new TextMorph(this.contents.toString(),MorphicPreferences.bubbleHelpFontSize,null,!1,!0,"center");this.add(this.contentsMorph);this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge));this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2);SpeechBubbleMorph.uber.drawNew.call(this);this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1)))};
SpeechBubbleMorph.prototype.outlinePath=function(a,b,c){function d(b,c,d){a.moveTo(b+d,c);a.arc(b,c,d,radians(0),radians(360))}var e=b+c,f=this.width(),g=this.height();a.arc(e,e,b,radians(-180),radians(-90),!1);a.arc(f-e,e,b,radians(-90),radians(-0.0),!1);a.arc(f-e,g-e-b,b,radians(0),radians(90),!1);this.isThought||(this.isPointingRight?(a.lineTo(e+b,g-e),a.lineTo(b/2+c,g-c)):(a.lineTo(f-(b/2+c),g-c),a.lineTo(f-(e+b),g-e)));a.arc(e,g-e-b,b,radians(90),radians(180),!1);this.isThought&&(a.lineTo(c,
e),this.isPointingRight?(e=b/4,d(e+c,g-e-c,e),e=b/3.2,d(2*e+c,g-e-2*c,e),e=b/2.8,d(3*e+2*c,g-e-4*c,e)):(e=b/4,d(f-(e+c),g-e-c,e),e=b/3.2,d(f-(2*e+c),g-e-2*c,e),e=b/2.8,d(f-(3*e+2*c),g-e-4*c,e)))};CircleBoxMorph.prototype=new Morph;CircleBoxMorph.prototype.constructor=CircleBoxMorph;CircleBoxMorph.uber=Morph.prototype;function CircleBoxMorph(a){this.init(a||"vertical")}
CircleBoxMorph.prototype.init=function(a){CircleBoxMorph.uber.init.call(this);this.orientation=a;this.autoOrient=!0;this.setExtent(new Point(20,100))};CircleBoxMorph.prototype.autoOrientation=function(){this.orientation=this.height()>this.width()?"vertical":"horizontal"};
CircleBoxMorph.prototype.drawNew=function(){var a,b,c,d,e,f=this;this.autoOrient&&this.autoOrientation();this.image=newCanvas(this.extent());e=this.image.getContext("2d");"vertical"===this.orientation?(a=this.width()/2,d=this.center().x,b=new Point(d,this.top()+a),c=new Point(d,this.bottom()-a),d=this.bounds.origin.add(new Point(0,a)).corner(this.bounds.corner.subtract(new Point(0,a)))):(a=this.height()/2,d=this.center().y,b=new Point(this.left()+a,d),c=new Point(this.right()-a,d),d=this.bounds.origin.add(new Point(a,
0)).corner(this.bounds.corner.subtract(new Point(a,0))));[b.subtract(this.bounds.origin),c.subtract(this.bounds.origin)].forEach(function(b){e.fillStyle=f.color.toString();e.beginPath();e.arc(b.x,b.y,a,0,2*Math.PI,false);e.closePath();e.fill()});d=d.translateBy(this.bounds.origin.neg());b=d.extent();0<b.x&&0<b.y&&e.fillRect(d.origin.x,d.origin.y,d.width(),d.height())};
CircleBoxMorph.prototype.developersMenu=function(){var a=CircleBoxMorph.uber.developersMenu.call(this);a.addLine();"vertical"===this.orientation?a.addItem("horizontal...","toggleOrientation","toggle the\norientation"):a.addItem("vertical...","toggleOrientation","toggle the\norientation");return a};
CircleBoxMorph.prototype.toggleOrientation=function(){var a=this.center();this.changed();this.orientation="vertical"===this.orientation?"horizontal":"vertical";this.silentSetExtent(new Point(this.height(),this.width()));this.setCenter(a);this.drawNew();this.changed()};SliderButtonMorph.prototype=new CircleBoxMorph;SliderButtonMorph.prototype.constructor=SliderButtonMorph;SliderButtonMorph.uber=CircleBoxMorph.prototype;function SliderButtonMorph(a){this.init(a)}
SliderButtonMorph.prototype.init=function(a){this.color=new Color(80,80,80);this.highlightColor=new Color(90,90,140);this.pressColor=new Color(80,80,160);this.hasMiddleDip=this.is3D=!0;SliderButtonMorph.uber.init.call(this,a)};SliderButtonMorph.prototype.autoOrientation=function(){nop()};
SliderButtonMorph.prototype.drawNew=function(){var a=this.color.copy();SliderButtonMorph.uber.drawNew.call(this);this.is3D&&this.drawEdges();this.normalImage=this.image;this.color=this.highlightColor.copy();SliderButtonMorph.uber.drawNew.call(this);this.is3D&&this.drawEdges();this.highlightImage=this.image;this.color=this.pressColor.copy();SliderButtonMorph.uber.drawNew.call(this);this.is3D&&this.drawEdges();this.pressImage=this.image;this.color=a;this.image=this.normalImage};
SliderButtonMorph.prototype.drawEdges=function(){var a=this.image.getContext("2d"),b,c,d=this.width(),e=this.height();a.lineJoin="round";a.lineCap="round";"vertical"===this.orientation?(a.lineWidth=d/3,b=a.createLinearGradient(0,0,a.lineWidth,0),b.addColorStop(0,"white"),b.addColorStop(1,this.color.toString()),a.strokeStyle=b,a.beginPath(),a.moveTo(0.5*a.lineWidth,d/2),a.lineTo(0.5*a.lineWidth,e-d/2),a.stroke(),b=a.createLinearGradient(d-a.lineWidth,0,d,0),b.addColorStop(0,this.color.toString()),
b.addColorStop(1,"black"),a.strokeStyle=b,a.beginPath(),a.moveTo(d-0.5*a.lineWidth,d/2),a.lineTo(d-0.5*a.lineWidth,e-d/2),a.stroke(),this.hasMiddleDip&&(b=a.createLinearGradient(a.lineWidth,0,d-a.lineWidth,0),c=d/4,b.addColorStop(0,"black"),b.addColorStop(0.35,this.color.toString()),b.addColorStop(0.65,this.color.toString()),b.addColorStop(1,"white"),a.fillStyle=b,a.beginPath(),a.arc(d/2,e/2,c,radians(0),radians(360),!1),a.closePath(),a.fill())):"horizontal"===this.orientation&&(a.lineWidth=e/3,b=
a.createLinearGradient(0,0,0,a.lineWidth),b.addColorStop(0,"white"),b.addColorStop(1,this.color.toString()),a.strokeStyle=b,a.beginPath(),a.moveTo(e/2,0.5*a.lineWidth),a.lineTo(d-e/2,0.5*a.lineWidth),a.stroke(),b=a.createLinearGradient(0,e-a.lineWidth,0,e),b.addColorStop(0,this.color.toString()),b.addColorStop(1,"black"),a.strokeStyle=b,a.beginPath(),a.moveTo(e/2,e-0.5*a.lineWidth),a.lineTo(d-e/2,e-0.5*a.lineWidth),a.stroke(),this.hasMiddleDip&&(b=a.createLinearGradient(0,a.lineWidth,0,e-a.lineWidth),
c=e/4,b.addColorStop(0,"black"),b.addColorStop(0.35,this.color.toString()),b.addColorStop(0.65,this.color.toString()),b.addColorStop(1,"white"),a.fillStyle=b,a.beginPath(),a.arc(this.width()/2,this.height()/2,c,radians(0),radians(360),!1),a.closePath(),a.fill()))};SliderButtonMorph.prototype.mouseEnter=function(){this.image=this.highlightImage;this.changed()};SliderButtonMorph.prototype.mouseLeave=function(){this.image=this.normalImage;this.changed()};
SliderButtonMorph.prototype.mouseDownLeft=function(a){this.image=this.pressImage;this.changed();this.escalateEvent("mouseDownLeft",a)};SliderButtonMorph.prototype.mouseClickLeft=function(){this.image=this.highlightImage;this.changed()};SliderButtonMorph.prototype.mouseMove=function(){nop()};SliderMorph.prototype=new CircleBoxMorph;SliderMorph.prototype.constructor=SliderMorph;SliderMorph.uber=CircleBoxMorph.prototype;
function SliderMorph(a,b,c,d,e,f){this.init(a||1,b||100,c||50,d||10,e||"vertical",f)}
SliderMorph.prototype.init=function(a,b,c,d,e,f){this.action=this.target=null;this.start=a;this.stop=b;this.value=c;this.size=d;this.offset=null;this.button=new SliderButtonMorph;this.button.isDraggable=!1;this.button.color=new Color(200,200,200);this.button.highlightColor=new Color(210,210,255);this.button.pressColor=new Color(180,180,255);SliderMorph.uber.init.call(this,e);this.add(this.button);this.alpha=0.3;this.color=f||new Color(0,0,0);this.setExtent(new Point(20,100))};
SliderMorph.prototype.autoOrientation=function(){nop()};SliderMorph.prototype.rangeSize=function(){return this.stop-this.start};SliderMorph.prototype.ratio=function(){return this.size/this.rangeSize()};SliderMorph.prototype.unitSize=function(){return"vertical"===this.orientation?(this.height()-this.button.height())/this.rangeSize():(this.width()-this.button.width())/this.rangeSize()};
SliderMorph.prototype.drawNew=function(){var a,b;SliderMorph.uber.drawNew.call(this);this.button.orientation=this.orientation;"vertical"===this.orientation?(a=this.width()-2,b=Math.max(a,Math.round(this.height()*this.ratio())),this.button.silentSetExtent(new Point(a,b)),a=1,b=Math.min(Math.round((this.value-this.start)*this.unitSize()),this.height()-this.button.height())):(b=this.height()-2,a=Math.max(b,Math.round(this.width()*this.ratio())),this.button.silentSetExtent(new Point(a,b)),b=1,a=Math.min(Math.round((this.value-
this.start)*this.unitSize()),this.width()-this.button.width()));this.button.setPosition((new Point(a,b)).add(this.bounds.origin));this.button.drawNew();this.button.changed()};SliderMorph.prototype.updateValue=function(){var a;a="vertical"===this.orientation?this.button.top()-this.top():this.button.left()-this.left();this.value=Math.round(a/this.unitSize()+this.start);this.updateTarget()};
SliderMorph.prototype.updateTarget=function(){this.action&&("function"===typeof this.action?this.action.call(this.target,this.value):this.target[this.action].call(this.target,this.value))};SliderMorph.prototype.copyRecordingReferences=function(a){var b=SliderMorph.uber.copyRecordingReferences.call(this,a);b.target&&a[this.target]&&(b.target=a[this.target]);b.button&&a[this.button]&&(b.button=a[this.button]);return b};
SliderMorph.prototype.developersMenu=function(){var a=SliderMorph.uber.developersMenu.call(this);a.addItem("show value...","showValue","display a dialog box\nshowing the selected number");a.addItem("floor...",function(){this.prompt(a.title+"\nfloor:",this.setStart,this,this.start.toString(),null,0,this.stop-this.size,!0)},"set the minimum value\nwhich can be selected");a.addItem("ceiling...",function(){this.prompt(a.title+"\nceiling:",this.setStop,this,this.stop.toString(),null,this.start+this.size,
100*this.size,!0)},"set the maximum value\nwhich can be selected");a.addItem("button size...",function(){this.prompt(a.title+"\nbutton size:",this.setSize,this,this.size.toString(),null,1,this.stop-this.start,!0)},"set the range\ncovered by\nthe slider button");a.addLine();a.addItem("set target","setTarget","select another morph\nwhose numerical property\nwill be controlled by this one");return a};SliderMorph.prototype.showValue=function(){this.inform(this.value)};
SliderMorph.prototype.userSetStart=function(a){this.start=Math.max(a,this.stop)};SliderMorph.prototype.setStart=function(a){"number"===typeof a?this.start=Math.min(Math.max(a,0),this.stop-this.size):(a=parseFloat(a),isNaN(a)||(this.start=Math.min(Math.max(a,0),this.stop-this.size)));this.value=Math.max(this.value,this.start);this.updateTarget();this.drawNew();this.changed()};
SliderMorph.prototype.setStop=function(a){"number"===typeof a?this.stop=Math.max(a,this.start+this.size):(a=parseFloat(a),isNaN(a)||(this.stop=Math.max(a,this.start+this.size)));this.value=Math.min(this.value,this.stop);this.updateTarget();this.drawNew();this.changed()};
SliderMorph.prototype.setSize=function(a){"number"===typeof a?this.size=Math.min(Math.max(a,1),this.stop-this.start):(a=parseFloat(a),isNaN(a)||(this.size=Math.min(Math.max(a,1),this.stop-this.start)));this.value=Math.min(this.value,this.stop-this.size);this.updateTarget();this.drawNew();this.changed()};
SliderMorph.prototype.setTarget=function(){var a=this.overlappedMorphs(),b=new MenuMorph(this,"choose target:"),c=this;a.push(this.world());a.forEach(function(a){b.addItem(a.toString().slice(0,50),function(){c.target=a;c.setTargetSetter()})});1===a.length?(this.target=a[0],this.setTargetSetter()):0<a.length&&b.popUpAtHand(this.world())};
SliderMorph.prototype.setTargetSetter=function(){var a=this.target.numericalSetters(),b=new MenuMorph(this,"choose target property:"),c=this;a.forEach(function(a){b.addItem(a,function(){c.action=a})});1===a.length?this.action=a[0]:0<a.length&&b.popUpAtHand(this.world())};SliderMorph.prototype.numericalSetters=function(){var a=SliderMorph.uber.numericalSetters.call(this);a.push("setStart","setStop","setSize");return a};SliderMorph.prototype.step=null;
SliderMorph.prototype.mouseDownLeft=function(a){var b,c=this;this.offset=this.button.bounds.containsPoint(a)?a.subtract(this.button.bounds.origin):new Point;b=this.root();this.step=function(){var a,e,f;b.hand.mouseButton?(a=b.hand.bounds.origin,"vertical"===c.orientation?(e=c.button.bounds.origin.x,f=Math.max(Math.min(a.y-c.offset.y,c.bottom()-c.button.height()),c.top())):(f=c.button.bounds.origin.y,e=Math.max(Math.min(a.x-c.offset.x,c.right()-c.button.width()),c.left())),c.button.setPosition(new Point(e,
f)),c.updateValue()):this.step=null}};MouseSensorMorph.prototype=new BoxMorph;MouseSensorMorph.prototype.constructor=MouseSensorMorph;MouseSensorMorph.uber=BoxMorph.prototype;function MouseSensorMorph(a,b,c){this.init(a,b,c)}MouseSensorMorph.prototype.init=function(a,b,c){MouseSensorMorph.uber.init.call(this);this.edge=a||4;this.border=b||2;this.color=new Color(255,255,255);this.borderColor=c||new Color;this.isTouched=!1;this.upStep=0.05;this.downStep=0.02;this.noticesTransparentClick=!1;this.drawNew()};
MouseSensorMorph.prototype.touch=function(){var a=this;this.isTouched||(this.isTouched=!0,this.alpha=0.6,this.step=function(){a.isTouched?1>a.alpha&&(a.alpha+=a.upStep):a.alpha>a.downStep?a.alpha-=a.downStep:(a.alpha=0,a.step=null);a.changed()})};MouseSensorMorph.prototype.unTouch=function(){this.isTouched=!1};MouseSensorMorph.prototype.mouseEnter=function(){this.touch()};MouseSensorMorph.prototype.mouseLeave=function(){this.unTouch()};MouseSensorMorph.prototype.mouseDownLeft=function(){this.touch()};
MouseSensorMorph.prototype.mouseClickLeft=function(){this.unTouch()};InspectorMorph.prototype=new BoxMorph;InspectorMorph.prototype.constructor=InspectorMorph;InspectorMorph.uber=BoxMorph.prototype;function InspectorMorph(a){this.init(a)}
InspectorMorph.prototype.init=function(a){this.target=a;this.currentProperty=null;this.showing="attributes";this.markOwnProperties=!1;InspectorMorph.uber.init.call(this);this.silentSetExtent(new Point(20*MorphicPreferences.handleSize,40*MorphicPreferences.handleSize/3));this.isDraggable=!0;this.border=1;this.edge=5;this.color=new Color(60,60,60);this.borderColor=new Color(95,95,95);this.drawNew();this.resizer=this.buttonEdit=this.buttonSubset=this.buttonClose=this.buttonInspect=this.work=this.detail=
this.list=this.label=null;this.target&&this.buildPanes()};InspectorMorph.prototype.setTarget=function(a){this.target=a;this.currentProperty=null;this.buildPanes()};
InspectorMorph.prototype.buildPanes=function(){var a=[],b,c=this;this.children.forEach(function(a){a!==this.work&&a.destroy()});this.children=[];this.label=new TextMorph(this.target.toString());this.label.fontSize=MorphicPreferences.menuFontSize;this.label.isBold=!0;this.label.color=new Color(255,255,255);this.label.drawNew();this.add(this.label);for(b in this.target)b&&a.push(b);"attributes"===this.showing?a=a.filter(function(a){return"function"!==typeof c.target[a]}):"methods"===this.showing&&(a=
a.filter(function(a){return"function"===typeof c.target[a]}));this.list=new ListMorph(this.target instanceof Array?a:a.sort(),null,this.markOwnProperties?[[new Color(0,0,180),function(a){return c.target.hasOwnProperty(a)}]]:null);this.list.action=function(a){a=c.target[a];c.currentProperty=a;a=null===a?"NULL":isString(a)?a:a.toString();a=new TextMorph(a);a.isEditable=!0;a.enableSelecting();a.setReceiver(c.target);c.detail.setContents(a)};this.list.hBar.alpha=0.6;this.list.vBar.alpha=0.6;this.add(this.list);
this.detail=new ScrollFrameMorph;this.detail.acceptsDrops=!1;this.detail.contents.acceptsDrops=!1;this.detail.isTextLineWrapping=!0;this.detail.color=new Color(255,255,255);this.detail.hBar.alpha=0.6;this.detail.vBar.alpha=0.6;a=new TextMorph("");a.isEditable=!0;a.enableSelecting();a.setReceiver(this.target);this.detail.setContents(a);this.add(this.detail);null===this.work&&(this.work=new ScrollFrameMorph,this.work.acceptsDrops=!1,this.work.contents.acceptsDrops=!1,this.work.isTextLineWrapping=!0,
this.work.color=new Color(255,255,255),this.work.hBar.alpha=0.6,this.work.vBar.alpha=0.6,a=new TextMorph(""),a.isEditable=!0,a.enableSelecting(),a.setReceiver(this.target),this.work.setContents(a));this.add(this.work);this.buttonSubset=new TriggerMorph;this.buttonSubset.labelString="show...";this.buttonSubset.action=function(){var a;a=new MenuMorph;a.addItem("attributes",function(){c.showing="attributes";c.buildPanes()});a.addItem("methods",function(){c.showing="methods";c.buildPanes()});a.addItem("all",
function(){c.showing="all";c.buildPanes()});a.addLine();a.addItem(c.markOwnProperties?"un-mark own":"mark own",function(){c.markOwnProperties=!c.markOwnProperties;c.buildPanes()},"highlight\n'own' properties");a.popUpAtHand(c.world())};this.add(this.buttonSubset);this.buttonInspect=new TriggerMorph;this.buttonInspect.labelString="inspect...";this.buttonInspect.action=function(){var a,b,f;if(isObject(c.currentProperty)){a=new MenuMorph;a.addItem("in new inspector...",function(){b=c.world();f=new InspectorMorph(c.currentProperty);
f.setPosition(b.hand.position());f.keepWithin(b);b.add(f);f.changed()});a.addItem("here...",function(){c.setTarget(c.currentProperty)});a.popUpAtHand(c.world())}else c.inform((c.currentProperty===null?"null":typeof c.currentProperty)+"\nis not inspectable")};this.add(this.buttonInspect);this.buttonEdit=new TriggerMorph;this.buttonEdit.labelString="edit...";this.buttonEdit.action=function(){var a;a=new MenuMorph(c);a.addItem("save","save","accept changes");a.addLine();a.addItem("add property...","addProperty");
a.addItem("rename...","renameProperty");a.addItem("remove...","removeProperty");a.popUpAtHand(c.world())};this.add(this.buttonEdit);this.buttonClose=new TriggerMorph;this.buttonClose.labelString="close";this.buttonClose.action=function(){c.destroy()};this.add(this.buttonClose);this.resizer=new HandleMorph(this,150,100,this.edge,this.edge);this.fixLayout()};
InspectorMorph.prototype.fixLayout=function(){var a,b,c,d;Morph.prototype.trackChanges=!1;a=this.left()+this.edge;b=this.top()+this.edge;c=this.right()-this.edge;c-=a;this.label.setPosition(new Point(a,b));this.label.setWidth(c);this.label.height()>this.height()-50&&(this.silentSetHeight(this.label.height()+50),this.drawNew(),this.changed(),this.resizer.drawNew());b=this.label.bottom()+2;c=Math.min(Math.floor(this.width()/3),this.list.listContents.width());c-=this.edge;d=this.bottom()-2*this.edge-
MorphicPreferences.handleSize-b;this.list.setPosition(new Point(a,b));this.list.setExtent(new Point(c,d));a=this.list.right()+this.edge;c=this.right()-this.edge;c-=a;this.detail.setPosition(new Point(a,b));this.detail.setExtent(new Point(c,2*d/3-this.edge));b=this.detail.bottom()+this.edge;this.work.setPosition(new Point(a,b));this.work.setExtent(new Point(c,d/3));a=this.list.left();b=this.list.bottom()+this.edge;c=this.list.width();d=MorphicPreferences.handleSize;this.buttonSubset.setPosition(new Point(a,
b));this.buttonSubset.setExtent(new Point(c,d));a=this.detail.left();c=this.detail.width()-this.edge-MorphicPreferences.handleSize;c=c/3-this.edge/3;this.buttonInspect.setPosition(new Point(a,b));this.buttonInspect.setExtent(new Point(c,d));a=this.buttonInspect.right()+this.edge;this.buttonEdit.setPosition(new Point(a,b));this.buttonEdit.setExtent(new Point(c,d));a=this.buttonEdit.right()+this.edge;c=this.detail.right()-this.edge-MorphicPreferences.handleSize;c-=a;this.buttonClose.setPosition(new Point(a,
b));this.buttonClose.setExtent(new Point(c,d));Morph.prototype.trackChanges=!0;this.changed()};InspectorMorph.prototype.setExtent=function(a){InspectorMorph.uber.setExtent.call(this,a);this.fixLayout()};InspectorMorph.prototype.save=function(){var a=this.detail.contents.children[0].text.toString(),b=this.list.selected;try{this.target.evaluateString("this."+b+" = "+a),this.target.drawNew&&(this.target.changed(),this.target.drawNew(),this.target.changed())}catch(c){this.inform(c)}};
InspectorMorph.prototype.addProperty=function(){var a=this;this.prompt("new property name:",function(b){b&&(a.target[b]=null,a.buildPanes(),a.target.drawNew&&(a.target.changed(),a.target.drawNew(),a.target.changed()))},this,"property")};
InspectorMorph.prototype.renameProperty=function(){var a=this,b=this.list.selected;this.prompt("property name:",function(c){try{delete a.target[b],a.target[c]=a.currentProperty}catch(d){a.inform(d)}a.buildPanes();a.target.drawNew&&(a.target.changed(),a.target.drawNew(),a.target.changed())},this,b)};
InspectorMorph.prototype.removeProperty=function(){var a=this.list.selected;try{delete this.target[a],this.currentProperty=null,this.buildPanes(),this.target.drawNew&&(this.target.changed(),this.target.drawNew(),this.target.changed())}catch(b){this.inform(b)}};MenuMorph.prototype=new BoxMorph;MenuMorph.prototype.constructor=MenuMorph;MenuMorph.uber=BoxMorph.prototype;function MenuMorph(a,b,c,d){this.init(a,b,c,d)}
MenuMorph.prototype.init=function(a,b,c,d){this.target=a;this.title=b||null;this.environment=c||null;this.fontSize=d||null;this.items=[];this.world=this.label=null;this.isListContents=!1;MenuMorph.uber.init.call(this);this.isDraggable=!1;this.edge=this.border=null};MenuMorph.prototype.addItem=function(a,b,c,d){this.items.push([a||"close",b||nop,c,d])};MenuMorph.prototype.addLine=function(a){this.items.push([0,a||1])};
MenuMorph.prototype.createLabel=function(){var a;null!==this.label&&this.label.destroy();a=new TextMorph(this.title,this.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,!0,!1,"center");a.alignment="center";a.color=new Color(255,255,255);a.backgroundColor=this.borderColor;a.drawNew();this.label=new BoxMorph(3,0);this.label.color=this.borderColor;this.label.borderColor=this.borderColor;this.label.setExtent(a.extent().add(4));this.label.drawNew();this.label.add(a);this.label.text=
a};
MenuMorph.prototype.drawNew=function(){var a=this,b,c,d,e=!1;this.children.forEach(function(a){a.destroy()});this.children=[];this.isListContents||(this.edge=5,this.border=2);this.color=new Color(255,255,255);this.borderColor=new Color(60,60,60);this.silentSetExtent(new Point(0,0));d=2;c=this.left()+4;this.isListContents||(this.title?(this.createLabel(),this.label.setPosition(this.bounds.origin.add(4)),this.add(this.label),d=this.label.bottom()):d=this.top()+4);d+=1;this.items.forEach(function(f){e=false;
if(f instanceof StringFieldMorph||f instanceof ColorPickerMorph||f instanceof SliderMorph)b=f;else if(f[0]===0){e=true;b=new Morph;b.color=a.borderColor;b.setHeight(f[1])}else b=new MenuItemMorph(a.target,f[1],f[0],a.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,a.environment,f[2],f[3]);e&&(d=d+1);b.setPosition(new Point(c,d));a.add(b);d=d+b.height();e&&(d=d+1)});this.silentSetExtent(this.fullBounds().extent().add(4));this.adjustWidths();MenuMorph.uber.drawNew.call(this)};
MenuMorph.prototype.maxWidth=function(){var a=0;this.parent instanceof FrameMorph&&this.parent.scrollFrame instanceof ScrollFrameMorph&&(a=this.parent.width());this.children.forEach(function(b){if(b instanceof MenuItemMorph||b instanceof StringFieldMorph||b instanceof ColorPickerMorph||b instanceof SliderMorph)a=Math.max(a,b.width())});this.label&&(a=Math.max(a,this.label.width()));return a};
MenuMorph.prototype.adjustWidths=function(){var a=this.maxWidth(),b=this;this.children.forEach(function(c){c.silentSetWidth(a);c instanceof MenuItemMorph?c.createBackgrounds():(c.drawNew(),c===b.label&&c.text.setPosition(c.center().subtract(c.text.extent().floorDivideBy(2))))})};MenuMorph.prototype.unselectAllItems=function(){this.children.forEach(function(a){a instanceof MenuItemMorph&&(a.image=a.normalImage)});this.changed()};
MenuMorph.prototype.popup=function(a,b){this.drawNew();this.setPosition(b);this.addShadow(new Point(2,2),80);this.keepWithin(a);a.activeMenu&&a.activeMenu.destroy();a.add(this);a.activeMenu=this;this.fullChanged()};MenuMorph.prototype.popUpAtHand=function(a){a=a||this.world;this.popup(a,a.hand.position())};MenuMorph.prototype.popUpCenteredAtHand=function(a){a=a||this.world;this.drawNew();this.popup(a,a.hand.position().subtract(this.extent().floorDivideBy(2)))};
MenuMorph.prototype.popUpCenteredInWorld=function(a){a=a||this.world;this.drawNew();this.popup(a,a.center().subtract(this.extent().floorDivideBy(2)))};StringMorph.prototype=new Morph;StringMorph.prototype.constructor=StringMorph;StringMorph.uber=Morph.prototype;function StringMorph(a,b,c,d,e,f,g,h,i){this.init(a,b,c,d,e,f,g,h,i)}
StringMorph.prototype.init=function(a,b,c,d,e,f,g,h,i){this.text=a||(""===a?"":"StringMorph");this.fontSize=b||12;this.fontStyle=c||"sans-serif";this.isBold=d||!1;this.isItalic=e||!1;this.isEditable=!1;this.isNumeric=f||!1;this.shadowOffset=g||new Point(0,0);this.shadowColor=h||null;this.currentlySelecting=!1;this.endMark=this.startMark=0;this.markedTextColor=new Color(255,255,255);this.markedBackgoundColor=new Color(60,60,120);StringMorph.uber.init.call(this);this.color=i||new Color(0,0,0);this.noticesTransparentClick=
!0;this.drawNew()};StringMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+'("'+this.text.slice(0,30)+'...")'};StringMorph.prototype.font=function(){var a="";this.isBold&&(a+="bold ");this.isItalic&&(a+="italic ");return a+this.fontSize+"px "+this.fontStyle};
StringMorph.prototype.drawNew=function(){var a,b,c,d,e,f,g;this.image=newCanvas();a=this.image.getContext("2d");a.font=this.font();b=Math.max(a.measureText(this.text).width+Math.abs(this.shadowOffset.x),1);this.bounds.corner=this.bounds.origin.add(new Point(b,fontHeight(this.fontSize)+Math.abs(this.shadowOffset.y)));this.image.width=b;this.image.height=this.height();a.font=this.font();a.textAlign="left";a.textBaseline="bottom";this.shadowColor&&(f=Math.max(this.shadowOffset.x,0),g=Math.max(this.shadowOffset.y,
0),a.fillStyle=this.shadowColor.toString(),a.fillText(this.text,f,fontHeight(this.fontSize)+g));f=Math.abs(Math.min(this.shadowOffset.x,0));g=Math.abs(Math.min(this.shadowOffset.y,0));a.fillStyle=this.color.toString();a.fillText(this.text,f,fontHeight(this.fontSize)+g);c=Math.min(this.startMark,this.endMark);for(b=Math.max(this.startMark,this.endMark);c<b;c+=1)d=this.slotPosition(c).subtract(this.position()),e=this.text.charAt(c),a.fillStyle=this.markedBackgoundColor.toString(),a.fillRect(d.x,d.y,
a.measureText(e).width+1+f,fontHeight(this.fontSize)+g),a.fillStyle=this.markedTextColor.toString(),a.fillText(e,d.x+f,fontHeight(this.fontSize)+g);this.parent&&this.parent.fixLayout&&this.parent.fixLayout()};StringMorph.prototype.slotPosition=function(a){var a=Math.min(Math.max(a,0),this.text.length),b=this.image.getContext("2d"),c,d;for(d=c=0;d<a;d+=1)c+=b.measureText(this.text[d]).width;this.pos=a;a=this.left()+c;b=this.top();return new Point(a,b)};
StringMorph.prototype.slotAt=function(a){for(var b=0,c=0,d=this.image.getContext("2d");a.x-this.left()>c;)if(c+=d.measureText(this.text[b]).width,b+=1,b===this.text.length&&d.measureText(this.text).width-d.measureText(this.text[b-1]).width/2<a.x-this.left())return b;return b-1};StringMorph.prototype.upFrom=function(a){return a};StringMorph.prototype.downFrom=function(a){return a};StringMorph.prototype.startOfLine=function(){return 0};StringMorph.prototype.endOfLine=function(){return this.text.length};
StringMorph.prototype.developersMenu=function(){var a=StringMorph.uber.developersMenu.call(this);a.addLine();a.addItem("edit","edit");a.addItem("font size...",function(){this.prompt(a.title+"\nfont\nsize:",this.setFontSize,this,this.fontSize.toString(),null,6,500,!0)},"set this String's\nfont point size");"serif"!==this.fontStyle&&a.addItem("serif","setSerif");"sans-serif"!==this.fontStyle&&a.addItem("sans-serif","setSansSerif");this.isBold?a.addItem("normal weight","toggleWeight"):a.addItem("bold",
"toggleWeight");this.isItalic?a.addItem("normal style","toggleItalic"):a.addItem("italic","toggleItalic");return a};StringMorph.prototype.toggleIsDraggable=function(){(this.isDraggable=!this.isDraggable)?this.disableSelecting():this.enableSelecting()};StringMorph.prototype.toggleWeight=function(){this.isBold=!this.isBold;this.changed();this.drawNew();this.changed()};StringMorph.prototype.toggleItalic=function(){this.isItalic=!this.isItalic;this.changed();this.drawNew();this.changed()};
StringMorph.prototype.setSerif=function(){this.fontStyle="serif";this.changed();this.drawNew();this.changed()};StringMorph.prototype.setSansSerif=function(){this.fontStyle="sans-serif";this.changed();this.drawNew();this.changed()};StringMorph.prototype.setFontSize=function(a){"number"===typeof a?this.fontSize=Math.round(Math.min(Math.max(a,4),500)):(a=parseFloat(a),isNaN(a)||(this.fontSize=Math.round(Math.min(Math.max(a,4),500))));this.changed();this.drawNew();this.changed()};
StringMorph.prototype.setText=function(a){this.text=Math.round(a).toString();this.changed();this.drawNew();this.changed()};StringMorph.prototype.numericalSetters=function(){return["setLeft","setTop","setAlphaScaled","setFontSize","setText"]};StringMorph.prototype.edit=function(){this.root().edit(this)};StringMorph.prototype.selection=function(){var a,b;a=Math.min(this.startMark,this.endMark);b=Math.max(this.startMark,this.endMark);return this.text.slice(a,b)};
StringMorph.prototype.selectionStartSlot=function(){return Math.min(this.startMark,this.endMark)};StringMorph.prototype.clearSelection=function(){this.currentlySelecting=!1;this.endMark=this.startMark=0;this.drawNew();this.changed()};StringMorph.prototype.deleteSelection=function(){var a,b,c;c=this.text;a=Math.min(this.startMark,this.endMark);b=Math.max(this.startMark,this.endMark);this.text=c.slice(0,a)+c.slice(b);this.changed();this.clearSelection()};
StringMorph.prototype.selectAll=function(){this.mouseDownLeft&&(this.startMark=0,this.endMark=this.text.length,this.drawNew(),this.changed())};StringMorph.prototype.mouseClickLeft=function(a){this.isEditable?(this.currentlySelecting||this.edit(),this.root().cursor.gotoPos(a),this.currentlySelecting=!1):this.escalateEvent("mouseClickLeft",a)};
StringMorph.prototype.enableSelecting=function(){this.mouseDownLeft=function(a){this.clearSelection();this.isEditable&&!this.isDraggable&&(this.edit(),this.root().cursor.gotoPos(a),this.endMark=this.startMark=this.slotAt(a),this.currentlySelecting=!0)};this.mouseMove=function(a){this.isEditable&&this.currentlySelecting&&!this.isDraggable&&(a=this.slotAt(a),a!==this.endMark&&(this.endMark=a,this.drawNew(),this.changed()))}};
StringMorph.prototype.disableSelecting=function(){delete this.mouseDownLeft;delete this.mouseMove};TextMorph.prototype=new Morph;TextMorph.prototype.constructor=TextMorph;TextMorph.uber=Morph.prototype;function TextMorph(a,b,c,d,e,f,g){this.init(a,b,c,d,e,f,g)}
TextMorph.prototype.init=function(a,b,c,d,e,f,g){this.text=a||(""===a?a:"TextMorph");this.words=[];this.lines=[];this.lineSlots=[];this.fontSize=b||12;this.fontStyle=c||"sans-serif";this.isBold=d||!1;this.isItalic=e||!1;this.alignment=f||"left";this.maxWidth=g||0;this.maxLineWidth=0;this.backgroundColor=null;this.isEditable=!1;this.receiver=null;this.currentlySelecting=!1;this.endMark=this.startMark=0;this.markedTextColor=new Color(255,255,255);this.markedBackgoundColor=new Color(60,60,120);TextMorph.uber.init.call(this);
this.color=new Color(0,0,0);this.noticesTransparentClick=!0;this.drawNew()};TextMorph.prototype.toString=function(){return'a TextMorph("'+this.text.slice(0,30)+'...")'};TextMorph.prototype.font=function(){var a="";this.isBold&&(a+="bold ");this.isItalic&&(a+="italic ");return a+this.fontSize+"px "+this.fontStyle};
TextMorph.prototype.parse=function(){var a=this,b=this.text.split("\n"),c=newCanvas().getContext("2d"),d="",e,f,g=0;c.font=this.font();this.maxLineWidth=0;this.lines=[];this.lineSlots=[0];this.words=[];b.forEach(function(b){a.words=a.words.concat(b.split(" "));a.words.push("\n")});this.words.forEach(function(b){"\n"===b?(a.lines.push(d),a.lineSlots.push(g),a.maxLineWidth=Math.max(a.maxLineWidth,c.measureText(d).width),d=""):(0<a.maxWidth?(e=d+b+" ",f=c.measureText(e).width,f>a.maxWidth?(a.lines.push(d),
a.lineSlots.push(g),a.maxLineWidth=Math.max(a.maxLineWidth,c.measureText(d).width),d=b+" "):d=e):d=d+b+" ",g+=b.length+1)})};
TextMorph.prototype.drawNew=function(){var a,b,c,d,e;this.image=newCanvas();a=this.image.getContext("2d");a.font=this.font();this.parse();a=this.lines.length*fontHeight(this.fontSize);this.bounds=0===this.maxWidth?this.bounds.origin.extent(new Point(this.maxLineWidth,a)):this.bounds.origin.extent(new Point(this.maxWidth,a));this.image.width=this.width();this.image.height=this.height();a=this.image.getContext("2d");this.backgroundColor&&(a.fillStyle=this.backgroundColor.toString(),a.fillRect(0,0,this.width(),
this.height()));a.fillStyle=this.color.toString();a.font=this.font();a.textAlign="left";a.textBaseline="bottom";for(b=0;b<this.lines.length;b+=1)c=this.lines[b],d=a.measureText(c).width,d="right"===this.alignment?this.width()-d:"center"===this.alignment?(this.width()-d)/2:0,e=(b+1)*fontHeight(this.fontSize),a.fillText(c,d,e);b=Math.min(this.startMark,this.endMark);for(c=Math.max(this.startMark,this.endMark);b<c;b+=1)d=this.slotPosition(b).subtract(this.position()),e=this.text.charAt(b),a.fillStyle=
this.markedBackgoundColor.toString(),a.fillRect(d.x,d.y,a.measureText(e).width+1,fontHeight(this.fontSize)),a.fillStyle=this.markedTextColor.toString(),a.fillText(e,d.x,d.y+fontHeight(this.fontSize));this.parent&&this.parent.layoutChanged&&this.parent.layoutChanged()};TextMorph.prototype.setExtent=function(a){this.maxWidth=Math.max(a.x,0);this.changed();this.drawNew()};
TextMorph.prototype.columnRow=function(a){var b,c,d=0;for(b=0;b<this.lines.length;b+=1){d=this.lineSlots[b];for(c=0;c<this.lines[b].length;c+=1){if(d===a)return new Point(c,b);d+=1}}return new Point(this.lines[this.lines.length-1].length-1,this.lines.length-1)};
TextMorph.prototype.slotPosition=function(a){var b=this.columnRow(a),c=this.image.getContext("2d"),d=0,e,a=b.y*fontHeight(this.fontSize);for(e=0;e<b.x;e+=1)d+=c.measureText(this.lines[b.y][e]).width;b=this.left()+d;a=this.top()+a;return new Point(b,a)};
TextMorph.prototype.slotAt=function(a){for(var b=0,c=0,d=0,e=this.image.getContext("2d");a.y-this.top()>fontHeight(this.fontSize)*c;)c+=1;for(c=Math.max(c,1);a.x-this.left()>b;)b+=e.measureText(this.lines[c-1][d]).width,d+=1;return this.lineSlots[Math.max(c-1,0)]+d-1};TextMorph.prototype.upFrom=function(a){var b=this.columnRow(a);if(1>b.y)return a;a=this.lines[b.y-1];return a.length<b.x-1?this.lineSlots[b.y-1]+a.length:this.lineSlots[b.y-1]+b.x};
TextMorph.prototype.downFrom=function(a){var b=this.columnRow(a);if(b.y>this.lines.length-2)return a;a=this.lines[b.y+1];return a.length<b.x-1?this.lineSlots[b.y+1]+a.length:this.lineSlots[b.y+1]+b.x};TextMorph.prototype.startOfLine=function(a){return this.lineSlots[this.columnRow(a).y]};TextMorph.prototype.endOfLine=function(a){return this.startOfLine(a)+this.lines[this.columnRow(a).y].length-1};TextMorph.prototype.edit=function(){this.root().edit(this)};
TextMorph.prototype.selection=function(){var a,b;a=Math.min(this.startMark,this.endMark);b=Math.max(this.startMark,this.endMark);return this.text.slice(a,b)};TextMorph.prototype.selectionStartSlot=function(){return Math.min(this.startMark,this.endMark)};TextMorph.prototype.clearSelection=function(){this.currentlySelecting=!1;this.endMark=this.startMark=0;this.drawNew();this.changed()};
TextMorph.prototype.deleteSelection=function(){var a,b,c;c=this.text;a=Math.min(this.startMark,this.endMark);b=Math.max(this.startMark,this.endMark);this.text=c.slice(0,a)+c.slice(b);this.changed();this.clearSelection()};TextMorph.prototype.selectAll=function(){this.startMark=0;this.endMark=this.text.length;this.drawNew();this.changed()};TextMorph.prototype.selectAllAndEdit=function(){this.edit();this.selectAll()};
TextMorph.prototype.mouseClickLeft=function(a){this.isEditable?(this.currentlySelecting||this.edit(),this.root().cursor.gotoPos(a),this.currentlySelecting=!1):this.escalateEvent("mouseClickLeft",a)};
TextMorph.prototype.enableSelecting=function(){this.mouseDownLeft=function(a){this.clearSelection();this.isEditable&&!this.isDraggable&&(this.edit(),this.root().cursor.gotoPos(a),this.endMark=this.startMark=this.slotAt(a),this.currentlySelecting=!0)};this.mouseMove=function(a){this.isEditable&&this.currentlySelecting&&!this.isDraggable&&(a=this.slotAt(a),a!==this.endMark&&(this.endMark=a,this.drawNew(),this.changed()))}};TextMorph.prototype.disableSelecting=function(){delete this.mouseDownLeft;delete this.mouseMove};
TextMorph.prototype.developersMenu=function(){var a=TextMorph.uber.developersMenu.call(this);a.addLine();a.addItem("edit","edit");a.addItem("font size...",function(){this.prompt(a.title+"\nfont\nsize:",this.setFontSize,this,this.fontSize.toString(),null,6,100,!0)},"set this Text's\nfont point size");"left"!==this.alignment&&a.addItem("align left","setAlignmentToLeft");"right"!==this.alignment&&a.addItem("align right","setAlignmentToRight");"center"!==this.alignment&&a.addItem("align center","setAlignmentToCenter");
a.addLine();"serif"!==this.fontStyle&&a.addItem("serif","setSerif");"sans-serif"!==this.fontStyle&&a.addItem("sans-serif","setSansSerif");this.isBold?a.addItem("normal weight","toggleWeight"):a.addItem("bold","toggleWeight");this.isItalic?a.addItem("normal style","toggleItalic"):a.addItem("italic","toggleItalic");return a};TextMorph.prototype.toggleIsDraggable=function(){(this.isDraggable=!this.isDraggable)?this.disableSelecting():this.enableSelecting()};
TextMorph.prototype.setAlignmentToLeft=function(){this.alignment="left";this.drawNew();this.changed()};TextMorph.prototype.setAlignmentToRight=function(){this.alignment="right";this.drawNew();this.changed()};TextMorph.prototype.setAlignmentToCenter=function(){this.alignment="center";this.drawNew();this.changed()};TextMorph.prototype.toggleWeight=function(){this.isBold=!this.isBold;this.changed();this.drawNew();this.changed()};
TextMorph.prototype.toggleItalic=function(){this.isItalic=!this.isItalic;this.changed();this.drawNew();this.changed()};TextMorph.prototype.setSerif=function(){this.fontStyle="serif";this.changed();this.drawNew();this.changed()};TextMorph.prototype.setSansSerif=function(){this.fontStyle="sans-serif";this.changed();this.drawNew();this.changed()};TextMorph.prototype.setText=function(a){this.text=Math.round(a).toString();this.changed();this.drawNew();this.changed()};
TextMorph.prototype.setFontSize=function(a){"number"===typeof a?this.fontSize=Math.round(Math.min(Math.max(a,4),500)):(a=parseFloat(a),isNaN(a)||(this.fontSize=Math.round(Math.min(Math.max(a,4),500))));this.changed();this.drawNew();this.changed()};TextMorph.prototype.numericalSetters=function(){return["setLeft","setTop","setAlphaScaled","setFontSize","setText"]};
TextMorph.prototype.evaluationMenu=function(){var a=new MenuMorph(this,null);a.addItem("do it","doIt","evaluate the\nselected expression");a.addItem("show it","showIt","evaluate the\nselected expression\nand show the result");a.addItem("inspect it","inspectIt","evaluate the\nselected expression\nand inspect the result");a.addLine();a.addItem("select all","selectAllAndEdit");return a};TextMorph.prototype.setReceiver=function(a){this.receiver=a;this.customContextMenu=this.evaluationMenu()};
TextMorph.prototype.doIt=function(){this.receiver.evaluateString(this.selection());this.edit()};TextMorph.prototype.showIt=function(){var a=this.receiver.evaluateString(this.selection());null!==a&&this.inform(a)};TextMorph.prototype.inspectIt=function(){var a=this.receiver.evaluateString(this.selection()),b=this.world();null!==a&&(a=new InspectorMorph(a),a.setPosition(b.hand.position()),a.keepWithin(b),b.add(a),a.changed())};TriggerMorph.prototype=new Morph;TriggerMorph.prototype.constructor=TriggerMorph;
TriggerMorph.uber=Morph.prototype;function TriggerMorph(a,b,c,d,e,f,g,h){this.init(a,b,c,d,e,f,g,h)}
TriggerMorph.prototype.init=function(a,b,c,d,e,f,g,h){this.target=a||null;this.action=b||null;this.environment=f||null;this.labelString=c||null;this.label=null;this.hint=g||null;this.fontSize=d||MorphicPreferences.menuFontSize;this.fontStyle=e||"sans-serif";this.highlightColor=new Color(192,192,192);this.pressColor=new Color(128,128,128);this.labelColor=h||new Color(0,0,0);TriggerMorph.uber.init.call(this);this.color=new Color(255,255,255);this.drawNew()};
TriggerMorph.prototype.drawNew=function(){this.createBackgrounds();null!==this.labelString&&this.createLabel()};
TriggerMorph.prototype.createBackgrounds=function(){var a,b=this.extent();this.normalImage=newCanvas(b);a=this.normalImage.getContext("2d");a.fillStyle=this.color.toString();a.fillRect(0,0,b.x,b.y);this.highlightImage=newCanvas(b);a=this.highlightImage.getContext("2d");a.fillStyle=this.highlightColor.toString();a.fillRect(0,0,b.x,b.y);this.pressImage=newCanvas(b);a=this.pressImage.getContext("2d");a.fillStyle=this.pressColor.toString();a.fillRect(0,0,b.x,b.y);this.image=this.normalImage};
TriggerMorph.prototype.createLabel=function(){null!==this.label&&this.label.destroy();this.label=new StringMorph(this.labelString,this.fontSize,this.fontStyle,!1,!1,!1,null,null,this.labelColor);this.label.setPosition(this.center().subtract(this.label.extent().floorDivideBy(2)));this.add(this.label)};TriggerMorph.prototype.copyRecordingReferences=function(a){var b=TriggerMorph.uber.copyRecordingReferences.call(this,a);b.label&&a[this.label]&&(b.label=a[this.label]);return b};
TriggerMorph.prototype.trigger=function(){"function"===typeof this.target?"function"===typeof this.action?this.target.call(this.environment,this.action.call()):this.target.call(this.environment,this.action):"function"===typeof this.action?this.action.call(this.target):this.target[this.action].call(this.target)};TriggerMorph.prototype.mouseEnter=function(){this.image=this.highlightImage;this.changed();this.hint&&this.bubbleHelp(this.hint)};
TriggerMorph.prototype.mouseLeave=function(){this.image=this.normalImage;this.changed();this.hint&&this.world().hand.destroyTemporaries()};TriggerMorph.prototype.mouseDownLeft=function(){this.image=this.pressImage;this.changed()};TriggerMorph.prototype.mouseClickLeft=function(){this.image=this.highlightImage;this.changed();this.trigger()};
TriggerMorph.prototype.bubbleHelp=function(a){var b=this;this.fps=2;this.step=function(){this.bounds.containsPoint(this.world().hand.position())&&b.popUpbubbleHelp(a);b.fps=0;delete b.step}};TriggerMorph.prototype.popUpbubbleHelp=function(a){(new SpeechBubbleMorph(a,null,null,1)).popUp(this.world(),this.rightCenter().add(new Point(-8,0)))};MenuItemMorph.prototype=new TriggerMorph;MenuItemMorph.prototype.constructor=MenuItemMorph;MenuItemMorph.uber=TriggerMorph.prototype;
function MenuItemMorph(a,b,c,d,e,f,g,h){this.init(a,b,c,d,e,f,g,h)}MenuItemMorph.prototype.createLabel=function(){null!==this.label&&this.label.destroy();this.label=new StringMorph(this.labelString,this.fontSize,this.fontStyle,!1,!1,!1,null,null,this.labelColor);this.silentSetExtent(this.label.extent().add(new Point(8,0)));this.label.bounds=this.position().add(new Point(4,0)).extent(this.label.extent());this.add(this.label)};
MenuItemMorph.prototype.mouseEnter=function(){this.isListItem()||(this.image=this.highlightImage,this.changed());this.hint&&this.bubbleHelp(this.hint)};MenuItemMorph.prototype.mouseLeave=function(){this.isListItem()||(this.image=this.normalImage,this.changed());this.hint&&this.world().hand.destroyTemporaries()};MenuItemMorph.prototype.mouseDownLeft=function(a){this.isListItem()&&(this.parent.unselectAllItems(),this.escalateEvent("mouseDownLeft",a));this.image=this.pressImage;this.changed()};
MenuItemMorph.prototype.mouseMove=function(){this.isListItem()&&this.escalateEvent("mouseMove")};MenuItemMorph.prototype.mouseClickLeft=function(){this.isListItem()||(this.parent.destroy(),this.root().activeMenu=null);this.trigger()};MenuItemMorph.prototype.isListItem=function(){return this.parent?this.parent.isListContents:!1};MenuItemMorph.prototype.isSelectedListItem=function(){return this.isListItem()?this.image===this.pressImage:!1};FrameMorph.prototype=new Morph;
FrameMorph.prototype.constructor=FrameMorph;FrameMorph.uber=Morph.prototype;function FrameMorph(a){this.init(a)}FrameMorph.prototype.init=function(a){this.scrollFrame=a||null;FrameMorph.uber.init.call(this);this.color=new Color(255,250,245);this.drawNew();this.acceptsDrops=!0;this.scrollFrame&&(this.noticesTransparentClick=this.isDraggable=!1,this.alpha=0)};FrameMorph.prototype.fullBounds=function(){var a=this.getShadow();return null!==a?this.bounds.merge(a.bounds):this.bounds};
FrameMorph.prototype.fullImage=function(){return this.image};FrameMorph.prototype.fullDrawOn=function(a,b){var c=this,d;if(!this.isVisible)return null;d=b||this.fullBounds();this.drawOn(a,d);this.children.forEach(function(b){b instanceof ShadowMorph?b.fullDrawOn(a,d):b.fullDrawOn(a,c.bounds.intersect(d))})};FrameMorph.prototype.moveBy=function(a){this.changed();this.bounds=this.bounds.translateBy(a);this.children.forEach(function(b){b.silentMoveBy(a)});this.changed()};
FrameMorph.prototype.submorphBounds=function(){var a=null;0<this.children.length&&(a=this.children[0].bounds,this.children.forEach(function(b){a=a.merge(b.fullBounds())}));return a};
FrameMorph.prototype.keepInScrollFrame=function(){if(null===this.scrollFrame)return null;this.left()>this.scrollFrame.left()&&this.moveBy(new Point(this.scrollFrame.left()-this.left(),0));this.right()<this.scrollFrame.right()&&this.moveBy(new Point(this.scrollFrame.right()-this.right(),0));this.top()>this.scrollFrame.top()&&this.moveBy(new Point(0,this.scrollFrame.top()-this.top()));this.bottom()<this.scrollFrame.bottom()&&this.moveBy(0,new Point(this.scrollFrame.bottom()-this.bottom(),0))};
FrameMorph.prototype.adjustBounds=function(){var a,b=this;if(null===this.scrollFrame)return null;a=(a=this.submorphBounds())&&!this.scrollFrame.isTextLineWrapping?a.expandBy(this.scrollFrame.padding).merge(this.scrollFrame.bounds):this.scrollFrame.bounds.copy();this.bounds.eq(a)||(this.bounds=a,this.drawNew(),this.keepInScrollFrame());this.scrollFrame.isTextLineWrapping&&this.children.forEach(function(a){if(a instanceof TextMorph){a.setWidth(b.width());b.setHeight(Math.max(a.height(),b.scrollFrame.height()))}});
this.scrollFrame.adjustScrollBars()};FrameMorph.prototype.reactToDropOf=function(){this.adjustBounds()};FrameMorph.prototype.reactToGrabOf=function(){this.adjustBounds()};FrameMorph.prototype.copyRecordingReferences=function(a){var b=FrameMorph.uber.copyRecordingReferences.call(this,a);b.frame&&a[this.scrollFrame]&&(b.frame=a[this.scrollFrame]);return b};
FrameMorph.prototype.developersMenu=function(){var a=FrameMorph.uber.developersMenu.call(this);0<this.children.length&&(a.addLine(),a.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible"));return a};FrameMorph.prototype.keepAllSubmorphsWithin=function(){var a=this;this.children.forEach(function(b){b.keepWithin(a)})};ScrollFrameMorph.prototype=new FrameMorph;ScrollFrameMorph.prototype.constructor=ScrollFrameMorph;ScrollFrameMorph.uber=FrameMorph.prototype;
function ScrollFrameMorph(a,b,c){this.init(a,b,c)}
ScrollFrameMorph.prototype.init=function(a,b,c){var d=this;ScrollFrameMorph.uber.init.call(this);this.scrollBarSize=b||MorphicPreferences.scrollBarSize;this.autoScrollTrigger=null;this.hasVelocity=this.isScrollingByDragging=!0;this.padding=0;this.isTextLineWrapping=!1;this.contents=a||new FrameMorph(this);this.add(this.contents);this.hBar=new SliderMorph(null,null,null,null,"horizontal",c);this.hBar.setHeight(this.scrollBarSize);this.hBar.action=function(a){d.contents.setPosition(new Point(d.left()-a,
d.contents.position().y))};this.hBar.isDraggable=!1;this.add(this.hBar);this.vBar=new SliderMorph(null,null,null,null,"vertical",c);this.vBar.setWidth(this.scrollBarSize);this.vBar.action=function(a){d.contents.setPosition(new Point(d.contents.position().x,d.top()-a))};this.vBar.isDraggable=!1;this.add(this.vBar)};
ScrollFrameMorph.prototype.adjustScrollBars=function(){var a=this.width()-this.scrollBarSize,b=this.height()-this.scrollBarSize;this.changed();this.contents.width()>this.width()+MorphicPreferences.scrollBarSize?(this.hBar.show(),this.hBar.width()!==a&&this.hBar.setWidth(a),this.hBar.setPosition(new Point(this.left(),this.bottom()-this.hBar.height())),this.hBar.start=0,this.hBar.stop=this.contents.width()-this.width(),this.hBar.size=this.width()/this.contents.width()*this.hBar.stop,this.hBar.value=
this.left()-this.contents.left(),this.hBar.drawNew()):this.hBar.hide();this.contents.height()>this.height()+this.scrollBarSize?(this.vBar.show(),this.vBar.height()!==b&&this.vBar.setHeight(b),this.vBar.setPosition(new Point(this.right()-this.vBar.width(),this.top())),this.vBar.start=0,this.vBar.stop=this.contents.height()-this.height(),this.vBar.size=this.height()/this.contents.height()*this.vBar.stop,this.vBar.value=this.top()-this.contents.top(),this.vBar.drawNew()):this.vBar.hide()};
ScrollFrameMorph.prototype.addContents=function(a){this.contents.add(a);this.contents.adjustBounds()};ScrollFrameMorph.prototype.setContents=function(a){this.contents.children.forEach(function(a){a.destroy()});this.contents.children=[];a.setPosition(this.position().add(new Point(2,2)));this.addContents(a)};ScrollFrameMorph.prototype.setExtent=function(a){this.isTextLineWrapping&&this.contents.setPosition(this.position().copy());ScrollFrameMorph.uber.setExtent.call(this,a);this.contents.adjustBounds()};
ScrollFrameMorph.prototype.scrollX=function(a){var b=this.contents.left(),c=this.left(),d=this.contents.width(),e=this.right(),a=b+a;a>c&&(a=c);a+d<e&&(a=e-d);a!==b&&this.contents.setLeft(a)};ScrollFrameMorph.prototype.scrollY=function(a){var b=this.contents.top(),c=this.top(),d=this.contents.height(),e=this.bottom(),a=b+a;a>c&&(a=c);a+d<e&&(a=e-d);a!==b&&this.contents.setTop(a)};ScrollFrameMorph.prototype.step=function(){nop()};
ScrollFrameMorph.prototype.mouseDownLeft=function(a){if(!this.isScrollingByDragging)return null;var b=this.root(),c=a,d=this,e=0,f=0;this.step=function(){var a;b.hand.mouseButton&&0===b.hand.children.length&&d.bounds.containsPoint(b.hand.position())?(a=b.hand.bounds.origin,e=a.x-c.x,0!==e&&d.scrollX(e),f=a.y-c.y,0!==f&&d.scrollY(f),c=a):d.hasVelocity?0.5>Math.abs(e)&&0.5>Math.abs(f)?d.step=function(){nop()}:(e*=0.8,d.scrollX(Math.round(e)),f*=0.8,d.scrollY(Math.round(f))):d.step=function(){nop()};
this.adjustScrollBars()}};ScrollFrameMorph.prototype.startAutoScrolling=function(){var a=this,b=3*MorphicPreferences.scrollBarSize,c=this.world(),d,e,f;if(!c)return null;d=c.hand;this.autoScrollTrigger||(this.autoScrollTrigger=Date.now());this.step=function(){f=d.bounds.origin;e=a.bounds.insetBy(b);if(a.bounds.containsPoint(f)&&!e.containsPoint(f)&&d.children.length>0)a.autoScroll(f);else{a.step=function(){nop()};a.autoScrollTrigger=null}}};
ScrollFrameMorph.prototype.autoScroll=function(a){var b,c;if(500>Date.now()-this.autoScrollTrigger)return null;b=3*MorphicPreferences.scrollBarSize;c=this.topLeft().extent(new Point(this.width(),b));c.containsPoint(a)&&this.scrollY(b-(a.y-this.top()));c=this.topLeft().extent(new Point(b,this.height()));c.containsPoint(a)&&this.scrollX(b-(a.x-this.left()));c=(new Point(this.right()-b,this.top())).extent(new Point(b,this.height()));c.containsPoint(a)&&this.scrollX(-(b-(this.right()-a.x)));c=(new Point(this.left(),
this.bottom()-b)).extent(new Point(this.width(),b));c.containsPoint(a)&&this.scrollY(-(b-(this.bottom()-a.y)));this.adjustScrollBars()};ScrollFrameMorph.prototype.mouseScroll=function(a,b){a&&this.scrollY(a*MorphicPreferences.mouseScrollAmount);b&&this.scrollX(b*MorphicPreferences.mouseScrollAmount);this.adjustScrollBars()};
ScrollFrameMorph.prototype.copyRecordingReferences=function(a){var b=ScrollFrameMorph.uber.copyRecordingReferences.call(this,a);b.contents&&a[this.contents]&&(b.contents=a[this.contents]);b.hBar&&a[this.hBar]&&(b.hBar=a[this.hBar],b.hBar.action=function(a){b.contents.setPosition(new Point(b.left()-a,b.contents.position().y))});b.vBar&&a[this.vBar]&&(b.vBar=a[this.vBar],b.vBar.action=function(a){b.contents.setPosition(new Point(b.contents.position().x,b.top()-a))});return b};
ScrollFrameMorph.prototype.developersMenu=function(){var a=ScrollFrameMorph.uber.developersMenu.call(this);this.isTextLineWrapping?a.addItem("auto line wrap off...","toggleTextLineWrapping","turn automatic\nline wrapping\noff"):a.addItem("auto line wrap on...","toggleTextLineWrapping","enable automatic\nline wrapping");return a};ScrollFrameMorph.prototype.toggleTextLineWrapping=function(){this.isTextLineWrapping=!this.isTextLineWrapping};ListMorph.prototype=new ScrollFrameMorph;
ListMorph.prototype.constructor=ListMorph;ListMorph.uber=ScrollFrameMorph.prototype;function ListMorph(a,b,c){this.init(a||[],b||function(a){return isString(a)?a:a.toSource?a.toSource():a.toString()},c||[])}
ListMorph.prototype.init=function(a,b,c){ListMorph.uber.init.call(this);this.contents.acceptsDrops=!1;this.color=new Color(255,255,255);this.hBar.alpha=0.6;this.vBar.alpha=0.6;this.elements=a||[];this.labelGetter=b;this.format=c;this.action=this.selected=this.listContents=null;this.acceptsDrops=!1;this.buildListContents()};
ListMorph.prototype.buildListContents=function(){var a=this;this.listContents&&this.listContents.destroy();this.listContents=new MenuMorph(this.select,null,this);0===this.elements.length&&(this.elements=["(empty)"]);this.elements.forEach(function(b){var c=null;a.format.forEach(function(a){a[1].call(null,b)&&(c=a[0])});a.listContents.addItem(a.labelGetter.call(a,b),b,null,c)});this.listContents.setPosition(this.contents.position());this.listContents.isListContents=!0;this.listContents.drawNew();this.addContents(this.listContents)};
ListMorph.prototype.select=function(a){this.selected=a;this.action&&this.action.call(null,a)};ListMorph.prototype.setExtent=function(a){var b=this.listContents.bounds,c=this.bounds.origin.copy().corner(this.bounds.origin.add(a));c.right()>b.right()&&c.width()<=b.width()&&this.listContents.setRight(c.right());c.bottom()>b.bottom()&&c.height()<=b.height()&&this.listContents.setBottom(c.bottom());ListMorph.uber.setExtent.call(this,a)};StringFieldMorph.prototype=new FrameMorph;
StringFieldMorph.prototype.constructor=StringFieldMorph;StringFieldMorph.uber=FrameMorph.prototype;function StringFieldMorph(a,b,c,d,e,f,g){this.init(a||"",b||100,c||12,d||"sans-serif",e||!1,f||!1,g)}
StringFieldMorph.prototype.init=function(a,b,c,d,e,f,g){this.defaultContents=a;this.minWidth=b;this.fontSize=c;this.fontStyle=d;this.isBold=e;this.isItalic=f;this.isNumeric=g||!1;this.text=null;StringFieldMorph.uber.init.call(this);this.color=new Color(255,255,255);this.isEditable=!0;this.acceptsDrops=!1;this.drawNew()};
StringFieldMorph.prototype.drawNew=function(){var a;a=this.text?this.string():this.defaultContents;this.text=null;this.children.forEach(function(a){a.destroy()});this.children=[];this.text=new StringMorph(a,this.fontSize,this.fontStyle,this.isBold,this.isItalic,this.isNumeric);this.text.isNumeric=this.isNumeric;this.text.setPosition(this.bounds.origin.copy());this.text.isEditable=this.isEditable;this.text.isDraggable=!1;this.text.enableSelecting();this.silentSetExtent(new Point(Math.max(this.width(),
this.minWidth),this.text.height()));StringFieldMorph.uber.drawNew.call(this);this.add(this.text)};StringFieldMorph.prototype.string=function(){return this.text.text};StringFieldMorph.prototype.mouseClickLeft=function(){this.isEditable&&this.text.edit()};StringFieldMorph.prototype.copyRecordingReferences=function(a){var b=StringFieldMorph.uber.copyRecordingReferences.call(this,a);b.text&&a[this.text]&&(b.text=a[this.text]);return b};BouncerMorph.prototype=new Morph;
BouncerMorph.prototype.constructor=BouncerMorph;BouncerMorph.uber=Morph.prototype;function BouncerMorph(){this.init()}BouncerMorph.prototype.init=function(a,b){BouncerMorph.uber.init.call(this);this.fps=50;this.isStopped=!1;this.type=a||"vertical";this.direction="vertical"===this.type?"down":"right";this.speed=b||1};BouncerMorph.prototype.moveUp=function(){this.moveBy(new Point(0,-this.speed))};BouncerMorph.prototype.moveDown=function(){this.moveBy(new Point(0,this.speed))};
BouncerMorph.prototype.moveRight=function(){this.moveBy(new Point(this.speed,0))};BouncerMorph.prototype.moveLeft=function(){this.moveBy(new Point(-this.speed,0))};
BouncerMorph.prototype.step=function(){if(!this.isStopped)if("vertical"===this.type){if("down"===this.direction?this.moveDown():this.moveUp(),this.fullBounds().top()<this.parent.top()&&"up"===this.direction&&(this.direction="down"),this.fullBounds().bottom()>this.parent.bottom()&&"down"===this.direction)this.direction="up"}else if("horizontal"===this.type&&("right"===this.direction?this.moveRight():this.moveLeft(),this.fullBounds().left()<this.parent.left()&&"left"===this.direction&&(this.direction=
"right"),this.fullBounds().right()>this.parent.right()&&"right"===this.direction))this.direction="left"};HandMorph.prototype=new Morph;HandMorph.prototype.constructor=HandMorph;HandMorph.uber=Morph.prototype;function HandMorph(a){this.init(a)}HandMorph.prototype.init=function(a){HandMorph.uber.init.call(this);this.bounds=new Rectangle;this.world=a;this.mouseButton=null;this.mouseOverList=[];this.morphToGrab=this.mouseDownMorph=null;this.temporaries=[]};
HandMorph.prototype.changed=function(){var a;null!==this.world&&(a=this.fullBounds(),a.extent().eq(new Point)||this.world.broken.push(this.fullBounds().spread()))};HandMorph.prototype.morphAtPointer=function(){var a=this,b=null;this.world.allChildren().slice(0).reverse().forEach(function(c){if(c.visibleBounds().containsPoint(a.bounds.origin)&&null===b&&c.isVisible&&(c.noticesTransparentClick||!c.isTransparentAt(a.bounds.origin))&&!(c instanceof ShadowMorph))b=c});return null!==b?b:this.world};
HandMorph.prototype.allMorphsAtPointer=function(){var a=this;return this.world.allChildren().filter(function(b){return b.isVisible&&b.visibleBounds().containsPoint(a.bounds.origin)})};HandMorph.prototype.dropTargetFor=function(a){for(var b=this.morphAtPointer();!b.wantsDropOf(a);)b=b.parent;return b};
HandMorph.prototype.grab=function(a){var b=a.parent;if(a instanceof WorldMorph)return null;0===this.children.length&&(this.world.stopEditing(),a.addShadow(),a.prepareToBeGrabbed&&a.prepareToBeGrabbed(this),this.add(a),this.changed(),b&&b.reactToGrabOf&&b.reactToGrabOf(a))};
HandMorph.prototype.drop=function(){var a,b;0!==this.children.length&&(b=this.children[0],a=this.dropTargetFor(b),this.changed(),a.add(b),b.changed(),b.removeShadow(),this.children=[],this.setExtent(new Point),b.justDropped&&b.justDropped(this),a.reactToDropOf&&a.reactToDropOf(b))};
HandMorph.prototype.processMouseDown=function(a){var b,c;this.destroyTemporaries();this.morphToGrab=null;if(0!==this.children.length)this.drop(),this.mouseButton=null;else{b=this.morphAtPointer();this.world.activeMenu&&(contains(b.allParents(),this.world.activeMenu)||this.world.activeMenu.destroy());this.world.activeHandle&&b!==this.world.activeHandle&&this.world.activeHandle.destroy();this.world.cursor&&b!==this.world.cursor.target&&this.world.stopEditing();b.mouseMove||(this.morphToGrab=b.rootForGrab());
2===a.button||a.ctrlKey?(this.mouseButton="right",c="mouseDownRight",a="mouseClickRight"):(this.mouseButton="left",c="mouseDownLeft",a="mouseClickLeft");for(this.mouseDownMorph=b;!this.mouseDownMorph[a];)this.mouseDownMorph=this.mouseDownMorph.parent;for(;!b[c];)b=b.parent;b[c].call(b,this.bounds.origin)}};
HandMorph.prototype.processTouchStart=function(a){this.mouseButton?(this.processMouseDown({button:2}),this.processMouseUp({button:2})):1<a.touches.length?(this.processTouchMove(a),this.processMouseDown({button:2}),this.processMouseUp({button:2})):(this.processTouchMove(a),this.processMouseDown({button:0}))};
HandMorph.prototype.processMouseUp=function(){var a=this.morphAtPointer(),b,c,d;this.destroyTemporaries();if(0!==this.children.length)this.drop();else{if("left"===this.mouseButton)d="mouseClickLeft";else if(d="mouseClickRight",this.mouseButton){b=a;for(c=b.contextMenu();!c&&b.parent;)b=b.parent,c=b.contextMenu();c&&c.popUpAtHand(this.world)}for(;!a[d];)a=a.parent;a[d].call(a,this.bounds.origin)}this.mouseButton=null};
HandMorph.prototype.processMouseMove=function(a){var b=getDocumentPositionOf(this.world.worldCanvas),c,d=this,e,a=new Point(a.pageX-b.x,a.pageY-b.y);this.setPosition(a);c=this.morphAtPointer().allParents();if(0===this.children.length&&"left"===this.mouseButton&&(e=this.morphAtPointer(),b=e.rootForGrab(),e.mouseMove&&e.mouseMove(a),this.morphToGrab&&(this.morphToGrab.isDraggable?(b=this.morphToGrab,this.grab(b)):this.morphToGrab.isTemplate&&(b=this.morphToGrab.fullCopy(),b.isTemplate=!1,b.isDraggable=
!0,this.grab(b)),e=b.fullBounds(),!e.containsPoint(a))))this.bounds.origin=e.center(),this.grab(b),this.setPosition(a);this.mouseOverList.forEach(function(a){contains(c,a)||(a.mouseLeave&&a.mouseLeave(),a.mouseLeaveDragging&&this.mouseButton&&a.mouseLeaveDragging())});c.forEach(function(a){contains(d.mouseOverList,a)||(a.mouseEnter&&a.mouseEnter(),a.mouseEnterDragging&&this.mouseButton&&a.mouseEnterDragging());0<d.children.length&&a instanceof ScrollFrameMorph&&(a.bounds.insetBy(3*MorphicPreferences.scrollBarSize).containsPoint(d.bounds.origin)||
a.startAutoScrolling())});this.mouseOverList=c};HandMorph.prototype.processTouchMove=function(a){this.processMouseMove(a.touches[0])};HandMorph.prototype.processMouseScroll=function(a){for(var b=this.morphAtPointer();b&&!b.mouseScroll;)b=b.parent;b&&b.mouseScroll.call(b,a.detail/-3||(a.hasOwnProperty("wheelDeltaY")?a.wheelDeltaY/120:a.wheelDelta/120),a.wheelDeltaX/120||0)};
HandMorph.prototype.processDrop=function(a){function b(a){var b=new Image,c=new FileReader;b.onload=function(){g=newCanvas(new Point(b.width,b.height));g.getContext("2d").drawImage(b,0,0);e.droppedImage(g)};c=new FileReader;c.onloadend=function(a){b.src=a.target.result};c.readAsDataURL(a)}function c(a){var b="",c,d;c=a.indexOf('<img src="');if(-1===c)return null;for(c+=10;c<a.length;c+=1){d=a[c];if('"'===d)return b;b=b.concat(d)}return null}for(var d=a.target.files||a.dataTransfer.files,a=a.dataTransfer.getData("Text/HTML"),
e=this.morphAtPointer(),f=new Image,g,h;!e.droppedImage;)e=e.parent;if(0<d.length)for(h=0;h<d.length;h+=1)a=d[h],0===a.type.indexOf("image")&&b(a);else if(a&&(f=new Image,f.onload=function(){g=newCanvas(new Point(f.width,f.height));g.getContext("2d").drawImage(f,0,0);e.droppedImage(g)},d=c(a)))f.src=d};HandMorph.prototype.destroyTemporaries=function(){this.temporaries.forEach(function(a){a.destroy()});this.temporaries=[]};
HandMorph.prototype.moveBy=function(a){Morph.prototype.trackChanges=!1;HandMorph.uber.moveBy.call(this,a);Morph.prototype.trackChanges=!0;this.fullChanged()};WorldMorph.prototype=new FrameMorph;WorldMorph.prototype.constructor=WorldMorph;WorldMorph.uber=FrameMorph.prototype;function WorldMorph(a,b){this.init(a,b)}
WorldMorph.prototype.init=function(a,b){WorldMorph.uber.init.call(this);this.color=new Color(205,205,205);this.alpha=1;this.bounds=new Rectangle(0,0,a.width,a.height);this.drawNew();this.isVisible=!0;this.isDraggable=!1;this.currentKey=null;this.worldCanvas=a;this.useFillPage=b;void 0===this.useFillPage&&(this.useFillPage=!0);this.isDevMode=!1;this.broken=[];this.hand=new HandMorph(this);this.trailsCanvas=this.activeHandle=this.activeMenu=this.cursor=this.lastEditedText=this.keyboardReceiver=null;
this.initEventListeners()};WorldMorph.prototype.drawNew=function(){WorldMorph.uber.drawNew.call(this);this.trailsCanvas=newCanvas(this.extent())};WorldMorph.prototype.penTrails=function(){return this.trailsCanvas};WorldMorph.prototype.brokenFor=function(a){var b=a.fullBounds();return this.broken.filter(function(a){return a.intersects(b)})};
WorldMorph.prototype.fullDrawOn=function(a,b){var c,d,e,f,g,h;c=b||this.fullBounds();d=c.intersect(this.bounds);e=d.left();f=d.top();g=d.width();h=d.height();if(0>g||0>h)return null;d=a.getContext("2d");d.globalAlpha=1;d.fillStyle=this.color.toString();d.fillRect(e,f,g,h);this.trailsCanvas&&1<g&&1<h&&d.drawImage(this.trailsCanvas,e,f,g,h,e,f,g,h);this.children.forEach(function(b){b.fullDrawOn(a,c)});this.hand.fullDrawOn(a,c)};
WorldMorph.prototype.updateBroken=function(){var a=this;this.broken.forEach(function(b){b.extent().gt(new Point(0,0))&&a.fullDrawOn(a.worldCanvas,b)});this.broken=[]};WorldMorph.prototype.doOneCycle=function(){this.stepFrame();this.updateBroken()};
WorldMorph.prototype.fillPage=function(){var a=getDocumentPositionOf(this.worldCanvas),b=window.innerHeight,c=this;this.worldCanvas.width!==document.body.clientWidth&&(this.worldCanvas.width=document.body.clientWidth,this.setWidth(document.body.clientWidth));this.worldCanvas.height!==b-2.5*a.y&&(this.worldCanvas.height=b-2.5*a.y,this.setHeight(b-2.5*a.y));this.children.forEach(function(a){a.reactToWorldResize&&a.reactToWorldResize(c.bounds.copy())})};
WorldMorph.prototype.getGlobalPixelColor=function(a){a=this.worldCanvas.getContext("2d").getImageData(a.x,a.y,1,1).data;return new Color(a[0],a[1],a[2])};
WorldMorph.prototype.initEventListeners=function(){var a=this.worldCanvas,b=this;b.useFillPage?b.fillPage():this.changed();a.addEventListener("mousedown",function(a){b.hand.processMouseDown(a)},!1);a.addEventListener("touchstart",function(a){b.hand.processTouchStart(a);a.preventDefault()},!1);a.addEventListener("mouseup",function(a){a.preventDefault();b.hand.processMouseUp(a)},!1);a.addEventListener("touchend",function(){b.hand.processMouseUp({button:0})},!1);a.addEventListener("mousemove",function(a){b.hand.processMouseMove(a)},
!1);a.addEventListener("touchmove",function(a){b.hand.processTouchMove(a)},!1);a.addEventListener("contextmenu",function(a){a.preventDefault()},!1);a.addEventListener("contextmenu",function(a){a.preventDefault()},!1);a.addEventListener("keydown",function(a){b.currentKey=a.keyCode;b.keyboardReceiver&&b.keyboardReceiver.processKeyDown(a);("U+0008"===a.keyIdentifier||"Backspace"===a.keyIdentifier)&&a.preventDefault();if("U+0009"===a.keyIdentifier||"Tab"===a.keyIdentifier)b.keyboardReceiver&&b.keyboardReceiver.processKeyPress(a),
a.preventDefault()},!1);a.addEventListener("keyup",function(a){b.currentKey=null;b.keyboardReceiver&&b.keyboardReceiver.processKeyUp&&b.keyboardReceiver.processKeyUp(a);a.preventDefault()},!1);a.addEventListener("keypress",function(a){b.keyboardReceiver&&b.keyboardReceiver.processKeyPress(a);a.preventDefault()},!1);a.addEventListener("mousewheel",function(a){b.hand.processMouseScroll(a);a.preventDefault()},!1);a.addEventListener("DOMMouseScroll",function(a){b.hand.processMouseScroll(a);a.preventDefault()},
!1);window.addEventListener("dragover",function(a){a.preventDefault()},!1);window.addEventListener("drop",function(a){b.hand.processDrop(a);a.preventDefault()},!1);window.addEventListener("resize",function(){b.useFillPage&&b.fillPage()},!1);window.onbeforeunload=function(a){if(a=a||window.event)a.returnValue="Are you sure you want to leave?";return"Are you sure you want to leave?"}};WorldMorph.prototype.mouseDownLeft=function(){nop()};WorldMorph.prototype.mouseClickLeft=function(){nop()};
WorldMorph.prototype.mouseDownRight=function(){nop()};WorldMorph.prototype.mouseClickRight=function(){nop()};WorldMorph.prototype.wantsDropOf=function(){return this.acceptsDrops};WorldMorph.prototype.droppedImage=function(){return null};WorldMorph.prototype.nextTab=function(a){var b=this.nextEntryField(a);a.clearSelection();b.selectAll();b.edit()};WorldMorph.prototype.previousTab=function(a){var b=this.previousEntryField(a);a.clearSelection();b.selectAll();b.edit()};
WorldMorph.prototype.contextMenu=function(){var a;a=this.isDevMode?new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]):new MenuMorph(this,"Morphic");this.isDevMode&&(a.addItem("demo...","userCreateMorph","sample morphs"),a.addLine(),a.addItem("hide all...","hideAll"),a.addItem("show all...","showAllHiddens"),a.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible"),a.addItem("inspect...","inspect","open a window on\nall properties"),
a.addLine(),a.addItem("restore display","changed","redraw the\nscreen once"),a.addItem("fill page...","fillPage","let the World automatically\nadjust to browser resizings"),useBlurredShadows?a.addItem("sharp shadows...","toggleBlurredShadows","sharp drop shadows\nuse for old browsers"):a.addItem("blurred shadows...","toggleBlurredShadows","blurry shades,\n use for new browsers"),a.addItem("color...",function(){this.pickColor(a.title+"\ncolor:",this.setColor,this,this.color)},"choose the World's\nbackground color"),
MorphicPreferences===standardSettings?a.addItem("touch screen settings","togglePreferences","bigger menu fonts\nand sliders"):a.addItem("standard settings","togglePreferences","smaller menu fonts\nand sliders"),a.addLine());this.isDevMode?a.addItem("user mode...","toggleDevMode","disable developers'\ncontext menus"):a.addItem("development mode...","toggleDevMode");a.addItem("about morphic.js...","about");return a};
WorldMorph.prototype.userCreateMorph=function(){function a(a){a.isDraggable=!0;a.pickUp(b)}var b=this,c,d;c=new MenuMorph(this,"make a morph");c.addItem("rectangle",function(){a(new Morph)});c.addItem("box",function(){a(new BoxMorph)});c.addItem("circle box",function(){a(new CircleBoxMorph)});c.addLine();c.addItem("slider",function(){a(new SliderMorph)});c.addItem("frame",function(){d=new FrameMorph;d.setExtent(new Point(350,250));a(d)});c.addItem("scroll frame",function(){d=new ScrollFrameMorph;
d.contents.acceptsDrops=!0;d.contents.adjustBounds();d.setExtent(new Point(350,250));a(d)});c.addItem("handle",function(){a(new HandleMorph)});c.addLine();c.addItem("string",function(){d=new StringMorph("Hello, World!");d.isEditable=!0;a(d)});c.addItem("text",function(){d=new TextMorph("Ich wei\u00df nicht, was soll es bedeuten, dass ich so traurig bin, ein M\u00e4rchen aus uralten Zeiten, das kommt mir nicht aus dem Sinn. Die Luft ist k\u00fchl und es dunkelt, und ruhig flie\u00dft der Rhein; der Gipfel des Berges funkelt im Abendsonnenschein. Die sch\u00f6nste Jungfrau sitzet dort oben wunderbar, ihr gold'nes Geschmeide blitzet, sie k\u00e4mmt ihr goldenes Haar, sie k\u00e4mmt es mit goldenem Kamme, und singt ein Lied dabei; das hat eine wundersame, gewalt'ge Melodei. Den Schiffer im kleinen Schiffe, ergreift es mit wildem Weh; er schaut nicht die Felsenriffe, er schaut nur hinauf in die H\u00f6h'. Ich glaube, die Wellen verschlingen am Ende Schiffer und Kahn, und das hat mit ihrem Singen, die Loreley getan.");
d.isEditable=!0;d.maxWidth=300;d.drawNew();a(d)});c.addItem("speech bubble",function(){d=new SpeechBubbleMorph("Hello, World!");a(d)});c.addLine();c.addItem("gray scale palette",function(){a(new GrayPaletteMorph)});c.addItem("color palette",function(){a(new ColorPaletteMorph)});c.addItem("color picker",function(){a(new ColorPickerMorph)});c.addLine();c.addItem("sensor demo",function(){d=new MouseSensorMorph;d.setColor(new Color(230,200,100));d.edge=35;d.border=15;d.borderColor=new Color(200,100,50);
d.alpha=0.2;d.setExtent(new Point(100,100));a(d)});c.addItem("animation demo",function(){var b,c,d,h,i;b=new BouncerMorph;b.setPosition(new Point(50,20));b.setExtent(new Point(300,200));b.alpha=0.9;b.speed=3;c=new BouncerMorph;c.setColor(new Color(50,50,50));c.setPosition(new Point(80,80));c.setExtent(new Point(80,250));c.type="horizontal";c.direction="right";c.alpha=0.9;c.speed=5;d=new BouncerMorph;d.setColor(new Color(20,20,20));d.setPosition(new Point(90,140));d.setExtent(new Point(40,30));d.type=
"horizontal";d.direction="right";d.speed=3;h=new BouncerMorph;h.setColor(new Color(200,20,20));h.setPosition(new Point(90,140));h.setExtent(new Point(20,20));h.type="vertical";h.direction="up";h.speed=8;i=new BouncerMorph;i.setColor(new Color(20,200,20));i.setPosition(new Point(120,140));i.setExtent(new Point(20,20));i.type="vertical";i.direction="down";i.speed=4;c.add(h);c.add(d);b.add(i);b.add(c);a(b)});c.addItem("pen",function(){a(new PenMorph)});b.customMorphs&&(c.addLine(),b.customMorphs().forEach(function(b){c.addItem(b.toString(),
function(){a(b)})}));c.popUpAtHand(this)};WorldMorph.prototype.toggleDevMode=function(){this.isDevMode=!this.isDevMode};WorldMorph.prototype.hideAll=function(){this.children.forEach(function(a){a.hide()})};WorldMorph.prototype.showAllHiddens=function(){this.forAllChildren(function(a){a.isVisible||a.show()})};
WorldMorph.prototype.about=function(){var a="",b;for(b in modules)modules.hasOwnProperty(b)&&(a+="\n"+b+" ("+modules[b]+")");""!==a&&(a="\n\nmodules:\n\nmorphic ("+morphicVersion+")"+a);this.inform("morphic.js\n\na lively Web GUI\ninspired by Squeak\n"+morphicVersion+"\n\nwritten by Jens M\u00f6nig\njens@moenig.org"+a)};
WorldMorph.prototype.edit=function(a){if(!a.isEditable)return null;this.cursor&&this.cursor.destroy();this.lastEditedText&&this.lastEditedText.clearSelection();this.cursor=new CursorMorph(a);a.parent.add(this.cursor);this.keyboardReceiver=this.cursor;MorphicPreferences.useVirtualKeyboard&&(a.parentThatIsA(MenuMorph)||this.slide(a))};
WorldMorph.prototype.slide=function(a){var b=parseFloat(a.text),c;isNaN(b)&&(b=0);c=new MenuMorph;b=new SliderMorph(b-25,b+25,b,10,"horizontal");b.alpha=1;b.color=new Color(225,225,225);b.button.color=c.borderColor;b.button.highlightColor=b.button.color.copy();b.button.highlightColor.b+=100;b.button.pressColor=b.button.color.copy();b.button.pressColor.b+=150;b.silentSetHeight(MorphicPreferences.scrollBarSize);b.silentSetWidth(10*MorphicPreferences.menuFontSize);b.drawNew();b.action=function(b){a.changed();
a.text=Math.round(b).toString();a.drawNew();a.changed()};c.items.push(b);c.popup(this,a.bottomLeft().add(new Point(0,5)))};WorldMorph.prototype.stopEditing=function(){this.cursor&&(this.lastEditedText=this.cursor.target,this.cursor.destroy());this.keyboardReceiver=null};WorldMorph.prototype.toggleBlurredShadows=function(){useBlurredShadows=!useBlurredShadows};WorldMorph.prototype.togglePreferences=function(){MorphicPreferences=MorphicPreferences===standardSettings?touchScreenSettings:standardSettings};
modules.widgets="2012-Mar-21";PushButtonMorph.prototype=new TriggerMorph;PushButtonMorph.prototype.constructor=PushButtonMorph;PushButtonMorph.uber=TriggerMorph.prototype;PushButtonMorph.prototype.fontSize=10;PushButtonMorph.prototype.fontStyle="sans-serif";PushButtonMorph.prototype.labelColor=new Color(0,0,0);PushButtonMorph.prototype.labelShadowColor=new Color(240,240,240);PushButtonMorph.prototype.labelShadowOffset=new Point(1,1);PushButtonMorph.prototype.color=new Color(220,220,220);
PushButtonMorph.prototype.pressColor=new Color(115,180,240);PushButtonMorph.prototype.highlightColor=PushButtonMorph.prototype.pressColor.lighter(50);PushButtonMorph.prototype.outlineColor=new Color(30,30,30);PushButtonMorph.prototype.outlineGradient=!1;PushButtonMorph.prototype.contrast=60;PushButtonMorph.prototype.edge=2;PushButtonMorph.prototype.corner=5;PushButtonMorph.prototype.outline=1.00001;PushButtonMorph.prototype.padding=3;function PushButtonMorph(a,b,c,d,e,f){this.init(a,b,c,d,e,f)}
PushButtonMorph.prototype.init=function(a,b,c,d,e,f){this.target=a||null;this.action=b||null;this.environment=d||null;this.labelString=c||null;this.label=null;this.hint=e||null;this.template=f||null;TriggerMorph.uber.init.call(this);this.color=PushButtonMorph.prototype.color;this.drawNew();this.fixLayout()};PushButtonMorph.prototype.fixLayout=function(){if(null!==this.label){var a=2*this.padding+2*this.outline+2*this.edge;this.setExtent(new Point(this.label.width()+a,this.label.height()+a));this.label.setCenter(this.center())}};
PushButtonMorph.prototype.mouseDownLeft=function(){PushButtonMorph.uber.mouseDownLeft.call(this);this.label&&this.label.setCenter(this.center().add(1))};PushButtonMorph.prototype.mouseClickLeft=function(){PushButtonMorph.uber.mouseClickLeft.call(this);this.label&&this.label.setCenter(this.center())};PushButtonMorph.prototype.mouseLeave=function(){PushButtonMorph.uber.mouseLeave.call(this);this.label&&this.label.setCenter(this.center())};PushButtonMorph.prototype.outlinePath=BoxMorph.prototype.outlinePath;
PushButtonMorph.prototype.drawOutline=function(a){var b;if(!this.outline)return null;this.outlineGradient?(b=a.createLinearGradient(0.45*this.width(),0,0.55*this.width(),this.height()),b.addColorStop(1,"white"),b.addColorStop(0,this.outlineColor.darker().toString())):b=this.outlineColor.toString();a.fillStyle=b;a.beginPath();this.outlinePath(a,this.corner,0);a.closePath();a.fill()};
PushButtonMorph.prototype.drawBackground=function(a,b){a.fillStyle=b.toString();a.beginPath();this.outlinePath(a,Math.max(this.corner-this.outline,0),this.outline);a.closePath();a.fill();a.lineWidth=this.outline};
PushButtonMorph.prototype.drawEdges=function(a,b,c,d){var e=Math.max(this.corner,this.outline+this.edge),f=this.width(),g=this.height(),h;h=a.createLinearGradient(0,this.outline,0,this.outline+this.edge);h.addColorStop(0,c.toString());h.addColorStop(1,b.toString());a.strokeStyle=h;a.lineCap="round";a.lineWidth=this.edge;a.beginPath();a.moveTo(e,this.outline+this.edge/2);a.lineTo(f-e,this.outline+this.edge/2);a.stroke();h=a.createRadialGradient(this.corner,this.corner,Math.max(this.corner-this.outline-
this.edge,0),this.corner,this.corner,Math.max(this.corner-this.outline,0));h.addColorStop(1,c.toString());h.addColorStop(0,b.toString());a.strokeStyle=h;a.lineCap="round";a.lineWidth=this.edge;a.beginPath();a.arc(this.corner,this.corner,Math.max(this.corner-this.outline-this.edge/2,0),radians(180),radians(270),!1);a.stroke();h=a.createLinearGradient(this.outline,0,this.outline+this.edge,0);h.addColorStop(0,c.toString());h.addColorStop(1,b.toString());a.strokeStyle=h;a.lineCap="round";a.lineWidth=
this.edge;a.beginPath();a.moveTo(this.outline+this.edge/2,e);a.lineTo(this.outline+this.edge/2,g-e);a.stroke();h=a.createLinearGradient(0,g-this.outline,0,g-this.outline-this.edge);h.addColorStop(0,d.toString());h.addColorStop(1,b.toString());a.strokeStyle=h;a.lineCap="round";a.lineWidth=this.edge;a.beginPath();a.moveTo(e,g-this.outline-this.edge/2);a.lineTo(f-e,g-this.outline-this.edge/2);a.stroke();h=a.createRadialGradient(f-this.corner,g-this.corner,Math.max(this.corner-this.outline-this.edge,
0),f-this.corner,g-this.corner,Math.max(this.corner-this.outline,0));h.addColorStop(1,d.toString());h.addColorStop(0,b.toString());a.strokeStyle=h;a.lineCap="round";a.lineWidth=this.edge;a.beginPath();a.arc(f-this.corner,g-this.corner,Math.max(this.corner-this.outline-this.edge/2,0),radians(0),radians(90),!1);a.stroke();h=a.createLinearGradient(f-this.outline,0,f-this.outline-this.edge,0);h.addColorStop(0,d.toString());h.addColorStop(1,b.toString());a.strokeStyle=h;a.lineCap="round";a.lineWidth=this.edge;
a.beginPath();a.moveTo(f-this.outline-this.edge/2,e);a.lineTo(f-this.outline-this.edge/2,g-e);a.stroke()};
PushButtonMorph.prototype.createBackgrounds=function(){var a,b=this.extent();if(this.template)return this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null;this.normalImage=newCanvas(b);a=this.normalImage.getContext("2d");this.drawOutline(a);this.drawBackground(a,this.color);this.drawEdges(a,this.color,this.color.lighter(this.contrast),this.color.darker(this.contrast));this.highlightImage=
newCanvas(b);a=this.highlightImage.getContext("2d");this.drawOutline(a);this.drawBackground(a,this.highlightColor);this.drawEdges(a,this.highlightColor,this.highlightColor.lighter(this.contrast),this.highlightColor.darker(this.contrast));this.pressImage=newCanvas(b);a=this.pressImage.getContext("2d");this.drawOutline(a);this.drawBackground(a,this.pressColor);this.drawEdges(a,this.pressColor,this.pressColor.darker(this.contrast),this.pressColor.lighter(this.contrast));this.image=this.normalImage};
PushButtonMorph.prototype.createLabel=function(){null!==this.label&&this.label.destroy();this.label=new StringMorph(this.labelString,this.fontSize,this.fontStyle,!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor);this.add(this.label)};ToggleButtonMorph.prototype=new PushButtonMorph;ToggleButtonMorph.prototype.constructor=ToggleButtonMorph;ToggleButtonMorph.uber=PushButtonMorph.prototype;ToggleButtonMorph.prototype.contrast=30;
function ToggleButtonMorph(a,b,c,d,e,f,g,h,i,j){this.init(a,b,c,d,e,f,g,h,i,j)}ToggleButtonMorph.prototype.init=function(a,b,c,d,e,f,g,h,i,j){this.state=!1;this.query=e||function(){return!0};this.minWidth=i||null;this.hasPreview=j||!1;ToggleButtonMorph.uber.init.call(this,b,c,d,f,g,h);a&&(this.color=a[0],this.highlightColor=a[1],this.pressColor=a[2]);this.refresh();this.drawNew()};
ToggleButtonMorph.prototype.mouseEnter=function(){this.state||(this.image=this.highlightImage,this.changed());this.hint&&this.bubbleHelp(this.hint)};ToggleButtonMorph.prototype.mouseLeave=function(){this.state||(this.image=this.normalImage,this.changed());this.hint&&this.world().hand.destroyTemporaries()};ToggleButtonMorph.prototype.mouseDownLeft=function(){this.state||(this.image=this.pressImage,this.changed())};
ToggleButtonMorph.prototype.mouseClickLeft=function(){this.state||(this.image=this.highlightImage,this.changed());this.trigger()};ToggleButtonMorph.prototype.trigger=function(){ToggleButtonMorph.uber.trigger.call(this);this.refresh()};ToggleButtonMorph.prototype.refresh=function(){this.image=(this.state="function"===typeof this.query?this.query.call(this.target):this.target[this.query].call(this.target))?this.pressImage:this.normalImage;this.changed()};
ToggleButtonMorph.prototype.fixLayout=function(){if(null!==this.label){var a=this.label.width(),b=2*this.padding+2*this.outline+2*this.edge;this.setExtent(new Point(this.minWidth?Math.max(this.minWidth,a)+b:a+b,this.label.height()+b));this.label.setCenter(this.center());this.minWidth&&this.label.setLeft(this.left()+this.outline+this.edge+this.corner+this.padding)}};
ToggleButtonMorph.prototype.createBackgrounds=function(){var a,b=this.extent();if(this.template)return this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null;this.normalImage=newCanvas(b);a=this.normalImage.getContext("2d");this.drawOutline(a);this.drawBackground(a,this.color);this.drawEdges(a,this.color,this.color.lighter(this.contrast),this.color.darker(this.contrast));this.highlightImage=
newCanvas(b);a=this.highlightImage.getContext("2d");this.drawOutline(a);this.drawBackground(a,this.highlightColor);this.drawEdges(a,this.highlightColor,this.highlightColor.lighter(this.contrast),this.highlightColor.darker(this.contrast));this.pressImage=newCanvas(b);a=this.pressImage.getContext("2d");this.drawOutline(a);this.drawBackground(a,this.pressColor);this.drawEdges(a,this.pressColor,this.pressColor.lighter(40),this.pressColor.darker(40));this.image=this.normalImage};
ToggleButtonMorph.prototype.drawEdges=function(a,b,c,d){ToggleButtonMorph.uber.drawEdges.call(this,a,b,c,d);this.hasPreview&&(b=a.createLinearGradient(0,0,this.corner,0),b.addColorStop(0,this.pressColor.lighter(40).toString()),b.addColorStop(1,this.pressColor.darker(40).toString()),a.fillStyle=b,a.beginPath(),this.previewPath(a,Math.max(this.corner-this.outline,0),this.outline),a.closePath(),a.fill())};
ToggleButtonMorph.prototype.previewPath=function(a,b,c){var c=b+c,d=this.height();a.arc(c,c,b,radians(-180),radians(-90),!1);a.arc(c,d-c,b,radians(90),radians(180),!1)};TabMorph.prototype=new ToggleButtonMorph;TabMorph.prototype.constructor=TabMorph;TabMorph.uber=ToggleButtonMorph.prototype;function TabMorph(a,b,c,d,e,f,g){this.init(a,b,c,d,e,f,g)}
TabMorph.prototype.fixLayout=function(){null!==this.label&&(this.setExtent(new Point(this.label.width()+2*this.padding+3*this.corner+2*this.edge,this.label.height()+2*this.padding+this.edge)),this.label.setCenter(this.center()))};TabMorph.prototype.refresh=function(){this.state&&this.parent&&this.parent.add(this);TabMorph.uber.refresh.call(this)};
TabMorph.prototype.drawBackground=function(a,b){var c=this.width(),d=this.height(),e=this.corner;a.fillStyle=b.toString();a.beginPath();a.moveTo(0,d);a.bezierCurveTo(e,d,e,0,2*e,0);a.lineTo(c-2*e,0);a.bezierCurveTo(c-e,0,c-e,d,c,d);a.closePath();a.fill()};TabMorph.prototype.drawOutline=function(){nop()};
TabMorph.prototype.drawEdges=function(a,b,c,d){var e=this.width(),f=this.height(),g=this.corner,h=this.edge,i=h/2;nop(b);b=a.createLinearGradient(0,0,e,0);b.addColorStop(0,c.toString());b.addColorStop(1,d.toString());a.strokeStyle=b;a.lineCap="round";a.lineWidth=h;a.beginPath();a.moveTo(0,f+i);a.bezierCurveTo(g,f,g,0,2*g,i);a.lineTo(e-2*g,i);a.bezierCurveTo(e-g,0,e-g,f,e,f+i);a.stroke()};ToggleMorph.prototype=new PushButtonMorph;ToggleMorph.prototype.constructor=ToggleMorph;ToggleMorph.uber=PushButtonMorph.prototype;
function ToggleMorph(a,b,c,d,e,f,g,h,i,j){this.init(a,b,c,d,e,f,g,h,i,j)}
ToggleMorph.prototype.init=function(a,b,c,d,e,f,g,h,i,j){this.padding=1;a=a||"checkbox";this.corner="checkbox"===a?0:fontHeight(this.fontSize)/2+this.outline+this.padding;this.state=!1;this.query=e||function(){return!0};this.tick=null;this.captionString=d||null;this.labelAlignment="right";this.element=i||null;this.builder=j||null;this.toggleElement=null;ToggleMorph.uber.init.call(this,b,c,"checkbox"===a?"\u2713":"\u25cf",f,g,h);this.refresh();this.drawNew()};
ToggleMorph.prototype.fixLayout=function(){var a=2*this.padding+2*this.outline,b;null!==this.tick&&(this.silentSetHeight(this.tick.height()+a),this.silentSetWidth(this.tick.width()+a),this.setExtent(new Point(Math.max(this.width(),this.height()),Math.max(this.width(),this.height()))),this.tick.setCenter(this.center()));this.state?this.tick.show():this.tick.hide();this.toggleElement&&"right"===this.labelAlignment&&(b=this.top()+(this.height()-this.toggleElement.height())/2,this.toggleElement.setPosition(new Point(this.right()+
a,b)));null!==this.label&&(b=this.top()+(this.height()-this.label.height())/2,"right"===this.labelAlignment?this.label.setPosition(new Point(this.toggleElement?this.toggleElement instanceof ToggleElementMorph?this.toggleElement.right():this.toggleElement.right()+a:this.right()+a,b)):this.label.setPosition(new Point(this.left()-this.label.width()-a,b)))};
ToggleMorph.prototype.createLabel=function(){null===this.label&&this.captionString&&(this.label=new TextMorph(this.captionString,this.fontSize,this.fontStyle,!0),this.add(this.label));null===this.tick&&(this.tick=new StringMorph(this.labelString,this.fontSize,this.fontStyle,!0,!1,!1,new Point(1,1),new Color(240,240,240)),this.add(this.tick));null===this.toggleElement&&this.element&&(this.element instanceof Morph?this.toggleElement=new ToggleElementMorph(this.target,this.action,this.element,this.query,
this.environment,this.hint,this.builder):this.element instanceof HTMLCanvasElement&&(this.toggleElement=new Morph,this.toggleElement.silentSetExtent(new Point(this.element.width,this.element.height)),this.toggleElement.image=this.element),this.add(this.toggleElement))};ToggleMorph.prototype.trigger=function(){ToggleMorph.uber.trigger.call(this);this.refresh()};
ToggleMorph.prototype.refresh=function(){(this.state="function"===typeof this.query?this.query.call(this.target):this.target[this.query].call(this.target))?this.tick.show():this.tick.hide();this.toggleElement&&this.toggleElement.refresh&&this.toggleElement.refresh()};ToggleMorph.prototype.mouseDownLeft=function(){PushButtonMorph.uber.mouseDownLeft.call(this);this.tick&&this.tick.setCenter(this.center().add(1))};
ToggleMorph.prototype.mouseClickLeft=function(){PushButtonMorph.uber.mouseClickLeft.call(this);this.tick&&this.tick.setCenter(this.center())};ToggleMorph.prototype.mouseLeave=function(){PushButtonMorph.uber.mouseLeave.call(this);this.tick&&this.tick.setCenter(this.center())};ToggleElementMorph.prototype=new TriggerMorph;ToggleElementMorph.prototype.constructor=ToggleElementMorph;ToggleElementMorph.uber=TriggerMorph.prototype;ToggleElementMorph.prototype.contrast=50;
ToggleElementMorph.prototype.shadowOffset=new Point(2,2);ToggleElementMorph.prototype.shadowAlpha=0.6;ToggleElementMorph.prototype.fontSize=10;ToggleElementMorph.prototype.inactiveColor=new Color(180,180,180);function ToggleElementMorph(a,b,c,d,e,f,g,h){this.init(a,b,c,d,e,f,g,h)}
ToggleElementMorph.prototype.init=function(a,b,c,d,e,f,g,h){this.target=a||null;this.action=b||null;this.element=c;this.query=d||function(){return!0};this.environment=e||null;this.hint=f||null;this.builder=g||"nop";this.captionString=h||null;this.labelAlignment="right";this.state=!1;TriggerMorph.uber.init.call(this);this.color=c.color;this.createLabel()};
ToggleElementMorph.prototype.createBackgrounds=function(){this.color=this.element.color;this.element.removeShadow();this.element[this.builder].call(this.element);this.element.addShadow(this.shadowOffset,this.shadowAlpha);this.silentSetExtent(this.element.fullBounds().extent());this.pressImage=this.element.fullImage();this.element.removeShadow();this.element.setColor(this.inactiveColor);this.element[this.builder].call(this.element,this.contrast);this.element.addShadow(this.shadowOffset,0);this.normalImage=
this.element.fullImage();this.element.removeShadow();this.element.setColor(this.color.lighter(this.contrast));this.element[this.builder].call(this.element,this.contrast);this.element.addShadow(this.shadowOffset,this.shadowAlpha);this.highlightImage=this.element.fullImage();this.element.removeShadow();this.element.setColor(this.color);this.element[this.builder].call(this.element);this.image=this.normalImage};
ToggleElementMorph.prototype.setColor=function(a){this.element.setColor(a);this.createBackgrounds();this.refresh()};ToggleElementMorph.prototype.createLabel=function(){var a;this.captionString&&(this.label=new StringMorph(this.captionString,this.fontSize,this.fontStyle,!0),this.add(this.label),a=this.top()+(this.height()-this.label.height())/2,"right"===this.labelAlignment?this.label.setPosition(new Point(this.right(),a)):this.label.setPosition(new Point(this.left()-this.label.width(),a)))};
ToggleElementMorph.prototype.trigger=ToggleButtonMorph.prototype.trigger;ToggleElementMorph.prototype.refresh=ToggleButtonMorph.prototype.refresh;ToggleElementMorph.prototype.mouseEnter=ToggleButtonMorph.prototype.mouseEnter;ToggleElementMorph.prototype.mouseLeave=ToggleButtonMorph.prototype.mouseLeave;ToggleElementMorph.prototype.mouseDownLeft=ToggleButtonMorph.prototype.mouseDownLeft;ToggleElementMorph.prototype.mouseClickLeft=ToggleButtonMorph.prototype.mouseClickLeft;
DialogBoxMorph.prototype=new Morph;DialogBoxMorph.prototype.constructor=DialogBoxMorph;DialogBoxMorph.uber=Morph.prototype;DialogBoxMorph.prototype.fontSize=12;DialogBoxMorph.prototype.titleFontSize=14;DialogBoxMorph.prototype.fontStyle="sans-serif";DialogBoxMorph.prototype.color=PushButtonMorph.prototype.color;DialogBoxMorph.prototype.titleTextColor=new Color(255,255,255);DialogBoxMorph.prototype.titleBarColor=PushButtonMorph.prototype.pressColor;DialogBoxMorph.prototype.contrast=40;
DialogBoxMorph.prototype.corner=12;DialogBoxMorph.prototype.padding=14;DialogBoxMorph.prototype.titlePadding=8;DialogBoxMorph.prototype.buttonContrast=50;DialogBoxMorph.prototype.buttonFontSize=12;DialogBoxMorph.prototype.buttonCorner=12;DialogBoxMorph.prototype.buttonEdge=6;DialogBoxMorph.prototype.buttonPadding=0;DialogBoxMorph.prototype.buttonOutline=3;DialogBoxMorph.prototype.buttonOutlineColor=PushButtonMorph.prototype.color;DialogBoxMorph.prototype.buttonOutlineGradient=!0;
function DialogBoxMorph(a,b,c){this.init(a,b,c)}DialogBoxMorph.prototype.init=function(a,b,c){this.target=a||null;this.action=b||null;this.environment=c||null;this.buttons=this.body=this.head=this.label=this.labelString=null;DialogBoxMorph.uber.init.call(this);this.isDraggable=!0;this.color=PushButtonMorph.prototype.color;this.createLabel();this.createButtons();this.setExtent(new Point(300,150))};
DialogBoxMorph.prototype.inform=function(a,b,c,d){b=new TextMorph(b,this.fontSize,this.fontStyle,!0,!1,"center");this.labelString=a;this.createLabel();d&&this.setPicture(d);this.addBody(b);this.addButton("ok","Ok");this.drawNew();this.fixLayout();c&&(c.add(this),c.keyboardReceiver=this,this.setCenter(c.center()))};
DialogBoxMorph.prototype.askYesNo=function(a,b,c,d){b=new TextMorph(b,this.fontSize,this.fontStyle,!0,!1,"center");this.labelString=a;this.createLabel();d&&this.setPicture(d);this.addBody(b);this.addButton("ok","Yes");this.addButton("cancel","No");this.fixLayout();this.drawNew();this.fixLayout();c&&(c.add(this),c.keyboardReceiver=this,this.setCenter(c.center()))};
DialogBoxMorph.prototype.prompt=function(a,b,c,d){b=new InputFieldMorph(b);b.setWidth(250);this.labelString=a;this.createLabel();d&&this.setPicture(d);this.addBody(b);b.drawNew();this.addButton("ok","Ok");this.addButton("cancel","Cancel");this.fixLayout();this.drawNew();this.fixLayout();c&&(c.add(this),this.setCenter(c.center()),this.edit())};
DialogBoxMorph.prototype.accept=function(){this.action&&("function"===typeof this.target?"function"===typeof this.action?this.target.call(this.environment,this.action.call()):this.target.call(this.environment,this.action):"function"===typeof this.action?this.action.call(this.target,this.getInput()):this.target[this.action].call(this.target,this.getInput()));this.destroy()};DialogBoxMorph.prototype.ok=function(){this.accept()};DialogBoxMorph.prototype.cancel=function(){this.destroy()};
DialogBoxMorph.prototype.edit=function(){this.children.forEach(function(a){if(a.edit)return a.edit()})};DialogBoxMorph.prototype.getInput=function(){return this.body instanceof InputFieldMorph?this.body.getValue():null};DialogBoxMorph.prototype.justDropped=function(a){a.world.keyboardReceiver=this;this.edit()};DialogBoxMorph.prototype.destroy=function(){this.world().keyboardReceiver=null;DialogBoxMorph.uber.destroy.call(this)};
DialogBoxMorph.prototype.normalizeSpaces=function(a){var b="",c,d,e=!1;for(c=0;c<a.length;c+=1)d=a[c]," "===d?e&&(b+=d,e=!1):(b+=d,e=!0);return b.trim()};DialogBoxMorph.prototype.createLabel=function(){this.label&&this.label.destroy();this.labelString&&(this.label=new StringMorph(this.labelString,this.titleFontSize,this.fontStyle,!0,!1,!1,new Point(2,1),this.titleBarColor.darker(this.contrast)),this.label.color=this.titleTextColor,this.label.drawNew(),this.add(this.label))};
DialogBoxMorph.prototype.createButtons=function(){this.buttons&&this.buttons.destroy();this.buttons=new AlignmentMorph("row",this.padding);this.add(this.buttons)};
DialogBoxMorph.prototype.addButton=function(a,b){var c=new PushButtonMorph(this,a||"ok","  "+(b||"Ok")+"  ");c.fontSize=this.buttonFontSize;c.corner=this.buttonCorner;c.edge=this.buttonEdge;c.outline=this.buttonOutline;c.outlineColor=this.buttonOutlineColor;c.outlineGradient=this.buttonOutlineGradient;c.padding=this.buttonPadding;c.contrast=this.buttonContrast;c.drawNew();c.fixLayout();this.buttons.add(c);return c};
DialogBoxMorph.prototype.setPicture=function(a){var b;a instanceof Morph?b=a:(b=new Morph,b.image=a,b.silentSetWidth(a.width),b.silentSetHeight(a.height));this.addHead(b)};DialogBoxMorph.prototype.addHead=function(a){this.head&&this.head.destroy();this.head=a;this.add(this.head)};DialogBoxMorph.prototype.addBody=function(a){this.body&&this.body.destroy();this.body=a;this.add(this.body)};DialogBoxMorph.prototype.addShadow=function(){nop()};DialogBoxMorph.prototype.removeShadow=function(){nop()};
DialogBoxMorph.prototype.fixLayout=function(){var a=fontHeight(this.titleFontSize)+2*this.titlePadding,b;this.head&&(this.head.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.silentSetWidth(this.head.width()+2*this.padding),this.silentSetHeight(this.head.height()+2*this.padding+a));this.body&&(this.head?(this.body.setPosition(this.head.bottomLeft().add(new Point(0,this.padding))),this.silentSetWidth(Math.max(this.width(),this.body.width()+2*this.padding)),this.silentSetHeight(this.height()+
this.body.height()+this.padding),b=this.width(),this.head.setLeft(this.left()+(b-this.head.width())/2),this.body.setLeft(this.left()+(b-this.body.width())/2)):(this.body.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+a)));this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(a-this.label.height())/2));this.buttons&&0<this.buttons.children.length&&
(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))};DialogBoxMorph.prototype.processKeyPress=function(){nop()};DialogBoxMorph.prototype.processKeyDown=function(a){switch(a.keyCode){case 13:this.ok();break;case 27:this.cancel()}};
DialogBoxMorph.prototype.drawNew=function(){this.fullChanged();Morph.prototype.trackChanges=!1;DialogBoxMorph.uber.removeShadow.call(this);this.fixLayout();var a,b,c=this.width(),d=this.height(),e=fontHeight(this.titleFontSize)+2*this.titlePadding,f=this.corner/2,g;this.image=newCanvas(this.extent());a=this.image.getContext("2d");b=a.createLinearGradient(0,0,0,e);b.addColorStop(0,this.titleBarColor.lighter(this.contrast/2).toString());b.addColorStop(1,this.titleBarColor.darker(this.contrast).toString());
a.fillStyle=b;a.beginPath();this.outlinePathTitle(a,this.corner);a.closePath();a.fill();a.fillStyle=this.color.toString();a.beginPath();this.outlinePathBody(a,this.corner);a.closePath();a.fill();b=a.createLinearGradient(0,d-this.corner,0,d);b.addColorStop(0,this.color.toString());b.addColorStop(1,this.color.darker(this.contrast.toString()));a.lineWidth=this.corner;a.lineCap="round";a.strokeStyle=b;a.beginPath();a.moveTo(this.corner,d-f);a.lineTo(this.corner+1,d-f);a.stroke();b=a.createLinearGradient(0,
d-this.corner,0,d);b.addColorStop(0,this.color.toString());b.addColorStop(1,this.color.darker(this.contrast.toString()));a.lineWidth=this.corner;a.lineCap="butt";a.strokeStyle=b;a.beginPath();a.moveTo(this.corner,d-f);a.lineTo(c-this.corner,d-f);a.stroke();b=a.createLinearGradient(c-this.corner,0,c,0);b.addColorStop(0,this.color.toString());b.addColorStop(1,this.color.darker(this.contrast).toString());a.lineWidth=this.corner;a.lineCap="butt";a.strokeStyle=b;a.beginPath();a.moveTo(c-f,e);a.lineTo(c-
f,d-this.corner);a.stroke();c-=this.corner;g=d-this.corner;b=a.createRadialGradient(c,g,0,c,g,this.corner);b.addColorStop(0,this.color.toString());b.addColorStop(1,this.color.darker(this.contrast.toString()));a.lineCap="butt";a.strokeStyle=b;a.beginPath();a.arc(c,g,f,radians(90),radians(0),!0);a.stroke();b=a.createLinearGradient(0,0,this.corner,0);b.addColorStop(1,this.color.toString());b.addColorStop(0,this.color.lighter(this.contrast).toString());a.lineCap="butt";a.strokeStyle=b;a.beginPath();a.moveTo(f,
e);a.lineTo(f,d-2*this.corner);a.stroke();b=a.createLinearGradient(0,0,this.corner,0);b.addColorStop(1,this.color.toString());b.addColorStop(0,this.color.lighter(this.contrast).toString());a.lineCap="round";a.strokeStyle=b;a.beginPath();a.moveTo(f,d-2*this.corner);a.lineTo(f,d-this.corner-f);a.stroke();DialogBoxMorph.uber.addShadow.call(this);Morph.prototype.trackChanges=!0;this.fullChanged()};
DialogBoxMorph.prototype.outlinePathTitle=function(a,b){var c=this.width(),d=fontHeight(this.titleFontSize)+2*this.titlePadding;a.arc(b,b,b,radians(-180),radians(-90),!1);a.arc(c-b,b,b,radians(-90),radians(-0.0),!1);a.lineTo(c,d);a.lineTo(0,d)};DialogBoxMorph.prototype.outlinePathBody=function(a,b){var c=this.width(),d=this.height(),e=fontHeight(this.titleFontSize)+2*this.titlePadding;a.moveTo(0,e);a.lineTo(c,e);a.arc(c-b,d-b,b,radians(0),radians(90),!1);a.arc(b,d-b,b,radians(90),radians(180),!1)};
AlignmentMorph.prototype=new Morph;AlignmentMorph.prototype.constructor=AlignmentMorph;AlignmentMorph.uber=Morph.prototype;function AlignmentMorph(a,b){this.init(a,b)}AlignmentMorph.prototype.init=function(a,b){this.orientation=a||"row";this.padding=b||0;this.respectHiddens=!1;AlignmentMorph.uber.init.call(this)};AlignmentMorph.prototype.drawNew=function(){this.image=newCanvas(new Point(1,1));this.fixLayout()};
AlignmentMorph.prototype.fixLayout=function(){var a=this,b=null,c;if(0===this.children.length)return null;this.children.forEach(function(d){var e=d.fullBounds(),f;if(d.isVisible||a.respectHiddens)b?(f=b.fullBounds(),"row"===a.orientation?d.setPosition(f.topRight().add(new Point(a.padding,(f.height()-e.height())/2))):d.setPosition(f.bottomLeft().add(new Point((f.width()-e.width())/2,a.padding))),c=c.merge(e)):c=e,b=d});this.bounds=c};InputFieldMorph.prototype=new Morph;
InputFieldMorph.prototype.constructor=InputFieldMorph;InputFieldMorph.uber=Morph.prototype;InputFieldMorph.prototype.edge=2;InputFieldMorph.prototype.fontSize=12;InputFieldMorph.prototype.typeInPadding=4;InputFieldMorph.prototype.contrast=65;function InputFieldMorph(a,b){this.init(a,b)}
InputFieldMorph.prototype.init=function(a,b){var c=new StringFieldMorph(a||"");this.isNumeric=b||!1;c.alpha=0;c.fontSize=this.fontSize;c.drawNew();this.oldContentsExtent=c.extent();this.isNumeric=b||!1;InputFieldMorph.uber.init.call(this);this.color=new Color(255,255,255);this.add(c);c.isDraggable=!1;this.drawNew()};InputFieldMorph.prototype.contents=function(){return detect(this.children,function(a){return a instanceof StringFieldMorph})};
InputFieldMorph.prototype.setContents=function(a){var b=this.contents();b.text.text=a;if(void 0===a)return null;null===a?b.text.text="":a.toString&&(b.text.text=a.toString());b.drawNew()};InputFieldMorph.prototype.edit=function(){var a=this.contents();a.text.edit();a.text.selectAll()};InputFieldMorph.prototype.setIsNumeric=function(a){this.isNumeric=a;this.contents().isNumeric=a;this.contents().text.isNumeric=a;a=this.getValue();this.isNumeric&&(a=parseFloat(a),isNaN(a)&&(a=null));this.setContents(a)};
InputFieldMorph.prototype.fixLayout=function(){var a=this.contents();if(!a)return null;a.isNumeric=this.isNumeric;this.silentSetHeight(a.height()+2*this.edge+2*this.typeInPadding);this.silentSetWidth(Math.max(a.minWidth+2*this.edge+2*this.typeInPadding,this.width()));a.setWidth(this.width()-this.edge-this.typeInPadding);a.silentSetPosition((new Point(this.edge,this.edge)).add(this.typeInPadding).add(this.position()))};
InputFieldMorph.prototype.getValue=function(){var a,b=this.contents();return this.isNumeric&&(a=parseFloat(b.text),!isNaN(a))?a:b.string()};
InputFieldMorph.prototype.drawNew=function(){var a,b;this.fixLayout();this.image=newCanvas(this.extent());a=this.image.getContext("2d");this.parent?(this.color=this.parent.color.lighter(0.75*this.contrast),b=this.parent.color):b=new Color(120,120,120);a.fillStyle=this.color.toString();this.cachedClr=b.toString();this.cachedClrBright=b.lighter(this.contrast).toString();this.cachedClrDark=b.darker(this.contrast).toString();a.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge);
this.drawRectBorder(a)};
InputFieldMorph.prototype.drawRectBorder=function(a){var b=0.5*this.edge,c;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.shadowOffsetY=b;a.shadowBlur=this.height()/3;a.shadowColor=this.cachedClrDark;c=a.createLinearGradient(0,0,0,this.edge);c.addColorStop(0,this.cachedClr);c.addColorStop(1,this.cachedClrDark);a.strokeStyle=c;a.beginPath();a.moveTo(this.edge,b);a.lineTo(this.width()-this.edge-b,b);a.stroke();a.shadowOffsetY=0;c=a.createLinearGradient(0,0,this.edge,0);c.addColorStop(0,
this.cachedClr);c.addColorStop(1,this.cachedClrDark);a.strokeStyle=c;a.beginPath();a.moveTo(b,this.edge);a.lineTo(b,this.height()-this.edge-b);a.stroke();a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;c=a.createLinearGradient(0,this.height()-this.edge,0,this.height());c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.strokeStyle=c;a.beginPath();a.moveTo(this.edge,this.height()-b);a.lineTo(this.width()-this.edge,this.height()-b);a.stroke();c=a.createLinearGradient(this.width()-
this.edge,0,this.width(),0);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.strokeStyle=c;a.beginPath();a.moveTo(this.width()-b,this.edge);a.lineTo(this.width()-b,this.height()-this.edge);a.stroke()};modules.blocks="2012-Mar-27";SyntaxElementMorph.prototype=new Morph;SyntaxElementMorph.prototype.constructor=SyntaxElementMorph;SyntaxElementMorph.uber=Morph.prototype;SyntaxElementMorph.prototype.corner=3;SyntaxElementMorph.prototype.rounding=7;
SyntaxElementMorph.prototype.edge=1.000001;SyntaxElementMorph.prototype.inset=6;SyntaxElementMorph.prototype.hatHeight=12;SyntaxElementMorph.prototype.hatWidth=70;SyntaxElementMorph.prototype.rfBorder=3;SyntaxElementMorph.prototype.dent=8;SyntaxElementMorph.prototype.bottomPadding=3;SyntaxElementMorph.prototype.cSlotPadding=4;SyntaxElementMorph.prototype.typeInPadding=1;SyntaxElementMorph.prototype.labelPadding=5;SyntaxElementMorph.prototype.fontSize=10;
SyntaxElementMorph.prototype.embossing=new Point(-1,-1);SyntaxElementMorph.prototype.labelWidth=450;SyntaxElementMorph.prototype.labelWordWrap=!0;SyntaxElementMorph.prototype.feedbackColor=new Color(255,255,255);SyntaxElementMorph.prototype.feedbackMinHeight=5;SyntaxElementMorph.prototype.minSnapDistance=20;SyntaxElementMorph.prototype.reporterDropFeedbackPadding=10;SyntaxElementMorph.prototype.contrast=65;SyntaxElementMorph.prototype.labelContrast=25;
SyntaxElementMorph.prototype.activeHighlight=new Color(153,255,213);SyntaxElementMorph.prototype.errorHighlight=new Color(173,15,0);SyntaxElementMorph.prototype.activeBlur=20;SyntaxElementMorph.prototype.rfColor=new Color(120,120,120);function SyntaxElementMorph(){this.init()}SyntaxElementMorph.prototype.init=function(){this.cachedClrDark=this.cachedClrBright=this.cachedClr=null;this.isStatic=!1;SyntaxElementMorph.uber.init.call(this);this.defaults=[]};
SyntaxElementMorph.prototype.parts=function(){var a=null;this.nextBlock&&(a=this.nextBlock());return this.children.filter(function(b){return b!==a&&!(b instanceof ShadowMorph)&&!(b instanceof BlockHighlightMorph)})};SyntaxElementMorph.prototype.inputs=function(){return this.parts().filter(function(a){return a instanceof SyntaxElementMorph})};
SyntaxElementMorph.prototype.allInputs=function(){var a=this;return this.allChildren().slice(0).reverse().filter(function(b){return b instanceof ArgMorph||b instanceof ReporterBlockMorph&&b!==a})};SyntaxElementMorph.prototype.allEmptySlots=function(){return this.allInputs().reverse().filter(function(a){return a.isEmptySlot()})};
SyntaxElementMorph.prototype.replaceInput=function(a,b){var c=this.parentThatIsA(ScriptsMorph),d=this.children.indexOf(a);if(-1===d||null===c)return null;this.startLayout();b.parent&&b.parent.removeChild(b);b.parent=this;this.children[d]=b;if(a instanceof ReporterBlockMorph)c.add(a),a.moveBy(b.extent());else if(a instanceof CommandSlotMorph&&(d=a.nestedBlock()))c.add(d),d.moveBy(b.extent());b instanceof MultiArgMorph||b.constructor===CommandSlotMorph?b.fixLayout():(b.drawNew(),this.fixLayout());this.endLayout()};
SyntaxElementMorph.prototype.silentReplaceInput=function(a,b){var c=this.children.indexOf(a);-1!==c&&(b.parent&&b.parent.removeChild(b),b.parent=this,this.children[c]=b,b instanceof MultiArgMorph||b.constructor===CommandSlotMorph?b.fixLayout():(b.drawNew(),this.fixLayout()))};
SyntaxElementMorph.prototype.revertToDefaultInput=function(a){var b=this.parts().indexOf(a),c=this.inputs().indexOf(a),d=new InputSlotMorph;-1!==b&&(this instanceof BlockMorph?d=this.labelPart(this.parseSpec(this.blockSpec)[b]):this instanceof MultiArgMorph?d=this.labelPart(this.slotSpec):this instanceof ReporterSlotMorph&&(d=ReporterSlotMorph.prototype.emptySlot()));-1!==c&&(d instanceof MultiArgMorph?(d.setContents(this.defaults),d.defaults=this.defaults):this.defaults[c]&&d.setContents(this.defaults[c]));
this.replaceInput(a,d);d instanceof MultiArgMorph&&d.refresh()};SyntaxElementMorph.prototype.isLocked=function(){return this.isStatic};SyntaxElementMorph.prototype.topBlock=function(){return this.parent&&this.parent.topBlock?this.parent.topBlock():this};SyntaxElementMorph.prototype.reactToGrabOf=function(a){if(a instanceof CommandBlockMorph&&(a=this.parentThatIsA(CommandSlotMorph)))this.startLayout(),a.fixLayout(),this.endLayout()};SyntaxElementMorph.prototype.bright=function(){return this.color.lighter(this.contrast).toString()};
SyntaxElementMorph.prototype.dark=function(){return this.color.darker(this.contrast).toString()};SyntaxElementMorph.prototype.setColor=function(a){a&&!this.color.eq(a)&&(this.color=a,this.drawNew(),this.children.forEach(function(a){a.drawNew();a.changed()}),this.changed())};
SyntaxElementMorph.prototype.labelPart=function(a){var b;if("%"===a[0]&&1<a.length){if(5<a.length&&"%mult"===a.slice(0,5))return b=new MultiArgMorph(a.slice(5)),b.addInput(),b;switch(a){case "%inputs":b=new MultiArgMorph("%s","with inputs");b.isStatic=!1;break;case "%scriptVars":b=new MultiArgMorph("%t",null,1,a);break;case "%parms":b=new MultiArgMorph("%t","Input Names:",0,a);break;case "%words":b=new MultiArgMorph("%s",null,2);b.isStatic=!1;break;case "%br":b=new Morph;b.setExtent(new Point(0,0));
b.isBlockLabelBreak=!0;b.getSpec=function(){return"%br"};break;case "%inputName":b=new ReporterBlockMorph;b.color=SpriteMorph.prototype.blockColor.variables;b.setSpec("Input name");break;case "%s":case "%txt":case "%anyUE":case "%obj":b=new InputSlotMorph;break;case "%n":b=new InputSlotMorph(null,!0);break;case "%dir":b=new InputSlotMorph(null,!0,{"(90) right":90,"(-90) left":-90,"(0) up":"0","(180) down":180});b.setContents(90);break;case "%inst":b=new InputSlotMorph(null,!0,{"(1) Acoustic Grand":1,
"(2) Bright Acoustic":2,"(3) Electric Grand":3,"(4) Honky Tonk":4,"(5) Electric Piano 1":5,"(6) Electric Piano 2":6,"(7) Harpsichord":7});b.setContents(1);break;case "%ida":b=new InputSlotMorph(null,!0,{1:1,last:"last","~":null,all:"all"});b.setContents(1);break;case "%idx":b=new InputSlotMorph(null,!0,{1:1,last:"last",any:"any"});b.setContents(1);break;case "%spr":b=new InputSlotMorph(null,!1,{" ":" ","mouse-pointer":"mouse-pointer",Sprite1:"Sprite1",Sprite2:"Sprite2",Sprite3:"Sprite3"},!0);break;
case "%col":b=new InputSlotMorph(null,!1,"collidablesMenu",!0);break;case "%cst":b=new InputSlotMorph(null,!1,"costumesMenu",!0);break;case "%eff":b=new InputSlotMorph(null,!1,{ghost:"ghost"},!0);b.setContents("ghost");break;case "%snd":b=new InputSlotMorph(null,!1,{sound1:"sound1",sound2:"sound2",sound3:"sound3"},!0);break;case "%key":b=new InputSlotMorph(null,!1,{"up arrow":"up arrow","down arrow":"down arrow","right arrow":"right arrow","left arrow":"left arrow",space:"space",a:"a",b:"b",c:"c",
d:"d",e:"e",f:"f",g:"g",h:"h",i:"i",j:"j",k:"k",l:"l",m:"m",n:"n",o:"o",p:"p",q:"q",r:"r",s:"s",t:"t",u:"u",v:"v",w:"w",x:"x",y:"y",z:"z","0":"0",1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",7:"7",8:"8",9:"9"},!0);b.setContents("space");break;case "%msg":b=new InputSlotMorph(null,!1,"messagesMenu",!0);break;case "%att":b=new InputSlotMorph(null,!1,{" ":" ","x position":"x position","y position":"y position",direction:"direction","costume #":"costume #",size:"size",volume:"volume"},!0);b.setContents("x position");
break;case "%fun":b=new InputSlotMorph(null,!1,{abs:"abs",sqrt:"sqrt",sin:"sin",cos:"cos",tan:"tan",asin:"ssin",acos:"acos",atan:"atan",ln:"ln",log:"log","e^":"e^","10^":"10^"},!0);b.setContents("sqrt");break;case "%typ":b=new InputSlotMorph(null,!1,{number:"number",text:"text",Boolean:"Boolean",list:"list",command:"command",reporter:"reporter",predicate:"predicate",object:"object"},!0);b.setContents("number");break;case "%var":b=new InputSlotMorph(null,!1,"getVarNamesDict",!0);break;case "%lst":b=
new InputSlotMorph(null,!1,{list1:"list1",list2:"list2",list3:"list3"},!0);break;case "%l":b=new ArgMorph("list");break;case "%b":case "%boolUE":b=new BooleanSlotMorph(null,!0);break;case "%cmd":b=new CommandSlotMorph;break;case "%c":b=new CSlotMorph;b.isStatic=!0;break;case "%cs":b=new CSlotMorph;break;case "%clr":b=new ColorSlotMorph;b.isStatic=!0;break;case "%t":b=new TemplateSlotMorph("a");break;case "%upvar":b=new TemplateSlotMorph("\u2191");break;case "%f":b=new FunctionSlotMorph;break;case "%r":b=
new ReporterSlotMorph;break;case "%p":b=new ReporterSlotMorph(!0);break;case "%clockwise":b=new StringMorph("\u21bb");b.fontSize=1.5*this.fontSize;b.color=new Color(255,255,255);b.isBold=!1;b.shadowColor=this.color.darker(this.labelContrast);b.shadowOffset=this.embossing;b.drawNew();break;case "%counterclockwise":b=new StringMorph("\u21ba");b.fontSize=1.5*this.fontSize;b.color=new Color(255,255,255);b.isBold=!1;b.shadowColor=this.color.darker(this.labelContrast);b.shadowOffset=this.embossing;b.drawNew();
break;case "%greenflag":b=new StringMorph("\u2691");b.fontSize=1.5*this.fontSize;b.color=new Color(0,200,0);b.isBold=!1;b.shadowColor=this.color.darker(this.labelContrast);b.shadowOffset=this.embossing;b.drawNew();break;case "%stop":b=new StringMorph("\u2b23"),b.fontSize=1.5*this.fontSize,b.color=new Color(200,0,0),b.isBold=!1,b.shadowColor=this.color.darker(this.labelContrast),b.shadowOffset=this.embossing,b.drawNew()}}else b=new StringMorph(a),b.fontSize=this.fontSize,b.color=new Color(255,255,
255),b.isBold=!0,b.shadowColor=this.color.darker(this.labelContrast),b.shadowOffset=this.embossing,b.drawNew();return b};
SyntaxElementMorph.prototype.fixLayout=function(){var a,b=this.parts(),c=this,d=0,e,f=0,g=0,h,i,j=[],k=[],l=this.isPrototype?1:Math.floor(fontHeight(this.fontSize)/3),m,n=!1,o=this.extent();h=this instanceof MultiArgMorph&&"%c"!==this.slotSpec?this.arrows().width():this instanceof ReporterBlockMorph?2*this.rounding+2*this.edge:4*this.corner+2*this.edge+3*this.inset+this.dent;this.nextBlock&&(a=this.nextBlock());b.forEach(function(a){if(a instanceof CSlotMorph||"%c"===a.slotSpec)0<j.length?(k.push(j),
k.push([a]),j=[],d=0):k.push([a]);else if(a instanceof BlockHighlightMorph)c.parent.topBlock||(n=!0),c.fullChanged(),c.removeChild(a);else{a.isVisible&&(d+=a.fullBounds().width()+l);if((d>c.labelWidth||a.isBlockLabelBreak)&&0<j.length)k.push(j),j=[],d=a.fullBounds().width()+l;j.push(a);a.isBlockLabelBreak&&(d=0)}});0<j.length&&k.push(j);this instanceof CommandBlockMorph?(e=this.top()+this.corner+this.edge,this instanceof HatBlockMorph&&(e+=this.hatHeight)):this instanceof ReporterBlockMorph?e=this.top()+
2*this.edge:this instanceof MultiArgMorph&&(e=this.top());k.forEach(function(a){d=c.left()+c.edge+c.labelPadding;c.isPredicate?d=c.left()+c.rounding:c instanceof MultiArgMorph&&(d=c.left());e=e+f;f=0;a.forEach(function(a){if(a instanceof CSlotMorph){d=d-c.labelPadding;c.isPredicate&&(d=c.left()+c.rounding);a.setColor(c.color);a.setPosition(new Point(d,e));f=a.height()}else{a.setPosition(new Point(d,e));a.isBlockLabelBreak||(a.slotSpec==="%c"?d=d+a.width():a.isVisible&&(d=d+(a.fullBounds().width()+
l)));g=Math.max(g,d);f=Math.max(f,a.height())}});a.forEach(function(a){a.moveBy(new Point(0,Math.round((f-a.height())/2)))})});e+=f;this.children.some(function(a){return a instanceof CSlotMorph})&&(m=this.bottomPadding,this instanceof ReporterBlockMorph&&!this.isPredicate&&(m=Math.max(this.bottomPadding,this.rounding-this.bottomPadding)),e+=m);this instanceof CommandBlockMorph?i=e-this.top()+2*this.corner:this instanceof ReporterBlockMorph?i=e-this.top()+2*this.edge:this instanceof MultiArgMorph&&
(i=e-this.top());this.isPredicate?h=Math.max(h,g-this.left()+this.rounding):this instanceof MultiArgMorph?h=Math.max(h,g-this.left()-l):(h=Math.max(h,g-this.left()+this.labelPadding-this.edge),this instanceof HatBlockMorph&&(h=Math.max(h,1.5*this.hatWidth)));this.setExtent(new Point(h,i));b.forEach(function(a){a instanceof CSlotMorph&&(c.isPredicate?a.setWidth(h-c.rounding*2):a.setWidth(h-c.edge))});this.drawNew();a&&a.setPosition(new Point(this.left(),this.bottom()-this.corner));if(this instanceof
CommandBlockMorph){if(this.height()!==o.y&&(a=this.parentThatIsA(CommandSlotMorph))&&a.fixLayout(),this.width()!==o.x)(a=this.parentThatIsAnyOf([ReporterBlockMorph,CommandSlotMorph]))&&a.fixLayout()}else this instanceof ReporterBlockMorph&&this.parent&&this.parent.fixLayout&&this.parent.fixLayout();n&&this.addHighlight()};SyntaxElementMorph.prototype.evaluate=function(){return null};SyntaxElementMorph.prototype.isEmptySlot=function(){return!1};
SyntaxElementMorph.prototype.showBubble=function(a){var b,c=this.world();if(void 0===a||!c)return null;a instanceof ListWatcherMorph?(b=a,b.update(!0),b.step=a.update):a instanceof Morph?(a=a.fullImage(),b=new Morph,b.silentSetWidth(a.width),b.silentSetHeight(a.height),b.image=a):a instanceof Context?(a=a.image(),b=new Morph,b.silentSetWidth(a.width),b.silentSetHeight(a.height),b.image=a):isString(a)?b=new TextMorph(a,this.fontSize,null,!1,!1,"center"):null===a?b=new TextMorph("",this.fontSize,null,
!1,!1,"center"):0===a?b=new TextMorph("0",this.fontSize,null,!1,!1,"center"):a.toString&&(b=new TextMorph(a.toString(),this.fontSize,null,!1,!1,"center"));(new SpeechBubbleMorph(b,null,Math.max(this.rounding-2,6),0)).popUp(c,this.rightCenter().add(new Point(2,0)))};SyntaxElementMorph.prototype.startLayout=function(){this.topBlock().fullChanged();Morph.prototype.trackChanges=!1};SyntaxElementMorph.prototype.endLayout=function(){Morph.prototype.trackChanges=!0;this.topBlock().fullChanged()};
BlockMorph.prototype=new SyntaxElementMorph;BlockMorph.prototype.constructor=BlockMorph;BlockMorph.uber=SyntaxElementMorph.prototype;function BlockMorph(){this.init()}BlockMorph.prototype.init=function(){this.selector=null;this.blockSpec="";BlockMorph.uber.init.call(this);this.color=new Color(0,17,173)};BlockMorph.prototype.receiver=function(){for(var a=this.parent;a;){if(a.owner)return a.owner;a=a.parent}return null};
BlockMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+' ("'+this.blockSpec.slice(0,30)+'...")'};BlockMorph.prototype.parseSpec=function(a){var b=[],c=a.split(" "),d="";0===c.length&&(c=[a]);if(this.labelWordWrap)return c;c.forEach(function(a){"%"===a[0]&&1<a.length?(""!==d&&(b.push(d),d=""),b.push(a)):d=""!==d?d+(" "+a):a});""!==d&&b.push(d);return b};
BlockMorph.prototype.setSpec=function(a){var b=this,c;this.parts().forEach(function(a){a.destroy()});this.isPrototype&&this.add(this.placeHolder());this.parseSpec(a).forEach(function(a){c=b.labelPart(a);b.add(c);c instanceof CommandSlotMorph||c.drawNew();(c instanceof MultiArgMorph||c.constructor===CommandSlotMorph)&&c.fixLayout();b.isPrototype&&b.add(b.placeHolder())});this.blockSpec=a;this.fixLayout()};
BlockMorph.prototype.buildSpec=function(){var a=this;this.blockSpec="";this.parts().forEach(function(b){a.blockSpec=b instanceof StringMorph?a.blockSpec+b.text:b instanceof ArgMorph?a.blockSpec+b.getSpec():b.isBlockLabelBreak?a.blockSpec+b.getSpec():a.blockSpec+"[undefined]";a.blockSpec+=" "});this.blockSpec=this.blockSpec.trim()};
BlockMorph.prototype.rebuild=function(a){this.setSpec(this.blockSpec);a&&this.inputs().forEach(function(b){b instanceof ReporterBlockMorph&&(b.setColor(b.color.lighter(a)),b.setSpec(b.blockSpec))})};BlockMorph.prototype.userMenu=function(){var a=new MenuMorph(this);if(this.isTemplate)return null;a.addItem("duplicate",function(){this.fullCopy().pickUp(this.world())},"make a copy\nand pick it up");a.addItem("delete","destroy");return a};
BlockMorph.prototype.developersMenu=function(){var a=BlockMorph.uber.developersMenu.call(this);a.addLine();a.addItem("delete block","deleteBlock");a.addItem("spec...",function(){(new DialogBoxMorph(this,this.setSpec,this)).prompt(a.title+"\nspec",this.blockSpec,this.world())});return a};
BlockMorph.prototype.deleteBlock=function(){var a=this.parentThatIsA(ScriptsMorph),b=this.nextBlock?this.nextBlock():null,c,d;a&&(b&&a.add(b),this.inputs().forEach(function(b){b instanceof BlockMorph&&a.add(b)}));this instanceof ReporterBlockMorph?this.parent instanceof BlockMorph&&this.parent.revertToDefaultInput(this):this.parent?this.parent.fixLayout&&(c=this.parentThatIsA(ArgMorph)):d=!0;this.destroy();d&&(this.isCorpse=!0);c&&c.fixLayout()};
BlockMorph.prototype.eraseCSlotAreas=function(a){var b=this,c=0.5*this.edge,d,e,f=this.parts().filter(function(a){return a instanceof CSlotMorph});this.isPredicate&&0<f.length&&(e=this.width()-this.rounding,a.clearRect(e,0,this.width(),this.height()),d=a.createLinearGradient(e-this.edge,0,this.width(),0),d.addColorStop(0,this.color.toString()),d.addColorStop(1,this.dark()),a.lineWidth=this.edge,a.lineJoin="round",a.lineCap="round",a.strokeStyle=d,a.beginPath(),a.moveTo(e-c,this.edge+c),a.lineTo(e-
c,this.height()-this.edge-c),a.stroke());f.forEach(function(c){var d=c.width(),e=c.height()-1;a.clearRect(c.bounds.origin.x-b.bounds.origin.x,c.bounds.origin.y-b.bounds.origin.y,d,e)})};BlockMorph.prototype.addHighlight=function(){var a=this.highlight(this.activeHighlight,this.activeBlur);this.addBack(a);this.fullChanged();return a};
BlockMorph.prototype.addErrorHighlight=function(){var a;this.removeHighlight();a=this.highlight(this.errorHighlight,this.activeBlur);this.addBack(a);this.fullChanged();return a};BlockMorph.prototype.removeHighlight=function(){var a=this.getHighlight();null!==a&&(this.fullChanged(),this.removeChild(a))};BlockMorph.prototype.toggleHighlight=function(){this.getHighlight()?this.removeHighlight():this.addHighlight()};
BlockMorph.prototype.highlight=function(a,b){var c=new BlockHighlightMorph,d=this.fullBounds();c.setExtent(d.extent().add(2*b));c.image=this.highlightImage(a,b);c.setPosition(d.origin.subtract(new Point(b,b)));return c};
BlockMorph.prototype.highlightImage=function(a,b){var c,d,e;c=this.fullBounds().extent();d=this.fullImage();c=newCanvas(c.add(2*b));e=c.getContext("2d");e.shadowBlur=b;e.shadowColor=a.toString();e.drawImage(d,b,b);e.shadowBlur=0;e.globalCompositeOperation="destination-out";e.drawImage(d,b,b);return c};BlockMorph.prototype.getHighlight=function(){var a;a=this.children.slice(0).reverse().filter(function(a){return a instanceof BlockHighlightMorph});return 0!==a.length?a[0]:null};
BlockMorph.prototype.fullCopy=function(){var a=BlockMorph.uber.fullCopy.call(this);a.removeHighlight();return a};BlockMorph.prototype.mouseClickLeft=function(){var a=this.topBlock(),b=a.receiver();if(a instanceof PrototypeHatBlockMorph)return a.mouseClickLeft();b&&(b=b.parentThatIsA(StageMorph))&&b.threads.toggleProcess(a)};BlockMorph.prototype.rootForGrab=function(){return this};
BlockMorph.prototype.wantsDropOf=function(a){return(a instanceof ArgMorph||a instanceof StringMorph||a instanceof TextMorph)&&!this.isTemplate};BlockMorph.prototype.reactToDropOf=function(a){a.isDraggable=!1;a instanceof InputSlotMorph?a.drawNew():a instanceof MultiArgMorph&&a.fixLayout();this.fixLayout();this.buildSpec()};CommandBlockMorph.prototype=new BlockMorph;CommandBlockMorph.prototype.constructor=CommandBlockMorph;CommandBlockMorph.uber=BlockMorph.prototype;
function CommandBlockMorph(){this.init()}CommandBlockMorph.prototype.init=function(){CommandBlockMorph.uber.init.call(this);this.setExtent(new Point(200,100))};CommandBlockMorph.prototype.blockSequence=function(){var a=this.nextBlock(),b=[this];a&&(b=b.concat(a.blockSequence()));return b};CommandBlockMorph.prototype.bottomBlock=function(){return this.nextBlock()?this.nextBlock().bottomBlock():this};
CommandBlockMorph.prototype.nextBlock=function(a){if(a){var b=this.nextBlock(),c=this.parentThatIsA(CommandSlotMorph);this.add(a);b&&a.bottomBlock().nextBlock(b);this.fixLayout();c&&c.fixLayout()}else return detect(this.children,function(a){return a instanceof CommandBlockMorph&&!a.isPrototype})};CommandBlockMorph.prototype.topAttachPoint=function(){return new Point(this.dentCenter(),this.top())};CommandBlockMorph.prototype.bottomAttachPoint=function(){return new Point(this.dentCenter(),this.bottom())};
CommandBlockMorph.prototype.dentLeft=function(){return this.left()+this.corner+this.inset};CommandBlockMorph.prototype.dentCenter=function(){return this.dentLeft()+this.corner+0.5*this.dent};CommandBlockMorph.prototype.attachTargets=function(){var a=[];this instanceof HatBlockMorph||this.parent instanceof SyntaxElementMorph||a.push({point:this.topAttachPoint(),element:this,loc:"top",type:"block"});this.isStop()||a.push({point:this.bottomAttachPoint(),element:this,loc:"bottom",type:"block"});return a};
CommandBlockMorph.prototype.allAttachTargets=function(a){var b=this,c=[];(a||this.parent).children.filter(function(a){return a!==b&&a instanceof SyntaxElementMorph&&!a.isTemplate}).forEach(function(a){a.forAllChildren(function(a){a.attachTargets&&a.attachTargets().forEach(function(a){c.push(a)})})});return c};
CommandBlockMorph.prototype.closestAttachTarget=function(a){var a=a||this.parent,b=this.bottomBlock(),c=null,d=Math.max(2*this.corner+this.dent,this.minSnapDistance),e,f=[],g=1E3;this instanceof HatBlockMorph||f.push({point:this.topAttachPoint(),loc:"top"});this.isStop()||f.push({point:b.bottomAttachPoint(),loc:"bottom"});this.allAttachTargets(a).forEach(function(a){f.forEach(function(b){b.loc!==a.loc&&(e=b.point.distanceTo(a.point),e<d&&e<g&&(g=e,c=a))})});return c};
CommandBlockMorph.prototype.snap=function(){var a=this.closestAttachTarget(),b;if(null===a)return null;this.startLayout();if("bottom"===a.loc){if("slot"===a.type?a.element.nestedBlock(this):a.element.nextBlock(this),this.isStop()&&(a=this.nextBlock()))this.parentThatIsA(ScriptsMorph).add(a),a.moveBy(this.extent().floorDivideBy(2)),(a=this.parentThatIsA(CommandSlotMorph))&&a.fixLayout()}else"top"===a.loc&&(b=this.bottomBlock().bottom()-this.bottom(),this.setBottom(a.element.top()+this.corner-b),this.setLeft(a.element.left()),
this.bottomBlock().nextBlock(a.element));this.endLayout()};CommandBlockMorph.prototype.isStop=function(){return-1<["doStop","doStopAll","doForever","doReport"].indexOf(this.selector)};
CommandBlockMorph.prototype.drawNew=function(){var a;this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();this.image=newCanvas(this.extent());a=this.image.getContext("2d");a.fillStyle=this.cachedClr;this.drawTop(a);this.drawBody(a);this.drawBottom(a);this.drawTopDentEdge(a,0,0);this.drawBottomDentEdge(a,0,this.height()-this.corner);this.drawLeftEdge(a);this.drawRightEdge(a);this.drawTopLeftEdge(a);this.drawBottomRightEdge(a);this.eraseCSlotAreas(a)};
CommandBlockMorph.prototype.drawBody=function(a){a.fillRect(0,this.corner,this.width(),this.height()-3*this.corner)};CommandBlockMorph.prototype.drawTop=function(a){a.beginPath();a.arc(this.corner,this.corner,this.corner,radians(-180),radians(-90),!1);this.drawDent(a,0,0);a.arc(this.width()-this.corner,this.corner,this.corner,radians(-90),radians(-0.0),!1);a.closePath();a.fill()};
CommandBlockMorph.prototype.drawBottom=function(a){var b=this.height()-2*this.corner;a.beginPath();a.arc(this.corner,b,this.corner,radians(180),radians(90),!0);this.isStop()||this.drawDent(a,0,this.height()-this.corner);a.arc(this.width()-this.corner,b,this.corner,radians(90),radians(0),!0);a.closePath();a.fill()};
CommandBlockMorph.prototype.drawDent=function(a,b,c){var d=b+2*this.corner+this.inset;a.lineTo(b+this.corner+this.inset,c);a.lineTo(d,c+this.corner);a.lineTo(d+this.dent,c+this.corner);a.lineTo(b+3*this.corner+this.inset+this.dent,c);a.lineTo(this.width()-this.corner,c)};
CommandBlockMorph.prototype.drawTopDentEdge=function(a,b,c){var d=0.5*this.edge,e=b+2*this.corner+this.inset,f;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";f=a.createLinearGradient(0,c,0,c+this.edge);f.addColorStop(0,this.cachedClrBright);f.addColorStop(1,this.cachedClr);a.strokeStyle=f;a.beginPath();a.moveTo(this.corner,c+d);a.lineTo(b+this.corner+this.inset,c+d);a.stroke();a.strokeStyle=f;a.beginPath();a.moveTo(b+3*this.corner+this.inset+this.dent+d,c+d);a.lineTo(this.width()-this.corner,
c+d);a.stroke();f=b+this.corner+this.inset;f=a.createLinearGradient(f-this.edge,c+this.edge,f,c);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.moveTo(b+this.corner+this.inset,c+d);a.lineTo(e,c+this.corner+d);a.stroke();b=a.createLinearGradient(0,c+this.corner,0,c+this.corner+this.edge);b.addColorStop(0,this.cachedClrBright);b.addColorStop(1,this.cachedClr);a.strokeStyle=b;a.beginPath();a.moveTo(e,c+this.corner+d);a.lineTo(e+this.dent,c+this.corner+
d);a.stroke()};
CommandBlockMorph.prototype.drawBottomDentEdge=function(a,b,c){var d=0.5*this.edge,e=b+2*this.corner+this.inset,f,g;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";f=a.createLinearGradient(0,c-this.edge,0,c);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.moveTo(this.corner,c-d);this.isStop()?a.lineTo(this.width()-this.corner,c-d):a.lineTo(b+this.corner+this.inset-d,c-d);a.stroke();if(this.isStop())return null;g=a.createLinearGradient(0,c+
this.corner-this.edge,0,c+this.corner);g.addColorStop(0,this.cachedClr);g.addColorStop(1,this.cachedClrDark);a.strokeStyle=g;a.beginPath();a.moveTo(e+d,c+this.corner-d);a.lineTo(e+this.dent,c+this.corner-d);a.stroke();g=a.createLinearGradient(b+e+this.dent-this.edge,c+this.corner-this.edge,b+e+this.dent,c+this.corner);g.addColorStop(0,this.cachedClr);g.addColorStop(1,this.cachedClrDark);a.strokeStyle=g;a.beginPath();a.moveTo(b+e+this.dent,c+this.corner-d);a.lineTo(b+3*this.corner+this.inset+this.dent,
c-d);a.stroke();a.strokeStyle=f;a.beginPath();a.moveTo(b+3*this.corner+this.inset+this.dent,c-d);a.lineTo(this.width()-this.corner,c-d);a.stroke()};CommandBlockMorph.prototype.drawLeftEdge=function(a){var b=0.5*this.edge,c=a.createLinearGradient(0,0,this.edge,0);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=c;a.beginPath();a.moveTo(b,this.corner);a.lineTo(b,this.height()-2*this.corner-b);a.stroke()};
CommandBlockMorph.prototype.drawRightEdge=function(a){var b=0.5*this.edge,c=this.width(),d;d=a.createLinearGradient(c-this.edge,0,c,0);d.addColorStop(0,this.cachedClr);d.addColorStop(1,this.cachedClrDark);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=d;a.beginPath();a.moveTo(c-b,this.corner+b);a.lineTo(c-b,this.height()-2*this.corner);a.stroke()};
CommandBlockMorph.prototype.drawTopLeftEdge=function(a){var b=0.5*this.edge,c;c=a.createRadialGradient(this.corner,this.corner,this.corner,this.corner,this.corner,this.corner-this.edge);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=c;a.beginPath();a.arc(this.corner,this.corner,this.corner-b,radians(-180),radians(-90),!1);a.stroke()};
CommandBlockMorph.prototype.drawBottomRightEdge=function(a){var b=0.5*this.edge,c=this.width()-this.corner,d=this.height()-2*this.corner,e;e=a.createRadialGradient(c,d,this.corner,c,d,this.corner-this.edge);e.addColorStop(0,this.cachedClrDark);e.addColorStop(1,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=e;a.beginPath();a.arc(c,d,this.corner-b,radians(90),radians(0),!0);a.stroke()};HatBlockMorph.prototype=new CommandBlockMorph;
HatBlockMorph.prototype.constructor=HatBlockMorph;HatBlockMorph.uber=CommandBlockMorph.prototype;function HatBlockMorph(){this.init()}HatBlockMorph.prototype.init=function(){HatBlockMorph.uber.init.call(this);this.setExtent(new Point(300,150))};HatBlockMorph.prototype.blockSequence=function(){var a=HatBlockMorph.uber.blockSequence.call(this);a.shift();return a};
HatBlockMorph.prototype.drawTop=function(a){var b=this.hatWidth,c=this.hatHeight,d=(4*c*c+b*b)/(8*c),e=degrees(4*Math.atan(2*c/b))/2,f=Math.min(1.7*b,this.width()-this.corner);a.beginPath();a.moveTo(0,c+this.corner);a.arc(b/2,d,d,radians(-e-90),radians(-90),!1);a.bezierCurveTo(b,0,b,c,f,c);a.arc(this.width()-this.corner,c+this.corner,this.corner,radians(-90),radians(-0.0),!1);a.closePath();a.fill()};
HatBlockMorph.prototype.drawBody=function(a){a.fillRect(0,this.hatHeight+this.corner,this.width(),this.height()-3*this.corner-this.hatHeight)};HatBlockMorph.prototype.drawLeftEdge=function(a){var b=0.5*this.edge,c=a.createLinearGradient(0,0,this.edge,0);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=c;a.beginPath();a.moveTo(b,this.hatHeight+b);a.lineTo(b,this.height()-2*this.corner-b);a.stroke()};
HatBlockMorph.prototype.drawRightEdge=function(a){var b=0.5*this.edge,c=this.width(),d;d=a.createLinearGradient(c-this.edge,0,c,0);d.addColorStop(0,this.cachedClr);d.addColorStop(1,this.cachedClrDark);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=d;a.beginPath();a.moveTo(c-b,this.corner+this.hatHeight+b);a.lineTo(c-b,this.height()-2*this.corner);a.stroke()};HatBlockMorph.prototype.drawTopDentEdge=function(){return null};
HatBlockMorph.prototype.drawTopLeftEdge=function(a){var b=0.5*this.edge,c=this.hatWidth,d=this.hatHeight,e=(4*d*d+c*c)/(8*d),f=degrees(4*Math.atan(2*d/c))/2,g=Math.min(1.7*c,this.width()-this.corner),h;h=a.createRadialGradient(c/2,e,e-this.edge,c/2,e,e);h.addColorStop(1,this.cachedClrBright);h.addColorStop(0,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=h;a.beginPath();a.arc(Math.round(c/2),e,e-b,radians(-f-90),radians(-90),!1);a.moveTo(c/2,b);a.bezierCurveTo(c,
b,c,d+b,g,d+b);a.lineTo(this.width()-this.corner,d+b);a.stroke()};ReporterBlockMorph.prototype=new BlockMorph;ReporterBlockMorph.prototype.constructor=ReporterBlockMorph;ReporterBlockMorph.uber=BlockMorph.prototype;function ReporterBlockMorph(a){this.init(a)}ReporterBlockMorph.prototype.init=function(a){ReporterBlockMorph.uber.init.call(this);this.isPredicate=a||!1;this.setExtent(new Point(200,80))};
ReporterBlockMorph.prototype.snap=function(){if(!this.parent instanceof ScriptsMorph)return null;var a=this.parent.closestInput(this);null!==a&&a.parent.replaceInput(a,this)};ReporterBlockMorph.prototype.prepareToBeGrabbed=function(a){var b=this.position();nop(a);if(this.parent instanceof BlockMorph||this.parent instanceof MultiArgMorph||this.parent instanceof ReporterSlotMorph)this.parent.revertToDefaultInput(this),this.setPosition(b)};ReporterBlockMorph.prototype.blockSequence=function(){return this};
ReporterBlockMorph.prototype.isUnevaluated=function(){return contains(["%anyUE","%boolUE","%f"],this.getSlotSpec())};ReporterBlockMorph.prototype.isLocked=function(){return this.isStatic||"%t"===this.getSlotSpec()};
ReporterBlockMorph.prototype.getSlotSpec=function(){var a;return this.parent instanceof BlockMorph&&(a=this.parent.parts().filter(function(a){return!(a instanceof BlockHighlightMorph)}),a=a.indexOf(this),-1!==a&&this.parent.blockSpec)?this.parseSpec(this.parent.blockSpec)[a]:this.parent instanceof MultiArgMorph?this.parent.slotSpec:this.parent instanceof TemplateSlotMorph?this.parent.getSpec():null};
ReporterBlockMorph.prototype.mouseClickLeft=function(a){if(this.parent instanceof BlockInputFragmentMorph)return this.parent.mouseClickLeft();this.parent instanceof TemplateSlotMorph?(new DialogBoxMorph(this,this.setSpec,this)).prompt("Input name",this.blockSpec,this.world()):ReporterBlockMorph.uber.mouseClickLeft.call(this,a)};
ReporterBlockMorph.prototype.drawNew=function(){var a;this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();this.image=newCanvas(this.extent());a=this.image.getContext("2d");a.fillStyle=this.cachedClr;this.isPredicate?this.drawDiamond(a):this.drawRounded(a);this.eraseCSlotAreas(a)};
ReporterBlockMorph.prototype.drawRounded=function(a){var b=this.height(),c=Math.min(this.rounding,b/2),d=this.width(),e=this.edge/2,f;a.fillStyle=this.cachedClr;a.beginPath();a.arc(c,c,c,radians(-180),radians(-90),!1);a.arc(d-c,c,c,radians(-90),radians(-0.0),!1);a.arc(d-c,b-c,c,radians(0),radians(90),!1);a.arc(c,b-c,c,radians(90),radians(180),!1);a.closePath();a.fill();a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";f=a.createRadialGradient(c,b-c,c-this.edge,c,b-c,c+this.edge);f.addColorStop(0,
this.cachedClr);f.addColorStop(1,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.arc(c,b-c,c-e,radians(90),radians(180),!1);a.stroke();f=a.createRadialGradient(d-c,c,c-this.edge,d-c,c,c+this.edge);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.arc(d-c,c,c-e,radians(-90),radians(0),!1);a.stroke();f=a.createLinearGradient(0,0,0,this.edge);f.addColorStop(0,this.cachedClrBright);f.addColorStop(1,this.cachedClr);a.strokeStyle=f;a.beginPath();
a.moveTo(c-e,e);a.lineTo(d-c+e,e);a.stroke();f=a.createRadialGradient(c,c,c-this.edge,c,c,c);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.arc(c,c,c-e,radians(180),radians(270),!1);a.stroke();f=a.createRadialGradient(d-c,b-c,c-this.edge,d-c,b-c,c);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.arc(d-c,b-c,c-e,radians(0),radians(90),!1);a.stroke();f=a.createLinearGradient(0,b-this.edge,
0,b);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.moveTo(c-e,b-e);a.lineTo(d-c+e,b-e);a.stroke();f=a.createLinearGradient(0,0,this.edge,0);f.addColorStop(0,this.cachedClrBright);f.addColorStop(1,this.cachedClr);a.strokeStyle=f;a.beginPath();a.moveTo(e,c);a.lineTo(e,b-c);a.stroke();f=a.createLinearGradient(d-this.edge,0,d,0);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.moveTo(d-e,c+e);
a.lineTo(d-e,b-c);a.stroke()};
ReporterBlockMorph.prototype.drawDiamond=function(a){var b=this.width(),c=this.height(),d=Math.floor(c/2),e=this.rounding,f=this.edge/2,g;a.fillStyle=this.cachedClr;a.beginPath();a.moveTo(0,d);a.lineTo(e,0);a.lineTo(b-e,0);a.lineTo(b,d);a.lineTo(b-e,c);a.lineTo(e,c);a.closePath();a.fill();a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";g=a.createLinearGradient(-e,0,e,0);g.addColorStop(1,this.cachedClr);g.addColorStop(0,this.cachedClrBright);a.strokeStyle=g;a.beginPath();a.moveTo(f,d);a.lineTo(e,
c-f);a.closePath();a.stroke();g=a.createLinearGradient(b-e,0,b+e,0);g.addColorStop(0,this.cachedClr);g.addColorStop(1,this.cachedClrDark);a.strokeStyle=g;a.beginPath();a.moveTo(b-f,d);a.lineTo(b-e,f);a.closePath();a.stroke();g=a.createLinearGradient(0,0,e,0);g.addColorStop(0,this.cachedClrBright);g.addColorStop(1,this.cachedClr);a.strokeStyle=g;a.beginPath();a.moveTo(f,d);a.lineTo(e,f);a.closePath();a.stroke();g=a.createLinearGradient(0,0,0,this.edge);g.addColorStop(0,this.cachedClrBright);g.addColorStop(1,
this.cachedClr);a.strokeStyle=g;a.beginPath();a.moveTo(e,f);a.lineTo(b-e,f);a.closePath();a.stroke();g=a.createLinearGradient(b-e,0,b,0);g.addColorStop(0,this.cachedClr);g.addColorStop(1,this.cachedClrDark);a.strokeStyle=g;a.beginPath();a.moveTo(b-e,c-f);a.lineTo(b-f,d);a.closePath();a.stroke();g=a.createLinearGradient(0,c-this.edge,0,c);g.addColorStop(0,this.cachedClr);g.addColorStop(1,this.cachedClrDark);a.strokeStyle=g;a.beginPath();a.moveTo(e+f,c-f);a.lineTo(b-e-f,c-f);a.closePath();a.stroke()};
ScriptsMorph.prototype=new FrameMorph;ScriptsMorph.prototype.constructor=ScriptsMorph;ScriptsMorph.uber=FrameMorph.prototype;ScriptsMorph.prototype.cleanUpMargin=20;ScriptsMorph.prototype.cleanUpSpacing=15;function ScriptsMorph(a){this.init(a)}ScriptsMorph.prototype.init=function(a){this.owner=a||null;this.feedbackColor=SyntaxElementMorph.prototype.feedbackColor;this.feedbackMorph=new BoxMorph;ScriptsMorph.uber.init.call(this);this.setColor(new Color(70,70,70))};
ScriptsMorph.prototype.step=function(){var a=this.world().hand,b;this.feedbackMorph.parent&&this.feedbackMorph.destroy();if(0===a.children.length||!this.bounds.containsPoint(a.bounds.origin))return null;b=a.children[0];if(!(b instanceof BlockMorph)||!contains(a.morphAtPointer().allParents(),this))return null;b instanceof ReporterBlockMorph?this.showReporterDropFeedback(b):this.showCommandDropFeedback(b)};
ScriptsMorph.prototype.showReporterDropFeedback=function(a){var b=this.closestInput(a);if(null===b)return null;this.feedbackMorph.bounds=b.fullBounds().expandBy(Math.max(2*a.edge,a.reporterDropFeedbackPadding));this.feedbackMorph.edge=SyntaxElementMorph.prototype.rounding;this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3);this.add(this.feedbackMorph);this.feedbackMorph.color=this.feedbackColor.copy();this.feedbackMorph.color.a=0.5;this.feedbackMorph.borderColor=this.feedbackColor;
this.feedbackMorph.drawNew();this.feedbackMorph.changed()};
ScriptsMorph.prototype.showCommandDropFeedback=function(a){var b;b=a.closestAttachTarget(this);if(!b)return null;this.add(this.feedbackMorph);this.feedbackMorph.border=0;this.feedbackMorph.edge=0;this.feedbackMorph.alpha=1;this.feedbackMorph.setExtent(new Point(b.element.width(),Math.max(SyntaxElementMorph.prototype.corner,SyntaxElementMorph.prototype.feedbackMinHeight)));this.feedbackMorph.color=this.feedbackColor;this.feedbackMorph.drawNew();this.feedbackMorph.changed();a=b.point.y;"bottom"===b.loc&&
("block"===b.type?b.element.nextBlock()&&(a-=SyntaxElementMorph.prototype.corner):"slot"===b.type&&b.element.nestedBlock()&&(a-=SyntaxElementMorph.prototype.corner));this.feedbackMorph.setPosition(new Point(b.element.left(),a))};
ScriptsMorph.prototype.closestInput=function(a){var b=a.fullBoundsNoShadow(),c=detect(this.children,function(a){return a instanceof BlockMorph&&a.fullBounds().intersects(b)}),d=a.allInputs();return null===c?null:detect(c.allInputs(),function(c){return c!==a&&!c.isLocked()&&c.fullBounds().intersects(b)&&!(c.parent instanceof PrototypeHatBlockMorph)&&!contains(d,c)})};
ScriptsMorph.prototype.userMenu=function(){var a=new MenuMorph(this),b=this.parentThatIsA(IDE_Morph),c=this,d=this.owner;a.addItem("clean up","cleanUp","arrange scripts\nvertically");b&&a.addItem("make a block...",function(){(new BlockDialogMorph(null,function(a){""!==a.spec&&(d.customBlocks.push(a),d.cacheCustomBlock(a),b.refreshPalette(),(new BlockEditorMorph(a,d)).popUp())},c)).prompt("Make a block",null,c.world())});return a};
ScriptsMorph.prototype.cleanUp=function(){var a=this.topLeft(),b=this.cleanUpMargin;this.children.sort(function(a,b){return a.top()-b.top()}).forEach(function(c){c.setPosition(a.add(new Point(this.cleanUpMargin,b)));b+=c.fullBounds().height()+this.cleanUpSpacing},this);this.parent&&this.setPosition(this.parent.topLeft());this.adjustBounds()};ScriptsMorph.prototype.wantsDropOf=function(a){return a instanceof SyntaxElementMorph};
ScriptsMorph.prototype.reactToDropOf=function(a){a instanceof BlockMorph&&a.snap();this.adjustBounds()};ArgMorph.prototype=new SyntaxElementMorph;ArgMorph.prototype.constructor=ArgMorph;ArgMorph.uber=SyntaxElementMorph.prototype;function ArgMorph(a){this.init(a)}ArgMorph.prototype.init=function(a){this.type=a||null;ArgMorph.uber.init.call(this);this.color=new Color(0,17,173);this.setExtent(new Point(50,50))};
ArgMorph.prototype.justDropped=function(){this instanceof CommandSlotMorph||(this.drawNew(),this.changed())};ArgMorph.prototype.getSpec=function(){return"%s"};ArgMorph.prototype.drawNew=function(){"list"===this.type?(this.image=this.listIcon(),this.silentSetExtent(new Point(this.image.width,this.image.height))):ArgMorph.uber.drawNew.call(this)};
ArgMorph.prototype.listIcon=function(){var a=new Morph,b=new CellMorph,c=new CellMorph,d;a.color=new Color(255,255,255);c.setPosition(b.bottomLeft().add(new Point(0,this.fontSize/3)));b.add(c);b.setPosition(a.position().add(this.fontSize));a.add(b);a.bounds.corner=c.bounds.corner.add(this.fontSize);a.drawNew();a=a.fullImage();d=(this.fontSize+this.edge)/a.height;b=newCanvas(new Point(Math.ceil(a.width*d)+1,Math.ceil(a.height*d)+1));c=b.getContext("2d");c.fillStyle="black";c.fillRect(0,0,b.width,b.height);
c.scale(d,d);c.drawImage(a,1/d,1/d);return b};ArgMorph.prototype.isEmptySlot=function(){return null!==this.type};CommandSlotMorph.prototype=new ArgMorph;CommandSlotMorph.prototype.constructor=CommandSlotMorph;CommandSlotMorph.uber=ArgMorph.prototype;function CommandSlotMorph(){this.init()}CommandSlotMorph.prototype.init=function(){CommandSlotMorph.uber.init.call(this);this.color=new Color(0,17,173);this.setExtent(new Point(230,4*this.corner+this.cSlotPadding))};
CommandSlotMorph.prototype.getSpec=function(){return"%cmd"};CommandSlotMorph.prototype.topBlock=function(){return this.parent.topBlock?this.parent.topBlock():this.nestedBlock()};CommandSlotMorph.prototype.nestedBlock=function(a){if(a){var b=this.nestedBlock();this.add(a);b&&a.bottomBlock().nextBlock(b);this.fixLayout()}else return detect(this.children,function(a){return a instanceof CommandBlockMorph})};
CommandSlotMorph.prototype.slotAttachPoint=function(){return new Point(this.dentCenter(),this.top()+2*this.corner)};CommandSlotMorph.prototype.dentLeft=function(){return this.left()+this.corner+2*this.inset};CommandSlotMorph.prototype.dentCenter=function(){return this.dentLeft()+this.corner+0.5*this.dent};CommandSlotMorph.prototype.attachTargets=function(){var a=[];a.push({point:this.slotAttachPoint(),element:this,loc:"bottom",type:"slot"});return a};
CommandSlotMorph.prototype.fixLayout=function(){var a=this.nestedBlock();this.parent&&(this.color.eq(this.parent.color)||this.setColor(this.parent.color));a?(a.setPosition(new Point(this.left()+this.edge+this.rfBorder,this.top()+this.edge+this.rfBorder)),this.setWidth(a.fullBounds().width()+2*(this.edge+this.rfBorder)),this.setHeight(a.fullBounds().height()+this.edge+this.rfBorder+(this.corner-this.rfBorder))):(this.setHeight(4*this.corner),this.setWidth(4*this.corner+this.inset+this.dent));this.parent.fixLayout&&
this.parent.fixLayout()};CommandSlotMorph.prototype.evaluate=function(){return this.nestedBlock()};CommandSlotMorph.prototype.isEmptySlot=function(){return null===this.nestedBlock()};CommandSlotMorph.prototype.attach=function(){var a=this.overlappedMorphs(),b=new MenuMorph(this,"choose new parent:"),c=this;a.forEach(function(a){b.addItem(a.toString().slice(0,50),function(){a.add(c);c.isDraggable=!1;a.fixLayout&&a.fixLayout()})});0<a.length&&b.popUpAtHand(this.world())};
CommandSlotMorph.prototype.drawNew=function(){var a;this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();this.image=newCanvas(this.extent());a=this.image.getContext("2d");a.fillStyle=this.cachedClr;a.fillRect(0,0,this.width(),this.height());a.fillStyle=this.rfColor.toString();this.drawFlat(a);this.drawEdges(a)};
CommandSlotMorph.prototype.drawFlat=function(a){var b=null!==this.nestedBlock(),c=b?this.inset:this.inset/2,d=b?this.dent:this.dent/2,e=2*this.corner+c,f=this.edge,b=b?this.rfBorder:0,g=this.height()-this.corner-f;a.beginPath();a.arc(this.corner+f,this.corner+f,this.corner,radians(-180),radians(-90),!1);a.lineTo(this.corner+c+f+2*b,f);a.lineTo(e+f+2*b,this.corner+f);a.lineTo(e+f+2*b+(d-2*b),this.corner+f);a.lineTo(e+f+2*b+(d-2*b)+this.corner,f);a.lineTo(this.width()-this.corner-f,f);a.arc(this.width()-
this.corner-f,this.corner+f,this.corner,radians(-90),radians(-0.0),!1);a.arc(this.width()-this.corner-f,g,this.corner,radians(0),radians(90),!1);a.arc(this.corner+f,g,this.corner,radians(90),radians(180),!1);a.closePath();a.fill()};
CommandSlotMorph.prototype.drawEdges=function(a){var b=null!==this.nestedBlock(),c=b?this.inset:this.inset/2,d=b?this.dent:this.dent/2,e=2*this.corner+c,f=this.edge,b=b?this.rfBorder:0,g=0.5*this.edge,h;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";h=a.createLinearGradient(0,this.height(),0,this.height()-this.edge);h.addColorStop(0,this.cachedClr);h.addColorStop(1,this.cachedClrBright);a.strokeStyle=h;a.beginPath();a.moveTo(this.corner+f,this.height()-g);a.lineTo(this.width()-this.corner-
f,this.height()-g);a.stroke();h=a.createRadialGradient(this.width()-(this.corner+f),this.height()-(this.corner+f),this.corner,this.width()-(this.corner+f),this.height()-(this.corner+f),this.corner+f);h.addColorStop(0,this.cachedClrBright);h.addColorStop(1,this.cachedClr);a.strokeStyle=h;a.beginPath();a.arc(this.width()-(this.corner+f),this.height()-(this.corner+f),this.corner+g,radians(0),radians(90),!1);a.stroke();h=a.createLinearGradient(this.width(),0,this.width()-this.edge,0);h.addColorStop(0,
this.cachedClr);h.addColorStop(1,this.cachedClrBright);a.strokeStyle=h;a.beginPath();a.moveTo(this.width()-g,this.height()-this.corner-this.edge);a.lineTo(this.width()-g,f+this.corner);a.stroke();useBlurredShadows&&(a.shadowOffsetY=g,a.shadowBlur=this.edge,a.shadowColor=this.rfColor.darker(80).toString());h=a.createLinearGradient(0,0,f,0);h.addColorStop(0,this.cachedClr);h.addColorStop(1,this.cachedClrDark);a.strokeStyle=h;a.beginPath();a.moveTo(g,f+this.corner);a.lineTo(g,this.height()-f-this.corner);
a.stroke();h=a.createRadialGradient(this.corner+f,this.corner+f,this.corner,this.corner+f,this.corner+f,this.corner+f);h.addColorStop(0,this.cachedClrDark);h.addColorStop(1,this.cachedClr);a.strokeStyle=h;a.beginPath();a.arc(this.corner+f,this.corner+f,this.corner+g,radians(-180),radians(-90),!1);a.stroke();h=a.createLinearGradient(0,0,0,this.edge);h.addColorStop(0,this.cachedClr);h.addColorStop(1,this.cachedClrDark);a.strokeStyle=h;a.beginPath();a.moveTo(this.corner+f,g);a.lineTo(this.corner+c+f+
2*b-g,g);a.stroke();c=a.createLinearGradient(0,this.corner,0,this.corner+f);c.addColorStop(0,this.cachedClr);c.addColorStop(1,this.cachedClrDark);a.strokeStyle=c;a.beginPath();a.moveTo(e+f+2*b+g,this.corner+g);a.lineTo(e+f+2*b+(d-2*b),this.corner+g);a.stroke();c=a.createLinearGradient(e+f+2*b+(d-2*b)-g,this.corner,e+f+2*b+(d-2*b)+0.7*g,this.corner+g+0.7*g);c.addColorStop(0,this.cachedClr);c.addColorStop(1,this.cachedClrDark);a.strokeStyle=c;a.beginPath();a.moveTo(e+f+2*b+(d-2*b),this.corner+g);a.lineTo(e+
f+2*b+(d-2*b)+this.corner,g);a.stroke();a.strokeStyle=h;a.beginPath();a.moveTo(e+f+2*b+(d-2*b)+this.corner,g);a.lineTo(this.width()-this.corner-f,g);a.stroke()};CSlotMorph.prototype=new CommandSlotMorph;CSlotMorph.prototype.constructor=CSlotMorph;CSlotMorph.uber=CommandSlotMorph.prototype;function CSlotMorph(){this.init()}CSlotMorph.prototype.init=function(){CommandSlotMorph.uber.init.call(this);this.color=new Color(0,17,173);this.setExtent(new Point(230,4*this.corner+this.cSlotPadding))};
CSlotMorph.prototype.getSpec=function(){return"%c"};CSlotMorph.prototype.fixLayout=function(){var a=this.nestedBlock();a?(a.setPosition(new Point(this.left()+this.inset,this.top()+this.corner)),this.setHeight(a.fullBounds().height()+this.corner),this.setWidth(a.fullBounds().width()+2*this.cSlotPadding)):(this.setHeight(4*this.corner+this.cSlotPadding),this.setWidth(4*this.corner+2*this.inset+this.dent+2*this.cSlotPadding));this.parent.fixLayout&&this.parent.fixLayout()};
CSlotMorph.prototype.drawNew=function(){var a;this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();this.image=newCanvas(this.extent());a=this.image.getContext("2d");a.fillStyle=this.cachedClr;this.drawFlat(a);this.drawTopRightEdge(a);this.drawTopEdge(a,this.inset,this.corner);this.drawTopLeftEdge(a);this.drawBottomEdge(a);this.drawRightEdge(a)};
CSlotMorph.prototype.drawFlat=function(a){a.beginPath();a.moveTo(0,0);a.lineTo(this.width(),0);a.arc(this.width()-this.corner,0,this.corner,radians(90),radians(0),!0);a.lineTo(this.width()-this.corner,this.corner);a.lineTo(2*this.inset+3*this.corner+this.dent,this.corner);a.lineTo(2*this.inset+2*this.corner+this.dent,2*this.corner);a.lineTo(2*this.inset+2*this.corner,2*this.corner);a.lineTo(2*this.inset+this.corner,this.corner);a.lineTo(this.inset+this.corner,this.corner);a.arc(this.inset+this.corner,
2*this.corner,this.corner,radians(270),radians(180),!0);a.lineTo(this.inset,this.height()-2*this.corner);a.arc(this.inset+this.corner,this.height()-2*this.corner,this.corner,radians(180),radians(90),!0);a.lineTo(this.width()-this.corner,this.height()-this.corner);a.arc(this.width()-this.corner,this.height(),this.corner,radians(-90),radians(-0.0),!1);a.lineTo(0,this.height());a.closePath();a.fill()};
CSlotMorph.prototype.drawTopRightEdge=function(a){var b=0.5*this.edge,c=this.width()-this.corner,d;d=a.createRadialGradient(c,0,this.corner,c,0,this.corner-this.edge);d.addColorStop(0,this.cachedClrDark);d.addColorStop(1,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=d;a.beginPath();a.arc(c,0,this.corner-b,radians(90),radians(0),!0);a.stroke()};
CSlotMorph.prototype.drawTopEdge=function(a,b,c){var d=0.5*this.edge,e=b+2*this.corner+this.inset,f,g;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";f=a.createLinearGradient(0,c-this.edge,0,c);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.moveTo(b+this.corner,c-d);a.lineTo(b+this.corner+this.inset-d,c-d);a.stroke();g=a.createLinearGradient(0,c+this.corner-this.edge,0,c+this.corner);g.addColorStop(0,this.cachedClr);g.addColorStop(1,
this.cachedClrDark);a.strokeStyle=g;a.beginPath();a.moveTo(e+d,c+this.corner-d);a.lineTo(e+this.dent,c+this.corner-d);a.stroke();e=a.createLinearGradient(b+this.inset+2*this.corner+this.dent-d,c+this.corner-d-d,b+this.inset+2*this.corner+this.dent+0.7*d,c+this.corner-d+0.7*d);e.addColorStop(0,this.cachedClr);e.addColorStop(1,this.cachedClrDark);a.strokeStyle=e;a.beginPath();a.moveTo(b+this.inset+2*this.corner+this.dent,c+this.corner-d);a.lineTo(b+3*this.corner+this.inset+this.dent,c-d);a.stroke();
a.strokeStyle=f;a.beginPath();a.moveTo(b+3*this.corner+this.inset+this.dent,c-d);a.lineTo(this.width()-this.corner,c-d);a.stroke()};
CSlotMorph.prototype.drawTopLeftEdge=function(a){var b=0.5*this.edge,c;c=a.createRadialGradient(this.corner+this.inset,2*this.corner,this.corner,this.corner+this.inset,2*this.corner,this.corner+this.edge);c.addColorStop(0,this.cachedClrDark);c.addColorStop(1,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=c;a.beginPath();a.arc(this.corner+this.inset,2*this.corner,this.corner+b,radians(-180),radians(-90),!1);a.stroke()};
CSlotMorph.prototype.drawRightEdge=function(a){var b=0.5*this.edge,c=this.inset,d;d=a.createLinearGradient(c-this.edge,0,c,0);d.addColorStop(0,this.cachedClr);d.addColorStop(1,this.cachedClrDark);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=d;a.beginPath();a.moveTo(c-b,2*this.corner);a.lineTo(c-b,this.height()-2*this.corner);a.stroke()};
CSlotMorph.prototype.drawBottomEdge=function(a){var b=0.5*this.edge,c;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";c=a.createRadialGradient(this.corner+this.inset,this.height()-2*this.corner,this.corner,this.corner+this.inset,this.height()-2*this.corner,this.corner+this.edge);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.strokeStyle=c;a.beginPath();a.arc(this.corner+this.inset,this.height()-2*this.corner,this.corner+b,radians(180),radians(90),!0);a.stroke();
c=a.createLinearGradient(0,this.height()-this.corner,0,this.height()-this.corner+this.edge);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.strokeStyle=c;a.beginPath();a.moveTo(this.inset+this.corner,this.height()-this.corner+b);a.lineTo(this.width()-this.corner,this.height()-this.corner+b);a.stroke()};InputSlotMorph.prototype=new ArgMorph;InputSlotMorph.prototype.constructor=InputSlotMorph;InputSlotMorph.uber=ArgMorph.prototype;
function InputSlotMorph(a,b,c,d){this.init(a,b,c,d)}InputSlotMorph.prototype.init=function(a,b,c,d){var a=new StringMorph(a||""),e=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));a.fontSize=this.fontSize;a.drawNew();this.choices=c||null;this.oldContentsExtent=a.extent();this.isNumeric=b||!1;this.isReadOnly=d||!1;InputSlotMorph.uber.init.call(this);this.color=new Color(255,255,255);this.add(a);this.add(e);a.isEditable=!0;a.isDraggable=!1;a.enableSelecting();this.fixLayout()};
InputSlotMorph.prototype.getSpec=function(){return this.isNumeric?"%n":"%s"};InputSlotMorph.prototype.contents=function(){return detect(this.children,function(a){return a instanceof StringMorph})};InputSlotMorph.prototype.arrow=function(){return detect(this.children,function(a){return a instanceof ArrowMorph})};InputSlotMorph.prototype.setContents=function(a){var b=this.contents();b.text=a;if(void 0===a)return null;null===a?b.text="":a.toString&&(b.text=a.toString());b.drawNew()};
InputSlotMorph.prototype.dropDownMenu=function(){var a=this.choices,b,c=new MenuMorph(this.setContents,null,this,this.fontSize);a instanceof Function?a=a.call(this):isString(a)&&(a=this[a].call(this));if(!a)return null;c.addItem(" ",null);for(b in a)a.hasOwnProperty(b)&&("~"===b[0]?c.addLine():c.addItem(b,a[b]));if(0<c.items.length)c.popUpAtHand(this.world());else return null};
InputSlotMorph.prototype.messagesMenu=function(){var a={},b=this.parentThatIsA(BlockMorph).receiver().parentThatIsA(StageMorph),c=this,d=[];b.children.concat(b).forEach(function(a){if(a instanceof SpriteMorph||a instanceof StageMorph)d=d.concat(a.allMessageNames())});d.forEach(function(b){a[b]=b});0<d.length&&(a["~"]=null);a["new..."]=function(){(new DialogBoxMorph(c,c.setContents,c)).prompt("Message name",null,c.world())};return a};
InputSlotMorph.prototype.collidablesMenu=function(){var a={"mouse-pointer":"mouse-pointer",edge:"edge"},b=this.parentThatIsA(BlockMorph).receiver(),c=[];b.parentThatIsA(StageMorph).children.forEach(function(a){a instanceof SpriteMorph&&a.name!==b.name&&(c=c.concat(a.name))});0<c.length&&(a["~"]=null,c.forEach(function(b){a[b]=b}));return a};
InputSlotMorph.prototype.costumesMenu=function(){var a={Turtle:"Turtle"},b=[];this.parentThatIsA(BlockMorph).receiver().costumes.asArray().forEach(function(a){b=b.concat(a.name)});0<b.length&&(a["~"]=null,b.forEach(function(b){a[b]=b}));return a};
InputSlotMorph.prototype.getVarNamesDict=function(){var a=this.parentThatIsA(BlockMorph),b,c,d=[],e;if(!a)return{};b=a.receiver();(c=detect(a.allParents(),function(a){return a instanceof PrototypeHatBlockMorph}))&&(d=c.inputs()[0].upvarFragmentNames());a.allParents().filter(function(a){return"doDeclareVariables"===a.selector}).forEach(function(a){d=d.concat(a.inputs()[0].evaluate())});return b?(e=b.variables.allNamesDict(),d.forEach(function(a){e[a]=a}),e):{}};
InputSlotMorph.prototype.fixLayout=function(){var a=this.contents(),b=this.arrow();a.isNumeric=this.isNumeric;a.isEditable=!this.isReadOnly;this.isReadOnly?(a.disableSelecting(),a.color=new Color(254,254,254)):(a.enableSelecting(),a.color=new Color(0,0,0));this.choices?(b.setSize(this.fontSize),b.show()):(b.setSize(0),b.hide());this.setHeight(a.height()+2*this.edge+2*this.typeInPadding);this.isNumeric?this.setWidth(a.width()+Math.floor(0.5*b.width())+this.height()+2*this.typeInPadding):this.setWidth(Math.max(a.width()+
b.width()+2*this.edge+2*this.typeInPadding,a.height()+b.width()));this.isNumeric?a.setPosition((new Point(Math.floor(this.height()/2),this.edge)).add(this.typeInPadding).add(this.position())):a.setPosition((new Point(this.edge,this.edge)).add(this.typeInPadding).add(this.position()));b.setPosition(new Point(this.right()-b.width()-this.edge,a.top()));this.parent&&this.parent.fixLayout&&(this.world()?(this.startLayout(),this.parent.fixLayout(),this.endLayout()):this.parent.fixLayout())};
InputSlotMorph.prototype.mouseClickLeft=function(a){this.arrow().bounds.containsPoint(a)?this.dropDownMenu():(this.contents().edit(),this.contents().selectAll())};InputSlotMorph.prototype.evaluate=function(){var a,b=this.contents();return this.isNumeric&&(a=parseFloat(b.text),!isNaN(a))?a:b.text};InputSlotMorph.prototype.isEmptySlot=function(){return""===this.contents().text};
InputSlotMorph.prototype.drawNew=function(){var a,b;this.image=newCanvas(this.extent());a=this.image.getContext("2d");b=this.parent?this.parent.color:new Color(120,120,120);a.fillStyle=this.color.toString();this.isReadOnly&&(a.fillStyle=b.darker().toString());this.cachedClr=b.toString();this.cachedClrBright=b.lighter(this.contrast).toString();this.cachedClrDark=b.darker(this.contrast).toString();this.isNumeric?(b=(this.height()-2*this.edge)/2,a.fillStyle=this.color.toString(),a.beginPath(),a.arc(b+
this.edge,b+this.edge,b,radians(90),radians(-90),!1),a.arc(this.width()-b-this.edge,b+this.edge,b,radians(-90),radians(90),!1),a.closePath(),a.fill(),this.drawRoundBorder(a)):(a.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),this.drawRectBorder(a))};
InputSlotMorph.prototype.drawRectBorder=function(a){var b=0.5*this.edge,c;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";useBlurredShadows&&(a.shadowOffsetY=b,a.shadowBlur=this.edge,a.shadowColor=this.color.darker(80).toString());c=a.createLinearGradient(0,0,0,this.edge);c.addColorStop(0,this.cachedClr);c.addColorStop(1,this.cachedClrDark);a.strokeStyle=c;a.beginPath();a.moveTo(this.edge,b);a.lineTo(this.width()-this.edge-b,b);a.stroke();a.shadowOffsetY=0;c=a.createLinearGradient(0,0,
this.edge,0);c.addColorStop(0,this.cachedClr);c.addColorStop(1,this.cachedClrDark);a.strokeStyle=c;a.beginPath();a.moveTo(b,this.edge);a.lineTo(b,this.height()-this.edge-b);a.stroke();a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;c=a.createLinearGradient(0,this.height()-this.edge,0,this.height());c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.strokeStyle=c;a.beginPath();a.moveTo(this.edge,this.height()-b);a.lineTo(this.width()-this.edge,this.height()-b);a.stroke();
c=a.createLinearGradient(this.width()-this.edge,0,this.width(),0);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.strokeStyle=c;a.beginPath();a.moveTo(this.width()-b,this.edge);a.lineTo(this.width()-b,this.height()-this.edge);a.stroke()};
InputSlotMorph.prototype.drawRoundBorder=function(a){var b=0.5*this.edge,c=(this.height()-2*this.edge)/2,d,e,f;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";d=c+this.edge;e=this.width()-c-this.edge;e>d&&(useBlurredShadows&&(a.shadowOffsetX=b,a.shadowOffsetY=b,a.shadowBlur=this.edge,a.shadowColor=this.color.darker(80).toString()),f=a.createLinearGradient(0,0,0,this.edge),f.addColorStop(0,this.cachedClr),f.addColorStop(1,this.cachedClrDark),a.strokeStyle=f,a.beginPath(),a.moveTo(d,b),a.lineTo(e,
b),a.stroke(),a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0);f=a.createLinearGradient(0,this.height()-this.edge,0,this.height());f.addColorStop(0,this.cachedClrBright);f.addColorStop(1,this.cachedClr);a.strokeStyle=f;a.beginPath();a.moveTo(c+this.edge,this.height()-b);a.lineTo(this.width()-c-this.edge,this.height()-b);a.stroke();c=this.height()/2;useBlurredShadows&&(a.shadowOffsetX=b,a.shadowOffsetY=b,a.shadowBlur=this.edge,a.shadowColor=this.color.darker(80).toString());f=a.createRadialGradient(c,
c,c-this.edge,c,c,c);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.arc(c,c,c-b,radians(180),radians(270),!1);a.stroke();a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;f=a.createRadialGradient(this.width()-c,c,c-this.edge,this.width()-c,c,c);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.arc(this.width()-c,c,c-b,radians(0),radians(90),!1);a.stroke()};TemplateSlotMorph.prototype=new ArgMorph;
TemplateSlotMorph.prototype.constructor=TemplateSlotMorph;TemplateSlotMorph.uber=ArgMorph.prototype;function TemplateSlotMorph(a){this.init(a)}
TemplateSlotMorph.prototype.init=function(a){var b=new ReporterBlockMorph;this.labelString=a||"";b.isDraggable=!1;b.isTemplate=!0;b.color=void 0!==modules.objects?SpriteMorph.prototype.blockColor.variables:new Color(243,118,29);b.setSpec(this.labelString);b.selector="reportGetVar";TemplateSlotMorph.uber.init.call(this);this.add(b);this.fixLayout();this.isDraggable=!1;this.isStatic=!0};TemplateSlotMorph.prototype.getSpec=function(){return"%t"};TemplateSlotMorph.prototype.template=function(){return this.children[0]};
TemplateSlotMorph.prototype.contents=function(){return this.template().blockSpec};TemplateSlotMorph.prototype.setContents=function(a){this.template().setSpec(a)};TemplateSlotMorph.prototype.evaluate=function(){return this.contents()};TemplateSlotMorph.prototype.fixLayout=function(){var a=this.template();this.setExtent(a.extent().add(2*this.edge+2));a.setPosition(this.position().add(this.edge+1));this.parent&&this.parent.fixLayout&&this.parent.fixLayout()};
TemplateSlotMorph.prototype.drawNew=function(){var a;this.parent instanceof Morph&&(this.color=this.parent.color.copy());this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();this.image=newCanvas(this.extent());a=this.image.getContext("2d");a.fillStyle=this.cachedClr;this.drawRounded(a)};TemplateSlotMorph.prototype.drawRounded=ReporterBlockMorph.prototype.drawRounded;BooleanSlotMorph.prototype=new ArgMorph;BooleanSlotMorph.prototype.constructor=BooleanSlotMorph;
BooleanSlotMorph.uber=ArgMorph.prototype;function BooleanSlotMorph(){this.init()}BooleanSlotMorph.prototype.init=function(){BooleanSlotMorph.uber.init.call(this)};BooleanSlotMorph.prototype.getSpec=function(){return"%b"};
BooleanSlotMorph.prototype.drawNew=function(){this.silentSetExtent(new Point(2*(this.fontSize+2*this.edge),this.fontSize+2*this.edge));this.parent&&(this.color=this.parent.color);this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();this.image=newCanvas(this.extent());this.drawDiamond(this.image.getContext("2d"),!0)};
BooleanSlotMorph.prototype.drawDiamond=function(a){var b=this.width(),c=this.height(),d=c/2,e=this.edge/2,f;a.fillStyle=this.color.darker(25).toString();a.beginPath();a.moveTo(0,d);a.lineTo(d,0);a.lineTo(b-d,0);a.lineTo(b,d);a.lineTo(b-d,c);a.lineTo(d,c);a.closePath();a.fill();a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";useBlurredShadows&&(a.shadowOffsetX=e,a.shadowBlur=e,a.shadowColor="black");f=a.createLinearGradient(0,d,0.6*this.edge,d+0.6*this.edge);f.addColorStop(1,this.cachedClrDark);
f.addColorStop(0,this.cachedClr);a.strokeStyle=f;a.beginPath();a.moveTo(e,d);a.lineTo(d,e);a.closePath();a.stroke();a.shadowOffsetX=0;useBlurredShadows&&(a.shadowOffsetY=e,a.shadowBlur=this.edge);f=a.createLinearGradient(0,0,0,this.edge);f.addColorStop(1,this.cachedClrDark);f.addColorStop(0,this.cachedClr);a.strokeStyle=f;a.beginPath();a.moveTo(d,e);a.lineTo(b-d,e);a.closePath();a.stroke();a.shadowOffsetY=0;a.shadowBlur=0;f=a.createLinearGradient(b-d-0.6*this.edge,c-0.6*this.edge,b-d,c);f.addColorStop(1,
this.cachedClr);f.addColorStop(0,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.moveTo(b-d,c-e);a.lineTo(b-e,d);a.closePath();a.stroke();f=a.createLinearGradient(0,c-this.edge,0,c);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.moveTo(d,c-e);a.lineTo(b-d-e,c-e);a.closePath();a.stroke()};ArrowMorph.prototype=new Morph;ArrowMorph.prototype.constructor=ArrowMorph;ArrowMorph.uber=Morph.prototype;
function ArrowMorph(a,b,c){this.init(a,b,c)}ArrowMorph.prototype.init=function(a,b,c){this.direction=a||"down";this.size=b||(0===b?0:50);this.padding=c||0;ArrowMorph.uber.init.call(this);this.color=new Color(0,0,0);this.setExtent(new Point(this.size,this.size))};ArrowMorph.prototype.setSize=function(a){var b=Math.max(a,1);this.size=a;this.setExtent(new Point(b,b))};
ArrowMorph.prototype.drawNew=function(){this.image=newCanvas(this.extent());var a=this.image.getContext("2d"),b=this.padding,c=this.height(),d=Math.floor(c/2),e=this.width(),f=Math.floor(e/2);a.fillStyle=this.color.toString();a.beginPath();"down"===this.direction?(a.moveTo(b,d),a.lineTo(e-b,d),a.lineTo(f,c-b)):"up"===this.direction?(a.moveTo(b,d),a.lineTo(e-b,d),a.lineTo(f,b)):("left"===this.direction?(a.moveTo(b,d),a.lineTo(f,b)):(a.moveTo(f,b),a.lineTo(e-b,d)),a.lineTo(f,c-b));a.closePath();a.fill()};
ColorSlotMorph.prototype=new ArgMorph;ColorSlotMorph.prototype.constructor=ColorSlotMorph;ColorSlotMorph.uber=ArgMorph.prototype;function ColorSlotMorph(a){this.init(a)}ColorSlotMorph.prototype.init=function(a){ColorSlotMorph.uber.init.call(this);this.setColor(a||new Color(145,26,68))};ColorSlotMorph.prototype.getSpec=function(){return"%clr"};
ColorSlotMorph.prototype.getUserColor=function(){var a=this,b=this.world(),c=b.hand,d=getDocumentPositionOf(b.worldCanvas),e=c.processMouseMove,f=c.processMouseDown,g=c.processMouseUp,h=new ColorPaletteMorph(null,new Point(16*this.fontSize,10*this.fontSize));b.add(h);h.setPosition(this.bottomLeft().add(new Point(0,this.edge)));c.processMouseMove=function(e){c.setPosition(new Point(e.pageX-d.x,e.pageY-d.y));a.setColor(b.getGlobalPixelColor(c.position()))};c.processMouseDown=nop;c.processMouseUp=function(){h.destroy();
c.processMouseMove=e;c.processMouseDown=f;c.processMouseUp=g}};ColorSlotMorph.prototype.mouseClickLeft=function(){this.getUserColor()};ColorSlotMorph.prototype.evaluate=function(){return this.color};
ColorSlotMorph.prototype.drawNew=function(){var a,b;a=this.fontSize+2*this.edge+2*this.typeInPadding;this.silentSetExtent(new Point(a,a));this.image=newCanvas(this.extent());a=this.image.getContext("2d");b=this.parent?this.parent.color:new Color(120,120,120);a.fillStyle=this.color.toString();this.cachedClr=b.toString();this.cachedClrBright=b.lighter(this.contrast).toString();this.cachedClrDark=b.darker(this.contrast).toString();a.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-
2*this.edge);this.drawRectBorder(a)};ColorSlotMorph.prototype.drawRectBorder=InputSlotMorph.prototype.drawRectBorder;BlockHighlightMorph.prototype=new Morph;BlockHighlightMorph.prototype.constructor=BlockHighlightMorph;BlockHighlightMorph.uber=Morph.prototype;function BlockHighlightMorph(){this.init()}MultiArgMorph.prototype=new ArgMorph;MultiArgMorph.prototype.constructor=MultiArgMorph;MultiArgMorph.uber=ArgMorph.prototype;function MultiArgMorph(a,b,c,d){this.init(a,b,c,d)}
MultiArgMorph.prototype.init=function(a,b,c,d){var e=new Morph;this.slotSpec=a||"%s";this.labelText=b||"";this.minInputs=c||0;this.elementSpec=d||null;MultiArgMorph.uber.init.call(this);this.isStatic=!0;a=this.labelPart(this.labelText);this.add(a);a.hide();a=new ArrowMorph("left",this.fontSize,Math.max(Math.floor(this.fontSize/6),1));b=new ArrowMorph("right",this.fontSize,Math.max(Math.floor(this.fontSize/6),1));e.add(a);e.add(b);e.drawNew();this.add(e);for(e=0;e<this.minInputs;e+=1)this.addInput()};
MultiArgMorph.prototype.label=function(){return this.children[0]};MultiArgMorph.prototype.arrows=function(){return this.children[this.children.length-1]};MultiArgMorph.prototype.getSpec=function(){return"%mult"+this.slotSpec};MultiArgMorph.prototype.setContents=function(a){var b=this.inputs(),c;for(c=0;c<a.length;c+=1)null!==a[c]&&b[c]&&b[c].setContents(a[c])};
MultiArgMorph.prototype.fixLayout=function(){"%t"===this.slotSpec&&(this.isStatic=!0);if(this.parent){var a=this.label(),b;this.color=this.parent.color;b=this.color.darker(this.labelContrast);this.arrows().color=this.color;""!==this.labelText&&!a.shadowColor.eq(b)&&(a.shadowColor=b,a.drawNew())}this.fixArrowsLayout();MultiArgMorph.uber.fixLayout.call(this);this.parent&&this.parent.fixLayout()};
MultiArgMorph.prototype.fixArrowsLayout=function(){var a=this.label(),b=this.arrows(),c=b.children[0],d=b.children[1];this.inputs().length<this.minInputs+1?(a.hide(),c.hide(),d.setPosition(b.position()),b.setExtent(d.extent())):(""!==this.labelText&&a.show(),c.show(),d.setPosition(c.topCenter()),b.bounds.corner=d.bottomRight().copy());b.drawNew()};MultiArgMorph.prototype.refresh=function(){this.inputs().forEach(function(a){a.drawNew()})};
MultiArgMorph.prototype.drawNew=function(){MultiArgMorph.uber.drawNew.call(this);this.refresh()};MultiArgMorph.prototype.addInput=function(){var a=this.labelPart(this.slotSpec),b=this.children.length-1;"%scriptVars"===this.elementSpec?a.setContents("abcdefghijklmnopqrstuvwxyz"[b-1]):"%parms"===this.elementSpec&&a.setContents("#"+b);a.parent=this;this.children.splice(b,0,a);a.drawNew();this.fixLayout()};
MultiArgMorph.prototype.removeInput=function(){var a,b;1<this.children.length&&(a=this.children[this.children.length-2],this.removeChild(a),a instanceof BlockMorph&&(b=this.parentThatIsA(ScriptsMorph))&&b.add(a));this.fixLayout()};
MultiArgMorph.prototype.mouseClickLeft=function(a){var b=this.arrows(),c=b.children[0],b=b.children[1],d=16===this.world().currentKey?3:1;this.startLayout();if(b.bounds.containsPoint(a))for(a=0;a<d;a+=1)b.isVisible&&this.addInput();else if(c.bounds.containsPoint(a))for(a=0;a<d;a+=1)c.isVisible&&this.removeInput();else this.escalateEvent("mouseClickLeft",a);this.endLayout()};MultiArgMorph.prototype.evaluate=function(){var a=[];this.inputs().forEach(function(b){a.push(b.evaluate())});return a};
FunctionSlotMorph.prototype=new ArgMorph;FunctionSlotMorph.prototype.constructor=FunctionSlotMorph;FunctionSlotMorph.uber=ArgMorph.prototype;function FunctionSlotMorph(a){this.init(a)}FunctionSlotMorph.prototype.init=function(a){FunctionSlotMorph.uber.init.call(this);this.isPredicate=a||!1;this.color=this.rfColor;this.setExtent(new Point(2*(this.fontSize+2*this.edge),this.fontSize+2*this.edge))};FunctionSlotMorph.prototype.getSpec=function(){return"%f"};
FunctionSlotMorph.prototype.drawNew=function(){var a,b;this.image=newCanvas(this.extent());a=this.image.getContext("2d");b=this.parent?this.parent.color:new Color(120,120,120);this.cachedClr=b.toString();this.cachedClrBright=b.lighter(this.contrast).toString();this.cachedClrDark=b.darker(this.contrast).toString();this.isPredicate?this.drawDiamond(a):this.drawRounded(a)};
FunctionSlotMorph.prototype.drawRounded=function(a){var b=this.height(),c=Math.min(this.rounding,b/2),d=this.width(),e=this.edge/2,f;a.fillStyle=this.color.toString();a.beginPath();a.arc(c,c,c,radians(-180),radians(-90),!1);a.arc(d-c,c,c,radians(-90),radians(-0.0),!1);a.arc(d-c,b-c,c,radians(0),radians(90),!1);a.arc(c,b-c,c,radians(90),radians(180),!1);a.closePath();a.fill();a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=this.cachedClr;a.beginPath();a.arc(c,b-c,c-e,radians(90),
radians(180),!1);a.stroke();a.strokeStyle=this.cachedClr;a.beginPath();a.arc(d-c,c,c-e,radians(-90),radians(0),!1);a.stroke();useBlurredShadows&&(a.shadowOffsetX=e,a.shadowOffsetY=e,a.shadowBlur=this.edge,a.shadowColor=this.color.darker(80).toString());f=a.createLinearGradient(0,0,0,this.edge);f.addColorStop(1,this.cachedClrDark);f.addColorStop(0,this.cachedClr);a.strokeStyle=f;a.beginPath();a.moveTo(c-e,e);a.lineTo(d-c+e,e);a.stroke();f=a.createRadialGradient(c,c,c-this.edge,c,c,c);f.addColorStop(1,
this.cachedClr);f.addColorStop(0,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.arc(c,c,c-e,radians(180),radians(270),!1);a.stroke();f=a.createLinearGradient(0,0,this.edge,0);f.addColorStop(1,this.cachedClrDark);f.addColorStop(0,this.cachedClr);a.strokeStyle=f;a.beginPath();a.moveTo(e,c);a.lineTo(e,b-c);a.stroke();a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;f=a.createRadialGradient(d-c,b-c,c-this.edge,d-c,b-c,c);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrBright);a.strokeStyle=
f;a.beginPath();a.arc(d-c,b-c,c-e,radians(0),radians(90),!1);a.stroke();f=a.createLinearGradient(0,b-this.edge,0,b);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.moveTo(c-e,b-e);a.lineTo(d-c+e,b-e);a.stroke();f=a.createLinearGradient(d-this.edge,0,d,0);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.moveTo(d-e,c+e);a.lineTo(d-e,b-c);a.stroke()};
FunctionSlotMorph.prototype.drawDiamond=function(a){var b=this.width(),c=this.height(),d=Math.floor(c/2),e=Math.min(this.rounding,d),f=this.edge/2,g;a.fillStyle=this.color.toString();a.beginPath();a.moveTo(0,d);a.lineTo(e,0);a.lineTo(b-e,0);a.lineTo(b,d);a.lineTo(b-e,c);a.lineTo(e,c);a.closePath();a.fill();a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=this.cachedClr;a.beginPath();a.moveTo(f,d);a.lineTo(e,c-f);a.closePath();a.stroke();a.strokeStyle=this.cachedClr;a.beginPath();
a.moveTo(b-f,d);a.lineTo(b-e,f);a.closePath();a.stroke();useBlurredShadows&&(a.shadowOffsetX=f,a.shadowOffsetY=f,a.shadowBlur=this.edge,a.shadowColor=this.color.darker(80).toString());g=a.createLinearGradient(0,0,e,0);g.addColorStop(1,this.cachedClrDark);g.addColorStop(0,this.cachedClr);a.strokeStyle=g;a.beginPath();a.moveTo(f,d);a.lineTo(e,f);a.closePath();a.stroke();g=a.createLinearGradient(0,0,0,this.edge);g.addColorStop(1,this.cachedClrDark);g.addColorStop(0,this.cachedClr);a.strokeStyle=g;a.beginPath();
a.moveTo(e,f);a.lineTo(b-e,f);a.closePath();a.stroke();a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;g=a.createLinearGradient(b-e,0,b,0);g.addColorStop(1,this.cachedClr);g.addColorStop(0,this.cachedClrBright);a.strokeStyle=g;a.beginPath();a.moveTo(b-e,c-f);a.lineTo(b-f,d);a.closePath();a.stroke();g=a.createLinearGradient(0,c-this.edge,0,c);g.addColorStop(1,this.cachedClr);g.addColorStop(0,this.cachedClrBright);a.strokeStyle=g;a.beginPath();a.moveTo(e+f,c-f);a.lineTo(b-e-f,c-f);a.closePath();
a.stroke()};ReporterSlotMorph.prototype=new FunctionSlotMorph;ReporterSlotMorph.prototype.constructor=ReporterSlotMorph;ReporterSlotMorph.uber=FunctionSlotMorph.prototype;function ReporterSlotMorph(a){this.init(a)}ReporterSlotMorph.prototype.init=function(a){ReporterSlotMorph.uber.init.call(this,a);this.add(this.emptySlot());this.fixLayout()};
ReporterSlotMorph.prototype.emptySlot=function(){var a=new ArgMorph,b=2*this.rfBorder+2*this.edge;a.color=this.rfColor;a.alpha=0;a.setExtent(new Point(2*(this.fontSize+2*this.edge)-b,this.fontSize+2*this.edge-b));return a};ReporterSlotMorph.prototype.getSpec=function(){return"%r"};ReporterSlotMorph.prototype.contents=function(){return this.children[0]};ReporterSlotMorph.prototype.nestedBlock=function(){var a=this.contents();return a instanceof ReporterBlockMorph?a:null};
ReporterSlotMorph.prototype.evaluate=function(){return this.nestedBlock()};CommandSlotMorph.prototype.isEmptySlot=function(){return null===this.nestedBlock()};ReporterSlotMorph.prototype.fixLayout=function(){var a=this.contents();this.setExtent(a.extent().add(2*this.edge+2*this.rfBorder));a.setCenter(this.center());this.parent&&this.parent.fixLayout&&this.parent.fixLayout()};modules.threads="2012-Mar-20";
function snapEquals(a,b){if(a instanceof List||b instanceof List)return a instanceof List&&b instanceof List?a.equalTo(b):!1;var c=parseFloat(a),d=parseFloat(b);if(isNaN(c)||isNaN(d))c=a,d=b;return c===d}function ThreadManager(){this.processes=[]}ThreadManager.prototype.toggleProcess=function(a){var b=this.findProcess(a);if(b)b.stop();else return this.startProcess(a)};
ThreadManager.prototype.startProcess=function(a){var b=this.findProcess(a),c=a.topBlock();b&&(b.stop(),this.removeTerminatedProcesses());c.addHighlight();a=new Process(a.topBlock());this.processes.push(a);return a};ThreadManager.prototype.stopAll=function(){this.processes.forEach(function(a){a.stop()})};ThreadManager.prototype.stopProcess=function(a){(a=this.findProcess(a))&&a.stop()};
ThreadManager.prototype.step=function(){this.processes.forEach(function(a){a.homeContext.receiver.isPickedUp()||a.runStep()});this.removeTerminatedProcesses()};
ThreadManager.prototype.removeTerminatedProcesses=function(){var a=[];this.processes.forEach(function(b){!b.isRunning()&&!b.errorFlag?(b.topBlock.removeHighlight(),b.topBlock instanceof ReporterBlockMorph&&(b.homeContext.inputs[0]instanceof List?b.topBlock.showBubble(new ListWatcherMorph(b.homeContext.inputs[0])):b.topBlock.showBubble(b.homeContext.inputs[0]))):a.push(b)});this.processes=a};
ThreadManager.prototype.findProcess=function(a){var b=a.topBlock();return detect(this.processes,function(a){return a.topBlock===b})};Process.prototype={};Process.prototype.contructor=Process;Process.prototype.timeout=500;Process.prototype.isCatchingErrors=!0;
function Process(a){this.topBlock=a||null;this.errorFlag=this.readyToTerminate=this.readyToYield=!1;this.context=null;this.homeContext=new Context;this.lastYield=Date.now();this.isAtomic=!1;a&&(this.homeContext.receiver=a.receiver(),this.homeContext.variables.parentFrame=this.homeContext.receiver.variables,this.context=new Context(null,a.blockSequence(),this.homeContext),this.pushContext("doYield"))}Process.prototype.isRunning=function(){return null!==this.context&&!this.readyToTerminate};
Process.prototype.runStep=function(){for(this.readyToYield=!1;!this.readyToYield&&this.context&&Date.now()-this.lastYield<this.timeout;)this.evaluateContext();this.lastYield=Date.now();if(this.readyToTerminate){for(;this.context;)this.popContext();this.homeContext.receiver&&this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp()}};Process.prototype.stop=function(){this.readyToTerminate=this.readyToYield=!0;this.errorFlag=!1};
Process.prototype.evaluateContext=function(){var a=this.context.expression;if(a instanceof Array)return this.evaluateSequence(a);if(a instanceof MultiArgMorph)return this.evaluateMultiSlot(a,a.inputs().length);if(a instanceof ArgMorph||a.bindingID)return this.evaluateInput(a);if(a instanceof BlockMorph)return this.evaluateBlock(a,a.inputs().length);if(isString(a))return this[a].call(this);this.popContext()};
Process.prototype.evaluateBlock=function(a,b){var c=this.context.receiver,d=this.context.inputs;if(b>d.length)this.evaluateNextInput(a);else if(this[a.selector]&&(c=this),this.isCatchingErrors)try{this.returnValueToParentContext(c[a.selector].apply(c,d)),this.popContext()}catch(e){this.handleError(e,a)}else this.returnValueToParentContext(c[a.selector].apply(c,d)),this.popContext()};
Process.prototype.evaluateMultiSlot=function(a,b){var c=this.context.inputs;b>c.length?this.evaluateNextInput(a):(this.returnValueToParentContext(new List(c)),this.popContext())};
Process.prototype.evaluateInput=function(a){var b;if(a.bindingID)if(this.isCatchingErrors)try{b=this.context.variables.getVar(a.bindingID)}catch(c){this.handleError(c,a)}else b=this.context.variables.getVar(a.bindingID);else if((b=a.evaluate())&&(contains([CommandSlotMorph,ReporterSlotMorph],a.constructor)||a instanceof CSlotMorph&&!a.isStatic))b=this.reify(b,new List);this.returnValueToParentContext(b);this.popContext()};
Process.prototype.evaluateSequence=function(a){var b=this.context.pc,c=this.context.outerContext,d=this.context.isLambda,e=this.context.isCustomBlock,f=this.context.upvars;b===a.length-1?(this.context=new Context(this.context.parentContext,a[b],this.context.outerContext,this.context.receiver,this.context.isInsideCustomBlock),this.context.isLambda=d,this.context.isCustomBlock=e,f&&(this.context.upvars=new UpvarReference(f))):b>=a.length?this.popContext():(this.context.pc+=1,this.pushContext(a[b],c))};
Process.prototype.evaluateNextInput=function(a){var b=this.context.inputs.length,a=a.inputs()[b],b=this.context.outerContext;a.isUnevaluated?a.isUnevaluated()?contains(["reify","reportScript"],this.context.expression.selector)?this.context.addInput(a):this.context.addInput(this.reify(a,new List)):this.pushContext(a,b):this.pushContext(a,b)};Process.prototype.doYield=function(){this.popContext();this.isAtomic||(this.readyToYield=!0)};
Process.prototype.handleError=function(a,b){this.errorFlag=!0;this.topBlock.addErrorHighlight();for((b||this.topBlock).showBubble((b?"":"Inside: ")+a.name+"\n"+a.message);this.context.parentContext;)this.popContext()};Process.prototype.reportScript=function(a,b){return this.reify(b,a)};
Process.prototype.reify=function(a,b){var c=new Context(null,null,this.context?this.context.outerContext:null),d=0;a?(c.expression=a.fullCopy(),c.expression.allEmptySlots().forEach(function(a){d+=1;a.bindingID=d}),c.emptySlots=d):c.expression=this.context.expression.fullCopy();c.inputs=b.asArray();c.receiver=this.context?this.context.receiver:a.receiver();return c};Process.prototype.doRun=function(a,b,c){return this.evaluate(a,b,!0,c)};
Process.prototype.evaluate=function(a,b,c,d){if(!a)return null;if(a.isContinuation)return this.runContinuation(a,b);var e=new Context(null,null,a.outerContext),f,g=b.asArray(),h=d?this.context.expression.definition.declarations:null,i;e.receiver||(e.receiver=a.receiver);b=new Context(this.context.parentContext,a.expression,e,a.receiver,d||this.context.isInsideCustomBlock);f=new Context(b,"doYield");this.context.parentContext=c||a.expression instanceof ReporterBlockMorph?f:b;b.isLambda=!0;b.isCustomBlock=
d||!1;if(0<g.length){for(c=0;c<a.inputs.length;c+=1)f=0,g[c]&&(f=g[c]),e.variables.addVar(a.inputs[c],f),d&&"%upvar"===h[a.inputs[c]][0]&&(i||(i=new UpvarReference(this.context.upvars)),i.addReference(f,a.inputs[c],e.variables));if(0===a.inputs.length)if(1===g.length)for(c=1;c<=a.emptySlots;c+=1)e.variables.addVar(c,g[0]);else if(g.length===a.emptySlots)for(c=1;c<=g.length;c+=1)e.variables.addVar(c,g[c-1]);else throw Error("expecting "+a.emptySlots+" input(s), but getting "+g.length);}else if(a.emptySlots)throw Error("expecting "+
a.emptySlots+" input(s), but getting none");i?b.upvars=i:this.context.upvars&&(b.upvars=new UpvarReference(this.context.upvars));b.expression instanceof CommandBlockMorph&&(b.expression=b.expression.blockSequence())};
Process.prototype.fork=function(a,b){if(a.isContinuation)throw Error("continuations cannot be forked");var c=new Context(null,null,a.outerContext),d=new Context(null,a.expression,c),e=b.asArray(),f,g,h=this.homeContext.receiver.parentThatIsA(StageMorph),i=new Process;d.isLambda=!0;if(0<e.length){for(f=0;f<a.inputs.length;f+=1)g=0,e[f]&&(g=e[f]),c.variables.addVar(a.inputs[f],g);if(0===a.inputs.length)if(1===e.length)for(f=1;f<=a.emptySlots;f+=1)c.variables.addVar(f,e[0]);else if(e.length===a.emptySlots)for(f=
1;f<=e.length;f+=1)c.variables.addVar(f,e[f-1]);else throw Error("expecting "+a.emptySlots+" input(s), but getting "+e.length);}else if(a.emptySlots)throw Error("expecting "+a.emptySlots+" input(s), but getting none");d.expression instanceof CommandBlockMorph&&(d.expression=d.expression.blockSequence());i.homeContext=a.outerContext;i.topBlock=a.expression;i.context=d;i.pushContext("doYield");h.threads.processes.push(i)};
Process.prototype.doReport=function(a){if(this.context.isInsideCustomBlock){for(;this.context&&!this.context.isCustomBlock;)this.popContext();this.context&&(this.context.pc=this.context.expression.length-1)}else for(;this.context&&!this.context.isLambda;)this.popContext();return a};Process.prototype.doCallCC=function(a){this.evaluate(a,new List([this.context.continuation()]))};Process.prototype.reportCallCC=function(a){this.doCallCC(a)};
Process.prototype.runContinuation=function(a,b){var c=b.asArray();this.context.parentContext=a.copyForContinuation();1===c.length&&this.context.parentContext.outerContext.variables.addVar(1,c[0])};Process.prototype.evaluateCustomBlock=function(){var a=this.context.expression.definition.body,b=new List(this.context.inputs);return this.doRun(a,b,!0)};Process.prototype.doDeclareVariables=function(a){var b=this.context.outerContext.variables;a.asArray().forEach(function(a){b.addVar(a)})};
Process.prototype.doSetVar=function(a,b){this.context.variables.setVar(a,b,this.context.parentContext)};Process.prototype.doChangeVar=function(a,b){this.context.variables.changeVar(a,b,this.context.parentContext)};Process.prototype.reportGetVar=function(){var a=this.context.expression.blockSpec,b;return this.context.upvars&&(b=this.context.upvars.find(a))?b.getVar(a):this.context.variables.getVar(a,this.context.parentContext)};
Process.prototype.doShowVar=function(a){var b=this.context.variables,c,d,e;if(this.homeContext.receiver&&(c=this.homeContext.receiver.parentThatIsA(StageMorph)))d=b.find(a,this.context.parentContext),b=detect(c.children,function(b){return b instanceof WatcherMorph&&b.target===d&&b.getter===a}),null!==b?b.show():(b=d.owner?a:a+" (temporary)",b=new WatcherMorph(b,SpriteMorph.prototype.blockColor.variables,d,a),b.setPosition(c.position().add(10)),e=c.watchers(b.left()),0<e.length&&b.setTop(e[e.length-
1].bottom()),c.add(b)),b.fixLayout()};Process.prototype.doHideVar=function(a){var b=this.context.variables,c,d;if(a){if(this.homeContext.receiver&&(c=this.homeContext.receiver.parentThatIsA(StageMorph)))d=b.find(a,this.context.parentContext),b=detect(c.children,function(b){return b instanceof WatcherMorph&&b.target===d&&b.getter===a}),null!==b&&(b.isTemporary()?b.destroy():b.hide())}else this.doRemoveTemporaries()};
Process.prototype.doRemoveTemporaries=function(){var a;this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph))&&a.watchers().forEach(function(a){a.isTemporary()&&a.destroy()})};Process.prototype.reportNewList=function(a){return a};Process.prototype.reportCONS=function(a,b){return(new List).cons(a,b)};Process.prototype.reportCDR=function(a){return a.cdr()};Process.prototype.doAddToList=function(a,b){b.add(a)};
Process.prototype.doDeleteFromList=function(a,b){var c=a;if("all"===a)return b.clear();if(""===a)return null;"last"===a&&(c=b.length());b.remove(c)};Process.prototype.doInsertInList=function(a,b,c){var d=b;if(""===b)return null;"any"===b&&(d=this.reportRandom(1,c.length()));"last"===b&&(d=c.length()+1);c.add(a,d)};Process.prototype.doReplaceInList=function(a,b,c){var d=a;if(""===a)return null;"any"===a&&(d=this.reportRandom(1,b.length()));"last"===a&&(d=b.length());b.put(c,d)};
Process.prototype.reportListItem=function(a,b){var c=a;if(""===a)return null;"any"===a&&(c=this.reportRandom(1,b.length()));"last"===a&&(c=b.length());return b.at(c)};Process.prototype.reportListLength=function(a){return a.length()};Process.prototype.reportListContainsItem=function(a,b){return a.contains(b)};
Process.prototype.doIf=function(){var a=this.context.inputs,b=this.context.outerContext,c=this.context.isInsideCustomBlock,d=this.context.isLambda,e=this.context.isCustomBlock;this.popContext();a[0]&&a[1]&&(this.pushContext(a[1].blockSequence(),b),this.context.isInsideCustomBlock=c,this.context.isLambda=d,this.context.isCustomBlock=e);this.pushContext()};
Process.prototype.doIfElse=function(){var a=this.context.inputs,b=this.context.outerContext,c=this.context.isInsideCustomBlock,d=this.context.isLambda,e=this.context.isCustomBlock;this.popContext();a[0]?a[1]&&this.pushContext(a[1].blockSequence(),b):a[2]&&this.pushContext(a[2].blockSequence(),b);this.context&&(this.context.isInsideCustomBlock=c,this.context.isLambda=d,this.context.isCustomBlock=e);this.pushContext()};Process.prototype.doStop=function(){this.stop()};
Process.prototype.doStopAll=function(){var a;if(this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph)))a.keysPressed={},a.threads.stopAll()};
Process.prototype.doWarp=function(a){var b=this.context.outerContext,c=this.context.isInsideCustomBlock,d=this.context.isLambda,e=this.context.isCustomBlock;this.popContext();a&&(this.homeContext.receiver&&this.homeContext.receiver.startWarp&&this.homeContext.receiver.startWarp(),this.pushContext("doYield"),this.context.isInsideCustomBlock=c,this.context.isLambda=d,this.context.isCustomBlock=e,this.isAtomic||this.pushContext("doStopWarping"),this.pushContext(a.blockSequence(),b),this.isAtomic=!0);
this.pushContext()};Process.prototype.doStopWarping=function(){this.popContext();this.isAtomic=!1;this.homeContext.receiver&&this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp()};Process.prototype.doForever=function(a){this.pushContext("doYield");a&&this.pushContext(a.blockSequence());this.pushContext()};
Process.prototype.doRepeat=function(a,b){var c=this.context.expression,d=this.context.outerContext,e=this.context.isInsideCustomBlock,f=this.context.isLambda,g=this.context.isCustomBlock;if(1>a)return null;this.popContext();this.pushContext(c,d);this.context.isInsideCustomBlock=e;this.context.isLambda=f;this.context.isCustomBlock=g;this.context.addInput(a-1);this.pushContext("doYield");b&&this.pushContext(b.blockSequence());this.pushContext()};
Process.prototype.doUntil=function(a,b){if(a)return this.popContext(),this.pushContext("doYield"),null;this.context.inputs=[];this.pushContext("doYield");b&&this.pushContext(b.blockSequence());this.pushContext()};Process.prototype.doWaitUntil=function(a){if(a)return this.popContext(),this.pushContext("doYield"),null;this.context.inputs=[];this.pushContext("doYield");this.pushContext()};
Process.prototype.doWait=function(a){this.context.startTime||(this.context.startTime=Date.now());if(Date.now()-this.context.startTime>=1E3*a)return null;this.pushContext("doYield");this.pushContext()};
Process.prototype.doGlide=function(a,b,c){this.context.startTime||(this.context.startTime=Date.now(),this.context.startValue=new Point(this.homeContext.receiver.xPosition(),this.homeContext.receiver.yPosition()));if(Date.now()-this.context.startTime>=1E3*a)return this.homeContext.receiver.gotoXY(b,c),null;this.homeContext.receiver.glide(1E3*a,b,c,Date.now()-this.context.startTime,this.context.startValue);this.pushContext("doYield");this.pushContext()};
Process.prototype.doSayFor=function(a,b){this.context.startTime||(this.context.startTime=Date.now(),this.homeContext.receiver.bubble(a));if(Date.now()-this.context.startTime>=1E3*b)return this.homeContext.receiver.stopTalking(),null;this.pushContext("doYield");this.pushContext()};
Process.prototype.doThinkFor=function(a,b){this.context.startTime||(this.context.startTime=Date.now(),this.homeContext.receiver.doThink(a));if(Date.now()-this.context.startTime>=1E3*b)return this.homeContext.receiver.stopTalking(),null;this.pushContext("doYield");this.pushContext()};
Process.prototype.doBroadcast=function(a){var b=this.homeContext.receiver.parentThatIsA(StageMorph),c=[],d=[];""!==a&&(b.children.concat(b).forEach(function(b){if(b instanceof SpriteMorph||b instanceof StageMorph)c=c.concat(b.allHatBlocksFor(a))}),c.forEach(function(a){d.push(b.threads.startProcess(a))}));return d};
Process.prototype.doBroadcastAndWait=function(a){this.context.activeSends||(this.context.activeSends=this.doBroadcast(a));this.context.activeSends=this.context.activeSends.filter(function(a){return a.isRunning()});if(0===this.context.activeSends.length)return null;this.pushContext("doYield");this.pushContext()};Process.prototype.reportSum=function(a,b){return parseFloat(a)+parseFloat(b)};Process.prototype.reportDifference=function(a,b){return parseFloat(a)-parseFloat(b)};
Process.prototype.reportProduct=function(a,b){return parseFloat(a)*parseFloat(b)};Process.prototype.reportQuotient=function(a,b){return parseFloat(a)/parseFloat(b)};Process.prototype.reportModulus=function(a,b){var c=parseFloat(a),d=parseFloat(b);return(c%d+d)%d};Process.prototype.reportRandom=function(a,b){var c=parseFloat(a),d=parseFloat(b);return 0!==c%1||0!==d%1?Math.random()*(d-c)+c:Math.floor(Math.random()*(d-c+1))+c};
Process.prototype.reportLessThan=function(a,b){var c=parseFloat(a),d=parseFloat(b);if(isNaN(c)||isNaN(d))c=a,d=b;return c<d};Process.prototype.reportAnd=function(a,b){return a&&b};Process.prototype.reportOr=function(a,b){return a||b};Process.prototype.reportNot=function(a){return!a};Process.prototype.reportGreaterThan=function(a,b){var c=parseFloat(a),d=parseFloat(b);if(isNaN(c)||isNaN(d))c=a,d=b;return c>d};Process.prototype.reportEquals=function(a,b){return snapEquals(a,b)};
Process.prototype.reportTrue=function(){return!0};Process.prototype.reportFalse=function(){return!1};Process.prototype.reportRound=function(a){return Math.round(parseFloat(a))};Process.prototype.reportJoin=function(a,b){return(a||"").toString().concat((b||"").toString())};Process.prototype.reportJoinWords=function(a){return a instanceof List?a.asText():(a||"").toString()};Process.prototype.reportLetter=function(a,b){var c=parseFloat(a||0);return(b||"").toString()[c-1]};
Process.prototype.reportStringSize=function(a){return(a||"").toString().length};Process.prototype.reportUnicode=function(a){return(a=(a||"").toString()[0])?a.charCodeAt(0):0};Process.prototype.reportUnicodeAsLetter=function(a){a=parseFloat(a||0);return String.fromCharCode(a)};Process.prototype.alert=function(a){var b;this.homeContext.receiver&&(b=this.homeContext.receiver.world(),b.isDevMode&&alert("Snap! "+a.asArray()))};
Process.prototype.log=function(a){var b;this.homeContext.receiver&&(b=this.homeContext.receiver.world(),b.isDevMode&&console.log("Snap! "+a.asArray()))};Process.prototype.reportTouchingObject=function(a){var b=this.homeContext.receiver,c;if(b){if("mouse-pointer"===a)return c=b.world().hand.position(),b.bounds.containsPoint(c)?!b.isTransparentAt(c):!1;if(c=b.parentThatIsA(StageMorph)){if("edge"===a)return!c.bounds.containsRectangle(b.bounds);if(c=detect(c.children,function(b){return b.name===a}))return b.isTouching(c)}}return!1};
Process.prototype.reportMouseX=function(){var a,b;if(this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph)))if(b=a.world())return b.hand.position().x-a.center().x;return 0};Process.prototype.reportMouseY=function(){var a,b;if(this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph)))if(b=a.world())return a.center().y-b.hand.position().y;return 0};
Process.prototype.reportMouseDown=function(){var a;return this.homeContext.receiver&&(a=this.homeContext.receiver.world())?"left"===a.hand.mouseButton:!1};Process.prototype.reportKeyPressed=function(a){var b;return this.homeContext.receiver&&(b=this.homeContext.receiver.parentThatIsA(StageMorph))?void 0!==b.keysPressed[a]:!1};Process.prototype.doResetTimer=function(){var a;this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph))&&a.resetTimer()};
Process.prototype.reportTimer=function(){var a;return this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph))?a.getTimer():0};Process.prototype.pushContext=function(a,b){var c=this.context?this.context.upvars:null;this.context=new Context(this.context,a,b||(this.context?this.context.outerContext:null),this.context?this.context.receiver:this.homeContext.receiver,this.context?this.context.isInsideCustomBlock:!1);c&&(this.context.upvars=new UpvarReference(c))};
Process.prototype.popContext=function(){this.context=this.context?this.context.parentContext:null};Process.prototype.returnValueToParentContext=function(a){void 0!==a&&(this.context?this.context.parentContext||this.homeContext:this.homeContext).addInput(a)};
function Context(a,b,c,d,e){this.outerContext=c||null;this.parentContext=a||null;this.expression=b||null;this.receiver=d||null;this.variables=new VariableFrame;this.outerContext&&(this.variables.parentFrame=this.outerContext.variables,this.receiver=this.outerContext.receiver);this.upvars=null;this.inputs=[];this.pc=0;this.startTime=null;this.isLambda=!1;this.isInsideCustomBlock=e||!1;this.isCustomBlock=!1;this.emptySlots=0}
Context.prototype.toString=function(){var a=this.isLambda?"\u03bb-":"",b=this.expression;b instanceof Array&&0<b.length&&(b="["+b[0]+"]");return a+"Context >> "+b+" "+this.variables};Context.prototype.image=function(){return this.expression instanceof Morph?this.expression.fullImage():this.expression instanceof Array?this.expression[this.pc].fullImage():newCanvas()};
Context.prototype.continuation=function(){var a;if(this.expression instanceof Array)a=this;else if(this.parentContext)a=this.parentContext;else return null;a=a.copyForContinuation();a.isContinuation=!0;return a};Context.prototype.copyForContinuation=function(){var a=copy(this),b=a,c=this.expression instanceof BlockMorph;for(c&&b.prepareContinuationForBinding();b.parentContext;)b.parentContext=copy(b.parentContext),b=b.parentContext,c&&(b.inputs=[]);return a};
Context.prototype.prepareContinuationForBinding=function(){this.expression=this.expression.fullCopy();this.inputs=[];this.emptySlots=detect(this.expression.inputs(),function(a){return a.selector&&"reportCallCC"===a.selector}).bindingID=1};Context.prototype.addInput=function(a){this.inputs.push(a)};Context.prototype.stackSize=function(){return!this.parentContext?1:1+this.parentContext.stackSize()};function VariableFrame(a,b){this.vars={};this.parentFrame=a||null;this.owner=b||null}
VariableFrame.prototype.toString=function(){return"a VariableFrame {"+this.names()+"}"};VariableFrame.prototype.copy=function(){var a=new VariableFrame(this.parentFrame);a.vars=copy(this.vars);return a};VariableFrame.prototype.find=function(a,b){if(void 0!==this.vars[a])return this;if(this.parentFrame)return this.parentFrame.find(a,b);if(b)return b.variables.find(a,b.parentContext);throw Error("a variable of name '"+a+"'\ndoes not exist in this context");};
VariableFrame.prototype.setVar=function(a,b,c){var c=this.find(a,c),d=parseFloat(b);c&&(c.vars[a]=isNaN(d)?b:d)};VariableFrame.prototype.changeVar=function(a,b,c){var c=this.find(a,c),d;c&&(d=parseFloat(c.vars[a]),c.vars[a]=isNaN(d)?b:c.vars[a]+b)};VariableFrame.prototype.getVar=function(a,b){var c=this.find(a,b);return c?(c=c.vars[a],0===c?0:c||0):null};VariableFrame.prototype.addVar=function(a,b){this.vars[a]=0===b?0:b||null};
VariableFrame.prototype.deleteVar=function(a,b){var c=this.find(a,b);c&&delete c.vars[a]};VariableFrame.prototype.names=function(){var a,b=[];for(a in this.vars)this.vars.hasOwnProperty(a)&&b.push(a);return b};VariableFrame.prototype.allNamesDict=function(){for(var a={},b=this;b;){var c=b.vars,d=a,e=void 0;for(e in c)c.hasOwnProperty(e)&&(d[e]=e);b=b.parentFrame}return a};VariableFrame.prototype.allNames=function(){var a=[],b,c=this.allNamesDict();for(b in c)c.hasOwnProperty(b)&&a.push(b);return a};
function UpvarReference(a){this.vars={};this.parentFrame=a||null}UpvarReference.prototype.addReference=function(a,b,c){this.vars[a]=[b,c]};UpvarReference.prototype.find=function(a){return void 0!==this.vars[a]?this:this.parentFrame?this.parentFrame.find(a):null};UpvarReference.prototype.getVar=function(a){a=this.vars[a][1].vars[this.vars[a][0]];return 0===a?0:a||0};UpvarReference.prototype.toString=function(){return"an UpvarReference {"+this.names()+"}"};UpvarReference.prototype.names=VariableFrame.prototype.names;
UpvarReference.prototype.allNames=VariableFrame.prototype.allNames;UpvarReference.prototype.allNamesDict=VariableFrame.prototype.allNamesDict;modules.objects="2012-Mar-29";SpriteMorph.prototype=new PenMorph;SpriteMorph.prototype.constructor=SpriteMorph;SpriteMorph.uber=PenMorph.prototype;SpriteMorph.prototype.categories="motion,control,looks,sensing,sound,operators,pen,variables,lists,other".split(",");
SpriteMorph.prototype.blockColor={motion:new Color(74,108,212),looks:new Color(143,86,227),sound:new Color(207,74,217),pen:new Color(0,161,120),control:new Color(230,168,34),sensing:new Color(4,148,220),operators:new Color(98,194,19),variables:new Color(243,118,29),lists:new Color(217,77,17),other:new Color(128,128,128)};SpriteMorph.prototype.paletteColor=new Color(55,55,55);SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor.lighter(30);
SpriteMorph.prototype.isCachingPrimitives=!0;SpriteMorph.prototype.bubbleColor=new Color(255,255,255);SpriteMorph.prototype.bubbleFontSize=14;SpriteMorph.prototype.bubbleFontIsBold=!0;SpriteMorph.prototype.bubbleCorner=10;SpriteMorph.prototype.bubbleBorder=3;SpriteMorph.prototype.bubbleBorderColor=new Color(190,190,190);SpriteMorph.prototype.bubbleMaxTextWidth=130;function SpriteMorph(a){this.init(a)}
SpriteMorph.prototype.init=function(a){this.name="Sprite";this.variables=new VariableFrame(a||null,this);this.scripts=new ScriptsMorph(this);this.customBlocks=[];this.costumes=new List;this.costume=null;this.normalExtent=new Point(60,60);this.scale=1;this.version=Date.now();this.blocksCache={};this.rotationOffset=new Point;SpriteMorph.uber.init.call(this);this.isDraggable=!0;this.isDown=!1;this.heading=90;this.changed();this.drawNew();this.changed()};
SpriteMorph.prototype.fullCopy=function(){var a=SpriteMorph.uber.fullCopy.call(this),b=[],c;a.stopTalking();a.color=this.color.copy();a.blocksCache={};a.scripts=this.scripts.fullCopy();a.scripts.owner=a;a.variables=this.variables.copy();a.variables.owner=a;a.customBlocks=[];this.customBlocks.forEach(function(b){c=b.copyAndBindTo(a);a.customBlocks.push(c);a.allBlockInstances(b).forEach(function(a){a.definition=c})});this.costumes.asArray().forEach(function(a){b.push(a)});a.costumes=new List(b);return a};
SpriteMorph.prototype.setName=function(a){this.name=a||this.name;this.version=Date.now()};
SpriteMorph.prototype.drawNew=function(){var a=this,b=this.center(),c;c=[];var d,e,f;this.costume?(c=this.costume.bounds().corners().map(function(b){return b.rotateBy(radians(a.heading-90),a.costume.center())}),d=c[0],e=c[0],c.forEach(function(a){d=d.min(a);e=e.max(a)}),f=d.corner(e).extent().multiplyBy(this.scale),c=(new Point(0,0)).rotateBy(radians(-(this.heading-90)),this.costume.center()).subtract(d),this.image=newCanvas(f),this.silentSetExtent(f),f=this.image.getContext("2d"),f.scale(this.scale,
this.scale),f.translate(c.x,c.y),f.rotate(radians(this.heading-90)),f.drawImage(this.costume.contents,0,0),this.setCenter(b),this.rotationOffset=c.translateBy(this.costume.rotationCenter).rotateBy(radians(-(this.heading-90)),c).scaleBy(this.scale)):(c=Math.min(Math.max(this.normalExtent.x*this.scale,5),1E3),this.silentSetExtent(new Point(c,c)),this.image=newCanvas(this.extent()),this.setCenter(b),SpriteMorph.uber.drawNew.call(this));this.version=Date.now()};
SpriteMorph.prototype.rotationCenter=function(){return this.costume?this.position().add(this.rotationOffset):this.center()};
SpriteMorph.prototype.blockTemplates=function(a){function b(a,b,c,d,e){a="reporter"===a?new ReporterBlockMorph:"predicate"===a?new ReporterBlockMorph(!0):"hat"===a?new HatBlockMorph:new CommandBlockMorph;a.isDraggable=!1;a.isTemplate=!0;a.color=f.blockColor[b];a.selector=d;a.setSpec(c);if(e)if(a.defaults=e,g=a.inputs(),g[0]instanceof MultiArgMorph)g[0].setContents(e),g[0].defaults=e;else for(h=0;h<e.length;h+=1)null!==e[h]&&g[h].setContents(e[h]);return a}function c(a,b,c){return new ToggleMorph("checkbox",
this,function(){f.toggleWatcher(c,b,f.blockColor[a])},null,function(){return f.showingWatcher(c)},null)}function d(a){return new ToggleMorph("checkbox",this,function(){f.toggleVariableWatcher(a)},null,function(){return f.showingVariableWatcher(a)},null)}var e=[],f=this,g,h,i=a||"motion";"motion"===i?(e.push(b("command","motion","move %n steps","forward",[10])),e.push(b("command","motion","turn %clockwise %n degrees","turn",[15])),e.push(b("command","motion","turn %counterclockwise %n degrees","turnLeft",
[15])),e.push("-"),e.push(b("command","motion","point in direction %dir","setHeading")),e.push("-"),e.push(b("command","motion","go to x: %n y: %n","gotoXY",[0,0])),e.push(b("command","motion","glide %n secs to x: %n y: %n","doGlide",[1,0,0])),e.push("-"),e.push(b("command","motion","change x by %n","changeXPosition",[10])),e.push(b("command","motion","set x to %n","setXPosition",[0])),e.push(b("command","motion","change y by %n","changeYPosition",[10])),e.push(b("command","motion","set y to %n",
"setYPosition",[0])),e.push("-"),e.push(b("command","motion","if on edge, bounce","bounceOffEdge")),e.push("-"),e.push(c("motion","x position","xPosition")),e.push(b("reporter","motion","x position","xPosition")),e.push(c("motion","y position","yPosition")),e.push(b("reporter","motion","y position","yPosition")),e.push(c("motion","direction","direction")),e.push(b("reporter","motion","direction","direction"))):"looks"===i?(e.push(b("command","looks","switch to costume %cst","doSwitchToCostume",["Turtle"])),
e.push(b("command","looks","next costume","doWearNextCostume")),e.push(c("looks","costume #","getCostumeIdx")),e.push(b("reporter","looks","costume #","getCostumeIdx")),e.push("-"),e.push(b("command","looks","say %s for %n secs","doSayFor",["Hello!",2])),e.push(b("command","looks","say %s","bubble",["Hello!"])),e.push(b("command","looks","think %s for %n secs","doThinkFor",["Hmm...",2])),e.push(b("command","looks","think %s","doThink",["Hmm..."])),e.push("-"),e.push(b("command","looks","change %eff effect by %n",
"changeEffect",[null,25])),e.push(b("command","looks","set %eff effect to %n","setEffect",[null,0])),e.push(b("command","looks","clear graphic effects","clearEffects")),e.push("-"),e.push(b("command","looks","change size by %n","changeScale",[10])),e.push(b("command","looks","set size to %n %","setScale",[100])),e.push(c("looks","size","getScale")),e.push(b("reporter","looks","size","getScale")),e.push("-"),e.push(b("command","looks","show","show")),e.push(b("command","looks","hide","hide")),e.push("-"),
e.push(b("command","looks","go to front","comeToFront")),e.push(b("command","looks","go back %n layers","goBack",[1])),this.world().isDevMode&&(e.push("-"),a=new TextMorph("development mode \ndebugging primitives:"),a.fontSize=9,a.setColor(new Color(230,230,230)),e.push(a),e.push("-"),e.push(b("command","looks","console log %mult%s","log")),e.push(b("command","looks","alert %mult%s","alert")))):"sound"===i?(a=new TextMorph("sound primitives are\nnot yet implemented"),a.fontSize=9,a.setColor(new Color(230,
230,230)),e.push(a)):"pen"===i?(e.push(b("command","pen","clear","clear")),e.push("-"),e.push(b("command","pen","pen down","down")),e.push(b("command","pen","pen up","up")),e.push("-"),e.push(b("command","pen","set pen color to %clr","setColor")),e.push(b("command","pen","change pen color by %n","changeHue",[10])),e.push(b("command","pen","set pen color to %n","setHue",[0])),e.push("-"),e.push(b("command","pen","change pen shade by %n","changeBrightness",[10])),e.push(b("command","pen","set pen shade to %n",
"setBrightness",[100])),e.push("-"),e.push(b("command","pen","change pen size by %n","changeSize",[1])),e.push(b("command","pen","set pen size to %n","setSize",[1])),e.push("-"),e.push(b("command","pen","stamp","doStamp"))):"control"===i?(e.push(b("hat","control","when %greenflag clicked","receiveGo")),e.push(b("hat","control","when %key key pressed","receiveKey")),e.push(b("hat","control","when I am clicked","receiveClick")),e.push(b("hat","control","when I receive %msg","receiveMessage")),e.push("-"),
e.push(b("command","control","broadcast %msg","doBroadcast")),e.push(b("command","control","broadcast %msg and wait","doBroadcastAndWait")),e.push("-"),e.push(b("command","control","wait %n secs","doWait",[1])),e.push(b("command","control","wait until %b","doWaitUntil")),e.push("-"),e.push(b("command","control","forever %c","doForever")),e.push(b("command","control","repeat %n %c","doRepeat",[10])),e.push(b("command","control","repeat until %b %c","doUntil")),e.push("-"),e.push(b("command","control",
"if %b %c","doIf")),e.push(b("command","control","if %b %c else %c","doIfElse")),e.push("-"),e.push(b("command","control","stop block","doReport")),e.push(b("command","control","stop script","doStop")),e.push(b("command","control","stop all %stop","doStopAll")),e.push("-"),e.push(b("command","control","run %cmd %inputs","doRun")),e.push(b("command","control","launch %cmd %inputs","fork")),e.push(b("reporter","control","call %r %inputs","evaluate")),e.push("-"),e.push(b("command","control","run %cmd w/continuation",
"doCallCC")),e.push(b("reporter","control","call %cmd w/continuation","reportCallCC")),e.push("-"),e.push(b("command","control","report %s","doReport")),e.push("-"),e.push(b("command","other","warp %c","doWarp"))):"sensing"===i?(e.push(b("predicate","sensing","touching %col ?","reportTouchingObject")),e.push("-"),e.push(b("reporter","sensing","mouse x","reportMouseX")),e.push(b("reporter","sensing","mouse y","reportMouseY")),e.push(b("predicate","sensing","mouse down?","reportMouseDown")),e.push("-"),
e.push(b("predicate","sensing","key %key pressed?","reportKeyPressed")),e.push("-"),e.push(b("command","sensing","reset timer","doResetTimer")),e.push(c("sensing","timer","getTimer")),e.push(b("reporter","sensing","timer","reportTimer"))):"operators"===i?(e.push(b("reporter","operators","%n + %n","reportSum")),e.push(b("reporter","operators","%n - %n","reportDifference")),e.push(b("reporter","operators","%n \u00d7 %n","reportProduct")),e.push(b("reporter","operators","%n \u00f7 %n","reportQuotient")),
e.push("-"),e.push(b("reporter","operators","%n mod %n","reportModulus")),e.push(b("reporter","operators","round %n","reportRound")),e.push(b("reporter","operators","pick random %n to %n","reportRandom",[1,10])),e.push("-"),e.push(b("predicate","operators","%s < %s","reportLessThan")),e.push(b("predicate","operators","%s = %s","reportEquals")),e.push(b("predicate","operators","%s > %s","reportGreaterThan")),e.push("-"),e.push(b("predicate","operators","%b and %b","reportAnd")),e.push(b("predicate",
"operators","%b or %b","reportOr")),e.push(b("predicate","operators","not %b","reportNot")),e.push("-"),e.push(b("predicate","operators","true","reportTrue")),e.push(b("predicate","operators","false","reportFalse")),e.push("-"),e.push(b("reporter","operators","join %words","reportJoinWords",["hello ","world"])),e.push(b("reporter","operators","letter %n of %s","reportLetter",[1,"world"])),e.push(b("reporter","operators","length of %s","reportStringSize",["world"])),e.push("-"),e.push(b("reporter",
"operators","unicode of %s","reportUnicode",["a"])),e.push(b("reporter","operators","unicode %n as letter","reportUnicodeAsLetter",[65])),e.push("-"),e.push(b("reporter","operators","the script %parms %c","reportScript")),e.push(b("reporter","operators","the %f block %parms","reify"))):"variables"===i&&(a=new PushButtonMorph(null,function(){(new VariableDialogMorph(null,function(a){a&&(f.addVariable(a[0],a[1]),f.toggleVariableWatcher(a[0],a[1]),f.blocksCache[i]=null,f.parentThatIsA(IDE_Morph).refreshPalette())},
f)).prompt("Variable name",null,f.world())},"Make a variable"),e.push(a),0<this.variables.allNames().length&&(a=new PushButtonMorph(null,function(){var a=new MenuMorph(f.deleteVariable,null,f);f.variables.allNames().forEach(function(b){a.addItem(b,b)});a.popUpAtHand(f.world())},"Delete a variable"),e.push(a)),e.push("-"),a=this.variables.allNames(),0<a.length&&(a.forEach(function(a){e.push(d(a));e.push(b("reporter","variables",a,"reportGetVar"))}),e.push("-")),e.push(b("command","variables","set %var to %s",
"doSetVar",[null,0])),e.push(b("command","variables","change %var by %n","doChangeVar",[null,1])),e.push(b("command","variables","show variable %var","doShowVar")),e.push(b("command","variables","hide variable %var","doHideVar")),e.push(b("command","other","script variables %scriptVars","doDeclareVariables")),e.push("="),e.push(b("reporter","lists","list %mult%s","reportNewList")),e.push("-"),e.push(b("reporter","lists","%s in front of %l","reportCONS")),e.push(b("reporter","lists","item %idx of %l",
"reportListItem",[1])),e.push(b("reporter","lists","all but first of %l","reportCDR")),e.push("-"),e.push(b("reporter","lists","length of %l","reportListLength")),e.push(b("predicate","lists","%l contains %s","reportListContainsItem",[null,"thing"])),e.push("-"),e.push(b("command","lists","add %s to %l","doAddToList",["thing"])),e.push(b("command","lists","delete %ida of %l","doDeleteFromList",[1])),e.push(b("command","lists","insert %s at %idx of %l","doInsertInList",["thing",1])),e.push(b("command",
"lists","replace item %idx of %l with %s","doReplaceInList",[1,null,"thing"])),e.push("="),a=new PushButtonMorph(null,function(){var a=f.parentThatIsA(IDE_Morph);(new BlockDialogMorph(null,function(b){if(b.spec!==""){f.customBlocks.push(b);f.cacheCustomBlock(b);a.refreshPalette();(new BlockEditorMorph(b,f)).popUp()}},f)).prompt("Make a block",null,f.world())},"Make a block"),e.push(a));return e};SpriteMorph.prototype.cacheCustomBlock=function(a){this.blocksCache.custom||this.cacheCustomBlocks();this.blocksCache.custom.push(a.templateInstance())};
SpriteMorph.prototype.cacheCustomBlocks=function(){var a=this;this.blocksCache.custom=[];this.customBlocks.forEach(function(b){a.blocksCache.custom.push(b.templateInstance())})};
SpriteMorph.prototype.palette=function(a){var b=new ScrollFrameMorph(null,null,this.sliderColor),c=SyntaxElementMorph.prototype.fontSize,d=0,e=5,f,g=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1;b.owner=this;b.padding=c/2;b.color=this.paletteColor;f=this.blocksCache[a];f||(f=this.blockTemplates(a),this.isCachingPrimitives&&(this.blocksCache[a]=f));f.forEach(function(a){if(a==="-")e=e+c*0.8;else if(a==="=")e=e+c*1.6;else{d===0&&(e=e+c*0.3);a.setPosition(new Point(d,e));b.addContents(a);
if(a instanceof ToggleMorph)d=a.right()+c/2;else{a.fixLayout&&a.fixLayout();d=0;e=e+a.height()}}});this.blocksCache.custom||this.cacheCustomBlocks();e+=1.6*c;this.blocksCache.custom.forEach(function(f){if(f.definition.category===a||a==="variables"&&contains(["lists","other"],f.definition.category)){e=e+c*0.3;f.setPosition(new Point(d,e));b.addContents(f);d=0;e=e+f.height()}});Morph.prototype.trackChanges=g;return b};
SpriteMorph.prototype.addVariable=function(a,b){var c=this.parentThatIsA(IDE_Morph);b?(this.variables.parentFrame.addVar(a),c&&c.flushBlocksCache("variables")):(this.variables.addVar(a),this.blocksCache.variables=null)};SpriteMorph.prototype.deleteVariable=function(a){var b=this.parentThatIsA(IDE_Morph);this.deleteVariableWatcher(a);this.variables.deleteVar(a);b&&(b.flushBlocksCache("variables"),b.refreshPalette())};
SpriteMorph.prototype.addCostume=function(a){a.name||(a.name="costume"+(this.costumes.length()+1));this.costumes.add(a)};SpriteMorph.prototype.wearCostume=function(a){var b=this.xPosition?this.xPosition():null,c=this.yPosition?this.yPosition():null;this.changed();this.costume=a;this.drawNew();this.changed();null!==b&&this.silentGotoXY(b,c);this.positionTalkBubble&&this.positionTalkBubble();this.version=Date.now()};
SpriteMorph.prototype.getCostumeIdx=function(){return this.costumes.asArray().indexOf(this.costume)+1};SpriteMorph.prototype.doWearNextCostume=function(){var a=this.costumes.asArray(),b;1<a.length&&(b=a.indexOf(this.costume),-1<b&&(b+=1,b>a.length-1&&(b=0),this.wearCostume(a[b])))};SpriteMorph.prototype.doSwitchToCostume=function(a){var b,c=this.costumes.asArray();"Turtle"===a?b=null:(b=detect(c,function(b){return b.name===a}),null===b&&(b=parseFloat(a),b=0===b?null:c[b-1]||null));this.wearCostume(b)};
SpriteMorph.prototype.userMenu=function(){var a=new MenuMorph(this);a.addItem("duplicate","duplicate");a.addItem("delete","remove");a.addItem("edit","edit");return a};SpriteMorph.prototype.edit=function(){var a=this.parentThatIsA(IDE_Morph);a&&a.selectSprite(this)};SpriteMorph.prototype.showOnStage=function(){var a=this.parentThatIsA(StageMorph);this.show();a&&this.keepWithin(a)};SpriteMorph.prototype.duplicate=function(){var a=this.parentThatIsA(IDE_Morph);a&&a.duplicateSprite(this)};
SpriteMorph.prototype.remove=function(){var a=this.parentThatIsA(IDE_Morph);a&&a.removeSprite(this)};SpriteMorph.prototype.getHue=function(){return 100*this.color.hsv()[0]};SpriteMorph.prototype.setHue=function(a){var b=this.color.hsv();b[0]=Math.max(Math.min(parseFloat(a),100),0)/100;b[1]=1;this.color.set_hsv.apply(this.color,b);this.drawNew();this.changed()};SpriteMorph.prototype.changeHue=function(a){this.setHue(this.getHue()+parseFloat(a))};
SpriteMorph.prototype.getBrightness=function(){return 100*this.color.hsv()[2]};SpriteMorph.prototype.setBrightness=function(a){var b=this.color.hsv();b[1]=1;b[2]=Math.max(Math.min(parseFloat(a),100),0)/100;this.color.set_hsv.apply(this.color,b);this.drawNew();this.changed()};SpriteMorph.prototype.changeBrightness=function(a){this.setBrightness(this.getBrightness()+parseFloat(a))};SpriteMorph.prototype.comeToFront=function(){this.parent&&(this.parent.add(this),this.changed())};
SpriteMorph.prototype.goBack=function(a){var b;if(!this.parent)return null;b=this.parent.children.indexOf(this);if(b<parseFloat(a))return null;this.parent.removeChild(this);this.parent.children.splice(b-parseFloat(a),null,this);this.parent.changed()};
SpriteMorph.prototype.overlappingImage=function(a){var b=this.bounds.intersect(a.bounds),c=newCanvas(b.extent()),d=c.getContext("2d");if(1>b.width()||1>b.height())return newCanvas(new Point(1,1));d.drawImage(this.image,this.left()-b.left(),this.top()-b.top());d.globalCompositeOperation="source-in";d.drawImage(a.image,a.left()-b.left(),a.top()-b.top());return c};
SpriteMorph.prototype.doStamp=function(){var a=this.parent;a.penTrails().getContext("2d").drawImage(this.image,this.left()-a.left(),this.top()-a.top());this.isWarped||this.changed()};SpriteMorph.prototype.setSize=function(a){this.size=Math.min(Math.max(parseFloat(a),1.0E-4),1E3)};SpriteMorph.prototype.changeSize=function(a){this.setSize(this.size+parseFloat(a))};SpriteMorph.prototype.getScale=function(){return 100*this.scale};
SpriteMorph.prototype.setScale=function(a){var b=this.xPosition(),c=this.yPosition();this.scale=Math.max(parseFloat(a/100),0.01);this.changed();this.drawNew();this.changed();this.silentGotoXY(b,c);this.positionTalkBubble()};SpriteMorph.prototype.changeScale=function(a){this.setScale(this.getScale()+parseFloat(a))};SpriteMorph.prototype.setEffect=function(a,b){"ghost"===a&&(this.alpha=1-Math.min(Math.max(parseFloat(b),0),100)/100,this.changed())};
SpriteMorph.prototype.getGhostEffect=function(){return 100*(1-this.alpha)};SpriteMorph.prototype.changeEffect=function(a,b){"ghost"===a&&this.setEffect(a,this.getGhostEffect()+parseFloat(b))};SpriteMorph.prototype.clearEffects=function(){this.setEffect("ghost",0)};SpriteMorph.prototype.stopTalking=function(){var a=this.talkBubble();a&&a.destroy()};SpriteMorph.prototype.doThink=function(a){this.bubble(a,!0)};
SpriteMorph.prototype.bubble=function(a,b){var c,d,e=!1,f;this.stopTalking();if(""===a)return null;a instanceof Morph?d=a:isString(a)?(e=!0,d=new TextMorph(a,this.bubbleFontSize,null,this.bubbleFontIsBold,!1,"center")):a instanceof HTMLCanvasElement?(d=new Morph,d.silentSetWidth(a.width),d.silentSetHeight(a.height),d.image=a):a instanceof List?(d=new ListWatcherMorph(a),d.isDraggable=!1,d.update(!0),d.step=d.update):a instanceof Context?(f=a.image(),d=new Morph,d.silentSetWidth(f.width),d.silentSetHeight(f.height),
d.image=f):d=new TextMorph(a.toString(),this.bubbleFontSize,null,this.bubbleFontIsBold,!1,"center");d instanceof TextMorph&&(f=Math.max(d.width(),2*this.bubbleCorner),e&&(f=Math.min(f,this.bubbleMaxTextWidth)),d.setWidth(f));c=new SpeechBubbleMorph(d,this.bubbleColor,this.bubbleCorner,this.bubbleBorder,this.bubbleBorderColor,this.bubbleCorner/2,b);c.fixLayout=function(){c.changed();c.drawNew();c.changed()};this.add(c);this.positionTalkBubble()};
SpriteMorph.prototype.talkBubble=function(){return detect(this.children,function(a){return a instanceof SpeechBubbleMorph})};
SpriteMorph.prototype.positionTalkBubble=function(){var a=this.parentThatIsA(StageMorph),b=this.talkBubble(),c=this.center().y;if(!b)return null;b.show();b.isPointingRight||(b.isPointingRight=!0,b.drawNew(),b.changed());b.setLeft(this.right());for(b.setBottom(this.top());!this.isTouching(b)&&b.bottom()<c;)b.silentMoveBy(new Point(-1,1));if(!a)return null;b.right()>a.right()&&(b.isPointingRight=!1,b.drawNew(),b.setRight(this.center().x));b.keepWithin(a);b.changed()};
SpriteMorph.prototype.prepareToBeGrabbed=function(a){var b=this.talkBubble();if(!b)return null;this.removeShadow();b.hide();this.bounds.containsPoint(a.position())||this.setCenter(a.position());this.addShadow()};SpriteMorph.prototype.justDropped=function(){this.positionTalkBubble()};
PenMorph.prototype.forward=function(a){var b=this.rotationCenter(),a=parseFloat(a);this.setPosition(0<=a?this.position().distanceAngle(a,this.heading):this.position().distanceAngle(Math.abs(a),this.heading-180));this.drawLine(b,this.rotationCenter());this.positionTalkBubble()};SpriteMorph.prototype.setHeading=function(a){var b=this.xPosition(),c=this.yPosition();this.changed();SpriteMorph.uber.setHeading.call(this,a);this.silentGotoXY(b,c);this.positionTalkBubble()};
SpriteMorph.prototype.turnLeft=function(a){this.setHeading(this.heading-parseFloat(a))};SpriteMorph.prototype.xPosition=function(){var a=this.parentThatIsA(StageMorph);return a?this.rotationCenter().x-a.center().x:this.rotationCenter().x};SpriteMorph.prototype.yPosition=function(){var a=this.parentThatIsA(StageMorph);return a?a.center().y-this.rotationCenter().y:this.rotationCenter().y};SpriteMorph.prototype.direction=function(){return this.heading};SpriteMorph.prototype.penSize=function(){return this.size};
SpriteMorph.prototype.gotoXY=function(a,b){var c=this.parentThatIsA(StageMorph),d=this.rotationCenter(),e;c?(e=c.center().x+parseFloat(a),c=c.center().y-parseFloat(b)):(e=parseFloat(a),c=parseFloat(b));this.setPosition(this.costume?(new Point(e,c)).subtract(this.rotationOffset):(new Point(e,c)).subtract(this.extent().divideBy(2)));this.drawLine(d,this.rotationCenter());this.positionTalkBubble()};
SpriteMorph.prototype.silentGotoXY=function(a,b){var c=this.isDown;this.isDown=!1;this.gotoXY(a,b);this.isDown=c};SpriteMorph.prototype.setXPosition=function(a){this.gotoXY(parseFloat(a),this.yPosition())};SpriteMorph.prototype.changeXPosition=function(a){this.setXPosition(this.xPosition()+parseFloat(a))};SpriteMorph.prototype.setYPosition=function(a){this.gotoXY(this.xPosition(),parseFloat(a))};SpriteMorph.prototype.changeYPosition=function(a){this.setYPosition(this.yPosition()+parseFloat(a))};
SpriteMorph.prototype.glide=function(a,b,c,d,e){b=new Point(b,c);a=Math.max(Math.min(d/a,1),0);e=e.add(b.subtract(e).multiplyBy(a));this.gotoXY(e.x,e.y)};
SpriteMorph.prototype.bounceOffEdge=function(){var a=this.parentThatIsA(StageMorph),b,c;if(!a||a.bounds.containsRectangle(this.bounds))return null;b=Math.cos(radians(this.heading));c=-Math.sin(radians(this.heading));this.left()<a.left()&&(b=Math.abs(b));this.right()>a.right()&&(b=-Math.abs(b));this.top()<a.top()&&(c=-Math.abs(c));this.bottom()>a.bottom()&&(c=Math.abs(c));this.setHeading(degrees(Math.atan2(-c,b))+90);this.setPosition(this.position().add(this.bounds.amountToTranslateWithin(a.bounds)));
this.positionTalkBubble()};SpriteMorph.prototype.allMessageNames=function(){var a=[];this.scripts.allChildren().forEach(function(b){b.selector&&contains(["receiveMessage","doBroadcast","doBroadcastAndWait"],b.selector)&&(b=b.inputs()[0].evaluate(),""!==b&&(contains(a,b)||a.push(b)))});return a};
SpriteMorph.prototype.allHatBlocksFor=function(a){return this.scripts.children.filter(function(b){if(b.selector){if("receiveMessage"===b.selector)return b.inputs()[0].evaluate()===a;if("receiveGo"===b.selector)return"__shout__go__"===a;if("receiveClick"===b.selector)return"__click__"===a}return!1})};SpriteMorph.prototype.allHatBlocksForKey=function(a){return this.scripts.children.filter(function(b){return b.selector&&"receiveKey"===b.selector?b.inputs()[0].evaluate()===a:!1})};
SpriteMorph.prototype.mouseClickLeft=function(){var a=this.parentThatIsA(StageMorph),b=[];this.allHatBlocksFor("__click__").forEach(function(c){b.push(a.threads.startProcess(c))});return b};SpriteMorph.prototype.getTimer=function(){var a=this.parentThatIsA(StageMorph);return a?a.getTimer():0};
SpriteMorph.prototype.findVariableWatcher=function(a){var b=this.parentThatIsA(StageMorph),c=this;return null===b?null:detect(b.children,function(b){return b instanceof WatcherMorph&&(b.target===c.variables||b.target===c.variables.parentFrame)&&b.getter===a})};
SpriteMorph.prototype.toggleVariableWatcher=function(a,b){var c=this.parentThatIsA(StageMorph),d,e;if(null===c)return null;d=this.findVariableWatcher(a);null!==d?d.isVisible?d.hide():(d.show(),d.fixLayout()):(d=new WatcherMorph(a,this.blockColor.variables,b?this.variables.parentFrame:this.variables,a),d.setPosition(c.position().add(10)),e=c.watchers(d.left()),0<e.length&&d.setTop(e[e.length-1].bottom()),c.add(d),d.fixLayout())};
SpriteMorph.prototype.showingVariableWatcher=function(a){return null===this.parentThatIsA(StageMorph)?!1:(a=this.findVariableWatcher(a))?a.isVisible:!1};SpriteMorph.prototype.deleteVariableWatcher=function(a){if(null===this.parentThatIsA(StageMorph))return null;a=this.findVariableWatcher(a);null!==a&&a.destroy()};
SpriteMorph.prototype.toggleWatcher=function(a,b,c){var d=this.parentThatIsA(StageMorph),e,f=this;if(null===d)return null;e=detect(d.children,function(b){return b instanceof WatcherMorph&&b.target===f&&b.getter===a});null!==e?e.isVisible?e.hide():(e.show(),e.fixLayout()):(e=new WatcherMorph(b,c,this,a),e.setPosition(d.position().add(10)),b=d.watchers(e.left()),0<b.length&&e.setTop(b[b.length-1].bottom()),d.add(e),e.fixLayout())};
SpriteMorph.prototype.showingWatcher=function(a){var b=this.parentThatIsA(StageMorph),c=this;return null===b?!1:(b=detect(b.children,function(b){return b instanceof WatcherMorph&&b.target===c&&b.getter===a}))?b.isVisible:!1};
SpriteMorph.prototype.deleteAllBlockInstances=function(a){var b=this.blocksCache.custom.indexOf(this.paletteBlockInstance(a));this.allBlockInstances(a).forEach(function(a){a.deleteBlock()});this.customBlocks.forEach(function(a){a.body&&a.body.expression.isCorpse&&(a.body=null)});-1<b&&this.blocksCache.custom.splice(b,1)};
SpriteMorph.prototype.allBlockInstances=function(a){var b,c,d;b=this.scripts.allChildren().filter(function(b){return b.definition&&b.definition===a});c=[];this.customBlocks.forEach(function(b){b.body&&b.body.expression.allChildren().forEach(function(b){b.definition&&b.definition===a&&c.push(b)})});d=this.paletteBlockInstance(a);b=b.concat(c);d&&b.push(d);return b};SpriteMorph.prototype.paletteBlockInstance=function(a){return detect(this.blocksCache.custom||[],function(b){return b.definition===a})};
SpriteMorph.prototype.usesBlockInstance=function(a){var b;if(detect(this.scripts.allChildren(),function(b){return b.definition&&b.definition===a}))return!0;b=[];this.customBlocks.forEach(function(c){c.body&&c.body.expression.allChildren().forEach(function(c){c.definition&&c.definition===a&&b.push(c)})});return 0<b.length};SpriteMorph.prototype.thumbnail=function(a){var b=this.image,c=Math.min(a.x/b.width,a.y/b.height),a=newCanvas(a),d=a.getContext("2d");d.scale(c,c);d.drawImage(b,0,0);return a};
StageMorph.prototype=new FrameMorph;StageMorph.prototype.constructor=StageMorph;StageMorph.uber=FrameMorph.prototype;StageMorph.prototype.isCachingPrimitives=SpriteMorph.prototype.isCachingPrimitives;StageMorph.prototype.sliderColor=SpriteMorph.prototype.sliderColor;function StageMorph(a){this.init(a)}
StageMorph.prototype.init=function(a){this.name="Stage";this.threads=new ThreadManager;this.variables=new VariableFrame(a||null,this);this.scripts=new ScriptsMorph(this);this.customBlocks=[];this.costumes=new List;this.costume=null;this.version=Date.now();this.timerStart=Date.now();this.watcherUpdateFrequency=2;this.lastWatcherUpdate=Date.now();this.keysPressed={};this.blocksCache={};StageMorph.uber.init.call(this);this.acceptsDrops=!1;this.setColor(new Color(255,255,255))};
StageMorph.prototype.drawNew=function(){var a;StageMorph.uber.drawNew.call(this);this.costume&&(a=this.image.getContext("2d"),a.drawImage(this.costume.contents,(this.width()-this.costume.width())/2,(this.height()-this.costume.height())/2))};StageMorph.prototype.watchers=function(a){return this.children.filter(function(b){return b instanceof WatcherMorph?a?b.left()===a:b.isVisible:!1})};StageMorph.prototype.resetTimer=function(){this.timerStart=Date.now()};
StageMorph.prototype.getTimer=function(){return Math.floor((Date.now()-this.timerStart)/100)/10};StageMorph.prototype.wantsDropOf=function(a){return a instanceof SpriteMorph||a instanceof WatcherMorph||a instanceof ListWatcherMorph};
StageMorph.prototype.step=function(){var a=this.world();null===a.keyboardReceiver&&(a.keyboardReceiver=this);null===a.currentKey&&(this.keyPressed=null);this.threads.step();1>1E3/this.watcherUpdateFrequency-(Date.now()-this.lastWatcherUpdate)&&(this.watchers().forEach(function(a){a.update()}),this.lastWatcherUpdate=Date.now())};
StageMorph.prototype.developersMenu=function(){var a=this,b=StageMorph.uber.developersMenu.call(this);b.addItem("stop",function(){a.threads.stopAll()},"terminate all running threads");return b};StageMorph.prototype.processKeyDown=function(a){this.processKeyEvent(a,this.fireKeyEvent)};StageMorph.prototype.processKeyUp=function(a){this.processKeyEvent(a,this.removePressedKey)};
StageMorph.prototype.processKeyEvent=function(a,b){var c;switch(a.keyCode){case 32:c="space";break;case 37:c="left arrow";break;case 39:c="right arrow";break;case 38:c="up arrow";break;case 40:c="down arrow";break;default:c=String.fromCharCode(a.keyCode||a.charCode)}b.call(this,c)};
StageMorph.prototype.fireKeyEvent=function(a){var b=a.toLowerCase(),c=[],d=[],e=this;this.keysPressed[a]=!0;this.children.concat(this).forEach(function(a){if(a instanceof SpriteMorph||a instanceof StageMorph)c=c.concat(a.allHatBlocksForKey(b))});c.forEach(function(a){d.push(e.threads.startProcess(a))});return d};StageMorph.prototype.removePressedKey=function(a){delete this.keysPressed[a]};StageMorph.prototype.processKeyPress=function(a){nop(a)};StageMorph.prototype.inspectKeyEvent=CursorMorph.prototype.inspectKeyEvent;
StageMorph.prototype.blockTemplates=function(a){function b(a,b,c,d,e){a="reporter"===a?new ReporterBlockMorph:"predicate"===a?new ReporterBlockMorph(!0):"hat"===a?new HatBlockMorph:new CommandBlockMorph;a.isDraggable=!1;a.isTemplate=!0;a.color=f.blockColor[b];a.selector=d;a.setSpec(c);if(e)if(a.defaults=e,g=a.inputs(),g[0]instanceof MultiArgMorph)g[0].setContents(e),g[0].defaults=e;else for(h=0;h<e.length;h+=1)null!==e[h]&&g[h].setContents(e[h]);return a}function c(a,b,c){return new ToggleMorph("checkbox",
this,function(){f.toggleWatcher(c,b,f.blockColor[a])},null,function(){return f.showingWatcher(c)},null)}function d(a){return new ToggleMorph("checkbox",this,function(){f.toggleVariableWatcher(a)},null,function(){return f.showingVariableWatcher(a)},null)}var e=[],f=this,g,h,i=a||"motion";"motion"===i?(a=new TextMorph("Stage selected:\nno motion primitives"),a.fontSize=9,a.setColor(new Color(230,230,230)),e.push(a)):"looks"===i?(e.push(b("command","looks","switch to costume %cst","doSwitchToCostume")),
e.push(b("command","looks","next costume","doWearNextCostume")),e.push(c("looks","costume #","getCostumeIdx")),e.push(b("reporter","looks","costume #","getCostumeIdx")),e.push("-"),this.world().isDevMode&&(e.push("-"),a=new TextMorph("development mode \ndebugging primitives:"),a.fontSize=9,a.setColor(new Color(230,230,230)),e.push(a),e.push("-"),e.push(b("command","looks","console log %mult%s","log")),e.push(b("command","looks","alert %mult%s","alert")))):"sound"===i?(a=new TextMorph("sound primitives are\nnot yet implemented"),
a.fontSize=9,a.setColor(new Color(230,230,230)),e.push(a)):"pen"===i?e.push(b("command","pen","clear","clear")):"control"===i?(e.push(b("hat","control","when %greenflag clicked","receiveGo")),e.push(b("hat","control","when %key key pressed","receiveKey")),e.push(b("hat","control","when I am clicked","receiveClick")),e.push(b("hat","control","when I receive %msg","receiveMessage")),e.push("-"),e.push(b("command","control","broadcast %msg","doBroadcast")),e.push(b("command","control","broadcast %msg and wait",
"doBroadcastAndWait")),e.push("-"),e.push(b("command","control","wait %n secs","doWait",[1])),e.push(b("command","control","wait until %b","doWaitUntil")),e.push("-"),e.push(b("command","control","forever %c","doForever")),e.push(b("command","control","repeat %n %c","doRepeat",[10])),e.push(b("command","control","repeat until %b %c","doUntil")),e.push("-"),e.push(b("command","control","if %b %c","doIf")),e.push(b("command","control","if %b %c else %c","doIfElse")),e.push("-"),e.push(b("command","control",
"stop block","doReport")),e.push(b("command","control","stop script","doStop")),e.push(b("command","control","stop all %stop","doStopAll")),e.push("-"),e.push(b("command","control","run %cmd %inputs","doRun")),e.push(b("command","control","launch %cmd %inputs","fork")),e.push(b("reporter","control","call %r %inputs","evaluate")),e.push("-"),e.push(b("command","control","run %cmd w/continuation","doCallCC")),e.push(b("reporter","control","call %cmd w/continuation","reportCallCC")),e.push("-"),e.push(b("command",
"control","report %s","doReport")),e.push("-"),e.push(b("command","other","warp %c","doWarp"))):"sensing"===i?(e.push(b("reporter","sensing","mouse x","reportMouseX")),e.push(b("reporter","sensing","mouse y","reportMouseY")),e.push(b("predicate","sensing","mouse down?","reportMouseDown")),e.push("-"),e.push(b("predicate","sensing","key %key pressed?","reportKeyPressed")),e.push("-"),e.push(b("command","sensing","reset timer","doResetTimer")),e.push(c("sensing","timer","getTimer")),e.push(b("reporter",
"sensing","timer","reportTimer"))):"operators"===i?(e.push(b("reporter","operators","%n + %n","reportSum")),e.push(b("reporter","operators","%n - %n","reportDifference")),e.push(b("reporter","operators","%n \u00d7 %n","reportProduct")),e.push(b("reporter","operators","%n \u00f7 %n","reportQuotient")),e.push("-"),e.push(b("reporter","operators","%n mod %n","reportModulus")),e.push(b("reporter","operators","round %n","reportRound")),e.push(b("reporter","operators","pick random %n to %n","reportRandom",
[1,10])),e.push("-"),e.push(b("predicate","operators","%s < %s","reportLessThan")),e.push(b("predicate","operators","%s = %s","reportEquals")),e.push(b("predicate","operators","%s > %s","reportGreaterThan")),e.push("-"),e.push(b("predicate","operators","%b and %b","reportAnd")),e.push(b("predicate","operators","%b or %b","reportOr")),e.push(b("predicate","operators","not %b","reportNot")),e.push("-"),e.push(b("predicate","operators","true","reportTrue")),e.push(b("predicate","operators","false","reportFalse")),
e.push("-"),e.push(b("reporter","operators","join %words","reportJoinWords",["hello ","world"])),e.push(b("reporter","operators","letter %n of %s","reportLetter",[1,"world"])),e.push(b("reporter","operators","length of %s","reportStringSize",["world"])),e.push("-"),e.push(b("reporter","operators","unicode of %s","reportUnicode",["a"])),e.push(b("reporter","operators","unicode %n as letter","reportUnicodeAsLetter",[65])),e.push("-"),e.push(b("reporter","operators","the script %parms %c","reportScript")),
e.push(b("reporter","operators","the %f block %parms","reify"))):"variables"===i&&(a=new PushButtonMorph(null,function(){(new VariableDialogMorph(null,function(a){a&&(f.addVariable(a[0],a[1]),f.toggleVariableWatcher(a[0],a[1]),f.blocksCache[i]=null,f.parentThatIsA(IDE_Morph).refreshPalette())},f)).prompt("Variable name",null,f.world())},"Make a variable"),e.push(a),0<this.variables.allNames().length&&(a=new PushButtonMorph(null,function(){var a=new MenuMorph(f.deleteVariable,null,f);f.variables.allNames().forEach(function(b){a.addItem(b,
b)});a.popUpAtHand(f.world())},"Delete a variable"),e.push(a)),e.push("-"),a=this.variables.allNames(),0<a.length&&(a.forEach(function(a){e.push(d(a));e.push(b("reporter","variables",a,"reportGetVar"))}),e.push("-")),e.push(b("command","variables","set %var to %s","doSetVar",[null,0])),e.push(b("command","variables","change %var by %n","doChangeVar",[null,1])),e.push(b("command","variables","show variable %var","doShowVar")),e.push(b("command","variables","hide variable %var","doHideVar")),e.push(b("command",
"other","script variables %scriptVars","doDeclareVariables")),e.push("="),e.push(b("reporter","lists","list %mult%s","reportNewList")),e.push("-"),e.push(b("reporter","lists","%s in front of %l","reportCONS")),e.push(b("reporter","lists","item %idx of %l","reportListItem",[1])),e.push(b("reporter","lists","all but first of %l","reportCDR")),e.push("-"),e.push(b("reporter","lists","length of %l","reportListLength")),e.push(b("predicate","lists","%l contains %s","reportListContainsItem",[null,"thing"])),
e.push("-"),e.push(b("command","lists","add %s to %l","doAddToList",["thing"])),e.push(b("command","lists","delete %ida of %l","doDeleteFromList",[1])),e.push(b("command","lists","insert %s at %idx of %l","doInsertInList",["thing",1])),e.push(b("command","lists","replace item %idx of %l with %s","doReplaceInList",[1,null,"thing"])),e.push("="),a=new PushButtonMorph(null,function(){var a=f.parentThatIsA(IDE_Morph);(new BlockDialogMorph(null,function(b){if(b.spec!==""){f.customBlocks.push(b);f.cacheCustomBlock(b);
a.refreshPalette();(new BlockEditorMorph(b,f)).popUp()}},f)).prompt("Make a block",null,f.world())},"Make a block"),e.push(a));return e};StageMorph.prototype.clear=function(){this.drawNew();this.changed()};StageMorph.prototype.userMenu=function(){var a=new MenuMorph(this);a.addItem("edit","edit");return a};StageMorph.prototype.edit=SpriteMorph.prototype.edit;StageMorph.prototype.categories=SpriteMorph.prototype.categories;StageMorph.prototype.blockColor=SpriteMorph.prototype.blockColor;
StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor;StageMorph.prototype.setName=SpriteMorph.prototype.setName;StageMorph.prototype.palette=SpriteMorph.prototype.palette;StageMorph.prototype.thumbnail=SpriteMorph.prototype.thumbnail;StageMorph.prototype.showingWatcher=SpriteMorph.prototype.showingWatcher;StageMorph.prototype.addVariable=SpriteMorph.prototype.addVariable;StageMorph.prototype.deleteVariable=SpriteMorph.prototype.deleteVariable;
StageMorph.prototype.findVariableWatcher=SpriteMorph.prototype.findVariableWatcher;StageMorph.prototype.toggleVariableWatcher=SpriteMorph.prototype.toggleVariableWatcher;StageMorph.prototype.showingVariableWatcher=SpriteMorph.prototype.showingVariableWatcher;StageMorph.prototype.deleteVariableWatcher=SpriteMorph.prototype.deleteVariableWatcher;StageMorph.prototype.addCostume=SpriteMorph.prototype.addCostume;StageMorph.prototype.wearCostume=SpriteMorph.prototype.wearCostume;
StageMorph.prototype.getCostumeIdx=SpriteMorph.prototype.getCostumeIdx;StageMorph.prototype.doWearNextCostume=SpriteMorph.prototype.doWearNextCostume;StageMorph.prototype.doSwitchToCostume=SpriteMorph.prototype.doSwitchToCostume;StageMorph.prototype.toggleWatcher=SpriteMorph.prototype.toggleWatcher;StageMorph.prototype.showingWatcher=SpriteMorph.prototype.showingWatcher;StageMorph.prototype.allMessageNames=SpriteMorph.prototype.allMessageNames;StageMorph.prototype.allHatBlocksFor=SpriteMorph.prototype.allHatBlocksFor;
StageMorph.prototype.allHatBlocksForKey=SpriteMorph.prototype.allHatBlocksForKey;StageMorph.prototype.mouseClickLeft=SpriteMorph.prototype.mouseClickLeft;StageMorph.prototype.cacheCustomBlock=SpriteMorph.prototype.cacheCustomBlock;StageMorph.prototype.cacheCustomBlocks=SpriteMorph.prototype.cacheCustomBlocks;StageMorph.prototype.deleteAllBlockInstances=SpriteMorph.prototype.deleteAllBlockInstances;StageMorph.prototype.allBlockInstances=SpriteMorph.prototype.allBlockInstances;
StageMorph.prototype.paletteBlockInstance=SpriteMorph.prototype.paletteBlockInstance;StageMorph.prototype.usesBlockInstance=SpriteMorph.prototype.usesBlockInstance;function Costume(a,b,c){this.contents=a||newCanvas();this.shrinkToFit(this.maxExtent);this.name=b||null;this.rotationCenter=c||this.center();this.version=Date.now()}Costume.prototype.maxExtent=new Point(480,360);Costume.prototype.toString=function(){return"a Costume("+this.name+")"};
Costume.prototype.extent=function(){return new Point(this.contents.width,this.contents.height)};Costume.prototype.center=function(){return this.extent().divideBy(2)};Costume.prototype.width=function(){return this.contents.width};Costume.prototype.height=function(){return this.contents.height};Costume.prototype.bounds=function(){return new Rectangle(0,0,this.width(),this.height())};
Costume.prototype.edit=function(a){var b=new CostumeEditorMorph(this),c,d;c=new DialogBoxMorph(this,function(){b.accept()});d=new TextMorph("click or drag crosshairs to move the rotation center",c.fontSize,c.fontStyle,!0,!1,"center");c.labelString="Costume Editor";c.createLabel();c.setPicture(b);c.addBody(d);c.addButton("ok","Ok");c.addButton("cancel","Cancel");c.fixLayout();c.drawNew();c.fixLayout();a&&(a.add(c),a.keyboardReceiver=c,c.setCenter(a.center()))};
Costume.prototype.shrinkToFit=function(a){if(a.x<this.width()||a.y<this.height())this.contents=this.thumbnail(a)};Costume.prototype.thumbnail=function(a){var b=this.contents,c=Math.min(a.x/b.width,a.y/b.height),a=newCanvas(a),d=a.getContext("2d");d.scale(c,c);d.drawImage(b,0,0);return a};CostumeEditorMorph.prototype=new Morph;CostumeEditorMorph.prototype.constructor=CostumeEditorMorph;CostumeEditorMorph.uber=Morph.prototype;CostumeEditorMorph.prototype.size=Costume.prototype.maxExtent;
function CostumeEditorMorph(a){this.init(a)}CostumeEditorMorph.prototype.init=function(a){this.costume=a||new Costume;this.rotationCenter=this.costume.rotationCenter.copy();this.margin=new Point(0,0);this.background=this.createTexture();CostumeEditorMorph.uber.init.call(this);this.noticesTransparentClick=!0};CostumeEditorMorph.prototype.accept=function(){this.costume.rotationCenter=this.rotationCenter.copy();this.costume.version=Date.now()};
CostumeEditorMorph.prototype.drawNew=function(){var a,b,c;this.margin=this.size.subtract(this.costume.extent()).divideBy(2);a=this.rotationCenter.add(this.margin);this.silentSetExtent(this.size);this.image=newCanvas(this.extent());b=this.image.getContext("2d");c=b.createPattern(this.background,"repeat");b.fillStyle=c;b.fillRect(0,0,this.size.x,this.size.y);b.drawImage(this.costume.contents,this.margin.x,this.margin.y);b.globalAlpha=0.5;b.fillStyle="white";b.beginPath();b.arc(a.x,a.y,20,radians(0),
radians(360),!1);b.closePath();b.fill();b.stroke();b.beginPath();b.arc(a.x,a.y,10,radians(0),radians(360),!1);b.stroke();b.beginPath();b.moveTo(0,a.y);b.lineTo(this.costume.width()+2*this.margin.x,a.y);b.stroke();b.beginPath();b.moveTo(a.x,0);b.lineTo(a.x,this.costume.height()+2*this.margin.y);b.stroke()};
CostumeEditorMorph.prototype.createTexture=function(){var a=newCanvas(new Point(10,10)),b=a.getContext("2d"),c=new Color(230,230,230);b.fillStyle="white";b.fillRect(0,0,10,10);b.fillStyle=c.toString();b.fillRect(0,0,5,5);b.fillRect(5,5,5,5);return a};CostumeEditorMorph.prototype.mouseDownLeft=function(a){this.rotationCenter=a.subtract(this.position().add(this.margin));this.drawNew();this.changed()};CostumeEditorMorph.prototype.mouseMove=CostumeEditorMorph.prototype.mouseDownLeft;
CellMorph.prototype=new BoxMorph;CellMorph.prototype.constructor=CellMorph;CellMorph.uber=BoxMorph.prototype;function CellMorph(a,b){this.init(a,b)}CellMorph.prototype.init=function(a,b){this.contents=0===a?0:a||"";CellMorph.uber.init.call(this,SyntaxElementMorph.prototype.corner,1.000001,new Color(255,255,255));this.color=b||new Color(255,140,0);this.isBig=!1;this.drawNew()};CellMorph.prototype.big=function(){this.isBig=!0;this.changed();this.drawNew();this.changed()};
CellMorph.prototype.normal=function(){this.isBig=!1;this.changed();this.drawNew();this.changed()};CellMorph.prototype.fixLayout=function(){var a;this.changed();this.drawNew();this.changed();this.parent&&this.parent.fixLayout?this.parent.fixLayout():(a=this.parentThatIsA(ListWatcherMorph))&&a.fixLayout()};
CellMorph.prototype.drawNew=function(){var a;a=SyntaxElementMorph.prototype.fontSize;var b=this.contentsMorph instanceof ListWatcherMorph&&this.contentsMorph.list===this.contents;this.isBig&&(a*=1.5);this.contentsMorph&&!b&&this.contentsMorph.destroy();b||(this.contents instanceof Morph?this.contentsMorph=this.contents:isString(this.contents)?(this.contentsMorph=new TextMorph(this.contents,a,null,!0,!1,"center"),this.contentsMorph.setColor(new Color(255,255,255))):this.contents instanceof HTMLCanvasElement?
(this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(this.contents.width),this.contentsMorph.silentSetHeight(this.contents.height),this.contentsMorph.image=this.contents):this.contents instanceof Context?(a=this.contents.image(),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(a.width),this.contentsMorph.silentSetHeight(a.height),this.contentsMorph.image=a):this.contents instanceof List?(this.contentsMorph=new ListWatcherMorph(this.contents),this.contentsMorph.isDraggable=
!1):(this.contentsMorph=new TextMorph(this.contents?this.contents.toString():"",a,null,!0,!1,"center"),this.contentsMorph.setColor(new Color(255,255,255))),this.add(this.contentsMorph));this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border);this.silentSetWidth(Math.max(this.contentsMorph.width()+2*this.edge,this.contents instanceof Context||this.contents instanceof List?0:2*this.height()));this.image=newCanvas(this.extent());a=this.image.getContext("2d");if(0===this.edge&&0===this.border)return BoxMorph.uber.drawNew.call(this),
null;a.fillStyle=this.color.toString();a.beginPath();this.outlinePath(a,Math.max(this.edge-this.border,0),this.border);a.closePath();a.fill();0<this.border&&(a.lineWidth=this.border,a.strokeStyle=this.borderColor.toString(),a.beginPath(),this.outlinePath(a,this.edge,this.border/2),a.closePath(),a.stroke(),useBlurredShadows&&(a.shadowOffsetX=this.border,a.shadowOffsetY=this.border,a.shadowBlur=this.border,a.shadowColor=this.color.darker(80).toString(),this.drawShadow(a,this.edge,this.border/2)));this.contentsMorph.setCenter(this.center())};
CellMorph.prototype.drawShadow=function(a,b,c){var c=b+c,d=this.width(),e=this.height();a.beginPath();a.moveTo(0,e-c);a.lineTo(0,c);a.stroke();a.beginPath();a.arc(c,c,b,radians(-180),radians(-90),!1);a.stroke();a.beginPath();a.moveTo(c,0);a.lineTo(d-c,0);a.stroke()};WatcherMorph.prototype=new BoxMorph;WatcherMorph.prototype.constructor=WatcherMorph;WatcherMorph.uber=BoxMorph.prototype;function WatcherMorph(a,b,c,d){this.init(a,b,c,d)}
WatcherMorph.prototype.init=function(a,b,c,d,e){this.labelText=a||"";this.version=null;this.objName="";WatcherMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,1.000001,new Color(120,120,120));this.color=new Color(220,220,220);this.readoutColor=b;this.style="normal";this.target=c||null;this.getter=d||null;this.cellMorph=this.sliderMorph=this.labelMorph=this.currentValue=null;this.isDraggable=!0;e?this.isVisible=!1:(this.fixLayout(),this.update())};
WatcherMorph.prototype.isTemporary=function(){return this.target instanceof VariableFrame?null===this.target.owner:!1};WatcherMorph.prototype.object=function(){return this.target instanceof VariableFrame?this.target.owner:this.target};
WatcherMorph.prototype.update=function(){var a,b;this.target&&this.getter&&(this.updateLabel(),a=this.target instanceof VariableFrame?this.target.vars[this.getter]:this.target[this.getter].call(this.target),a!==this.currentValue&&(this.changed(),this.cellMorph.contents=a,this.cellMorph.drawNew(),b=parseFloat(a),isNaN(b)||(this.sliderMorph.value=b,this.sliderMorph.drawNew()),this.fixLayout(),this.currentValue=a));this.cellMorph.contentsMorph instanceof ListWatcherMorph&&this.cellMorph.contentsMorph.update()};
WatcherMorph.prototype.updateLabel=function(){var a=this.object();if(!a)return null;a.version!==this.version&&(this.objName=(a.name||"")+" ",this.labelMorph&&(this.labelMorph.destroy(),this.labelMorph=null,this.fixLayout()))};
WatcherMorph.prototype.fixLayout=function(){var a=SyntaxElementMorph.prototype.fontSize,b,c=this;this.changed();null===this.labelMorph&&(this.labelMorph=new StringMorph(this.objName+this.labelText,a,null,!0,!1,!1,new Point(1,1),new Color(255,255,255)),this.add(this.labelMorph));null===this.cellMorph&&(this.cellMorph=new CellMorph("",this.readoutColor),this.add(this.cellMorph));null===this.sliderMorph&&(this.sliderMorph=new SliderMorph(0,100,0,20,"horizontal"),this.sliderMorph.alpha=1,this.sliderMorph.button.color=
this.color.darker(),this.sliderMorph.color=this.color.lighter(60),this.sliderMorph.button.highlightColor=this.color.darker(),this.sliderMorph.button.highlightColor.b+=50,this.sliderMorph.button.pressColor=this.color.darker(),this.sliderMorph.button.pressColor.b+=100,this.sliderMorph.setHeight(a),this.sliderMorph.action=function(a){c.target.vars[c.getter]=Math.round(a)},this.add(this.sliderMorph));if(b=this.cellMorph.contents instanceof List)this.style="normal";"large"===this.style?(this.labelMorph.hide(),
this.sliderMorph.hide(),this.cellMorph.big(),this.cellMorph.setPosition(this.position()),this.setExtent(this.cellMorph.extent().subtract(1))):(this.labelMorph.show(),this.sliderMorph.show(),this.cellMorph.normal(),this.labelMorph.setPosition(this.position().add(new Point(this.edge,this.border+SyntaxElementMorph.prototype.typeInPadding))),b?this.cellMorph.setPosition(this.labelMorph.bottomLeft().add(new Point(0,SyntaxElementMorph.prototype.typeInPadding))):(this.cellMorph.setPosition(this.labelMorph.topRight().add(new Point(a/
3,0))),this.labelMorph.setTop(this.cellMorph.top()+(this.cellMorph.height()-this.labelMorph.height())/2)),"slider"===this.style?(this.sliderMorph.silentSetPosition(new Point(this.labelMorph.left(),this.cellMorph.bottom()+SyntaxElementMorph.prototype.typeInPadding)),this.sliderMorph.setWidth(this.cellMorph.right()-this.labelMorph.left()),this.silentSetHeight(this.cellMorph.height()+this.sliderMorph.height()+2*this.border+3*SyntaxElementMorph.prototype.typeInPadding)):(this.sliderMorph.hide(),this.bounds.corner.y=
this.cellMorph.bottom()+this.border+SyntaxElementMorph.prototype.typeInPadding),this.bounds.corner.x=Math.max(this.cellMorph.right(),this.labelMorph.right())+this.edge+SyntaxElementMorph.prototype.typeInPadding,this.drawNew(),this.changed())};WatcherMorph.prototype.mouseClickLeft=function(){this.style="normal"===this.style?this.target instanceof VariableFrame?"slider":"large":"slider"===this.style?"large":"normal";this.fixLayout()};
WatcherMorph.prototype.drawNew=function(){var a,b;this.image=newCanvas(this.extent());a=this.image.getContext("2d");if(0===this.edge&&0===this.border)return BoxMorph.uber.drawNew.call(this),null;b=a.createLinearGradient(0,0,0,this.height());b.addColorStop(0,this.color.lighter().toString());b.addColorStop(1,this.color.darker().toString());a.fillStyle=b;a.beginPath();this.outlinePath(a,Math.max(this.edge-this.border,0),this.border);a.closePath();a.fill();0<this.border&&(b=a.createLinearGradient(0,0,
0,this.height()),b.addColorStop(0,this.borderColor.lighter().toString()),b.addColorStop(1,this.borderColor.darker().toString()),a.lineWidth=this.border,a.strokeStyle=b,a.beginPath(),this.outlinePath(a,this.edge,this.border/2),a.closePath(),a.stroke())};modules.gui="2012-Mar-27";IDE_Morph.prototype=new Morph;IDE_Morph.prototype.constructor=IDE_Morph;IDE_Morph.uber=Morph.prototype;IDE_Morph.prototype.buttonContrast=30;IDE_Morph.prototype.frameColor=SpriteMorph.prototype.paletteColor;
IDE_Morph.prototype.groupColor=SpriteMorph.prototype.paletteColor.lighter(8);IDE_Morph.prototype.sliderColor=SpriteMorph.prototype.sliderColor;function IDE_Morph(a){this.init(a)}
IDE_Morph.prototype.init=function(a){this.globalVariables=new VariableFrame;this.currentSprite=new SpriteMorph(this.globalVariables);this.currentCategory="motion";this.currentTab="scripts";this.projectNotes=this.projectName="";this.corral=this.corralBar=this.stage=this.spriteEditor=this.spriteBar=this.palette=this.categories=this.controlBar=this.logo=null;this.isAutoFill=a||!0;IDE_Morph.uber.init.call(this);this.color=new Color(40,40,40)};
IDE_Morph.prototype.openIn=function(a){var b;this.buildPanes();a.add(this);a.userMenu=this.userMenu;a.reactToDropOf=function(b){b instanceof DialogBoxMorph||a.hand.grab(b)};this.reactToWorldResize(a.bounds);if("#open:"===location.hash.substr(0,6)){b=location.hash.substr(6);if("%"===b.charAt(0)||-1<b.search(/\%(?:[0-9a-f]{2})/i))b=decodeURIComponent(b);this.openProjectString(b)}};
IDE_Morph.prototype.buildPanes=function(){this.createLogo();this.createControlBar();this.createCategories();this.createPalette();this.createStage();this.createSpriteBar();this.createSpriteEditor();this.createCorralBar();this.createCorral()};
IDE_Morph.prototype.createLogo=function(){var a=this;this.logo&&this.logo.destroy();this.logo=new Morph;this.logo.texture="snap_logo_sm.gif";this.logo.drawNew=function(){this.image=newCanvas(this.extent());var b=this.image.getContext("2d"),c=b.createLinearGradient(0,0,this.width(),0);c.addColorStop(0,"black");c.addColorStop(0.8,a.frameColor.toString());b.fillStyle=c;b.fillRect(0,0,this.width(),this.height());this.texture&&this.drawTexture(this.texture)};this.logo.drawCachedTexture=function(){this.image.getContext("2d").drawImage(this.cachedTexture,
5,Math.round((this.height()-this.cachedTexture.height)/2));this.changed()};this.logo.mouseClickLeft=function(){a.snapMenu()};this.logo.color=new Color;this.logo.setExtent(new Point(200,28));this.add(this.logo)};
IDE_Morph.prototype.createControlBar=function(){var a,b,c,d,e,f=[this.groupColor,this.frameColor.darker(50),this.frameColor.darker(50)],g=this;this.controlBar&&this.controlBar.destroy();this.controlBar=new Morph;this.controlBar.color=this.frameColor;this.controlBar.setHeight(this.logo.height());this.add(this.controlBar);a=new PushButtonMorph(this,"stopAllScripts","  \u2b23  ");a.corner=12;a.color=f[0];a.highlightColor=f[1];a.pressColor=f[2];a.fontSize=18;a.padding=0;a.labelShadowOffset=new Point(-1,
-1);a.labelShadowColor=f[1];a.labelColor=new Color(200,0,0);a.contrast=this.buttonContrast;a.drawNew();a.hint="stop\nevery-\nthing";a.fixLayout();this.controlBar.add(b=a);a=new PushButtonMorph(this,"runScripts","   \u2691   ");a.corner=12;a.color=f[0];a.highlightColor=f[1];a.pressColor=f[2];a.fontSize=18;a.padding=0;a.labelShadowOffset=new Point(-1,-1);a.labelShadowColor=f[1];a.labelColor=new Color(0,200,0);a.contrast=this.buttonContrast;a.drawNew();a.hint="start green\nflag scripts";a.fixLayout();
this.controlBar.add(c=a);a=new PushButtonMorph(this,"projectMenu","  \u270e  ");a.corner=12;a.color=f[0];a.highlightColor=f[1];a.pressColor=f[2];a.fontSize=18;a.padding=0;a.labelShadowOffset=null;a.labelShadowColor=null;a.labelColor=new Color(255,255,255);a.contrast=this.buttonContrast;a.drawNew();a.hint="open, save, & annotate project";a.fixLayout();this.controlBar.add(d=a);this.controlBar.projectButton=d;this.controlBar.fixLayout=function(){e=this.right()-5;d.setCenter(g.controlBar.center());d.setLeft(this.left()+
5);[b,c].forEach(function(a){a.setCenter(g.controlBar.center());a.setRight(e);e-=a.width();e-=5});this.updateLabel()};this.controlBar.updateLabel=function(){var a=g.world().isDevMode?" - development mode":"";this.label&&this.label.destroy();this.label=new StringMorph((g.projectName||"untitled")+a,14,"sans-serif",!0,!1,!1,new Point(2,1),g.frameColor.darker(g.buttonContrast));this.label.color=new Color(255,255,255);this.label.drawNew();this.add(this.label);this.label.setCenter(this.center());this.label.setLeft(this.projectButton.right()+
5)}};
IDE_Morph.prototype.createCategories=function(){function a(a){var d=[b.frameColor,b.frameColor.darker(50),SpriteMorph.prototype.blockColor[a]],e;e=new ToggleButtonMorph(d,b,function(){b.currentCategory=a;b.categories.children.forEach(function(a){a.refresh()});b.refreshPalette(!0)},a[0].toUpperCase().concat(a.slice(1)),function(){return b.currentCategory===a},null,null,null,75,!0);e.corner=8;e.padding=0;e.labelShadowOffset=new Point(-1,-1);e.labelShadowColor=d[1];e.labelColor=new Color(255,255,255);
e.fixLayout();e.refresh();b.categories.add(e);return e}var b=this;this.categories&&this.categories.destroy();this.categories=new Morph;this.categories.color=this.groupColor;this.categories.silentSetWidth(this.logo.width());SpriteMorph.prototype.categories.forEach(function(b){contains(["lists","other"],b)||a(b)});(function(){var a=b.categories.children[0].width(),d=b.categories.children[0].height(),e=Math.ceil(b.categories.children.length/2),f=(b.categories.width()-3-2*a)/3,g=b.categories.left(),h=
b.categories.top(),i=0,j,k;b.categories.children.forEach(function(b){i+=1;j=Math.ceil(i/2);k=2-i%2;b.setPosition(new Point(g+(k*f+(k-1)*a),h+(2*j+(j-1)*d+3)))});b.categories.setHeight(2*(e+1)+e*d+6)})();this.add(this.categories)};
IDE_Morph.prototype.createPalette=function(){var a=this;this.palette&&this.palette.destroy();this.palette=this.currentSprite.palette(this.currentCategory);this.palette.isDraggable=!1;this.palette.acceptsDrops=!0;this.palette.contents.acceptsDrops=!1;this.palette.reactToDropOf=function(b){b instanceof DialogBoxMorph?a.world().add(b):b instanceof SpriteMorph?a.removeSprite(b):b.destroy()};this.palette.setWidth(this.logo.width());this.add(this.palette);this.palette.scrollX(this.palette.padding);this.palette.scrollY(this.palette.padding)};
IDE_Morph.prototype.createStage=function(){this.stage&&this.stage.destroy();this.stage=new StageMorph(this.globalVariables);this.stage.setExtent(new Point(480,360));this.currentSprite instanceof SpriteMorph&&(this.currentSprite.setPosition(this.stage.center().subtract(this.currentSprite.extent().divideBy(2))),this.stage.add(this.currentSprite));this.add(this.stage)};
IDE_Morph.prototype.createSpriteBar=function(){var a=new Point(45,45),b,c,d,e=new AlignmentMorph("row",-30),f,g=this;this.spriteBar&&this.spriteBar.destroy();this.spriteBar=new Morph;this.spriteBar.color=this.frameColor;this.add(this.spriteBar);c=new Morph;c.setExtent(a);c.image=this.currentSprite.thumbnail(a);c.setPosition(this.spriteBar.position().add(5));this.spriteBar.add(c);c.fps=3;c.step=function(){c.version!==g.currentSprite.version&&(c.image=g.currentSprite.thumbnail(a),c.changed(),c.version=
g.currentSprite.version)};b=new InputFieldMorph(this.currentSprite.name);b.setWidth(100);b.contrast=90;b.setPosition(c.topRight().add(10));this.spriteBar.add(b);b.drawNew();b.accept=function(){g.currentSprite.setName(b.getValue())};d=[g.groupColor.darker(40),g.groupColor.darker(60),g.groupColor];e.tabTo=function(a){var b;g.currentTab=a;this.children.forEach(function(a){a.refresh();a.state&&(b=a)});b.refresh();g.createSpriteEditor();g.fixLayout("tabEditor")};f=new TabMorph([g.groupColor.darker(40),
g.groupColor.darker(60),g.groupColor.lighter(30)],null,function(){e.tabTo("scripts")},"Scripts",function(){return"scripts"===g.currentTab});f.padding=3;f.corner=15;f.edge=1;f.labelShadowOffset=new Point(-1,-1);f.labelShadowColor=d[1];f.labelColor=new Color(255,255,255);f.drawNew();f.fixLayout();e.add(f);f=new TabMorph(d,null,function(){e.tabTo("costumes")},"Costumes",function(){return"costumes"===g.currentTab});f.padding=3;f.corner=15;f.edge=1;f.labelShadowOffset=new Point(-1,-1);f.labelShadowColor=
d[1];f.labelColor=new Color(255,255,255);f.drawNew();f.fixLayout();e.add(f);f=new TabMorph(d,null,function(){e.tabTo("sounds")},"Sounds",function(){return"sounds"===g.currentTab});f.padding=3;f.corner=15;f.edge=1;f.labelShadowOffset=new Point(-1,-1);f.labelShadowColor=d[1];f.labelColor=new Color(255,255,255);f.drawNew();f.fixLayout();e.add(f);e.fixLayout();e.children.forEach(function(a){a.refresh()});this.spriteBar.add(this.spriteBar.tabBar=e);this.spriteBar.fixLayout=function(){this.tabBar.setLeft(this.left());
this.tabBar.setBottom(this.bottom())}};
IDE_Morph.prototype.createSpriteEditor=function(){var a=this.currentSprite.scripts,b=this;this.spriteEditor&&this.spriteEditor.destroy();"scripts"===this.currentTab?(a.isDraggable=!1,a.color=this.color.copy(),a.texture="scriptsPaneTexture.gif",this.spriteEditor=new ScrollFrameMorph(a),this.spriteEditor.padding=5,this.spriteEditor.isDraggable=!1,this.spriteEditor.acceptsDrops=!1,this.spriteEditor.contents.acceptsDrops=!0,a.scrollFrame=this.spriteEditor,this.add(this.spriteEditor),this.spriteEditor.scrollX(this.spriteEditor.padding),
this.spriteEditor.scrollY(this.spriteEditor.padding)):"costumes"===this.currentTab?(this.spriteEditor=new WardrobeMorph(this.currentSprite,this.sliderColor),this.spriteEditor.color=this.groupColor,this.add(this.spriteEditor),this.spriteEditor.updateSelection(),this.spriteEditor.acceptsDrops=!1,this.spriteEditor.contents.acceptsDrops=!1):(this.spriteEditor=new Morph,this.spriteEditor.color=this.groupColor,this.spriteEditor.acceptsDrops=!0,this.spriteEditor.reactToDropOf=function(a){a instanceof DialogBoxMorph?
b.world().add(a):a instanceof SpriteMorph?b.removeSprite(a):a.destroy()},this.add(this.spriteEditor))};
IDE_Morph.prototype.createCorralBar=function(){var a,b=[this.groupColor,this.frameColor.darker(50),this.frameColor.darker(50)];this.corralBar&&this.corralBar.destroy();this.corralBar=new Morph;this.corralBar.color=this.frameColor;this.corralBar.setHeight(this.logo.height());this.add(this.corralBar);a=new PushButtonMorph(this,"addNewSprite","  +  ");a.corner=12;a.color=b[0];a.highlightColor=b[1];a.pressColor=b[2];a.fontSize=18;a.padding=0;a.labelShadowOffset=new Point(-1,-1);a.labelShadowColor=b[1];
a.labelColor=new Color(255,255,255);a.contrast=this.buttonContrast;a.drawNew();a.hint="add a new Sprite";a.fixLayout();a.setCenter(this.corralBar.center());a.setLeft(this.corralBar.left()+5);this.corralBar.add(a)};
IDE_Morph.prototype.createCorral=function(){var a,b;this.corral&&this.corral.destroy();this.corral=new Morph;this.corral.color=this.groupColor;this.add(this.corral);this.corral.stageIcon=new SpriteIconMorph(this.stage);this.corral.add(this.corral.stageIcon);a=new ScrollFrameMorph(null,null,this.sliderColor);a.acceptsDrops=!1;a.contents.acceptsDrops=!1;a.alpha=0;this.stage.children.forEach(function(c){c instanceof SpriteMorph&&a.contents.add(b=new SpriteIconMorph(c,b))});this.corral.frame=a;this.corral.add(a);
this.corral.fixLayout=function(){this.stageIcon.setCenter(this.center());this.stageIcon.setLeft(this.left()+5);this.frame.setLeft(this.stageIcon.right()+5);this.frame.setExtent(new Point(this.right()-this.frame.left(),this.height()));this.arrangeIcons();this.refresh()};this.corral.arrangeIcons=function(){var a=this.frame.left(),b=this.frame.top(),e=this.frame.right(),f=this.frame.left();this.frame.contents.children.forEach(function(g){var h=g.width();a+h>e&&(a=f,b+=g.height());g.setPosition(new Point(a,
b));a+=h});this.frame.contents.adjustBounds()};this.corral.addSprite=function(a){this.frame.contents.add(new SpriteIconMorph(a));this.fixLayout()};this.corral.refresh=function(){this.stageIcon.refresh();this.frame.contents.children.forEach(function(a){a.refresh()})}};
IDE_Morph.prototype.fixLayout=function(a){Morph.prototype.trackChanges=!1;"refreshPalette"!==a&&(this.controlBar.setPosition(this.logo.topRight()),this.controlBar.setWidth(this.right()-this.controlBar.left()),this.controlBar.fixLayout(),this.categories.setLeft(this.logo.left()),this.categories.setTop(this.logo.bottom()));this.palette.setLeft(this.logo.left());this.palette.setTop(this.categories.bottom());this.palette.setHeight(this.bottom()-this.palette.top());"refreshPalette"!==a&&(this.stage.setTop(this.logo.bottom()+
5),this.stage.setRight(this.right()),this.spriteBar.setPosition(this.logo.bottomRight().add(5)),this.spriteBar.setExtent(new Point(Math.max(0,this.stage.left()-5-this.spriteBar.left()),this.categories.bottom()-this.spriteBar.top()-5)),this.spriteBar.fixLayout(),this.spriteEditor.setPosition(this.spriteBar.bottomLeft()),this.spriteEditor.setExtent(new Point(this.spriteBar.width(),this.bottom()-this.spriteEditor.top())),this.corralBar.setLeft(this.stage.left()),this.corralBar.setTop(this.stage.bottom()+
5),this.corralBar.setWidth(this.stage.width()),contains(["selectSprite","tabEditor"],a)||(this.corral.setPosition(this.corralBar.bottomLeft()),this.corral.setWidth(this.stage.width()),this.corral.setHeight(this.bottom()-this.corral.top()),this.corral.fixLayout()));Morph.prototype.trackChanges=!0;this.changed()};IDE_Morph.prototype.setProjectName=function(a){this.projectName=a;this.controlBar.updateLabel()};
IDE_Morph.prototype.setExtent=function(a){a=a.max(new Point(910,490));IDE_Morph.uber.setExtent.call(this,a);this.fixLayout()};IDE_Morph.prototype.reactToWorldResize=function(a){this.isAutoFill&&(this.setPosition(a.origin),this.setExtent(a.extent()))};IDE_Morph.prototype.droppedImage=function(a){a=new Costume(a);this.currentSprite.addCostume(a);this.currentSprite.wearCostume(a);this.spriteBar.tabBar.tabTo("costumes")};
IDE_Morph.prototype.refreshPalette=function(a){var b=this.palette.contents.top();this.createPalette();this.fixLayout("refreshPalette");a||this.palette.contents.setTop(b)};IDE_Morph.prototype.runScripts=function(){var a=[],b=[],c=this;this.stage.children.concat(this.stage).forEach(function(a){if(a instanceof SpriteMorph||a instanceof StageMorph)b=b.concat(a.allHatBlocksFor("__shout__go__"))});b.forEach(function(b){a.push(c.stage.threads.startProcess(b))});return a};
IDE_Morph.prototype.stopAllScripts=function(){this.stage.keysPressed={};this.stage.threads.stopAll()};IDE_Morph.prototype.selectSprite=function(a){this.currentSprite=a;this.createPalette();this.createSpriteBar();this.createSpriteEditor();this.corral.refresh();this.fixLayout("selectSprite")};
IDE_Morph.prototype.addNewSprite=function(){var a=new SpriteMorph(this.globalVariables),b=Process.prototype.reportRandom;a.name+=this.corral.frame.contents.children.length+1;a.setCenter(this.stage.center());this.stage.add(a);a.setHue(b.call(this,0,100));a.setBrightness(b.call(this,50,100));a.turn(b.call(this,1,360));a.setXPosition(b.call(this,-220,220));a.setYPosition(b.call(this,-160,160));this.corral.addSprite(a);this.selectSprite(a)};
IDE_Morph.prototype.duplicateSprite=function(a){var b=a.fullCopy();b.name=a.name+"(2)";b.setPosition(this.world().hand.position());this.stage.add(b);b.keepWithin(this.stage);this.corral.addSprite(b);this.selectSprite(b)};IDE_Morph.prototype.removeSprite=function(a){a.destroy();this.stage.watchers().forEach(function(b){b.object()===a&&b.destroy()});this.currentSprite=detect(this.stage.children,function(a){return a instanceof SpriteMorph})||this.stage;this.createCorral();this.fixLayout();this.selectSprite(this.currentSprite)};
IDE_Morph.prototype.userMenu=function(){var a=new MenuMorph(this);a.addItem("help","nop");return a};
IDE_Morph.prototype.snapMenu=function(){var a,b=this.world();a=new MenuMorph(this);a.addItem("About...","aboutSnap");a.addLine();a.addItem("Snap! website",function(){window.open("http://snap.berkeley.edu/","SnapWebsite")});b.isDevMode?(a.addLine(),a.addItem("Switch back to user mode","switchToUserMode","disable deep-Morphic\ncontext menus\nand show user-friendly ones",new Color(0,100,0))):16===b.currentKey&&(a.addLine(),a.addItem("Switch to dev mode","switchToDevMode","enable deep-Morphic\ncontext menus\nand inspectors\n\nCaution:\nNot user-friendly!",
new Color(100,0,0)));a.popup(b,this.logo.bottomLeft())};
IDE_Morph.prototype.projectMenu=function(){var a,b=this,c=this.world(),d=this.controlBar.projectButton.bottomLeft();a=new MenuMorph(this);a.addItem("Project Notes...","editProjectNotes");a.addLine();a.addItem("New",function(){b.confirm("Replace the current project with a new one?","New Project",function(){b.newProject()})});a.addItem("Open...","openProjectBrowser");a.addItem("Save",function(){b.projectName?b.saveProject(b.projectName):b.prompt("Save Project As...",function(a){b.saveProject(a)})});
a.addItem("Save As...",function(){b.prompt("Save Project As...",function(a){b.saveProject(a)})});a.popup(c,d)};
IDE_Morph.prototype.aboutSnap=function(){var a,b="",c,d,e,f,g,h=this.world();for(c in modules)modules.hasOwnProperty(c)&&(b+="\n"+c+" ("+modules[c]+")");""!==b&&(b="current module versions:\n\nmorphic ("+morphicVersion+")"+b);a=new DialogBoxMorph;a.inform("About Snap","Snap!\nBuild Your Own Blocks\n\n--- pre-alpha ---\n\nCopyright \u24b8 2012 Brian Harvey and Jens M\u00f6nig\nbh@cs.berkeley.edu, jens@moenig.org\nAll rights reserved\n\n Snap! is developed by the University of California, Berkeley \nwith support from the National Science Foundation.\nThe design of Snap! is influenced and inspired by Scratch,\nfrom the Lifelong Kindergarten group at the MIT Media Lab\n\nfor more information see http://snap.berkeley.edu\nand http://scratch.mit.edu",h);
d=a.buttons.children[0];e=a.addButton(function(){a.body.text="Snap!\nBuild Your Own Blocks\n\n--- pre-alpha ---\n\nCopyright \u24b8 2012 Brian Harvey and Jens M\u00f6nig\nbh@cs.berkeley.edu, jens@moenig.org\nAll rights reserved\n\n Snap! is developed by the University of California, Berkeley \nwith support from the National Science Foundation.\nThe design of Snap! is influenced and inspired by Scratch,\nfrom the Lifelong Kindergarten group at the MIT Media Lab\n\nfor more information see http://snap.berkeley.edu\nand http://scratch.mit.edu";
a.body.drawNew();d.show();e.hide();f.show();g.show();a.fixLayout();a.drawNew();a.setCenter(h.center())},"Back\u2026");e.hide();f=a.addButton(function(){a.body.text=b;a.body.drawNew();d.show();e.show();f.hide();g.hide();a.fixLayout();a.drawNew();a.setCenter(h.center())},"Modules\u2026");g=a.addButton(function(){a.body.text="Contributors\n\nNathan Dinsmore\nSaving/Loading, Snap-Logo Design,\ncountless bugfixes\n\nIvan Motyashov\nInitial Squeak Porting\n\nIan Reynolds\nUI Design, Event Bindings\n\nJoe Otto\nMorphic Testing and Debugging";
a.body.drawNew();d.show();e.show();f.hide();g.hide();a.fixLayout();a.drawNew();a.setCenter(h.center())},"Contributors\u2026");a.fixLayout();a.drawNew()};
IDE_Morph.prototype.editProjectNotes=function(){var a=new DialogBoxMorph,b=new ScrollFrameMorph,c=new TextMorph(this.projectNotes||""),d=a.ok,e=c.drawNew,f=this,g=this.world();b.padding=6;b.setWidth(250);b.acceptsDrops=!1;b.contents.acceptsDrops=!1;c.setWidth(250-2*b.padding);c.setPosition(b.topLeft().add(b.padding));c.enableSelecting();c.isEditable=!0;b.setHeight(250);b.fixLayout=nop;b.edge=InputFieldMorph.prototype.edge;b.fontSize=InputFieldMorph.prototype.fontSize;b.typeInPadding=InputFieldMorph.prototype.typeInPadding;
b.contrast=InputFieldMorph.prototype.contrast;b.drawNew=InputFieldMorph.prototype.drawNew;b.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;c.drawNew=function(){var a=this.topLeft().y-b.topLeft().y;e.call(this);a<=b.padding&&a>=-b.contents.height()+b.height()-b.padding&&b.contents.adjustBounds()};b.addContents(c);c.drawNew();a.ok=function(){f.projectNotes=c.text;d.call(this)};a.justDropped=function(){c.edit()};a.labelString="Project Notes";a.createLabel();a.addBody(b);b.drawNew();a.addButton("ok",
"Ok");a.addButton("cancel","Cancel");a.fixLayout();a.drawNew();g.add(a);a.setCenter(g.center());c.edit()};IDE_Morph.prototype.newProject=function(){this.stage&&this.stage.destroy();location.hash="";this.globalVariables=new VariableFrame;this.currentSprite=new SpriteMorph(this.globalVariables);this.setProjectName("");this.projectNotes="";this.createStage();this.add(this.stage);this.createCorral();this.selectSprite(this.stage.children[0]);this.fixLayout()};
IDE_Morph.prototype.saveProject=function(a){var b,c;if(a){this.setProjectName(a);try{b=this.showMessage("Saving"),localStorage["-snap-project-"+a]=c=XMLSerializer.serialize(this.stage),location.hash="#open:"+c,b.destroy(),this.showMessage("Saved!",1)}catch(d){this.showMessage("Save failed: "+d)}}};IDE_Morph.prototype.openProjectString=function(a){try{XMLSerializer.openProject(XMLSerializer.load(a),this)}catch(b){this.showMessage("Load failed: "+b)}};
IDE_Morph.prototype.openProject=function(a){a&&(this.setProjectName(a),this.openProjectString(a=localStorage["-snap-project-"+a]),location.hash="#open:"+a)};
IDE_Morph.prototype.openProjectBrowser=function(){var a=new DialogBoxMorph,b=this,c=[],d={},e,f=new Color(190,190,190),g,h,i,j,k=this.world();a.labelString="Open Project";a.createLabel();for(e in localStorage)localStorage.hasOwnProperty(e)&&"-snap-project-"===e.substr(0,14)&&c.push(e.substr(14));c.sort();g=new ListMorph(c);g.action=function(a){var a=localStorage["-snap-project-"+a],b;if(a){if(b=XMLSerializer.parse(a),a=b.element("notes"),b=b.element("thumbnail"),a&&(j.text=a.textContent(),j.drawNew(),
i.contents.adjustBounds()),b)h.texture=b.textContent(),h.cachedTexture=null,h.drawNew()}else j.text="",j.drawNew(),i.contents.adjustBounds(),h.texture=null,h.cachedTexture=null,h.drawNew(),h.changed()};g.setExtent(new Point(150,250));g.contents.children[0].maxWidth=function(){return g.width()-12};g.contents.children[0].drawNew();g.contents.children[0].children.forEach(function(b){b.pressColor=a.titleBarColor.darker(20);b.color=new Color(0,0,0,0);b.noticesTransparentClick=!0;b.createBackgrounds()});
g.padding=6;g.fixLayout=nop;g.edge=InputFieldMorph.prototype.edge;g.fontSize=InputFieldMorph.prototype.fontSize;g.typeInPadding=InputFieldMorph.prototype.typeInPadding;g.contrast=InputFieldMorph.prototype.contrast;g.drawNew=InputFieldMorph.prototype.drawNew;g.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;h=new Morph;h.fixLayout=nop;h.edge=InputFieldMorph.prototype.edge;h.fontSize=InputFieldMorph.prototype.fontSize;h.typeInPadding=InputFieldMorph.prototype.typeInPadding;h.contrast=InputFieldMorph.prototype.contrast;
h.drawNew=function(){InputFieldMorph.prototype.drawNew.call(this);this.texture&&this.drawTexture(this.texture)};h.drawCachedTexture=function(){this.image.getContext("2d").drawImage(this.cachedTexture,this.edge,this.edge);this.changed()};h.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;h.setExtent(XMLSerializer.thumbnailSize.add(2*h.edge));i=new ScrollFrameMorph;i.padding=6;i.fixLayout=nop;i.edge=InputFieldMorph.prototype.edge;i.fontSize=InputFieldMorph.prototype.fontSize;i.typeInPadding=
InputFieldMorph.prototype.typeInPadding;i.contrast=InputFieldMorph.prototype.contrast;i.drawNew=InputFieldMorph.prototype.drawNew;i.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;i.acceptsDrops=!1;i.contents.acceptsDrops=!1;j=new TextMorph("");j.setWidth(h.width()-2*i.padding);j.setPosition(i.topLeft().add(6));i.addContents(j);c=new Morph;c.setColor(a.color);c.setExtent(new Point(g.width()+h.width()+12,g.height()));c.add(g);c.add(h);c.add(i);h.drawNew();i.setExtent(new Point(h.width(),c.height()-
h.height()-6));g.setPosition(c.topLeft());h.setPosition(g.topRight().add(new Point(6,0)));i.setPosition(h.bottomLeft().add(new Point(0,6)));a.addBody(c);g.drawNew();a.addButton("open","Open");a.open=function(){g.selected&&(b.openProject(g.selected),this.destroy())};a.addButton("deleteProject","Delete");a.deleteProject=function(){g.selected&&!d[g.selected]&&b.confirm('Are you sure you want to delete\n"'+g.selected+'"?',"Delete Project",function(){var a,b;delete localStorage["-snap-project-"+g.selected];
d[g.selected]=!0;if(a=detect(g.listContents.children,function(a){return a.labelString===g.selected}))b=a.extent(),a.labelColor=f,a.createLabel(),a.silentSetExtent(b);g.action(g.selected)})};a.addButton("cancel","Cancel");a.fixLayout();a.drawNew();k.add(a);a.setCenter(k.center());g.contents.children[0].color=new Color(0,0,0,0);MenuMorph.uber.drawNew.call(g.contents.children[0]);g.contents.children[0].setPosition(g.contents.topLeft().add(6))};
IDE_Morph.prototype.switchToUserMode=function(){var a=this.world();a.isDevMode=!1;Process.prototype.isCatchingErrors=!0;this.controlBar.updateLabel();this.isAutoFill=!0;this.isDraggable=!1;this.reactToWorldResize(a.bounds.copy());this.siblings().forEach(function(b){b instanceof DialogBoxMorph?a.add(b):b.destroy()});this.flushBlocksCache();this.refreshPalette();a.reactToDropOf=function(b){b instanceof DialogBoxMorph||a.hand.grab(b)};this.showMessage("entering user mode",1)};
IDE_Morph.prototype.switchToDevMode=function(){var a=this.world();a.isDevMode=!0;Process.prototype.isCatchingErrors=!1;this.controlBar.updateLabel();this.isAutoFill=!1;this.isDraggable=!0;this.setExtent(a.extent().subtract(100));this.setPosition(a.position().add(20));this.flushBlocksCache();this.refreshPalette();delete a.reactToDropOf;this.showMessage("entering development mode.\n\nerror catching is turned off,\nuse the browser's web console\nto see error messages.")};
IDE_Morph.prototype.flushBlocksCache=function(a){a?(this.stage.blocksCache[a]=null,this.stage.children.forEach(function(b){b instanceof SpriteMorph&&(b.blocksCache[a]=null)})):(this.stage.blocksCache={},this.stage.children.forEach(function(a){a instanceof SpriteMorph&&(a.blocksCache={})}))};IDE_Morph.prototype.showMessage=function(a,b){var c=new MenuMorph(null,a);c.popUpCenteredInWorld(this.world());b&&setInterval(function(){c.destroy()},1E3*b);return c};
IDE_Morph.prototype.confirm=function(a,b,c){(new DialogBoxMorph(null,c)).askYesNo(b,a,this.world())};IDE_Morph.prototype.prompt=function(a,b){(new DialogBoxMorph(null,b)).prompt(a,"",this.world())};SpriteIconMorph.prototype=new ToggleButtonMorph;SpriteIconMorph.prototype.constructor=SpriteIconMorph;SpriteIconMorph.uber=ToggleButtonMorph.prototype;SpriteIconMorph.prototype.thumbSize=new Point(40,40);SpriteIconMorph.prototype.labelShadowOffset=null;SpriteIconMorph.prototype.labelShadowColor=null;
SpriteIconMorph.prototype.labelColor=new Color(255,255,255);SpriteIconMorph.prototype.fontSize=9;function SpriteIconMorph(a,b){this.init(a,b)}
SpriteIconMorph.prototype.init=function(a,b){var c,d=this;b||(c=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]);this.object=a||new SpriteMorph;this.version=this.object.version;this.thumbnail=null;SpriteIconMorph.uber.init.call(this,c,null,function(){var a=d.parentThatIsA(IDE_Morph);a&&a.selectSprite(d.object)},this.object.name,function(){var a=d.parentThatIsA(IDE_Morph);return a?a.currentSprite===d.object:!1},null,null,b);this.createThumbnail();this.padding=
2;this.corner=8;this.fixLayout();this.fps=1};SpriteIconMorph.prototype.createThumbnail=function(){this.thumbnail&&this.thumbnail.destroy();this.thumbnail=new Morph;this.thumbnail.setExtent(this.thumbSize);this.thumbnail.image=this.object.thumbnail(this.thumbSize);this.add(this.thumbnail)};
SpriteIconMorph.prototype.createLabel=function(){var a;this.label&&this.label.destroy();a=new StringMorph(this.object.name,this.fontSize,this.fontStyle,!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor);this.label=new FrameMorph;this.label.acceptsDrops=!1;this.label.alpha=0;this.label.setExtent(a.extent());a.setPosition(this.label.position());this.label.add(a);this.add(this.label)};
SpriteIconMorph.prototype.step=function(){this.version!==this.object.version&&(this.createThumbnail(),this.createLabel(),this.fixLayout(),this.version=this.object.version,this.refresh())};
SpriteIconMorph.prototype.fixLayout=function(){if(!this.thumbnail)return null;this.setWidth(this.thumbnail.width()+2*this.outline+2*this.edge+2*this.padding);this.setHeight(this.thumbnail.height()+2*this.outline+2*this.edge+3*this.padding+this.label.height());this.thumbnail.setCenter(this.center());this.thumbnail.setTop(this.top()+this.outline+this.edge+this.padding);this.label.setWidth(Math.min(this.label.children[0].width(),this.thumbnail.width()));this.label.setCenter(this.center());this.label.setTop(this.thumbnail.bottom()+
this.padding)};SpriteIconMorph.prototype.userMenu=function(){var a=new MenuMorph(this);if(!(this.object instanceof SpriteMorph))return null;a.addItem("show","showSpriteOnStage");a.addLine();a.addItem("duplicate","duplicateSprite");a.addItem("delete","removeSprite");return a};SpriteIconMorph.prototype.duplicateSprite=function(){var a=this.parentThatIsA(IDE_Morph);a&&a.duplicateSprite(this.object)};SpriteIconMorph.prototype.removeSprite=function(){var a=this.parentThatIsA(IDE_Morph);a&&a.removeSprite(this.object)};
SpriteIconMorph.prototype.showSpriteOnStage=function(){this.object.showOnStage()};
SpriteIconMorph.prototype.createBackgrounds=function(){var a,b=this.extent();if(this.template)return this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null;this.normalImage=newCanvas(b);a=this.normalImage.getContext("2d");this.drawBackground(a,this.color);this.highlightImage=newCanvas(b);a=this.highlightImage.getContext("2d");this.drawBackground(a,this.highlightColor);this.pressImage=
newCanvas(b);a=this.pressImage.getContext("2d");this.drawOutline(a);this.drawBackground(a,this.pressColor);this.drawEdges(a,this.pressColor,this.pressColor.lighter(this.contrast),this.pressColor.darker(this.contrast));this.image=this.normalImage};CostumeIconMorph.prototype=new ToggleButtonMorph;CostumeIconMorph.prototype.constructor=CostumeIconMorph;CostumeIconMorph.uber=ToggleButtonMorph.prototype;CostumeIconMorph.prototype.thumbSize=new Point(80,60);
CostumeIconMorph.prototype.labelShadowOffset=null;CostumeIconMorph.prototype.labelShadowColor=null;CostumeIconMorph.prototype.labelColor=new Color(255,255,255);CostumeIconMorph.prototype.fontSize=9;function CostumeIconMorph(a,b){this.init(a,b)}
CostumeIconMorph.prototype.init=function(a,b){var c,d=this;b||(c=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]);this.object=a||new Costume;this.version=this.object.version;this.thumbnail=null;CostumeIconMorph.uber.init.call(this,c,null,function(){var a=d.parentThatIsA(IDE_Morph),b=d.parentThatIsA(WardrobeMorph);a&&a.currentSprite.wearCostume(d.object);b&&b.updateSelection()},this.object.name,function(){var a=d.parentThatIsA(IDE_Morph);return a?a.currentSprite.costume===
d.object:!1},null,null,b);this.createThumbnail();this.padding=2;this.corner=8;this.fixLayout();this.fps=1};CostumeIconMorph.prototype.createThumbnail=SpriteIconMorph.prototype.createThumbnail;CostumeIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel;CostumeIconMorph.prototype.step=SpriteIconMorph.prototype.step;CostumeIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout;
CostumeIconMorph.prototype.userMenu=function(){var a=new MenuMorph(this);if(!(this.object instanceof Costume))return null;a.addItem("edit","editCostume");a.addItem("delete","removeCostume");return a};CostumeIconMorph.prototype.editCostume=function(){this.object.edit(this.world())};CostumeIconMorph.prototype.removeCostume=function(){var a=this.parentThatIsA(WardrobeMorph),b=this.parent.children.indexOf(this);a.removeCostumeAt(b)};CostumeIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds;
WardrobeMorph.prototype=new ScrollFrameMorph;WardrobeMorph.prototype.constructor=WardrobeMorph;WardrobeMorph.uber=ScrollFrameMorph.prototype;function WardrobeMorph(a,b){this.init(a,b)}WardrobeMorph.prototype.init=function(a,b){this.sprite=a||new SpriteMorph;this.spriteVersion=this.costumesVersion=null;WardrobeMorph.uber.init.call(this,null,null,b);this.fps=2;this.updateList()};
WardrobeMorph.prototype.updateList=function(){var a=this,b=this.left()+5,c=this.top()+5,d=Morph.prototype.trackChanges,e,f,g;this.changed();d=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1;this.contents.destroy();this.contents=new FrameMorph(this);this.addBack(this.contents);g=new TextMorph("import a picture from another web page or from\na file on your computer by dropping it here\n");g.fontSize=9;g.setColor(new Color(230,230,230));g.setPosition(new Point(b,c));this.addContents(g);
c=g.bottom()+4;this.sprite.costumes.asArray().forEach(function(d){f=e=new CostumeIconMorph(d,f);e.setPosition(new Point(b,c));a.addContents(e);c=e.bottom()+4});this.costumesVersion=this.sprite.costumes.lastChanged;Morph.prototype.trackChanges=d;this.changed();this.updateSelection()};WardrobeMorph.prototype.updateSelection=function(){this.contents.children.forEach(function(a){a.refresh&&a.refresh()});this.spriteVersion=this.sprite.version};
WardrobeMorph.prototype.step=function(){this.costumesVersion!==this.sprite.costumes.lastChanged&&this.updateList();this.spriteVersion!==this.sprite.version&&this.updateSelection()};WardrobeMorph.prototype.removeCostumeAt=function(a){this.sprite.costumes.remove(a)};modules.lists="2012-Mar-14";function List(a){this.contents=a||[];this.rest=this.first=null;this.isLinked=!1;this.lastChanged=Date.now()}List.prototype.toString=function(){return"a List ["+this.asArray+"]"};
List.prototype.changed=function(){this.lastChanged=Date.now()};List.prototype.cons=function(a,b){var c=new List;c.first=a||null;c.rest=b||null;c.isLinked=!0;return c};List.prototype.cdr=function(){function a(b){return b>this.contents.length?new List:this.cons(this.at(b),a.call(this,b+1))}return this.isLinked?this.rest||new List:2>this.contents.length?new List:a.call(this,2)};List.prototype.add=function(a,b){var c=b||this.length()+1,d=a||null;this.becomeArray();this.contents.splice(c-1,0,d);this.changed()};
List.prototype.put=function(a,b){var c=a||null;this.becomeArray();this.contents[b-1]=c;this.changed()};List.prototype.remove=function(a){this.becomeArray();this.contents.splice(a-1,1);this.changed()};List.prototype.clear=function(){this.contents=[];this.rest=this.first=null;this.isLinked=!1;this.changed()};List.prototype.length=function(){return this.isLinked?(void 0===this.first?0:1)+(this.rest?this.rest.length():0):this.contents.length};
List.prototype.at=function(a){return this.isLinked?1===a?this.first:this.rest.at(a-1):this.contents[a-1]};List.prototype.contains=function(a){var b=parseFloat(a);return this.isLinked?this.first===a||!isNaN(b)&&this.first===b?!0:this.rest instanceof List?this.rest.contains(a):!1:contains(this.contents,a)?!0:!isNaN(b)?contains(this.contents,b):!1};List.prototype.asArray=function(){this.becomeArray();return this.contents};
List.prototype.asText=function(){var a="",b=this.length(),c,d;for(d=1;d<=b;d+=1)c=this.at(d),a=c instanceof List?a.concat(c.asText()):a.concat((c||"").toString());return a};List.prototype.becomeArray=function(){if(this.isLinked){var a=this;for(this.contents=[];a instanceof List&&0<a.length();)this.contents.push(a.at(1)),a=a.cdr();this.isLinked=!1}};
List.prototype.becomeLinked=function(){var a,b,c=this;if(!this.isLinked){b=this.length();for(a=0;a<b;a+=1)c.first=this.contents[a],c.rest=new List,c.isLinked=!0,c=c.rest;this.contents=[];this.isLinked=!0}};
List.prototype.equalTo=function(a){var b;if(!(a instanceof List))return!1;if(!this.isLinked&&!a.isLinked){if(0===this.length()&&0===a.length())return!0;if(this.length()!==a.length())return!1;for(b=0;b<this.length();b+=1)if(!snapEquals(this.contents[b],a.contents[b]))return!1;return!0}return snapEquals(this.at(1),a.at(1))?this.cdr().equalTo(a.cdr()):!1};ListWatcherMorph.prototype=new BoxMorph;ListWatcherMorph.prototype.constructor=ListWatcherMorph;ListWatcherMorph.uber=BoxMorph.prototype;
ListWatcherMorph.prototype.cellColor=SpriteMorph.prototype.blockColor.lists;function ListWatcherMorph(a){this.init(a)}
ListWatcherMorph.prototype.init=function(a){var b=this;this.list=a||new List;this.start=1;this.range=100;this.lastUpdated=Date.now();this.lastCell=null;this.label=new StringMorph("length: "+this.list.length(),SyntaxElementMorph.prototype.fontSize,null,!1,!1,!1,new Point(1,1),new Color(255,255,255));this.label.mouseClickLeft=function(){b.startIndexMenu()};this.frame=new ScrollFrameMorph(null,10);this.frame.alpha=0;this.handle=new HandleMorph(this,80,70,3,3);this.handle.setExtent(new Point(13,13));
this.arrow=new ArrowMorph("down",SyntaxElementMorph.prototype.fontSize);this.arrow.mouseClickLeft=function(){b.startIndexMenu()};this.arrow.setRight(this.handle.right());this.arrow.setBottom(this.handle.top());this.handle.add(this.arrow);this.plusButton=new PushButtonMorph(this.list,"add","+");this.plusButton.padding=0;this.plusButton.edge=0;this.plusButton.outlineColor=this.color;this.plusButton.drawNew();this.plusButton.fixLayout();ListWatcherMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,
1.000001,new Color(120,120,120));this.color=new Color(220,220,220);this.isDraggable=!0;this.setExtent(new Point(80,70));this.add(this.label);this.add(this.frame);this.add(this.plusButton);this.add(this.handle);this.handle.drawNew();this.update();this.fixLayout()};
ListWatcherMorph.prototype.update=function(a){var b,c,d,e,f,g,h;this.frame.contents.children.forEach(function(a){a instanceof CellMorph&&a.contentsMorph instanceof ListWatcherMorph&&a.contentsMorph.update()});if(this.lastUpdated===this.list.lastChanged&&!a)return null;this.updateLength(!0);this.start=Math.max(Math.min(this.start,Math.floor((this.list.length()-1)/this.range)*this.range+1),1);h=Math.min(this.start+this.range-1,this.list.length());c=Math.min(3*(h-this.start+1),this.frame.contents.children.length);
for(a=0;a<c;a+=3)b=this.start+a/3,d=this.frame.contents.children[a],f=this.frame.contents.children[a+1],g=this.frame.contents.children[a+2],e=this.list.at(b),d.contents!==e&&(d.contents=e,d.drawNew(),this.lastCell&&d.setLeft(this.lastCell.left())),this.lastCell=d,f.text!==b.toString()&&(f.text=b.toString(),f.drawNew()),g.action=b;for(a=3*(h-this.start+1);this.frame.contents.children.length>a;)this.frame.contents.children[a].destroy();c=a;a=this.frame.contents.children.length;e=Date.now();if(c>a+1)for(a;a<
c;a+=3){if(1E3<Date.now()-e)return this.fixLayout(),this.frame.contents.adjustBounds(),this.frame.contents.setLeft(this.frame.left()),null;b=this.start+a/3;f=new StringMorph(b.toString(),SyntaxElementMorph.prototype.fontSize,null,!1,!1,!1,new Point(1,1),new Color(255,255,255));d=new CellMorph(this.list.at(b),this.cellColor);g=new PushButtonMorph(this.list.remove,b,"-",this.list);g.padding=1;g.edge=0;g.corner=1;g.outlineColor=this.color.darker();g.drawNew();g.fixLayout();this.frame.contents.add(d);
this.lastCell?d.setPosition(this.lastCell.bottomLeft()):d.setTop(this.frame.contents.top());this.lastCell=d;f.setCenter(d.center());f.setRight(d.left()-2);this.frame.contents.add(f);this.frame.contents.add(g)}this.lastCell=null;this.fixLayout();this.frame.contents.adjustBounds();this.frame.contents.setLeft(this.frame.left());this.updateLength();this.lastUpdated=this.list.lastChanged};
ListWatcherMorph.prototype.updateLength=function(a){this.label.text="length: "+this.list.length();this.label.color=a?new Color(0,0,100):new Color(0,0,0);this.label.drawNew();this.label.setCenter(this.center());this.label.setBottom(this.bottom()-3)};ListWatcherMorph.prototype.startIndexMenu=function(){var a,b,c=this,d=Math.ceil(this.list.length()/this.range),e=new MenuMorph(function(a){c.setStartIndex(a)},null,c);e.addItem("1...",1);for(a=1;a<d;a+=1)b=100*a+1,e.addItem(b+"...",b);e.popUpAtHand(this.world())};
ListWatcherMorph.prototype.setStartIndex=function(a){this.start=a;this.list.changed()};
ListWatcherMorph.prototype.fixLayout=function(){Morph.prototype.trackChanges=!1;this.frame&&(this.arrangeCells(),this.frame.silentSetPosition(this.position().add(3)),this.frame.bounds.corner=this.bounds.corner.subtract(new Point(3,17)),this.frame.drawNew(),this.frame.contents.adjustBounds());this.label.setCenter(this.center());this.label.setBottom(this.bottom()-3);this.plusButton.setLeft(this.left()+3);this.plusButton.setBottom(this.bottom()-3);Morph.prototype.trackChanges=!0;this.changed();this.parent&&
this.parent.fixLayout&&this.parent.fixLayout()};ListWatcherMorph.prototype.arrangeCells=function(){var a,b,c,d,e,f=this.frame.contents.children.length;for(a=0;a<f;a+=3)b=this.frame.contents.children[a],c=this.frame.contents.children[a+1],d=this.frame.contents.children[a+2],e&&b.setTop(e.bottom()),c&&(c.setTop(b.center().y-c.height()/2),c.setRight(b.left()-2)),d&&(d.setCenter(b.center()),d.setLeft(b.right()+2)),e=b;this.frame.contents.adjustBounds()};
ListWatcherMorph.prototype.show=function(){ListWatcherMorph.uber.show.call(this);this.frame.contents.adjustBounds()};ListWatcherMorph.prototype.drawNew=function(){WatcherMorph.prototype.drawNew.call(this);this.fixLayout()};modules.byob="2012-Mar-20";function CustomBlockDefinition(a){this.category=this.body=null;this.isGlobal=!1;this.type="command";this.spec=a||"";this.declarations={}}
CustomBlockDefinition.prototype.blockInstance=function(){var a;a="command"===this.type?new CustomCommandBlockMorph(this):new CustomReporterBlockMorph(this,"predicate"===this.type);a.isDraggable=!0;return a};CustomBlockDefinition.prototype.templateInstance=function(){var a;a=this.blockInstance();a.refreshDefaults();a.isDraggable=!1;a.isTemplate=!0;return a};
CustomBlockDefinition.prototype.prototypeInstance=function(){var a,b,c=this;a="command"===this.type?new CustomCommandBlockMorph(this,!0):new CustomReporterBlockMorph(this,"predicate"===this.type,!0);a.parts().forEach(function(a){if(a instanceof BlockInputFragmentMorph&&(b=c.declarations[a.fragment.labelString]))a.fragment.type=b[0],a.fragment.defaultValue=b[1]});return a};
CustomBlockDefinition.prototype.copyAndBindTo=function(a){var b=copy(this),c;b.declarations=copy(this.declarations);b.body=Process.prototype.reify.call(null,this.body.expression,new List(this.inputNames()));c=new Context;c.receiver=a;c.variables.parentFrame=a.variables;b.body.outerContext=c;return b};
CustomBlockDefinition.prototype.blockSpec=function(){var a=this,b=[],c;this.parseSpec(this.spec).forEach(function(d){c="%"===d[0]?a.typeOf(d.slice(1)):d;b.push(c);b.push(" ")});return"".concat.apply("",b).trim()};CustomBlockDefinition.prototype.typeOf=function(a){return this.declarations[a]?this.declarations[a][0]:"%s"};CustomBlockDefinition.prototype.defaultValueOf=function(a){return this.declarations[a]?this.declarations[a][1]:""};CustomBlockDefinition.prototype.defaultValueOfInputIdx=function(a){return this.defaultValueOf(this.inputNames()[a])};
CustomBlockDefinition.prototype.inputNames=function(){var a=[];this.parseSpec(this.spec).forEach(function(b){"%"===b[0]&&a.push(b.slice(1))});return a};CustomBlockDefinition.prototype.parseSpec=function(a){var b=[],c="",d,e=!1,f;for(d=0;d<a.length;d+=1)f=a[d],"'"===f?e=!e:" "===f&&!e?(b.push(c),c=""):c=c.concat(f);b.push(c);return b};CustomCommandBlockMorph.prototype=new CommandBlockMorph;CustomCommandBlockMorph.prototype.constructor=CustomCommandBlockMorph;CustomCommandBlockMorph.uber=CommandBlockMorph.prototype;
function CustomCommandBlockMorph(a,b){this.init(a,b)}CustomCommandBlockMorph.prototype.init=function(a,b){this.definition=a;this.isPrototype=b||!1;CustomCommandBlockMorph.uber.init.call(this);this.selector="evaluateCustomBlock";a&&this.refresh()};
CustomCommandBlockMorph.prototype.refresh=function(){var a=this.definition,b=this,b=this.isPrototype?a.spec:a.blockSpec(),c=0,d=SpriteMorph.prototype.blockColor[a.category||"other"];if(this.isTemplate&&this.parent&&(c=this.parent.children.indexOf(this),-1<c))return b=a.templateInstance(),b.setPosition(this.position()),b.parent=this.parent,b.parent.children[c]=b,b.parent.changed(),null;this.setColor(d);this.blockSpec!==b&&this.setSpec(b);this.isPrototype||(c=0,this.inputs().forEach(function(b){b instanceof
TemplateSlotMorph&&b.setContents(a.inputNames()[c]);c+=1}))};CustomCommandBlockMorph.prototype.refreshDefaults=function(){var a=0,b=this;this.inputs().forEach(function(c){c instanceof InputSlotMorph&&c.setContents(b.definition.defaultValueOfInputIdx(a));a+=1})};
CustomCommandBlockMorph.prototype.refreshPrototype=function(){var a,b,c,d=[],e=this,f,g,h=0;if(!this.isPrototype)return null;a=this.parentThatIsA(PrototypeHatBlockMorph);this.parts().forEach(function(a){a.fragment.isDeleted||(a.fragment.type?d.push(a.fragment):(f=e.definition.parseSpec(a.fragment.labelString),f.forEach(function(b){g=a.fragment.copy();g.labelString=b;d.push(g)})))});b=this.specFromFragments();this instanceof CustomCommandBlockMorph&&("reporter"===a.type||"predicate"===a.type)?(e=new CustomReporterBlockMorph(this.definition,
"predicate"===a.type,!0),a.silentReplaceInput(this,e)):this instanceof CustomReporterBlockMorph&&("command"===a.type?(e=new CustomCommandBlockMorph(this.definition,!0),a.silentReplaceInput(this,e)):(this.isPredicate="predicate"===a.type,this.drawNew()));e.color=SpriteMorph.prototype.blockColor[a.category||"other"];e.setSpec(b);e.parts().forEach(function(a){if(!(a instanceof BlockLabelPlaceHolderMorph)){if(d[h])a.fragment=d[h];h=h+1}});a.fixLayout();c=e.blockSpecFromFragments();e.receiver().allBlockInstances(e.definition).forEach(function(a){a.setColor(e.color);
a.setSpec(c);h=0;a.inputs().forEach(function(a){if(a instanceof TemplateSlotMorph){a.setContents(e.upvarFragmentName(h));h=h+1}})})};CustomCommandBlockMorph.prototype.upvarFragmentNames=function(){var a=[];this.parts().forEach(function(b){!b.fragment.isDeleted&&"%upvar"===b.fragment.type&&a.push(b.fragment.labelString)});return a};CustomCommandBlockMorph.prototype.upvarFragmentName=function(a){return this.upvarFragmentNames()[a]||"\u2191"};
CustomCommandBlockMorph.prototype.specFromFragments=function(){var a="";this.parts().forEach(function(b){b.fragment.isDeleted||(a=a+b.fragment.defSpecFragment()+" ")});return a.trim()};CustomCommandBlockMorph.prototype.blockSpecFromFragments=function(){var a="";this.parts().forEach(function(b){b.fragment.isDeleted||(a=a+b.fragment.blockSpecFragment()+" ")});return a.trim()};
CustomCommandBlockMorph.prototype.declarationsFromFragments=function(){var a={};this.parts().forEach(function(b){b instanceof BlockInputFragmentMorph&&(a[b.fragment.labelString]=[b.fragment.type,b.fragment.defaultValue])});return a};CustomCommandBlockMorph.prototype.parseSpec=function(a){return!this.isPrototype?CustomCommandBlockMorph.uber.parseSpec.call(this,a):this.definition.parseSpec.call(this,a)};
CustomCommandBlockMorph.prototype.mouseClickLeft=function(){if(!this.isPrototype)return CustomCommandBlockMorph.uber.mouseClickLeft.call(this);this.edit()};
CustomCommandBlockMorph.prototype.edit=function(){var a=this,b,c;this.isPrototype?(b=this.definition.blockInstance(),b.addShadow(),c=this.parentThatIsA(PrototypeHatBlockMorph),(new BlockDialogMorph(null,function(b){b&&(c.category=b.category,c.type=b.type,a.refreshPrototype())},a)).openForChange("Change block",c.category,c.type,a.world(),b.fullImage(),a.isInUse())):(new BlockEditorMorph(this.definition,this.receiver())).popUp()};
CustomCommandBlockMorph.prototype.labelPart=function(a){if(!this.isPrototype)return CustomCommandBlockMorph.uber.labelPart.call(this,a);"%"===a[0]&&1<a.length?a=new BlockInputFragmentMorph(a.slice(1)):(a=new BlockLabelFragmentMorph(a),a.fontSize=this.fontSize,a.color=new Color(255,255,255),a.isBold=!0,a.shadowColor=this.color.darker(this.labelContrast),a.shadowOffset=this.embossing,a.drawNew());return a};
CustomCommandBlockMorph.prototype.placeHolder=function(){var a;a=new BlockLabelPlaceHolderMorph;a.fontSize=1.4*this.fontSize;a.color=new Color(45,45,45);a.drawNew();return a};CustomCommandBlockMorph.prototype.attachTargets=function(){return this.isPrototype?[]:CustomCommandBlockMorph.uber.attachTargets.call(this)};CustomCommandBlockMorph.prototype.isInUse=function(){return this.receiver().usesBlockInstance(this.definition)};
CustomCommandBlockMorph.prototype.userMenu=function(){var a;this.isPrototype?a=new MenuMorph(this):((a=this.constructor.uber.userMenu.call(this))?a.addLine():a=new MenuMorph(this),a.addItem("delete block definition...","deleteBlockDefinition"));a.addItem("edit...","edit");return a};
CustomCommandBlockMorph.prototype.deleteBlockDefinition=function(){var a,b,c,d=this,e;if(this.isPrototype)return null;e=d.definition.blockInstance();e.addShadow();(new DialogBoxMorph(this,function(){b=d.receiver();b.deleteAllBlockInstances(d.definition);a=b.customBlocks.indexOf(d.definition);-1!==a&&(b.customBlocks.splice(a,1),(c=b.parentThatIsA(IDE_Morph))&&c.refreshPalette())},this)).askYesNo("Delete Custom Block","Are you sure you want to delete this\ncustom block and all its instances?",d.world(),
e.fullImage())};CustomReporterBlockMorph.prototype=new ReporterBlockMorph;CustomReporterBlockMorph.prototype.constructor=CustomReporterBlockMorph;CustomReporterBlockMorph.uber=ReporterBlockMorph.prototype;function CustomReporterBlockMorph(a,b,c){this.init(a,b,c)}CustomReporterBlockMorph.prototype.init=function(a,b,c){this.definition=a;this.isPrototype=c||!1;CustomReporterBlockMorph.uber.init.call(this,b);this.selector="evaluateCustomBlock";a&&this.refresh()};
CustomReporterBlockMorph.prototype.refresh=function(){CustomCommandBlockMorph.prototype.refresh.call(this);this.isPrototype||(this.isPredicate="predicate"===this.definition.type);this.drawNew()};CustomReporterBlockMorph.prototype.mouseClickLeft=function(){if(!this.isPrototype)return CustomReporterBlockMorph.uber.mouseClickLeft.call(this);this.edit()};CustomReporterBlockMorph.prototype.placeHolder=CustomCommandBlockMorph.prototype.placeHolder;CustomReporterBlockMorph.prototype.parseSpec=CustomCommandBlockMorph.prototype.parseSpec;
CustomReporterBlockMorph.prototype.edit=CustomCommandBlockMorph.prototype.edit;CustomReporterBlockMorph.prototype.labelPart=CustomCommandBlockMorph.prototype.labelPart;CustomReporterBlockMorph.prototype.upvarFragmentNames=CustomCommandBlockMorph.prototype.upvarFragmentNames;CustomReporterBlockMorph.prototype.upvarFragmentName=CustomCommandBlockMorph.prototype.upvarFragmentName;CustomReporterBlockMorph.prototype.specFromFragments=CustomCommandBlockMorph.prototype.specFromFragments;
CustomReporterBlockMorph.prototype.blockSpecFromFragments=CustomCommandBlockMorph.prototype.blockSpecFromFragments;CustomReporterBlockMorph.prototype.declarationsFromFragments=CustomCommandBlockMorph.prototype.declarationsFromFragments;CustomReporterBlockMorph.prototype.refreshPrototype=CustomCommandBlockMorph.prototype.refreshPrototype;CustomReporterBlockMorph.prototype.refreshDefaults=CustomCommandBlockMorph.prototype.refreshDefaults;CustomReporterBlockMorph.prototype.isInUse=CustomCommandBlockMorph.prototype.isInUse;
CustomReporterBlockMorph.prototype.userMenu=CustomCommandBlockMorph.prototype.userMenu;CustomReporterBlockMorph.prototype.deleteBlockDefinition=CustomCommandBlockMorph.prototype.deleteBlockDefinition;JaggedBlockMorph.prototype=new ReporterBlockMorph;JaggedBlockMorph.prototype.constructor=JaggedBlockMorph;JaggedBlockMorph.uber=ReporterBlockMorph.prototype;JaggedBlockMorph.prototype.jag=5;function JaggedBlockMorph(a){this.init(a)}
JaggedBlockMorph.prototype.init=function(a){JaggedBlockMorph.uber.init.call(this);a&&this.setSpec(a)};JaggedBlockMorph.prototype.drawNew=function(){var a;this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();this.image=newCanvas(this.extent());a=this.image.getContext("2d");a.fillStyle=this.cachedClr;this.drawBackground(a);this.drawEdges(a);this.eraseCSlotAreas(a)};
JaggedBlockMorph.prototype.drawBackground=function(a){var b=this.width(),c=this.height(),d=Math.round(c/this.jag),e=c/d,f,g;a.fillStyle=this.cachedClr;a.beginPath();a.moveTo(0,0);a.lineTo(b,0);for(f=g=0;f<d;f+=1)g+=e/2,a.lineTo(b-this.jag/2,g),g+=e/2,a.lineTo(b,g);a.lineTo(0,c);g=c;for(f=0;f<d;f+=1)g-=e/2,a.lineTo(this.jag/2,g),g-=e/2,a.lineTo(0,g);a.closePath();a.fill()};
JaggedBlockMorph.prototype.drawEdges=function(a){var b=this.width(),c=this.height(),d=Math.round(c/this.jag),e=c/d,f=this.edge/2,g,h;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";g=a.createLinearGradient(0,0,0,this.edge);g.addColorStop(0,this.cachedClrBright);g.addColorStop(1,this.cachedClr);a.strokeStyle=g;a.beginPath();a.moveTo(f,f);a.lineTo(b-f,f);a.stroke();for(g=h=0;g<d;g+=1)a.strokeStyle=this.cachedClrDark,a.beginPath(),a.moveTo(b-f,h),h+=e/2,a.lineTo(b-this.jag/2-f,h),a.stroke(),
h+=e/2;g=a.createLinearGradient(0,c-this.edge,0,c);g.addColorStop(0,this.cachedClr);g.addColorStop(1,this.cachedClrDark);a.strokeStyle=g;a.beginPath();a.moveTo(b-f,c-f);a.lineTo(f,c-f);a.stroke();h=c;for(g=0;g<d;g+=1)a.strokeStyle=this.cachedClrBright,a.beginPath(),a.moveTo(f,h),h-=e/2,a.lineTo(this.jag/2+f,h),a.stroke(),h-=e/2};BlockDialogMorph.prototype=new DialogBoxMorph;BlockDialogMorph.prototype.constructor=BlockDialogMorph;BlockDialogMorph.uber=DialogBoxMorph.prototype;
function BlockDialogMorph(a,b,c){this.init(a,b,c)}
BlockDialogMorph.prototype.init=function(a,b,c){this.blockType="command";this.category="other";this.categories=this.types=null;BlockDialogMorph.uber.init.call(this,a,b,c);this.types=new AlignmentMorph("row",this.padding);this.add(this.types);this.categories=new BoxMorph;this.categories.color=SpriteMorph.prototype.paletteColor.lighter(8);this.categories.borderColor=this.categories.color.lighter(40);this.createCategoryButtons();this.fixCategoriesLayout();this.add(this.categories);this.createTypeButtons();
this.fixLayout()};
BlockDialogMorph.prototype.openForChange=function(a,b,c,d,e,f){var g=SpriteMorph.prototype.blockColor[b];this.category=b;this.blockType=c;this.categories.children.forEach(function(a){a.refresh()});this.types.children.forEach(function(a){a.setColor(g);a.refresh()});this.labelString=a;this.createLabel();e&&this.setPicture(e);this.addButton("ok","Ok");this.addButton("cancel","Cancel");f&&(this.types.destroy(),this.types=null);this.fixLayout();this.drawNew();d&&(d.add(this),this.setCenter(d.center()),this.edit())};
BlockDialogMorph.prototype.createCategoryButtons=function(){var a=this,b=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1;SpriteMorph.prototype.categories.forEach(function(b){a.addCategoryButton(b)});Morph.prototype.trackChanges=b};
BlockDialogMorph.prototype.addCategoryButton=function(a){var b=this,c=[SpriteMorph.prototype.paletteColor,SpriteMorph.prototype.paletteColor.darker(50),SpriteMorph.prototype.blockColor[a]],d;d=new ToggleButtonMorph(c,this,function(){b.category=a;b.categories.children.forEach(function(a){a.refresh()});b.types&&b.types.children.forEach(function(a){a.setColor(c[2])});b.edit()},a[0].toUpperCase().concat(a.slice(1)),function(){return b.category===a},null,null,null,75,!0);d.corner=8;d.padding=0;d.labelShadowOffset=
new Point(-1,-1);d.labelShadowColor=c[1];d.labelColor=new Color(255,255,255);d.contrast=this.buttonContrast;d.fixLayout();d.refresh();this.categories.add(d);return d};
BlockDialogMorph.prototype.fixCategoriesLayout=function(){var a=this.categories.children[0].width(),b=this.categories.children[0].height(),c=Math.ceil(this.categories.children.length/2),d=this.categories.left(),e=this.categories.top(),f=0,g,h,i=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1;this.categories.children.forEach(function(c){f+=1;g=Math.ceil(f/2);h=2-f%2;c.setPosition(new Point(d+(15*h+(h-1)*a),e+(2*g+(g-1)*b+10)))});this.categories.setExtent(new Point(45+2*a,2*(c+1)+c*b+20));
Morph.prototype.trackChanges=i;this.categories.changed()};
BlockDialogMorph.prototype.createTypeButtons=function(){var a,b=this,c=SpriteMorph.prototype.blockColor[this.category];a=new CommandBlockMorph;a.setColor(c);a.setSpec("Command");this.addBlockTypeButton(function(){b.setType("command")},a,function(){return"command"===b.blockType});a=new ReporterBlockMorph;a.setColor(c);a.setSpec("Reporter");this.addBlockTypeButton(function(){b.setType("reporter")},a,function(){return"reporter"===b.blockType});a=new ReporterBlockMorph(!0);a.setColor(c);a.setSpec("Predicate");
this.addBlockTypeButton(function(){b.setType("predicate")},a,function(){return"predicate"===b.blockType})};BlockDialogMorph.prototype.addBlockTypeButton=function(a,b,c){a=new ToggleElementMorph(this,a,b,c,null,null,"rebuild");a.refresh();this.types.add(a);return a};
BlockDialogMorph.prototype.addTypeButton=function(a,b,c){a=new ToggleMorph("radiobutton",this,a,b,c);a.edge=this.buttonEdge/2;a.outline=this.buttonOutline/2;a.outlineColor=this.buttonOutlineColor;a.outlineGradient=this.buttonOutlineGradient;a.contrast=this.buttonContrast;a.drawNew();a.fixLayout();this.types.add(a);return a};BlockDialogMorph.prototype.setType=function(a){this.blockType=a||this.blockType;this.types.children.forEach(function(a){a.refresh()});this.edit()};
BlockDialogMorph.prototype.getInput=function(){var a;this.body instanceof InputFieldMorph&&(a=this.normalizeSpaces(this.body.getValue()));a=new CustomBlockDefinition(a);a.type=this.blockType;a.category=this.category;return a};
BlockDialogMorph.prototype.fixLayout=function(){var a=fontHeight(this.titleFontSize)+2*this.titlePadding;if(this.body)this.body.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+a),this.categories&&(this.categories.setCenter(this.body.center()),this.categories.setTop(this.body.top()),this.body.setTop(this.categories.bottom()+this.padding),this.silentSetHeight(this.height()+
this.categories.height()+this.padding));else if(this.head&&(this.types?(this.types.fixLayout(),this.silentSetWidth(Math.max(this.types.width(),this.head.width())+2*this.padding)):this.silentSetWidth(Math.max(this.categories.width(),this.head.width())+2*this.padding),this.head.setCenter(this.center()),this.head.setTop(a+this.padding),this.silentSetHeight(this.head.height()+2*this.padding+a),this.categories))this.categories.setCenter(this.center()),this.categories.setTop(this.head.bottom()+this.padding),
this.silentSetHeight(this.height()+this.categories.height()+this.padding);this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(a-this.label.height())/2));this.types&&(this.types.fixLayout(),this.silentSetHeight(this.height()+this.types.height()+this.padding),this.silentSetWidth(Math.max(this.width(),this.types.width()+2*this.padding)),this.types.setCenter(this.center()),this.body?this.types.setTop(this.body.bottom()+this.padding):this.categories&&this.types.setTop(this.categories.bottom()+
this.padding));this.buttons&&0<this.buttons.children.length&&(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))};BlockEditorMorph.prototype=new DialogBoxMorph;BlockEditorMorph.prototype.constructor=BlockEditorMorph;BlockEditorMorph.uber=DialogBoxMorph.prototype;function BlockEditorMorph(a,b){this.init(a,b)}
BlockEditorMorph.prototype.init=function(a,b){var c,d,e=this;this.definition=a;this.handle=null;BlockEditorMorph.uber.init.call(this,b,function(){e.updateDefinition()},b);this.labelString="Block Editor";this.createLabel();c=new ScriptsMorph(b);c.isDraggable=!1;c.color=new Color(112,112,112);c.texture="scriptsPaneTexture.gif";c.cleanUpMargin=10;d=new PrototypeHatBlockMorph(this.definition);d.setPosition(c.position().add(10));null!==a.body&&d.nextBlock(a.body.expression.fullCopy());c.add(d);d=new ScrollFrameMorph(c);
d.padding=10;d.isDraggable=!1;d.acceptsDrops=!1;d.contents.acceptsDrops=!0;c.scrollFrame=d;this.addBody(d);this.addButton("ok","Ok");this.addButton("cancel","Cancel");this.setExtent(new Point(375,300));this.fixLayout()};BlockEditorMorph.prototype.popUp=function(){var a=this.target.world();a&&(a.add(this),a.keyboardReceiver=this,this.handle=new HandleMorph(this,280,220,this.corner,this.corner),this.setCenter(a.center()))};
BlockEditorMorph.prototype.cancel=function(){this.refreshAllBlockInstances();this.destroy()};BlockEditorMorph.prototype.refreshAllBlockInstances=function(){var a=this.target.paletteBlockInstance(this.definition);this.target.allBlockInstances(this.definition).forEach(function(a){a.refresh()});a&&a.refreshDefaults()};
BlockEditorMorph.prototype.updateDefinition=function(){var a;this.definition.spec=this.prototypeSpec();this.definition.declarations=this.prototypeSlots();if(a=detect(this.body.contents.children,function(a){return a instanceof PrototypeHatBlockMorph}))this.definition.category=a.category,this.definition.type=a.type;a=this.context();null!==a&&(this.definition.body=a);this.refreshAllBlockInstances()};
BlockEditorMorph.prototype.context=function(){var a,b,c;a=detect(this.body.contents.children,function(a){return a instanceof PrototypeHatBlockMorph});b=a.nextBlock();if(null===b)return null;a.parts();a=Process.prototype.reify.call(null,b,new List(this.definition.inputNames()));c=new Context;c.receiver=b.receiver();c.variables.parentFrame=c.receiver.variables;a.outerContext=c;return a};
BlockEditorMorph.prototype.prototypeSpec=function(){return detect(this.body.contents.children,function(a){return a instanceof PrototypeHatBlockMorph}).parts()[0].specFromFragments()};BlockEditorMorph.prototype.prototypeSlots=function(){return detect(this.body.contents.children,function(a){return a instanceof PrototypeHatBlockMorph}).parts()[0].declarationsFromFragments()};
BlockEditorMorph.prototype.fixLayout=function(){var a=fontHeight(this.titleFontSize)+2*this.titlePadding;this.buttons&&0<this.buttons.children.length&&this.buttons.fixLayout();this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-a-this.buttons.height())));this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(a-this.label.height())/2));this.buttons&&
0<this.buttons.children.length&&(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))};PrototypeHatBlockMorph.prototype=new HatBlockMorph;PrototypeHatBlockMorph.prototype.constructor=PrototypeHatBlockMorph;PrototypeHatBlockMorph.uber=HatBlockMorph.prototype;function PrototypeHatBlockMorph(a){this.init(a)}
PrototypeHatBlockMorph.prototype.init=function(a){this.category=(this.definition=a)?a.category:null;this.type=a?a.type:null;HatBlockMorph.uber.init.call(this);this.color=SpriteMorph.prototype.blockColor.control;this.add(a.prototypeInstance());this.fixLayout()};PrototypeHatBlockMorph.prototype.mouseClickLeft=function(){this.children[0].mouseClickLeft()};PrototypeHatBlockMorph.prototype.userMenu=function(){return this.children[0].userMenu()};
function BlockLabelFragment(a){this.labelString=a||"";this.type="%s";this.defaultValue="";this.isDeleted=!1}BlockLabelFragment.prototype.defSpecFragment=function(){var a=this.type?"%'":"";return this.isDeleted?"":a+this.labelString+(this.type?"'":"")};BlockLabelFragment.prototype.blockSpecFragment=function(){return this.isDeleted?"":this.type||this.labelString};
BlockLabelFragment.prototype.copy=function(){var a=new BlockLabelFragment(this.labelString);a.type=this.type;a.defaultValue=this.defaultValue;return a};BlockLabelFragment.prototype.isSingleInput=function(){return!this.isMultipleInput()&&"%upvar"!==this.type};BlockLabelFragment.prototype.isMultipleInput=function(){return!this.type?!1:-1<this.type.indexOf("%mult")};BlockLabelFragment.prototype.isUpvar=function(){return!this.type?!1:"%upvar"===this.type};
BlockLabelFragment.prototype.setToSingleInput=function(){if(!this.type)return null;this.type="%upvar"===this.type?"%s":this.singleInputType()};BlockLabelFragment.prototype.setToMultipleInput=function(){if(!this.type)return null;"%upvar"===this.type&&(this.type="%s");this.type="%mult".concat(this.singleInputType())};BlockLabelFragment.prototype.setToUpvar=function(){if(!this.type)return null;this.type="%upvar"};
BlockLabelFragment.prototype.singleInputType=function(){return!this.type?null:this.isMultipleInput()?this.type.substr(5):this.type};BlockLabelFragment.prototype.setSingleInputType=function(a){this.type=!this.type||!this.isMultipleInput()?a:"%mult".concat(a)};BlockLabelFragmentMorph.prototype=new StringMorph;BlockLabelFragmentMorph.prototype.constructor=BlockLabelFragmentMorph;BlockLabelFragmentMorph.uber=StringMorph.prototype;function BlockLabelFragmentMorph(a){this.init(a)}
BlockLabelFragmentMorph.prototype.init=function(a){this.fragment=new BlockLabelFragment(a);this.sO=this.fragment.type=null;BlockLabelFragmentMorph.uber.init.call(this,a)};BlockLabelFragmentMorph.prototype.mouseEnter=function(){this.sO=this.shadowOffset;this.shadowOffset=this.sO.neg();this.drawNew();this.changed()};BlockLabelFragmentMorph.prototype.mouseLeave=function(){this.shadowOffset=this.sO;this.drawNew();this.changed()};
BlockLabelFragmentMorph.prototype.mouseClickLeft=function(){var a=this.fragment.copy(),b=this,c=this instanceof BlockLabelPlaceHolderMorph;(new InputSlotDialogMorph(a,null,function(){b.updateBlockLabel(a)},this,this.parent.definition.category)).open(this instanceof BlockLabelFragmentMorph?"Edit label fragment":c?"Create input name":"Edit input name",a.labelString,this.world(),null,c)};
BlockLabelFragmentMorph.prototype.updateBlockLabel=function(a){var b=this.parentThatIsA(BlockMorph);this.fragment=a;b&&b.refreshPrototype()};BlockLabelPlaceHolderMorph.prototype=new StringMorph;BlockLabelPlaceHolderMorph.prototype.constructor=BlockLabelPlaceHolderMorph;BlockLabelPlaceHolderMorph.uber=StringMorph.prototype;function BlockLabelPlaceHolderMorph(){this.init()}
BlockLabelPlaceHolderMorph.prototype.init=function(){this.fragment=new BlockLabelFragment("");this.fragment.type="%s";this.fragment.isDeleted=!0;this.isHighlighted=!1;BlockLabelFragmentMorph.uber.init.call(this,"+")};
BlockLabelPlaceHolderMorph.prototype.drawNew=function(){var a,b,c;this.image=newCanvas();a=this.image.getContext("2d");a.font=this.font();b=Math.max(a.measureText(this.text).width+Math.abs(this.shadowOffset.x),1);this.bounds.corner=this.bounds.origin.add(new Point(b,fontHeight(this.fontSize)+Math.abs(this.shadowOffset.y)));this.image.width=b;this.image.height=this.height();this.isHighlighted&&(b=Math.floor(b/2),c=Math.floor(this.height()/2),a.fillStyle=this.color.toString(),a.beginPath(),a.arc(b,
c,Math.min(b,c),radians(0),radians(360),!1),a.closePath(),a.fill());a.font=this.font();a.textAlign="left";a.textBaseline="bottom";this.shadowColor&&(b=Math.max(this.shadowOffset.x,0),c=Math.max(this.shadowOffset.y,0),a.fillStyle=this.shadowColor.toString(),a.fillText(this.text,b,fontHeight(this.fontSize)+c));b=Math.abs(Math.min(this.shadowOffset.x,0));c=Math.abs(Math.min(this.shadowOffset.y,0));a.fillStyle=this.isHighlighted?"white":this.color.toString();a.fillText(this.text,b,fontHeight(this.fontSize)+
c);this.parent&&this.parent.fixLayout&&this.parent.fixLayout()};BlockLabelPlaceHolderMorph.prototype.mouseEnter=function(){this.isHighlighted=!0;this.drawNew();this.changed()};BlockLabelPlaceHolderMorph.prototype.mouseLeave=function(){this.isHighlighted=!1;this.drawNew();this.changed()};BlockLabelPlaceHolderMorph.prototype.mouseClickLeft=BlockLabelFragmentMorph.prototype.mouseClickLeft;BlockLabelPlaceHolderMorph.prototype.updateBlockLabel=BlockLabelFragmentMorph.prototype.updateBlockLabel;
BlockInputFragmentMorph.prototype=new TemplateSlotMorph;BlockInputFragmentMorph.prototype.constructor=BlockInputFragmentMorph;BlockInputFragmentMorph.uber=TemplateSlotMorph.prototype;function BlockInputFragmentMorph(a){this.init(a)}BlockInputFragmentMorph.prototype.init=function(a){this.fragment=new BlockLabelFragment(a);this.fragment.type="%s";BlockInputFragmentMorph.uber.init.call(this,a)};BlockInputFragmentMorph.prototype.mouseClickLeft=BlockLabelFragmentMorph.prototype.mouseClickLeft;
BlockInputFragmentMorph.prototype.updateBlockLabel=BlockLabelFragmentMorph.prototype.updateBlockLabel;InputSlotDialogMorph.prototype=new DialogBoxMorph;InputSlotDialogMorph.prototype.constructor=InputSlotDialogMorph;InputSlotDialogMorph.uber=DialogBoxMorph.prototype;function InputSlotDialogMorph(a,b,c,d,e){this.init(a,b,c,d,e)}
InputSlotDialogMorph.prototype.init=function(a,b,c,d,e){var f=fontHeight(10);this.fragment=a||new BlockLabelFragment;this.slots=this.types=null;this.isExpanded=!1;this.category=e||"other";this.cachedRadioButton=null;BlockDialogMorph.uber.init.call(this,b,c,d);this.types=new AlignmentMorph("row",this.padding);this.types.respectHiddens=!0;this.add(this.types);this.slots=new BoxMorph;this.slots.color=new Color(55,55,55);this.slots.borderColor=this.slots.color.lighter(50);this.slots.setExtent(new Point(21*
(f+10),10*(f+9.5)));this.add(this.slots);this.createSlotTypeButtons();this.fixSlotsLayout();this.createTypeButtons();this.fixLayout()};
InputSlotDialogMorph.prototype.createTypeButtons=function(){var a,b,c=this,d=SpriteMorph.prototype.blockColor[this.category];a=new JaggedBlockMorph("Title text");a.setColor(d);this.addBlockTypeButton(function(){c.setType(null)},a,function(){return null===c.fragment.type});a=new JaggedBlockMorph("%inputName");a.setColor(d);this.addBlockTypeButton(function(){c.setType("%s")},a,function(){return null!==c.fragment.type});b=new ArrowMorph("right",PushButtonMorph.prototype.fontSize+4,2);b.noticesTransparentClick=
!0;this.types.add(b);this.types.fixLayout();b.refresh=function(){null===c.fragment.type?(c.isExpanded=!1,b.hide(),c.drawNew()):(b.show(),b.direction=c.isExpanded?"down":"right",b.drawNew(),b.changed())};b.mouseClickLeft=function(){b.isVisible&&(c.isExpanded=!c.isExpanded,c.types.children.forEach(function(a){a.refresh()}),c.drawNew(),c.edit())};b.refresh()};InputSlotDialogMorph.prototype.addTypeButton=BlockDialogMorph.prototype.addTypeButton;InputSlotDialogMorph.prototype.addBlockTypeButton=BlockDialogMorph.prototype.addBlockTypeButton;
InputSlotDialogMorph.prototype.setType=function(a){this.fragment.type=a||null;this.types.children.forEach(function(a){a.refresh()});this.slots.children.forEach(function(a){a.refresh()});this.edit()};InputSlotDialogMorph.prototype.getInput=function(){var a;this.body instanceof InputFieldMorph&&(a=this.normalizeSpaces(this.body.getValue()));if(a)return this.fragment.labelString=a,this.fragment.defaultValue=this.slots.defaultInputField.getValue(),a;this.fragment.isDeleted=!0;return null};
InputSlotDialogMorph.prototype.fixLayout=function(){var a,b=this.left(),c=fontHeight(this.titleFontSize)+2*this.titlePadding;if(!this.isExpanded)return this.slots&&this.slots.hide(),BlockDialogMorph.prototype.fixLayout.call(this);this.slots.show();a=this.slots.width();this.body.setPosition(this.position().add(new Point(this.padding+(a-this.body.width())/2,c+this.padding)));this.label.setLeft(b+this.padding+(a-this.label.width())/2);this.label.setTop(this.top()+(c-this.label.height())/2);this.types.fixLayout();
this.types.setTop(this.body.bottom()+this.padding);this.types.setLeft(b+this.padding+(a-this.types.width())/2);this.slots.setPosition(new Point(this.left()+this.padding,this.types.bottom()+this.padding));this.slots.children.forEach(function(a){a.refresh()});this.buttons.fixLayout();this.buttons.setTop(this.slots.bottom()+this.padding);this.buttons.setLeft(b+this.padding+(a-this.buttons.width())/2);this.silentSetHeight(this.buttons.bottom()-this.top()+this.padding);this.silentSetWidth(this.slots.right()-
this.left()+this.padding)};
InputSlotDialogMorph.prototype.open=function(a,b,c,d,e){var b=new InputFieldMorph(b),f=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1;b.setWidth(250);this.labelString=a;this.createLabel();d&&this.setPicture(d);this.addBody(b);b.drawNew();this.addButton("ok","Ok");e||this.addButton("deleteFragment","Delete");this.addButton("cancel","Cancel");this.fixLayout();this.drawNew();this.fixLayout();c&&(c.add(this),this.setCenter(c.center()),this.edit());Morph.prototype.trackChanges=f;this.changed()};
InputSlotDialogMorph.prototype.deleteFragment=function(){this.fragment.isDeleted=!0;this.accept()};
InputSlotDialogMorph.prototype.createSlotTypeButtons=function(){var a=this,b,c,d=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1;this.addSlotTypeButton("Object","%obj");this.addSlotTypeButton("Text","%txt");this.addSlotTypeButton("List","%l");this.addSlotTypeButton("Number","%n");this.addSlotTypeButton("Any type","%s");this.addSlotTypeButton("Boolean (T/F)","%b");this.addSlotTypeButton("Command\n(inline)","%cmd");this.addSlotTypeButton("Reporter","%r");this.addSlotTypeButton("Predicate",
"%p");this.addSlotTypeButton("Command\n(C-shape)","%cs");this.addSlotTypeButton("Any\n(unevaluated)","%anyUE");this.addSlotTypeButton("Boolean\n(unevaluated)","%boolUE");this.slots.radioButtonSingle=this.addSlotArityButton(function(){a.setSlotArity("single")},"Single input.",function(){return a.fragment.isSingleInput()});this.addSlotArityButton(function(){a.setSlotArity("multiple")},"Multiple inputs (value is list of inputs)",function(){return a.fragment.isMultipleInput()});this.addSlotArityButton(function(){a.setSlotArity("upvar")},
"Upvar - make internal variable visible to caller",function(){return a.fragment.isUpvar()});b=new StringMorph("Default Value:");b.fontSize=this.slots.radioButtonSingle.fontSize;b.setColor(new Color(255,255,255));b.refresh=function(){a.isExpanded&&contains(["%s","%n","%txt","%anyUE"],a.fragment.type)?b.show():b.hide()};this.slots.defaultInputLabel=b;this.slots.add(b);c=new InputFieldMorph(this.fragment.defaultValue);c.contents().fontSize=b.fontSize;c.contrast=90;c.contents().drawNew();c.setWidth(50);
c.refresh=function(){b.isVisible?(c.show(),"%n"===a.fragment.type?c.setIsNumeric(!0):c.setIsNumeric(!1)):c.hide()};this.slots.defaultInputField=c;this.slots.add(c);c.drawNew();Morph.prototype.trackChanges=d};InputSlotDialogMorph.prototype.setSlotType=function(a){this.fragment.setSingleInputType(a);this.slots.children.forEach(function(a){a.refresh()});this.edit()};
InputSlotDialogMorph.prototype.setSlotArity=function(a){"single"===a?this.fragment.setToSingleInput():"multiple"===a?this.fragment.setToMultipleInput():"upvar"===a&&this.fragment.setToUpvar();this.slots.children.forEach(function(a){a.refresh()});this.edit()};
InputSlotDialogMorph.prototype.addSlotTypeButton=function(a,b){var c=this,d=new JaggedBlockMorph(b);d.setColor(SpriteMorph.prototype.blockColor[this.category]);d.rebuild();d=new ToggleMorph("radiobutton",this,function(){c.setSlotType(b)},a,function(){return c.fragment.singleInputType()===b},null,null,this.cachedRadioButton,d.fullImage(),"rebuild");d.edge=this.buttonEdge/2;d.outline=this.buttonOutline/2;d.outlineColor=this.buttonOutlineColor;d.outlineGradient=this.buttonOutlineGradient;d.drawNew();
d.fixLayout();d.label.isBold=!1;d.label.setColor(new Color(255,255,255));this.cachedRadioButton||(this.cachedRadioButton=d);this.slots.add(d);return d};
InputSlotDialogMorph.prototype.addSlotArityButton=function(a,b,c){a=new ToggleMorph("radiobutton",this,a,b,c,null,null,this.cachedRadioButton);a.edge=this.buttonEdge/2;a.outline=this.buttonOutline/2;a.outlineColor=this.buttonOutlineColor;a.outlineGradient=this.buttonOutlineGradient;a.drawNew();a.fixLayout();a.label.isBold=!1;a.label.setColor(new Color(255,255,255));this.slots.add(a);this.cachedRadioButton||(this.cachedRadioButton=a);return a};
InputSlotDialogMorph.prototype.fixSlotsLayout=function(){var a=this.slots,b=fontHeight(10)+13,c=fontHeight(10)+10,d=[a.left()+10,a.left()+a.width()/3,a.left()+2*a.width()/3],b=[a.top()+14,a.top()+14+b,a.top()+14+2*b,a.top()+14+3*b,a.top()+14+4*b,a.top()+14+5*b,a.top()+14+5*b+c,a.top()+14+5*b+2*c],e=-1,f,g=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1;for(c=0;12>c;c+=1)f=c%3,0===c%3&&(e+=1),a.children[c].setPosition(new Point(d[f],b[e]));f=0;e=5;for(c=12;15>c;c+=1)a.children[c].setPosition(new Point(d[f],
b[e+c-12]));this.slots.defaultInputLabel.setPosition(this.slots.radioButtonSingle.label.topRight().add(new Point(5,0)));this.slots.defaultInputField.setCenter(this.slots.defaultInputLabel.center().add(new Point(this.slots.defaultInputField.width()/2+this.slots.defaultInputLabel.width()/2+5,0)));Morph.prototype.trackChanges=g;this.slots.changed()};VariableDialogMorph.prototype=new DialogBoxMorph;VariableDialogMorph.prototype.constructor=VariableDialogMorph;VariableDialogMorph.uber=DialogBoxMorph.prototype;
function VariableDialogMorph(a,b,c){this.init(a,b,c)}VariableDialogMorph.prototype.init=function(a,b,c){this.types=null;this.isGlobal=!0;BlockDialogMorph.uber.init.call(this,a,b,c);this.types=new AlignmentMorph("row",this.padding);this.add(this.types);this.createTypeButtons()};
VariableDialogMorph.prototype.createTypeButtons=function(){var a=this;this.addTypeButton(function(){a.setType("gobal")},"for all sprites",function(){return a.isGlobal});this.addTypeButton(function(){a.setType("local")},"for this sprite only",function(){return!a.isGlobal})};VariableDialogMorph.prototype.addTypeButton=BlockDialogMorph.prototype.addTypeButton;VariableDialogMorph.prototype.setType=function(a){this.isGlobal="gobal"===a;this.types.children.forEach(function(a){a.refresh()});this.edit()};
VariableDialogMorph.prototype.getInput=function(){return[this.normalizeSpaces(this.body.getValue()),this.isGlobal]};
VariableDialogMorph.prototype.fixLayout=function(){var a=fontHeight(this.titleFontSize)+2*this.titlePadding;this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+a));this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(a-this.label.height())/2));this.types&&(this.types.fixLayout(),this.silentSetHeight(this.height()+this.types.height()+
this.padding),this.silentSetWidth(Math.max(this.width(),this.types.width()+2*this.padding)),this.types.setCenter(this.center()),this.body?this.types.setTop(this.body.bottom()+this.padding):this.categories&&this.types.setTop(this.categories.bottom()+this.padding));this.buttons&&0<this.buttons.children.length&&(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))};
modules.store="2012-Mar-27";var XMLSerializer;
XMLSerializer={version:1,thumbnailSize:new Point(160,120),serialize:function(a){this.objects=[];a=this.store(a);this.cleanup();return a},cleanup:function(){this.objects.forEach(function(a){delete a.$_id})},store:function(a){if(a.$_id)return this.f('<ref id="@"></ref>',a.$_id);a.$_id=this.objects.length;this.objects.push(a);return a.toXML(this).replace("~",this.f('id="@"',a.$_id))},f:function(a){var b=-1,c=arguments,d;return a.replace(/[@$%]([\d]+)?/g,function(a,f){f=parseInt(f,10);d=c[(isNaN(f)?b+=
1:f)+1];return"@"===a?XMLSerializer.escape(d,!0):"$"===a?XMLSerializer.escape(d,!1):d})},escape:function(a,b){return XMLSerializer.nil(a)?"":a.toString().replace(b?/[<>&"']/g:/[<>&]/g,function(a){return"<"===a?"&lt;":">"===a?"&gt;":"&"===a?"&amp;":'"'===a?"&quot;":a})},unescape:function(a){return XMLSerializer.nil(a)?"":a.toString().replace(/&(lt|gt|amp|quot|apos);/g,function(a){return"&lt;"===a?"<":"&gt;"===a?">":"&amp;"===a?"&":"&quot;"===a?'"':"&apos;"===a?"'":a})},nil:function(a){return void 0===
a||null===a},StringStream:function(a){this.contents=a;this.index=0},Element:function(a){this.name=a;this.attributes={};this.children=[]},Text:function(a){this.value=a},parse:function(a){a=new this.StringStream(a);try{return this.$parse(a)}catch(b){throw Error(b.message+" near "+a.contents.substr(a.index,50)+(50<a.contents.length-a.index?"...":""));}},$parse:function(a){var b,c,d,e;if("<"!==a.peek())return new this.Text(this.unescape(a.upTo(/<|$/)));a.skip(1);if("/"===a.peek())return a.upTo(/>|$/),
a.skip(1),null;b=new this.Element(a.word());for(a.skipSpace();">"!==(c=a.peek())&&"/"!==c;){d=a.word();a.skipSpace();if("="!==a.next())throw Error('Expected "=" after attribute name');a.skipSpace();if('"'!==(c=a.next())&&"'"!==c)throw Error("Expected single- or double-quoted attribute value");e=a.upTo(c);a.skip(1);a.skipSpace();b.attributes[d]=this.unescape(e)}if("/"===a.next()){if(">"!==a.next())throw Error('Expected ">" after "/" in empty tag');}else{do c=this.$parse(a),null!==c&&b.children.push(c);
while(null!==c)}return b},load:function(a){var b,c,d=this.project={},a=this.parse(a);c=c=b=b=void 0;if(+d.version>this.version)throw"Project uses newer version of XMLSerializer";this.objects={};d.name=a.attributes.name;if(this.nil(d.name)){for(b=1;localStorage.hasOwnProperty("-snap-project-Untitled "+b);)b+=1;d.name="Untitled "+b}b=a.element("notes");this.nil(b)||(d.notes=b.textContent());b=a.element("variables");d.globalVariables=new VariableFrame;c=a.require("stage");d.stage=new StageMorph;c.attributes.id&&
(this.objects[c.attributes.id]=d.stage);d.stage.setExtent(new Point(480,360));this.loadObject(d.stage,c);c=c.require("sprites");d.sprites={};d.sprites.stage=d.stage;c.all("sprite").forEach(function(a){var b;b=new SpriteMorph(d.globalVariables);a.attributes.id&&(this.objects[a.attributes.id]=b);if(!this.nil(a.attributes.name)){b.name=a.attributes.name;d.sprites[a.attributes.name]=b}if(!this.nil(a.attributes.color))b.color=this.loadColor(a.attributes.color);d.stage.add(b);b.gotoXY(+a.attributes.x||
0,+a.attributes.y||0);b.heading=parseFloat(a.attributes.heading)||0;b.drawNew();this.loadObject(b,a)},this);this.nil(b)||this.loadVariables(d.globalVariables,b);c.all("watcher").forEach(function(a){var b,c,h;b=this.loadColor(a.attributes.color);c=a.attributes.hasOwnProperty("scope")?d.sprites[a.attributes.scope]:null;h=a.attributes.hasOwnProperty("hidden");b=a.attributes.hasOwnProperty("var")?new WatcherMorph(a.attributes["var"],b,c===null?d.globalVariables:c.variables,a.attributes["var"],h):new WatcherMorph(this.watcherLabels[a.attributes.s],
b,c,a.attributes.s,h);b.setPosition(d.stage.topLeft().add(new Point(+a.attributes.x||0,+a.attributes.y||0)));d.stage.add(b)},this);delete this.objects;return d},loadObject:function(a,b){var c=b.require("blocks");this.loadCustomBlocks(a,c);this.populateCustomBlocks(a,c);this.loadVariables(a.variables,b.require("variables"));this.loadScripts(a.scripts,b.require("scripts"))},loadVariables:function(a,b){b.children.forEach(function(b){var d;b.isElement&&"variable"===b.name&&(d=b.firstElement(),a.vars[b.attributes.name]=
this.nil(d)?0:this.loadValue(d))},this)},loadCustomBlocks:function(a,b){b.children.forEach(function(b){var d,e,f;if(b.isElement&&"block-definition"===b.name&&(d=new CustomBlockDefinition(b.attributes.s||""),d.category=this.nil(b.attributes.category)?"other":b.attributes.category,d.type=b.attributes.type||"command",a.customBlocks.push(d),e=d.parseSpec(d.spec).filter(function(a){return"%"===a.charAt(0)}).map(function(a){return a.substr(1)}),d.names=e,b=b.element("inputs")))f=-1,b.children.forEach(function(a){a.isElement&&
"input"===a.name&&(d.declarations[e[f+=1]]=[a.attributes.type,a.textContent()])})},this)},populateCustomBlocks:function(a,b){b.children.forEach(function(b,d){var e,f,g;b.isElement&&"block-definition"===b.name&&(e=a.customBlocks[d],f=b.element("script"),g=new Context,g.receiver=a,g.variables.parentFrame=g.receiver.variables,e.body=new Context(null,this.nil(f)?null:this.loadScript(f),g,a),e.body.inputs=e.names.slice(0),e.body.receiver=a,delete e.names)},this)},loadScripts:function(a,b){a.texture="scriptsPaneTexture.gif";
b.children.forEach(function(b){var d;b.isElement&&"script"===b.name&&(d=this.loadScript(b),this.nil(d)||(d.setPosition((new Point(+b.attributes.x||0,+b.attributes.y||0)).add(a.topLeft())),a.add(d)))},this)},loadScript:function(a){var b,c,d;a.children.forEach(function(a){a.isElement&&(d=this.loadBlock(a),this.nil(d)||(c?c.nextBlock(d):b=d,c=d))},this);return b},loadBlock:function(a){var b,c,d;if("block"===a.name){if(a.attributes.hasOwnProperty("var"))return b=new ReporterBlockMorph(!1),b.selector=
"reportGetVar",b.color=SpriteMorph.prototype.blockColor.variables,b.setSpec(a.attributes["var"]),b.isDraggable=!0,b;c=this.blocks[a.attributes.s];if(this.nil(c))return this.obsoleteBlock();b="command"===c.type?new CommandBlockMorph:"hat"===c.type?new HatBlockMorph:new ReporterBlockMorph("predicate"===c.type);b.color=SpriteMorph.prototype.blockColor[c.category];b.selector=a.attributes.s;b.setSpec(c.spec)}else if("custom-block"===a.name){c=this.nil(a.attributes.scope)?this.project.stage:this.project.sprites[a.attributes.scope];
if(this.nil(c))return this.obsoleteBlock();c=detect(c.customBlocks,function(b){return b.blockSpec()===a.attributes.s});if(this.nil(c))return this.obsoleteBlock();b="command"===c.type?new CustomCommandBlockMorph(c,!1):new CustomReporterBlockMorph(c,"predicate"===c.type,!1)}b.isDraggable=!0;d=b.inputs();a.children.forEach(function(a,c){this.loadInput(a,d[c],b)},this);return b},obsoleteBlock:function(a,b){var c="command"===b||!b?new CommandBlockMorph:"hat"===b?new HatBlockMorph:new ReporterBlockMorph("predicate"===
b);c.selector="nop";c.color=new Color(200,0,20);c.setSpec(a||"Obsolete!");c.isDraggable=!0;return c},loadInput:function(a,b,c){if("script"===a.name)a=this.loadScript(a),this.nil(a)||(b.add(a),b.fixLayout());else if("autolambda"===a.name&&a.children[0])a=this.loadBlock(a.children[0]),this.nil(a)||(b.silentReplaceInput(b.children[0],a),b.fixLayout());else if("list"===a.name){for(;0<b.inputs().length;)b.removeInput();a.children.forEach(function(a){b.addInput();this.loadInput(a,b.children[b.children.length-
2],b)},this);b.fixLayout()}else"block"===a.name||"custom-block"===a.name?c.silentReplaceInput(b,this.loadBlock(a)):"color"===a.name?b.setColor(this.loadColor(a.textContent())):b.setContents(this.loadValue(a))},loadValue:function(a){function b(){a.attributes.hasOwnProperty("id")&&(e.objects[a.attributes.id]=c)}var c,d,e=this;switch(a.name){case "ref":return this.objects[a.attributes.id];case "l":return a.textContent();case "list":if(a.attributes.hasOwnProperty("linked")){d=a.all("item");if(0===d.length)return c=
new List,b(),c;d.forEach(function(a){a=a.firstElement();void 0===c?(c=new List,b()):c=c.rest=new List;c.isLinked=!0;c.first=this.nil(a)?0:this.loadValue(a)},this);return c}c=new List;b();c.contents=a.all("item").map(function(a){a=a.firstElement();return this.nil(a)?0:this.loadValue(a)},this);return c;case "context":c=new Context(null);b();if(!this.nil(d=a.element("script"))&&d.isElement)c.expression=this.loadScript(d);if(!this.nil(d=a.element("receiver"))&&d.isElement&&!this.nil(d.element("ref")))c.receiver=
this.loadValue(d);!this.nil(d=a.element("inputs"))&&d.isElement&&d.children.forEach(function(a){a.isElement&&"input"===a.name&&c.inputs.push(a.textContent())});!this.nil(d=a.element("variables"))&&d.isElement&&this.loadVariables(c.variables,d);if(!this.nil(d=a.element("context"))&&d.isElement)c.outerContext=this.loadValue(d);return c}},loadColor:function(a){a=(this.nil(a)?"":a).split(",");return new Color(+a[0],+a[1],+a[2],+a[3])},openProject:function(a,b){var c=b.stage;!this.nil(a)&&!this.nil(a.stage)&&
(b.projectName=a.name,b.projectNotes=this.nil(a.notes)?"":a.notes,this.nil(b.globalVariables)||(b.globalVariables=a.globalVariables),this.nil(c)||c.destroy(),b.add(b.stage=a.stage),c=detect(a.stage.children,function(a){return a instanceof SpriteMorph})||a.stage,a.stage.drawNew(),b.createCorral(),b.selectSprite(c),b.fixLayout())},watcherLabels:{xPosition:"x position",yPosition:"y position",direction:"direction",getScale:"size",getTimer:"timer"},blocks:{forward:{type:"command",category:"motion",spec:"move %n steps"},
turn:{type:"command",category:"motion",spec:"turn %clockwise %n degrees"},turnLeft:{type:"command",category:"motion",spec:"turn %counterclockwise %n degrees"},setHeading:{type:"command",category:"motion",spec:"point in direction %dir"},gotoXY:{type:"command",category:"motion",spec:"go to x: %n y: %n"},doGlide:{type:"command",category:"motion",spec:"glide %n secs to x: %n y: %n"},changeXPosition:{type:"command",category:"motion",spec:"change x by %n"},setXPosition:{type:"command",category:"motion",
spec:"set x to %n"},changeYPosition:{type:"command",category:"motion",spec:"change y by %n"},setYPosition:{type:"command",category:"motion",spec:"set y to %n"},bounceOffEdge:{type:"command",category:"motion",spec:"if on edge, bounce"},xPosition:{type:"reporter",category:"motion",spec:"x position"},yPosition:{type:"reporter",category:"motion",spec:"y position"},direction:{type:"reporter",category:"motion",spec:"direction"},doSwitchToCostume:{type:"command",category:"looks",spec:"switch to costume %cst"},
doWearNextCostume:{type:"command",category:"looks",spec:"next costume"},getCostumeIdx:{type:"reporter",category:"looks",spec:"costume #"},doSayFor:{type:"command",category:"looks",spec:"say %s for %n secs"},bubble:{type:"command",category:"looks",spec:"say %s"},doThinkFor:{type:"command",category:"looks",spec:"think %s for %n secs"},doThink:{type:"command",category:"looks",spec:"think %s"},changeEffect:{type:"command",category:"looks",spec:"change %eff effect by %n"},setEffect:{type:"command",category:"looks",
spec:"set %eff effect to %n"},clearEffects:{type:"command",category:"looks",spec:"clear graphic effects"},changeScale:{type:"command",category:"looks",spec:"change size by %n"},setScale:{type:"command",category:"looks",spec:"set size to %n %"},getScale:{type:"reporter",category:"looks",spec:"size"},show:{type:"command",category:"looks",spec:"show"},hide:{type:"command",category:"looks",spec:"hide"},comeToFront:{type:"command",category:"looks",spec:"go to front"},goBack:{type:"command",category:"looks",
spec:"go back %n layers"},alert:{type:"command",category:"looks",spec:"alert %mult%s"},log:{type:"command",category:"looks",spec:"multi log %mult%s"},clear:{type:"command",category:"pen",spec:"clear"},down:{type:"command",category:"pen",spec:"pen down"},up:{type:"command",category:"pen",spec:"pen up"},setColor:{type:"command",category:"pen",spec:"set pen color to %clr"},changeHue:{type:"command",category:"pen",spec:"change pen color by %n"},setHue:{type:"command",category:"pen",spec:"set pen color to %n"},
changeBrightness:{type:"command",category:"pen",spec:"change pen shade by %n"},setBrightness:{type:"command",category:"pen",spec:"set pen shade to %n"},changeSize:{type:"command",category:"pen",spec:"change pen size by %n"},setSize:{type:"command",category:"pen",spec:"set pen size to %n"},doStamp:{type:"command",category:"pen",spec:"stamp"},receiveGo:{type:"hat",category:"control",spec:"when %greenflag clicked"},receiveKey:{type:"hat",category:"control",spec:"when %key key pressed"},receiveClick:{type:"hat",
category:"control",spec:"when I am clicked"},receiveMessage:{type:"hat",category:"control",spec:"when I receive %msg"},doBroadcast:{type:"command",category:"control",spec:"broadcast %msg"},doBroadcastAndWait:{type:"command",category:"control",spec:"broadcast %msg and wait"},doWait:{type:"command",category:"control",spec:"wait %n secs"},doWaitUntil:{type:"command",category:"control",spec:"wait until %b"},doForever:{type:"command",category:"control",spec:"forever %c"},doRepeat:{type:"command",category:"control",
spec:"repeat %n %c"},doUntil:{type:"command",category:"control",spec:"repeat until %b %c"},doIf:{type:"command",category:"control",spec:"if %b %c"},doIfElse:{type:"command",category:"control",spec:"if %b %c else %c"},doStop:{type:"command",category:"control",spec:"stop script"},doStopAll:{type:"command",category:"control",spec:"stop all"},doRun:{type:"command",category:"control",spec:"run %cmd %inputs"},fork:{type:"command",category:"control",spec:"launch %cmd %inputs"},evaluate:{type:"reporter",
category:"control",spec:"call %r %inputs"},doReport:{type:"command",category:"control",spec:"report %s"},doCallCC:{type:"command",category:"control",spec:"run %cmd w/continuation"},reportCallCC:{type:"reporter",category:"control",spec:"call %cmd w/continuation"},doWarp:{type:"command",category:"other",spec:"warp %c"},reportTouchingObject:{type:"predicate",category:"sensing",spec:"touching %col ?"},reportMouseX:{type:"reporter",category:"sensing",spec:"mouse x"},reportMouseY:{type:"reporter",category:"sensing",
spec:"mouse y"},reportMouseDown:{type:"predicate",category:"sensing",spec:"mouse down?"},reportKeyPressed:{type:"predicate",category:"sensing",spec:"key %key pressed?"},doResetTimer:{type:"command",category:"sensing",spec:"reset timer"},reportTimer:{type:"reporter",category:"sensing",spec:"timer"},reportSum:{type:"reporter",category:"operators",spec:"%n + %n"},reportDifference:{type:"reporter",category:"operators",spec:"%n - %n"},reportProduct:{type:"reporter",category:"operators",spec:"%n \u00d7 %n"},
reportQuotient:{type:"reporter",category:"operators",spec:"%n \u00f7 %n"},reportRound:{type:"reporter",category:"operators",spec:"round %n"},reportModulus:{type:"reporter",category:"operators",spec:"%n mod %n"},reportRandom:{type:"reporter",category:"operators",spec:"pick random %n to %n"},reportLessThan:{type:"predicate",category:"operators",spec:"%s < %s"},reportEquals:{type:"predicate",category:"operators",spec:"%s = %s"},reportGreaterThan:{type:"predicate",category:"operators",spec:"%s > %s"},
reportAnd:{type:"predicate",category:"operators",spec:"%b and %b"},reportOr:{type:"predicate",category:"operators",spec:"%b or %b"},reportNot:{type:"predicate",category:"operators",spec:"not %b"},reportTrue:{type:"predicate",category:"operators",spec:"true"},reportFalse:{type:"predicate",category:"operators",spec:"false"},reportJoinWords:{type:"reporter",category:"operators",spec:"join %words"},reportLetter:{type:"reporter",category:"operators",spec:"letter %n of %s"},reportStringSize:{type:"reporter",
category:"operators",spec:"length of %s"},reportUnicode:{type:"reporter",category:"operators",spec:"unicode of %s"},reportUnicodeAsLetter:{type:"reporter",category:"operators",spec:"unicode %n as letter"},reportScript:{type:"reporter",category:"operators",spec:"the script %parms %c"},reify:{type:"reporter",category:"operators",spec:"the %f block %parms"},doSetVar:{type:"command",category:"variables",spec:"set %var to %s"},doChangeVar:{type:"command",category:"variables",spec:"change %var by %n"},
doShowVar:{type:"command",category:"variables",spec:"show variable %var"},doHideVar:{type:"command",category:"variables",spec:"hide variable %var"},doDeclareVariables:{type:"command",category:"other",spec:"script variables %scriptVars"},reportNewList:{type:"reporter",category:"lists",spec:"list %mult%s"},reportCONS:{type:"reporter",category:"lists",spec:"%s in front of %l"},reportListItem:{type:"reporter",category:"lists",spec:"item %idx of %l"},reportCDR:{type:"reporter",category:"lists",spec:"all but first of %l"},
reportListLength:{type:"reporter",category:"lists",spec:"length of %l"},reportListContainsItem:{type:"predicate",category:"lists",spec:"%l contains %s"},doAddToList:{type:"command",category:"lists",spec:"add %s to %l"},doDeleteFromList:{type:"command",category:"lists",spec:"delete %ida of %l"},doInsertInList:{type:"command",category:"lists",spec:"insert %s at %idx of %l"},doReplaceInList:{type:"command",category:"lists",spec:"replace item %idx of %l with %s",defaults:[1,null,"thing"]}}};
XMLSerializer.StringStream.prototype.next=function(a){return void 0===a?(a=this.contents.charAt(this.index),this.index+=1,a):this.contents.substring(this.index,this.index+=a)};XMLSerializer.StringStream.prototype.peek=function(){return this.contents.charAt(this.index)};XMLSerializer.StringStream.prototype.skip=function(a){this.index+=a};
XMLSerializer.StringStream.prototype.upTo=function(a){a=this.contents.substr(this.index).search(a);return-1===a?"":this.contents.substring(this.index,this.index+=a)};XMLSerializer.StringStream.prototype.space=/[\s]/;XMLSerializer.StringStream.prototype.skipSpace=function(){for(var a;this.space.test(a=this.peek())&&""!==a;)this.skip(1)};
XMLSerializer.StringStream.prototype.word=function(){var a=this.contents.substr(this.index).search(/[\s\>\/\=]|$/);return-1===a?"":this.contents.substring(this.index,this.index+=a)};XMLSerializer.Element.prototype.isElement=!0;XMLSerializer.Element.prototype.attr=function(a){return this.attributes[a]};XMLSerializer.Element.prototype.textContent=function(){return this.children.reduce(function(a,b){return a+(b instanceof XMLSerializer.Text?b.value:b.textContent())},"")};
XMLSerializer.Element.prototype.all=function(a){return this.children.filter(function(b){return b.isElement&&b.name===a})};XMLSerializer.Element.prototype.element=function(a){var b;for(b=0;b<this.children.length;b+=1)if(this.children[b].name===a)return this.children[b];return null};XMLSerializer.Element.prototype.require=function(a){var b=this.element(a);if(XMLSerializer.nil(b))throw Error("Missing required element <"+a+">!");return b};
XMLSerializer.Element.prototype.firstElement=function(){var a;for(a=0;a<this.children.length;a+=1)if(this.children[a].isElement)return this.children[a];return null};
XMLSerializer.Element.prototype.toString=function(a){var b=this;void 0===a&&(a="");return a+"<"+this.name+Object.keys(this.attributes).reduce(function(a,d){return a+" "+d+'="'+b.attributes[d]+'"'},"")+(0===this.children.length?" />":">"+this.children.reduce(function(b,d){return b+(d.isElement?"\n":"")+d.toString(a+"  ")},"")+(1<this.children.length||this.children[0].isElement?"\n"+a:"")+"</"+this.name+">")};XMLSerializer.Text.prototype.isElement=!1;XMLSerializer.Text.prototype.toString=function(){return this.value};
Array.prototype.toXML=function(a){return this.reduce(function(b,c){return b+a.store(c)},"")};
StageMorph.prototype.toXML=function(a){var b=this.extent(),c=this.world(),d=newCanvas(XMLSerializer.thumbnailSize),e=d.getContext("2d"),f=this.parentThatIsA(IDE_Morph);a.nil(c)||e.drawImage(c.worldCanvas,this.bounds.origin.x,this.bounds.origin.y,b.x,b.y,0,0,XMLSerializer.thumbnailSize.x,XMLSerializer.thumbnailSize.y);return a.f('<project name="@" version="@"><notes>$</notes><thumbnail>$</thumbnail><stage costume="@" ~><variables>%</variables><media></media><blocks>%</blocks><scripts>%<\/scripts><sprites>%</sprites></stage><variables>%</variables></project>',a.nil(f)||
a.nil(f.projectName)?"Untitled":f.projectName,a.version,a.nil(f)||a.nil(f.projectNotes)?"":f.projectNotes,d.toDataURL("image/png"),0,a.store(this.variables),a.store(this.customBlocks),a.store(this.scripts),a.store(this.children),a.nil(f)||a.nil(f.globalVariables)?"":a.store(f.globalVariables))};SpriteMorph.spriteID=0;
SpriteMorph.prototype.toXML=function(a){var b=this.parentThatIsA(StageMorph),b=a.nil(b)?this.center():this.center().subtract(b.center());a.nil(this.name)&&(this.name="Sprite"+(SpriteMorph.spriteID+=1));return a.f('<sprite name="@" x="@" y="@" heading="@" color="@,@,@" ~><variables>%</variables><media></media><blocks>%</blocks><scripts>%<\/scripts></sprite>',this.name,b.x,-b.y,this.heading,this.color.r,this.color.g,this.color.b,a.store(this.variables),a.nil(this.customBlocks)?"":a.store(this.customBlocks),
a.store(this.scripts))};VariableFrame.prototype.toXML=function(a){var b=this;return Object.keys(this.vars).reduce(function(c,d){var e=b.vars[d];return c+(a.nil(e)?a.f('<variable name="@"/>',d):a.f('<variable name="@">%</variable>',d,"object"===typeof e?a.store(e):a.f("<l>$</l>",e)))},"")};
WatcherMorph.prototype.toXML=function(a){var b=this.target instanceof VariableFrame,c=this.readoutColor,d=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft();return a.f('<watcher% % x="@" y="@" color="@,@,@"%/>',b&&!a.nil(this.target.owner)||!b&&!a.nil(this.target)?a.f(' scope="@"',b?this.target.owner.name:this.target.name):"",a.f(b?'var="@"':'s="@"',this.getter),d.x,d.y,c.r,c.g,c.b,this.isVisible?"":' hidden="hidden"')};
ScriptsMorph.prototype.toXML=function(a){return this.children.reduce(function(b,c){return!(c instanceof BlockMorph)?b:b+c.toScriptXML(a,!0)},"")};BlockMorph.prototype.toXML=BlockMorph.prototype.toScriptXML=function(a,b){var c=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft(),c=b?a.f('<script x="@" y="@">',c.x,c.y):"<script>",d=this;do c+=d.toBlockXML(a),d=d.nextBlock();while(!a.nil(d));return c+"<\/script>"};
BlockMorph.prototype.toBlockXML=function(a){return a.f('<block s="@">%</block>',this.selector,a.store(this.inputs()))};ReporterBlockMorph.prototype.toXML=function(a){return"reportGetVar"===this.selector?a.f('<block var="@"/>',this.blockSpec):this.toBlockXML(a)};ReporterBlockMorph.prototype.toScriptXML=function(a,b){var c=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft();return b?a.f('<script x="@" y="@">%<\/script>',c.x,c.y,this.toXML(a)):a.f("<script>%<\/script>",this.toXML(a))};
CustomCommandBlockMorph.prototype.toBlockXML=CustomReporterBlockMorph.prototype.toBlockXML=function(a){var b=this.isGlobal?void 0:a.nil(this.definition)||a.nil(this.definition.body)||a.nil(this.definition.body.receiver)?"none":this.definition.body.receiver.name;return a.f('<custom-block s="@"%>%</custom-block>',this.blockSpec,this.isGlobal?"":a.f(' scope="@"',b),a.store(this.inputs()))};
CustomBlockDefinition.prototype.toXML=function(a){var b=this;return a.f('<block-definition s="@" type="@" category="@"><inputs>%</inputs>%</block-definition>',this.spec,this.type,a.nil(this.category)?"other":this.category,Object.keys(this.declarations).reduce(function(c,d){return c+a.f('<input type="@">$</input>',b.declarations[d][0],b.declarations[d][1])},""),a.store(this.body.expression))};InputSlotMorph.prototype.toXML=function(a){return a.f("<l>$</l>",this.contents().text)};
TemplateSlotMorph.prototype.toXML=function(a){return a.f("<l>$</l>",this.contents())};CommandSlotMorph.prototype.toXML=FunctionSlotMorph.prototype.toXML=function(a){var b=this.children[0];return a.nil(b)||!(b instanceof BlockMorph)?"<script><\/script>":b instanceof ReporterBlockMorph?a.f("<autolambda>%</autolambda>",a.store(b)):a.store(b)};MultiArgMorph.prototype.toXML=function(a){return a.f("<list>%</list>",a.store(this.inputs()))};
ColorSlotMorph.prototype.toXML=function(a){return a.f("<color>$,$,$,$</color>",this.color.r,this.color.g,this.color.b,this.color.a)};List.prototype.toXML=function(a){var b,c;if(this.isLinked){b='<list linked="linked" ~>';c=this;do b+=a.f("<item>%</item>",a.store(c.first)),c=c.rest;while(!a.nil(c));return b+"</list>"}return a.f("<list ~>%</list>",this.contents.reduce(function(b,c){return b+a.f("<item>%</item>","object"===typeof c?a.store(c):a.f("<l>$</l>",c))},""))};
Context.prototype.toXML=function(a){return a.f("<context% ~><inputs>%</inputs><variables>%</variables>%<receiver>%</receiver>%</context>",this.isLambda?' lambda="lambda"':"",this.inputs.reduce(function(b,c){return b+a.f("<input>$</input>",c)},""),a.nil(this.variables)?"":a.store(this.variables),a.nil(this.expression)?"":a.store(this.expression),a.nil(this.receiver)?"":a.store(this.receiver),a.nil(this.outerContext)?"":a.store(this.outerContext))};